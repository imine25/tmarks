import{b as O}from"./prompts-Dz0Snwak.js";import{A as c}from"./index-DlUqGJ2w.js";class g extends Error{constructor(e,o,s){super(o),this.code=e,this.details=s,this.name="AppError"}}class p{buildPrompt(e,o){const{page:s,context:n,options:i}=e;return console.log("[AI Provider] 已有标签库 ("+n.existingTags.length+"个):",n.existingTags),o?o.replace(/\{title\}/g,s.title).replace(/\{url\}/g,s.url).replace(/\{description\}/g,s.description||"无").replace(/\{content\}/g,s.content?.substring(0,500)||"无").replace(/\{existingTags\}/g,n.existingTags.slice(0,100).join(", ")).replace(/\{recentBookmarks\}/g,n.recentBookmarks.slice(0,10).map(r=>`- ${r.title} [${r.tags.join(", ")}]`).join(`
`)).replace(/\{maxTags\}/g,i.maxTags.toString()).replace(/\{preferExisting\}/g,i.preferExisting?"优先":"可以"):O(e)}handleError(e,o){if(e instanceof g)return e;if(e instanceof TypeError||e&&typeof e=="object"&&"name"in e&&e.name==="NetworkError")return new g("NETWORK_ERROR",`Network error when calling ${o}`,{originalError:e});if(e&&typeof e=="object"&&"status"in e){const n=e;if(n.status===401||n.status===403)return new g("API_KEY_INVALID",`Invalid API key for ${o}`,{status:n.status});if(n.status===429)return new g("RATE_LIMIT_ERROR",`Rate limit exceeded for ${o}`,{status:n.status})}const s=e&&typeof e=="object"&&"message"in e?String(e.message):"Unknown error";return new g("AI_SERVICE_ERROR",`AI service error (${o}): ${s}`,{originalError:e})}parseResponse(e){try{const o=e.match(/\{[\s\S]*\}/),s=o?o[0]:e,n=JSON.parse(s);if(console.log("[AI Response]",JSON.stringify(n,null,2)),!n.suggestedTags||!Array.isArray(n.suggestedTags))throw new Error("Invalid response format: suggestedTags not found");return{suggestedTags:n.suggestedTags.map(r=>{if(!r||typeof r!="object")return{name:"",isNew:!0,confidence:.5};const a=r,l={name:typeof a.name=="string"?a.name:"",isNew:typeof a.isNew=="boolean"?a.isNew:!0,confidence:typeof a.confidence=="number"?a.confidence:.5};return console.log(`[Tag] ${l.name} - isNew: ${l.isNew}`),l}),reasoning:n.reasoning,translatedTitle:n.translatedTitle,translatedDescription:n.translatedDescription}}catch(o){throw console.error("Failed to parse AI response:",e),new g("AI_SERVICE_ERROR","Failed to parse AI response",{content:e,error:o})}}}const x="你是一个智能书签标签推荐助手。优先使用已有标签,只有在必要时才建议新标签。返回格式必须是JSON。",m=t=>{if(!t||typeof t!="object")return;const e=t,o=e.choices;if(!Array.isArray(o)||o.length===0)return;const s=o[0];if(!s||typeof s!="object")return;const n=s.message;if(!n||typeof n!="object")return;const i=n,r=i.content;if(typeof r=="string")return r.trim();if(Array.isArray(r)){const a=r.map(l=>{if(!l)return"";if(typeof l=="string")return l;if(typeof l=="object"){const u=l;if(typeof u.text=="string")return u.text;if(typeof u.content=="string")return u.content;if(typeof u.value=="string")return u.value;if(u.text&&typeof u.text=="object"){const h=u.text;if(typeof h.value=="string")return h.value}}return""}).filter(Boolean).join(`
`).trim();if(a)return a}if(typeof i.text=="string")return i.text.trim();if(typeof e.output_text=="string")return e.output_text.trim();if(e.output&&typeof e.output=="object"){const a=e.output;if(typeof a.text=="string")return a.text.trim()}},S=t=>{const e=t?.content;if(Array.isArray(e)&&e[0]?.type==="text"&&typeof e[0]?.text=="string")return e[0].text.trim();if(typeof t?.output_text=="string")return t.output_text.trim()},b=(t,e)=>{const o=t.trim();if(!o)return e;if(o.includes(e))return o;const s=o.replace(/\/$/,""),n=e.startsWith("/")?e:`/${e}`;return`${s}${n}`},f=(t,e,o)=>{const{apiKey:s,apiUrl:n,model:i,prompt:r,temperature:a,maxTokens:l}=e;let u=n?.trim()||t;u=u.replace(/\/$/,"");const h=b(u,"/chat/completions"),y={"Content-Type":"application/json"};s&&(y.Authorization=`Bearer ${s}`);const w={model:i,messages:[{role:"system",content:x},{role:"user",content:r}],temperature:typeof a=="number"?a:.7,max_tokens:l??o?.defaultMaxTokens??500};return o?.includeJsonResponseFormat&&(w.response_format={type:"json_object"}),o?.additionalBody&&Object.assign(w,o.additionalBody),{url:h,headers:y,body:w,maxTokens:w.max_tokens}},j={openai:{defaultBaseUrl:c.OPENAI,buildRequest:t=>f(c.OPENAI,t,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:m},claude:{defaultBaseUrl:c.CLAUDE,buildRequest:t=>{const e=t.apiUrl?.trim()||c.CLAUDE,o=b(e,"/messages"),s={"Content-Type":"application/json","x-api-key":t.apiKey,"anthropic-version":"2023-06-01"},n={model:t.model,system:x,max_tokens:t.maxTokens??1024,temperature:typeof t.temperature=="number"?t.temperature:.7,messages:[{role:"user",content:[{type:"text",text:t.prompt}]}]};return{url:o,headers:s,body:n,maxTokens:n.max_tokens}},extractContent:S},deepseek:{defaultBaseUrl:c.DEEPSEEK,buildRequest:t=>f(c.DEEPSEEK,t,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:m},zhipu:{defaultBaseUrl:c.ZHIPU,buildRequest:t=>f(c.ZHIPU,t,{defaultMaxTokens:500}),extractContent:m},modelscope:{defaultBaseUrl:c.MODELSCOPE,buildRequest:t=>f(c.MODELSCOPE,t,{defaultMaxTokens:500,additionalBody:{result_format:"message"}}),extractContent:m},siliconflow:{defaultBaseUrl:c.SILICONFLOW,buildRequest:t=>f(c.SILICONFLOW,t,{defaultMaxTokens:500,additionalBody:{stream:!1}}),extractContent:m},iflow:{defaultBaseUrl:c.IFLOW,buildRequest:t=>f(c.IFLOW,t,{defaultMaxTokens:1e3}),extractContent:m},custom:{defaultBaseUrl:c.OPENAI,buildRequest:t=>f(t.apiUrl?.trim()||c.OPENAI,t,{defaultMaxTokens:500}),extractContent:m}};async function d(t){const e=j[t.provider];if(!e)throw new Error(`Unsupported AI provider: ${t.provider}`);const{url:o,headers:s,body:n}=e.buildRequest(t),i=await fetch(o,{method:"POST",headers:s,body:JSON.stringify(n)});if(!i.ok){let l;try{l=await i.text()}catch(u){l=u.message||"Unknown error"}throw new Error(`AI API 请求失败 (${i.status}): ${l.substring(0,200)}`)}const r=await i.json(),a=e.extractContent(r);if(!a)throw new Error(`AI 响应格式错误: ${JSON.stringify(r).substring(0,200)}`);return{content:a,raw:r}}class E extends p{name="openai";models=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];async generateTags(e,o,s="gpt-4o",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"openai",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"OpenAI")}}}class T extends p{name="claude";models=["claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229"];async generateTags(e,o,s="claude-3-5-sonnet-20241022",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"claude",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:1024,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"Claude")}}}class I extends p{name="deepseek";models=["deepseek-chat","deepseek-reasoner"];async generateTags(e,o,s="deepseek-chat",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"deepseek",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"DeepSeek")}}}class A extends p{name="zhipu";models=["glm-4-plus","glm-4-flash","glm-4-air","glm-4"];async generateTags(e,o,s="glm-4-flash",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"zhipu",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"ZhipuAI")}}}class k extends p{name="modelscope";models=["qwen-plus","qwen-turbo","qwen-max","qwen2.5-72b-instruct"];async generateTags(e,o,s="qwen-turbo",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"modelscope",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"ModelScope")}}}class R extends p{name="siliconflow";models=["deepseek-ai/DeepSeek-V3","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-72B-Instruct","THUDM/glm-4-9b-chat","meta-llama/Meta-Llama-3.1-8B-Instruct"];async generateTags(e,o,s="Qwen/Qwen2.5-7B-Instruct",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"siliconflow",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"SiliconFlow")}}}class v extends p{name="iflow";models=["TBStars2-200B-A13B","TBStars2-70B-A7B"];async generateTags(e,o,s="TBStars2-200B-A13B",n,i){try{const r=this.buildPrompt(e,i),{content:a}=await d({provider:"iflow",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:1e3,temperature:.7});return this.parseResponse(a)}catch(r){throw this.handleError(r,"iFlow")}}}class P extends p{name="custom";models=["custom-model"];async generateTags(e,o,s="gpt-4o",n,i){try{if(!n)throw new Error("自定义 AI 需要配置 API 地址");const r=this.buildPrompt(e,i),{content:a}=await d({provider:"custom",apiKey:o,apiUrl:n,model:s,prompt:r,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(r){throw console.error("[CustomProvider] 错误详情:",r),this.handleError(r,"Custom")}}}const B=new Map([["openai",new E],["claude",new T],["deepseek",new I],["zhipu",new A],["modelscope",new k],["siliconflow",new R],["iflow",new v],["custom",new P]]);function C(t){const e=B.get(t);if(!e)throw new Error(`Unknown AI provider: ${t}`);return e}const M=Object.freeze(Object.defineProperty({__proto__:null,AIProvider:p,ClaudeProvider:T,CustomProvider:P,DeepSeekProvider:I,IFlowProvider:v,ModelScopeProvider:k,OpenAIProvider:E,SiliconFlowProvider:R,ZhipuProvider:A,getAIProvider:C},Symbol.toStringTag,{value:"Module"}));export{g as A,C as g,M as i};
