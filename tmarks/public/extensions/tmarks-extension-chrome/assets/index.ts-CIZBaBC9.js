import{d as t}from"./index-NQ3jknxk.js";import{A as e,g as a,c as o}from"./index-7RnQ6Fxb.js";import{S as n,g as r,P as s}from"./urls-DpCSGfkZ.js";import{c as i}from"./index-CK9CFPi6.js";import{s as c}from"./tab-collection-D8RrnWD8.js";import{N as l,b as d}from"./newtabPrompts-5mIaLKQk.js";import{S as u}from"./constants-LJ5_wtHo.js";import"./dexie-BAhLzSXZ.js";import"./prompts-CKcm-rRX.js";const m=new class{client=null;webBaseUrl=null;async initialize(){const t=await n.getBookmarkSiteApiUrl(),a=await n.getBookmarkSiteApiKey();if(!a)throw new e("API_KEY_INVALID","API Key not found. Please configure your TMarks API key in the extension settings (Options page).");let o;o=t?t.endsWith("/api")?t:r(t).API_BASE:r().API_BASE,this.webBaseUrl=o.endsWith("/api")?o.slice(0,-4):o,this.client=i({apiKey:a,baseUrl:o})}async notifyWebAppDataChanged(){if(this.webBaseUrl)try{const t=await chrome.tabs.query({url:[`${this.webBaseUrl}/*`]});await Promise.all((t||[]).filter(t=>"number"==typeof t.id).map(t=>chrome.tabs.sendMessage(t.id,{type:"TMARKS_WEB_DATA_CHANGED",payload:{timestamp:Date.now()}}).catch(()=>{})))}catch{}}async ensureClient(){if(await this.initialize(),!this.client)throw new e("API_KEY_INVALID","API Key not found. Failed to initialize TMarks client. Please configure your API key in the extension settings.");return this.client}async getTags(){const t=await this.ensureClient();try{return(await t.tags.getTags()).data.tags.map(t=>({name:t.name,color:t.color,count:t.bookmark_count||0,createdAt:new Date(t.created_at).getTime()}))}catch(a){if("MISSING_API_KEY"===a.code)throw new e("API_KEY_INVALID","TMarks API key is required. Please configure your API key in the extension settings.",{originalError:a});throw new e("BOOKMARK_SITE_ERROR",`Failed to fetch tags: ${a.message}`,{originalError:a})}}async getBookmarks(t=1,a=100){const o=await this.ensureClient();try{const e=await o.bookmarks.getBookmarks({page_size:a,page_cursor:t>1?`page_${t}`:void 0});if(!e.data.bookmarks.length)return{bookmarks:[],hasMore:!1};return{bookmarks:e.data.bookmarks.map(t=>({url:t.url,title:t.title,description:t.description||"",tags:t.tags.map(t=>t.name),createdAt:new Date(t.created_at).getTime(),remoteId:t.id,isPublic:t.is_public})),hasMore:e.data.meta.has_more}}catch(n){throw new e("BOOKMARK_SITE_ERROR",`Failed to fetch bookmarks: ${n.message}`,{originalError:n})}}async addBookmark(t){const a=await this.ensureClient(),o={title:t.title,url:t.url,description:t.description,cover_image:t.thumbnail,favicon:t.favicon,tags:t.tags,is_public:t.isPublic??!1};try{const t=await a.bookmarks.createBookmark(o);if(!t.data.bookmark)throw new e("BOOKMARK_SITE_ERROR","Failed to add bookmark: No data returned");const n="BOOKMARK_EXISTS"===t.meta?.code;return n?(await this.notifyWebAppDataChanged(),{id:t.data.bookmark.id,isExisting:n,existingBookmark:t.data.bookmark}):(await this.notifyWebAppDataChanged(),{id:t.data.bookmark.id,isExisting:n})}catch(n){let t;const a=n.code||"",o=n.status||0;t="INVALID_API_KEY"===a||"MISSING_API_KEY"===a||401===o?"认证失败：API Key 无效或已过期，请在设置中检查您的 TMarks API Key":"INSUFFICIENT_PERMISSIONS"===a||403===o?"权限不足：您的 API Key 没有保存书签的权限":"RATE_LIMIT_EXCEEDED"===a||429===o?"请求过于频繁，请稍后再试":"NETWORK_ERROR"===a||0===o?"网络错误：无法连接到 TMarks 服务器，请检查网络连接":o>=500?"TMarks 服务器错误，请稍后再试":n.message||"保存书签失败";const r=new e("BOOKMARK_SITE_ERROR",t,{originalError:n});throw r.code=a,r.status=o,r}}async updateBookmarkTags(t,a){const o=await this.ensureClient();try{await o.bookmarks.updateBookmark(t,{tags:a}),await this.notifyWebAppDataChanged()}catch(n){throw new e("BOOKMARK_SITE_ERROR",`Failed to update tags: ${n.message}`,{originalError:n})}}async updateBookmarkDescription(t,a){const o=await this.ensureClient();try{await o.bookmarks.updateBookmark(t,{description:a}),await this.notifyWebAppDataChanged()}catch(n){throw new e("BOOKMARK_SITE_ERROR",`Failed to update description: ${n.message}`,{originalError:n})}}async createSnapshot(t,a){const o=await this.ensureClient();try{await o.snapshots.createSnapshot(t,a),await this.notifyWebAppDataChanged()}catch(n){throw new e("BOOKMARK_SITE_ERROR",`Failed to create snapshot: ${n.message}`,{originalError:n})}}async createSnapshotV2(t,a){await this.ensureClient();try{const e=await n.getBookmarkSiteApiKey(),o=await n.getBookmarkSiteApiUrl();let s;s=o?o.endsWith("/api")?o:r(o).API_BASE:r().API_BASE;const i=await fetch(`${s}/tab/bookmarks/${t}/snapshots-v2`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":e},body:JSON.stringify(a)});if(!i.ok){const t=await i.json();throw new Error(t.error?.message||"Failed to create snapshot")}await this.notifyWebAppDataChanged()}catch(o){throw new e("BOOKMARK_SITE_ERROR",`Failed to create snapshot (V2): ${o.message}`,{originalError:o})}}async testConnection(){try{const t=await this.ensureClient();return await t.user.getMe(),!0}catch(t){return!1}}};const h=new class{contextCache=null;contextPromise=null;async recommendTags(t){try{const e=n.loadConfig(),a=this.getContext(),o=await e,r=o.aiConfig.apiKeys[o.aiConfig.provider];if(!r)return this.fallbackRecommendation(t);const s=await a,i={page:{title:t.title,url:t.url,description:t.description,content:t.content?.substring(0,500)},context:s,options:{maxTags:o.preferences.maxSuggestedTags||5,preferExisting:!0}},c=o.aiConfig.apiUrls?.[o.aiConfig.provider],l=o.aiConfig.enableCustomPrompt?o.aiConfig.customPrompt:void 0,d=await this.callAIWithRetry(i,r,o.aiConfig.provider,o.aiConfig.model,c,l,1,void 0),u=s.existingTags,m=new Set(u.map(t=>t.trim().toLowerCase())),h=d.suggestedTags.map(t=>{const e=t.name.trim().toLowerCase(),a=m.has(e);return{...t,isNew:!a}});return{tags:this.deduplicateAndSort(h),source:"ai",timestamp:Date.now()}}catch(e){const a=e instanceof Error?e.message:"AI recommendation failed";return this.fallbackRecommendation(t,a)}}async getContext(){if(this.contextCache)return this.contextCache;if(this.contextPromise)return this.contextPromise;this.contextPromise=this.loadContextFromDB();try{const t=await this.contextPromise;return this.contextCache=t,t}finally{this.contextPromise=null}}async callAIWithRetry(t,e,o,n,r,s,i,c){const l=a(o);let d;for(let a=0;a<i;a++)try{if("number"==typeof c&&c>0){const a=new Promise((t,e)=>{setTimeout(()=>e(new Error("AI request timeout")),c)});return await Promise.race([l.generateTags(t,e,n,r,s),a])}return await l.generateTags(t,e,n,r,s)}catch(u){if(d=u,a<i-1){const t=1e3*Math.pow(2,a);await this.delay(t)}}throw d||new Error("AI request failed after retries")}async fallbackRecommendation(e,a){const o=this.extractKeywords(e.title+" "+(e.description||""));return{tags:(await t.tags.toArray()).filter(t=>o.some(e=>t.name.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(t.name.toLowerCase()))).sort((t,e)=>(e.count||0)-(t.count||0)).slice(0,3).map(t=>({name:t.name,isNew:!1,confidence:.6})),source:"fallback",timestamp:Date.now(),message:a||null}}extractKeywords(t){return t.split(/[\s\/\-_、，。！？]+/).map(t=>t.trim()).filter(t=>t.length>1).slice(0,20)}deduplicateAndSort(t){const e=new Set,a=[];for(const o of t){const t=o.name.toLowerCase().trim();e.has(t)||(e.add(t),a.push(o))}return a.sort((t,e)=>e.confidence-t.confidence)}delay(t){return new Promise(e=>setTimeout(e,t))}clearContextCache(){this.contextCache=null}async preloadContext(){if(this.contextPromise)return void(await this.contextPromise);const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}async refreshContextFromDB(){const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}updateContextWithBookmark(t){if(!this.contextCache)return;const e=new Set(this.contextCache.existingTags.map(t=>t.toLowerCase())),a=[];for(const o of t.tags){const t=o.trim();t&&(e.has(t.toLowerCase())||(e.add(t.toLowerCase()),a.push(t)))}a.length>0&&(this.contextCache.existingTags=[...this.contextCache.existingTags,...a].slice(-200)),this.contextCache.recentBookmarks=[{title:t.title,tags:t.tags},...this.contextCache.recentBookmarks].slice(0,20)}async loadContextFromDB(e=!1){if(!e&&this.contextCache)return this.contextCache;const[a,o]=await Promise.all([t.tags.orderBy("count").reverse().limit(200).toArray().then(t=>t.map(t=>t.name)),t.bookmarks.orderBy("createdAt").reverse().limit(20).toArray().then(t=>t.map(t=>({title:t.title,tags:t.tags})))]),n={existingTags:a,recentBookmarks:o};return this.contextCache=n,n}};const f=new class{async fullSync(){const e=Date.now();try{const a=await m.getTags();await t.tags.clear(),await t.tags.bulkAdd(a);let o=1,n=0;for(await t.bookmarks.clear();o<=s.MAX_PAGES;){const{bookmarks:e,hasMore:a}=await m.getBookmarks(o,s.DEFAULT_PAGE_SIZE);if(e.length>0&&(await t.bookmarks.bulkAdd(e),n+=e.length),!a)break;o++}await t.updateLastSyncTime(Date.now()),await t.metadata.put({key:"totalTags",value:a.length,updatedAt:Date.now()}),await t.metadata.put({key:"totalBookmarks",value:n,updatedAt:Date.now()}),await h.refreshContextFromDB();return{success:!0,duration:Date.now()-e,stats:{tags:a.length,bookmarks:n}}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async incrementalSync(){try{await t.getLastSyncTime();return this.fullSync()}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getStats(){return t.getStats()}async isCacheStale(e=24){const a=await t.getLastSyncTime();if(0===a)return!0;const o=60*e*60*1e3;return Date.now()-a>o}async autoSync(t=24){return await this.isCacheStale(t)?this.incrementalSync():null}async clearCache(){await t.clearAll(),h.clearContextCache()}};const p=new class{async saveBookmark(e){let a,o=!1;try{const n=await m.addBookmark(e);if(a=n.id,o=n.isExisting||!1,o&&n.existingBookmark)return{success:!0,existingBookmark:{...n.existingBookmark,needsDialog:!0},message:"书签已存在"};o||(await t.bookmarks.add({url:e.url,title:e.title,description:e.description,tags:e.tags,createdAt:Date.now(),remoteId:n.id,isPublic:e.isPublic??!1}),await this.updateTagCounts(e.tags),h.updateContextWithBookmark({title:e.title,tags:e.tags}))}catch(n){const t=n instanceof Error?n.message:"Unknown error",a=n?.code||"",o=n?.status||0,r="INVALID_API_KEY"===a||"MISSING_API_KEY"===a||"INSUFFICIENT_PERMISSIONS"===a||401===o||403===o||t.includes("认证")||t.includes("API Key");if(("NETWORK_ERROR"===a||0===o)&&!r&&(t.includes("Network")||t.includes("网络")||t.includes("connect")))return await this.queueForLaterSync(e),{success:!0,offline:!0,message:"网络不可用，已暂存到本地，将在网络恢复后自动同步"};throw n}if(e.createSnapshot&&a)try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t&&t.id){let o;try{const e=chrome.tabs.sendMessage(t.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),a=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),n=await Promise.race([e,a]);if(!n.success)throw new Error(n.error||"Capture failed");o=n.data}catch(n){throw n}const r=o.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));await m.createSnapshotV2(a,{html_content:o.html,title:e.title,url:e.url,images:r})}}catch(r){}return{success:!0,bookmarkId:a,message:o?"书签已存在，已为其创建新快照":void 0}}async updateTagCounts(e){for(const a of e){const e=await t.tags.where("name").equals(a).first();e&&e.id?await t.tags.update(e.id,{count:(e.count||0)+1}):await t.tags.add({name:a,count:1,createdAt:Date.now()})}}async queueForLaterSync(e){await t.metadata.add({key:`pending_${Date.now()}`,value:e,updatedAt:Date.now()})}async syncPendingBookmarks(){const e=await t.metadata.where("key").startsWith("pending_").toArray();let a=0;for(const n of e)try{if(n.value&&"object"==typeof n.value&&"url"in n.value&&"title"in n.value){const e=n.value;await m.addBookmark(e),await t.metadata.delete(n.key),a++}}catch(o){}return a}async getPendingCount(){return await t.metadata.where("key").startsWith("pending_").count()}},w="TMarks",g="NewTab Home",y="tmarks_root_bookmark_id",k="tmarks_home_bookmark_id",I=864e5,b="[ROOT]";async function C(){try{const t=(await chrome.storage.local.get(y))[y];return"string"==typeof t?t:null}catch{return null}}async function A(t){try{await chrome.storage.local.set({[y]:t})}catch{}}async function E(){try{const t=(await chrome.storage.local.get(k))[k];return"string"==typeof t?t:null}catch{return null}}async function S(t){try{await chrome.storage.local.set({[k]:t})}catch{}}async function T(){try{const e=await async function(){try{const t=(await chrome.bookmarks.getTree())[0],e=t.children?.find(t=>"1"===t.id&&!t.url);if(e)return e.id;const a=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),o=t.children?.find(t=>!t.url&&a.has(t.title));if(o)return o.id;const n=t.children?.find(t=>!t.url);return n?.id||null}catch{return null}}();if(!e)return null;const a=await C();if(a){const o=await async function(t){try{const e=await chrome.bookmarks.get(t),a=e?.[0];return a&&!a.url?a:null}catch{return null}}(a);if(o){const n=o.parentId;if(n&&n!==e)try{await chrome.bookmarks.move(a,{parentId:e})}catch(t){}return{id:a,wasRecreated:!1}}}const o=await chrome.bookmarks.getChildren(e),n=o.find(t=>!t.url&&t.title===w);if(n)return await A(n.id),{id:n.id,wasRecreated:!1};const r="AI 书签助手 NewTab",s=o.find(t=>!t.url&&t.title===r);if(s){try{await chrome.bookmarks.update(s.id,{title:w})}catch{}return await A(s.id),{id:s.id,wasRecreated:!1}}const i=await chrome.bookmarks.create({parentId:e,title:w});await A(i.id);const c=null!==a;return{id:i.id,wasRecreated:c}}catch{return null}}async function _(t){if(!t)return null;const e=await E();if(e)try{const o=await chrome.bookmarks.get(e),n=o?.[0];if(n&&!n.url){if(n.parentId!==t)try{await chrome.bookmarks.move(e,{parentId:t})}catch(a){}return await S(n.id),{id:n.id,wasRecreated:!1}}}catch{}try{const a=(await chrome.bookmarks.getChildren(t)).find(t=>!t.url&&t.title===g);if(a)return await S(a.id),{id:a.id,wasRecreated:!1};const o=await chrome.bookmarks.create({parentId:t,title:g});return await S(o.id),{id:o.id,wasRecreated:null!==e}}catch(a){return null}}async function P(){const t=await T();if(!t)return null;const e=await _(t.id);return{rootId:t.id,homeId:e?.id??null}}async function x(t){try{await chrome.runtime.sendMessage({type:"AI_ORGANIZE_PROGRESS",payload:{...t,ts:Date.now()}})}catch{}}async function R(t,e){try{const e=await chrome.tabs.get(t);return{success:!0,data:{title:e.title||"Untitled",url:e.url||"",description:"",content:"",thumbnail:""}}}catch{return{success:!0,data:{title:"Untitled",url:e,description:"",content:"",thumbnail:""}}}}async function v(t,e,a=3e3){return Promise.race([chrome.tabs.sendMessage(t,e),new Promise((t,e)=>setTimeout(()=>e(new Error("Message timeout")),a))])}function B(t){const e=(t||"").trim();if(!e)return null;const a=t=>{try{return JSON.parse(t)}catch{return null}},o=t=>{const e=(t||"").trim();return e?e.replace(/,\s*([}\]])/g,"$1"):""},n=a(e);if(n)return n;const r=e.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);if(r&&r[1]){const t=a(o(r[1]));if(t)return t}const s=e.indexOf("{"),i=e.lastIndexOf("}");if(-1!==s&&-1!==i&&i>s){const t=a(o(e.slice(s,i+1)));if(t)return t}const c=e.indexOf("["),l=e.lastIndexOf("]");if(-1!==c&&-1!==l&&l>c){const t=a(o(e.slice(c,l+1)));if(t)return t}const d=e.match(/"domainMoves"|"domain_moves"/);if(void 0!==d?.index){const t=e.lastIndexOf("{",d.index);if(-1!==t){const n=o(e.slice(t)),r=[];r.push(n);const s=n.lastIndexOf("}");if(-1!==s){const t=n.slice(0,s+1);r.push(t);const e=t.search(/"domainMoves"|"domain_moves"/);if(-1!==e){const a=t.indexOf("[",e),o=t.lastIndexOf("]");-1!==a&&o<a&&r.push(`${t}]}`)}}for(const t of r){const e=a(t);if(e)return e}}}return null}function M(t){try{return new URL(t).hostname||""}catch{return""}}async function O(t){const e=new Date,a=t=>String(t).padStart(2,"0"),o=`Imported ${e.getFullYear()}-${a(e.getMonth()+1)}-${a(e.getDate())} ${a(e.getHours())}${a(e.getMinutes())}${a(e.getSeconds())}`,n=await chrome.bookmarks.create({parentId:t,title:o}),r=await chrome.bookmarks.getTree(),s=r?.[0];if(!s)throw new Error("Bookmarks root not found");const i=await async function(t){const e=[],a={folders:0,bookmarks:0},o=(t,a)=>{t&&0!==t.length&&e.push({children:t,index:0,targetParentId:a})};for(o(t.sourceRoot.children,t.targetParentId);e.length>0;){const n=e[e.length-1];if(n.index>=n.children.length){e.pop();continue}const r=n.children[n.index],s=n.index;if(n.index+=1,t.skipSourceId&&r.id===t.skipSourceId)continue;if(!r.url&&r.title===w)continue;if(r.url){await chrome.bookmarks.create({parentId:n.targetParentId,index:s,title:r.title||r.url,url:r.url}),a.bookmarks+=1;continue}const i=await chrome.bookmarks.create({parentId:n.targetParentId,index:s,title:r.title||"文件夹"});a.folders+=1,o(r.children,i.id)}return a}({sourceRoot:s,targetParentId:n.id,skipSourceId:t});return{importFolderId:n.id,folderTitle:o,counts:i}}async function N(t,e,a){const o=(e||"").split("/").map(t=>t.trim()).filter(Boolean).join("/");if(!o)return t;const n=a.get(o);if(n)return n;const r=o.split("/");let s=t,i="";for(const c of r){i=i?`${i}/${c}`:c;const t=a.get(i);if(t){s=t;continue}const e=(await chrome.bookmarks.getChildren(s)).find(t=>!t.url&&t.title===c);if(e){a.set(i,e.id),s=e.id;continue}const o=await chrome.bookmarks.create({parentId:s,title:c});a.set(i,o.id),s=o.id}return s}function D(t){const e=(t||"").split("/").map(t=>t.trim()).filter(Boolean);return 0===e.length?"":e.slice(0,2).join("/")}async function K(){const t=await T();if(!t)throw new Error("NewTab root folder not found");const e=t.id,a=(await chrome.bookmarks.get(e))?.[0];if(!a)throw new Error("NewTab root folder not found");const o=[],n=[{node:a,parentId:null,pathPrefix:""}];for(;n.length>0&&o.length<200;){const{node:t,parentId:e,pathPrefix:a}=n.shift(),r=a?`${a}/${t.title}`:t.title;o.push({id:t.id,title:t.title,parentId:e,path:r});const s=(await chrome.bookmarks.getChildren(t.id)).filter(t=>!t.url);for(const i of s){if(o.length+n.length>=200)break;n.push({node:i,parentId:t.id,pathPrefix:r})}}return{success:!0,data:{rootId:a.id,folders:o}}}function F(t,e,a,o){const n=function(t){const e=new Map;for(const a of t||[]){if(!a?.url)continue;const t=M(a.url)||"(no-domain)",o=e.get(t)||{clickCount:0,shortcutCount:0};o.shortcutCount+=1,o.clickCount+="number"==typeof a.clickCount?a.clickCount:0,e.set(t,o)}return e}(e),r=new Map;return{summaries:Array.from(t.entries()).map(([t,e])=>{const s=t||"(no-domain)",i=n.get(s)||{clickCount:0,shortcutCount:0},c=a?.get(s),l=c?.count??0,d=c?.lastVisitTime??null,u=d?Math.max(0,Math.min(1,1-Math.min((Date.now()-d)/I,o)/o)):0,m=e.length,h=i.clickCount,f=Number((1*m+.5*h+.3*l+2*u).toFixed(3)),p=new Map;for(const a of e){const t=a.path||b;p.set(t,(p.get(t)??0)+1)}const w=Array.from(p.entries()).sort((t,e)=>e[1]-t[1]).slice(0,5).map(([t,e])=>({path:t,count:e}));return w.length>0&&r.set(s,w[0].path),{domain:s,count:m,bookmarkCount:m,shortcutCount:i.shortcutCount,clickCount:h,historyCount:l,historyLastVisit:d,historyLastVisitISO:d?new Date(d).toISOString():null,recencyScore:Number(u.toFixed(3)),heatScore:f,samples:e.slice(0,3).map(t=>({title:t.title,url:t.url,path:t.path})),originalPaths:w}}).sort((t,e)=>(e.heatScore??0)!==(t.heatScore??0)?(e.heatScore??0)-(t.heatScore??0):(e.bookmarkCount??e.count??0)-(t.bookmarkCount??t.count??0)),domainPreferredPathMap:r}}async function $(t){const e=t.payload||{},a="string"==typeof e.sessionId&&e.sessionId.trim()?e.sessionId.trim():String(Date.now()),r="string"==typeof e.rules?e.rules:"",s=Math.min(2e3,Math.max(50,Number(e.maxBookmarks??300))),i="string"==typeof e.promptTemplate?e.promptTemplate.trim():"",c=Boolean(e.enableHistoryHeat),l=function(t){if(!Number.isFinite(t))return 30;const e=Math.round(t);return Math.max(1,Math.min(90,e))}(Number(e.historyDays??30)),m=function(t){if(!Number.isFinite(t))return 20;const e=Math.round(t);return Math.max(5,Math.min(100,e))}(Number(e.historyHeatTopN??20)),h=Boolean(e.strictHierarchy),f=!h&&!1!==e.allowNewFolders,p=!1!==e.preferOriginalPaths,w=!1!==e.verboseLogs,g=function(t){if(!Number.isFinite(t))return 5;const e=Math.round(t);return Math.max(3,Math.min(7,e))}(Number(e.topLevelCount??5));let y=!1;const k=async(t,e)=>{const a=t.level??"info";!w&&(e?.verbose??"info"===a)||await x(t)};await k({sessionId:a,level:"info",step:"start",message:"开始 AI 整理：准备读取书签与配置"},{verbose:!1});const C=await T();if(!C)throw new Error("NewTab root folder not found");const A=C.id;await k({sessionId:a,level:"info",step:"root",message:`已定位工作区根目录: ${A}`});const E=await async function(t){const e=await chrome.bookmarks.getTree(),a=e?.[0],o=[];if(!a)return o;const n=[{node:a,path:"",parentPath:""}];for(;n.length>0;){const{node:e,path:a,parentPath:r}=n.pop();if(t&&e.id===t)continue;if(e.url){const t=e.url||"",a=r||b;o.push({id:e.id,title:e.title||t,url:t,domain:M(t),path:a});continue}const s=e.children||[];for(let t=s.length-1;t>=0;t--){const e=s[t],o=(e.title||"").trim()||"未命名",r=e.url?a:a?`${a}/${o}`:o;n.push({node:e,path:r,parentPath:a})}}return o}(A);if(0===E.length)return await k({sessionId:a,level:"warn",step:"collect",message:"浏览器没有可整理的书签"}),{success:!0,data:{total:0,processed:0,truncated:y,moved:0,createdFolders:0,createdBookmarks:0,message:"浏览器没有可整理的书签"}};const S=await async function(){try{const t=await chrome.storage.local.get(u),e=t?.[u];return e&&"object"==typeof e&&Array.isArray(e.shortcuts)?e.shortcuts:[]}catch{return[]}}();await k({sessionId:a,level:"info",step:"usage",message:`已加载快捷方式: ${S.length} 个`});let _=null;if(c)if(chrome.history&&"function"==typeof chrome.history.search)try{await k({sessionId:a,level:"info",step:"history",message:`读取浏览历史：最近 ${l} 天`});const t=await async function(t){if(!chrome.history||"function"!=typeof chrome.history.search)throw new Error("History API unavailable");const e=Date.now()-t*I,a=await chrome.history.search({text:"",startTime:e,maxResults:5e3}),o=new Map;for(const n of a){if(!n?.url)continue;const t=M(n.url)||"(no-domain)",e=o.get(t)||{count:0,lastVisitTime:0};e.count+=1,"number"==typeof n.lastVisitTime&&n.lastVisitTime>e.lastVisitTime&&(e.lastVisitTime=n.lastVisitTime),o.set(t,e)}return{domains:o,totalItems:a.length,truncated:a.length>=5e3}}(l);_=t.domains,await k({sessionId:a,level:"info",step:"history",message:`历史记录: ${t.totalItems} 条，覆盖 ${_.size} 个域名${t.truncated?"（部分截断）":""}`})}catch(Q){await k({sessionId:a,level:"warn",step:"history",message:`历史记录读取失败：${Q instanceof Error?Q.message:"未知错误"}，继续使用书签数据`})}else await k({sessionId:a,level:"warn",step:"history",message:"历史记录 API 不可用，跳过热度统计"});const P=function(t){const e=new Map;for(const a of t){const t=a.domain||"(no-domain)",o=e.get(t)||[];o.push({id:a.id,title:a.title,url:a.url,path:a.path}),e.set(t,o)}return e}(E),R=function(t){const e=new Map;for(const a of t){const t=a.path||b;e.set(t,(e.get(t)??0)+1)}return Array.from(e.entries()).sort((t,e)=>e[1]-t[1]).slice(0,500).map(([t,e])=>({path:t,count:e}))}(E),{summaries:v}=F(P,S,_,l),O=v.slice(0,Math.min(m,v.length));await x({sessionId:a,level:"info",step:"collect",message:`已读取书签: ${E.length} 个；域名: ${P.size} 个`});const K=[];for(let o=0;o<v.length;o+=s)K.push(v.slice(o,o+s));const $={totalDomains:v.length,totalBatches:K.length||1,batchSize:s,truncated:!1,topHistoryLimit:m,topHistoryDomains:O,folderPaths:R,strictHierarchy:h,allowNewFolders:f,preferOriginalPaths:p,batches:(K.length?K:[v]).map((t,e,a)=>({batchIndex:e+1,totalBatches:a.length,waitForMoreBatches:e+1<a.length,isFinalBatch:e+1===a.length,domains:t})),allBatchesProvided:!0};await x({sessionId:a,level:"info",step:"summarize",message:`已生成域名汇总: ${$.totalDomains} 个，批次数 ${$.totalBatches}（每批 ${$.batchSize} 个），历史优先 Top ${m}`});const L=await n.loadConfig(),j=L.aiConfig.apiKeys[L.aiConfig.provider];if(!j)throw await x({sessionId:a,level:"error",step:"config",message:"未配置 AI API Key"}),new Error("未配置 AI API Key");await x({sessionId:a,level:"info",step:"ai_call",message:`准备调用 AI: ${L.aiConfig.provider}/${L.aiConfig.model}`});const W=(i||d).split("{{rules}}").join(r||"(无)").split("{{domainSummariesJson}}").join(JSON.stringify($)).split("{{topLevelCount}}").join(String(g)),U=await o({provider:L.aiConfig.provider,apiKey:j,model:L.aiConfig.model,apiUrl:L.aiConfig.apiUrls?.[L.aiConfig.provider],prompt:W,temperature:.2,maxTokens:2e3});await x({sessionId:a,level:"success",step:"ai_call",message:`AI 调用完成（返回长度 ${String(U.content||"").length}）`});const G=U.content||"",V=B(G),H=Array.isArray(V?.domainMoves)?V.domainMoves:Array.isArray(V?.domain_moves)?V.domain_moves:[],z=D("string"==typeof V?.fallbackPath?V.fallbackPath:"")||"其他/未分类",q=H.map(t=>({domain:"string"==typeof t?.domain?t.domain:"",path:D("string"==typeof t?.path?t.path:"")||z})).filter(t=>t.domain&&t.path);if(0===q.length){const t=G.trim().slice(0,1e3);throw await x({sessionId:a,level:"error",step:"parse",message:"AI 返回结果不可解析或为空（domainMoves 为空）",detail:{rawPreview:t,parsed:V}}),new Error("AI 返回结果不可解析或为空")}await x({sessionId:a,level:"success",step:"parse",message:`已解析 AI 规划: domainMoves=${q.length}，fallbackPath=${z}`});const Y=new Map;for(const o of q)Y.set(o.domain,o.path);await async function(t,e){const a=await chrome.bookmarks.getChildren(t);let o=0;for(const n of a)(n.url||"NewTab Home"!==n.title)&&(await chrome.bookmarks.removeTree(n.id),o+=1);return await x({sessionId:e,level:"info",step:"cleanup",message:`已清空工作区：移除旧目录/书签 ${o} 个`}),o}(A,a);const{folderCache:X,createdFolders:J}=await async function(t,e,a,o,n){const r=new Map;let s=0;const i=new Set;for(const[c]of e.entries()){const t=c||"(no-domain)",e=a.get(t)||o;i.add(e),"(no-domain)"!==t||a.has(t)||i.add(o)}for(const c of i){const e=r.size;await N(t,c,r);const a=r.size;a>e&&(s+=a-e)}return await x({sessionId:n,level:"info",step:"folders",message:`目录准备完成：新建目录 ${s} 个`}),{folderCache:r,createdFolders:s}}(A,P,Y,z,a),Z=await async function(t,e,a,o,n,r){let s=0;for(const i of t){const c=i.domain||"(no-domain)",l=a.get(c)||o,d=await N(e,l,n);await chrome.bookmarks.create({parentId:d,title:i.title||i.url,url:i.url}),s+=1,s%100==0&&await x({sessionId:r,level:"info",step:"copy",message:`复制书签进度：${s}/${t.length}`})}return s}(E,A,Y,z,X,a);return await x({sessionId:a,level:"success",step:"done",message:`整理完成：创建目录 ${J} 个，复制书签 ${Z} 个`}),{success:!0,data:{total:E.length,processed:E.length,truncated:y,moved:0,createdFolders:J,createdBookmarks:Z}}}P().catch(()=>{}),h.preloadContext().catch(()=>{}),chrome.runtime.onInstalled.addListener(async t=>{"install"===t.reason||t.reason,P().catch(()=>{})}),chrome.runtime.onStartup.addListener(()=>{P().catch(()=>{})}),chrome.bookmarks.onRemoved.addListener(t=>{(async function(t){try{const[e,a]=await Promise.all([C(),E()]);if(t&&e&&t===e)return void(await P());if(t&&a&&t===a){const t=await T();t&&await _(t.id)}}catch(e){}})(t).catch(()=>{})}),chrome.bookmarks.onMoved.addListener(t=>{(async function(t){try{const[e,a]=await Promise.all([C(),E()]);if(e&&t===e)return void(await T());if(a&&t===a){const t=await T();t&&await _(t.id)}}catch(e){}})(t).catch(()=>{})}),async function(){const t=()=>{const e=function(){const t=new Date,e=new Date(t);return e.setHours(23,0,0,0),e<=t&&e.setDate(e.getDate()+1),e.getTime()-t.getTime()}();setTimeout(async()=>{await async function(){try{const t=await n.loadConfig();if(!t.preferences.autoSync)return;await f.autoSync(t.preferences.syncInterval)}catch{}}(),t()},e)};t()}().catch(()=>{}),p.syncPendingBookmarks().catch(()=>{}),(async()=>{try{const t=await n.loadConfig();t.bookmarkSite.apiKey&&await c(t.bookmarkSite)}catch{}})(),async function(){const t=async()=>{try{const e=(await chrome.storage.local.get("newtab")).newtab;if(!e?.settings?.autoRefreshPinnedBookmarks)return void setTimeout(t,36e5);const a=function(t){const e=new Date,a=new Date(e);return"morning"===t?a.setHours(8,0,0,0):a.setHours(22,0,0,0),a<=e&&a.setDate(a.getDate()+1),a.getTime()-e.getTime()}(e.settings.pinnedBookmarksRefreshTime||"morning");setTimeout(async()=>{await async function(){try{await chrome.storage.local.remove("tmarks_pinned_bookmarks_cache"),await chrome.runtime.sendMessage({type:"REFRESH_PINNED_BOOKMARKS",payload:{timestamp:Date.now(),source:"scheduled"}}).catch(()=>{})}catch(t){}}(),t()},a)}catch{setTimeout(t,36e5)}};t()}().catch(()=>{}),chrome.runtime.onMessage.addListener((t,e,a)=>(async function(t){const e=String(t?.type??"").trim().toUpperCase();switch(e){case"AI_ORGANIZE_PROGRESS":return{success:!0,data:{}};case"EXTRACT_PAGE_INFO":return async function(t){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.id)throw new Error("No active tab found");const a=e.url||"";if(a.startsWith("chrome://")||a.startsWith("chrome-extension://")||a.startsWith("edge://")||a.startsWith("about:")||!a)return{success:!0,data:{title:e.title||"Untitled",url:a,description:"",content:"",thumbnail:""}};let o=!1;try{await v(e.id,{type:"PING"},1e3),o=!0}catch{}if(!o)try{const t=chrome.runtime.getManifest(),n=t.content_scripts?.[0];if(!n||!n.js||0===n.js.length)return await R(e.id,a);const r=n.js[0];await chrome.scripting.executeScript({target:{tabId:e.id},files:[r]}),await new Promise(t=>setTimeout(t,300));try{await v(e.id,{type:"PING"},1e3),o=!0}catch{return await R(e.id,a)}}catch{return await R(e.id,a)}if(o)try{const o=await v(e.id,t,5e3);return o.success&&o.data?o:await R(e.id,a)}catch{return await R(e.id,a)}return await R(e.id,a)}(t);case"RECOMMEND_TAGS":{const e=t.payload;return{success:!0,data:await h.recommendTags(e)}}case"SAVE_BOOKMARK":{const e=t.payload;return{success:!0,data:await p.saveBookmark(e)}}case"AI_ORGANIZE_NEWTAB_WORKSPACE":try{return await $(t)}catch(a){const e=a instanceof Error?a.message:"Failed to organize",o=(()=>{const t=String(e||"");return t.includes("429")||t.includes("rate_limit_exceeded")?"AI 服务当前拥塞/触发限流（429）。请稍后重试，或切换到其他模型/供应商。":e})();try{const n=t.payload||{},r="string"==typeof n.sessionId&&n.sessionId.trim()?n.sessionId.trim():String(Date.now());await x({sessionId:r,level:"error",step:"fatal",message:o,detail:{rawMessage:e,stack:a instanceof Error?a.stack:void 0}})}catch{}return{success:!1,error:o}}case"SAVE_TO_NEWTAB":return async function(t){const e=t.payload,a=e?.url,o=e?.title||e?.url||"Untitled";if(!a)throw new Error("Missing url");const n=await T();if(!n)throw new Error("NewTab root folder not found");const r=n.id,s=e.parentBookmarkId||r;return{success:!0,data:{id:(await chrome.bookmarks.create({parentId:s,title:o,url:a})).id}}}(t);case"IMPORT_ALL_BOOKMARKS_TO_NEWTAB":return async function(){const t=await T();if(!t)throw new Error("NewTab root folder not found");const e=t.id,a=await O(e);return{success:!0,data:{importFolderId:a.importFolderId,folderTitle:a.folderTitle,counts:a.counts}}}();case"GET_NEWTAB_FOLDER":case"GET_NEWTAB_FOLDERS":return K();case"RECOMMEND_NEWTAB_FOLDER":return async function(t){const e=t.payload,a=e?.url;if(!a)throw new Error("Missing url");const r=await n.loadConfig();if(!1===r.preferences.enableNewtabAI)return{success:!0,data:{suggestedFolders:[]}};const s=Number(r.preferences.newtabFolderRecommendCount??10),i=Math.min(20,Math.max(1,Number.isFinite(s)?s:10)),c=await K();if(!c.success)throw new Error(c.error||"Failed to load folders");const d=c.data,u=d.folders.filter(t=>t.id!==d.rootId).map(t=>t.path).slice(0,200),m=l.split("{{title}}").join(e.title||"").split("{{url}}").join(a).split("{{description}}").join(e.description||"无").split("{{recommendCount}}").join(String(i)).split("{{folderPaths}}").join(u.join("\n")),h=(r.preferences.newtabFolderPrompt||"").trim(),f=r.preferences.enableNewtabFolderPrompt&&h?h.split("{{title}}").join(e.title||"").split("{{url}}").join(a).split("{{description}}").join(e.description||"无").split("{{recommendCount}}").join(String(i)).split("{{folderPaths}}").join(u.join("\n")):m,p=r.aiConfig.apiKeys[r.aiConfig.provider];if(!p)return{success:!0,data:{suggestedFolders:[]}};const w=(await o({provider:r.aiConfig.provider,apiKey:p,model:r.aiConfig.model,apiUrl:r.aiConfig.apiUrls?.[r.aiConfig.provider],prompt:f})).content||"",g=B(w)||{suggestedFolders:[]},y=Array.isArray(g?.suggestedFolders)?g.suggestedFolders:[];0===y.length&&w.trim();const k=new Map(d.folders.map(t=>[t.path,t.id]));return{success:!0,data:{suggestedFolders:y.map(t=>({path:"string"==typeof t?.path?t.path:"",confidence:"number"==typeof t?.confidence?t.confidence:0})).filter(t=>t.path&&k.has(t.path)).slice(0,i).map(t=>({id:k.get(t.path),path:t.path,confidence:t.confidence}))}}}(t);case"SYNC_CACHE":{const t=await f.fullSync();return{success:t.success,data:t,error:t.error}}case"GET_EXISTING_TAGS":return{success:!0,data:await m.getTags()};case"UPDATE_BOOKMARK_TAGS":{const{bookmarkId:e,tags:a}=t.payload;return await m.updateBookmarkTags(e,a),{success:!0,data:{message:"Tags updated successfully"}}}case"UPDATE_BOOKMARK_DESCRIPTION":{const{bookmarkId:e,description:a}=t.payload;return await m.updateBookmarkDescription(e,a),{success:!0,data:{message:"Description updated successfully"}}}case"REFRESH_PINNED_BOOKMARKS":{const e=await chrome.tabs.query({url:chrome.runtime.getURL("src/newtab/index.html")});for(const a of e)a.id&&chrome.tabs.sendMessage(a.id,{type:"REFRESH_PINNED_BOOKMARKS",payload:t.payload}).catch(()=>{});return{success:!0,data:{message:"Pinned bookmarks refresh triggered"}}}case"CREATE_SNAPSHOT":{const{bookmarkId:e,title:a,url:o}=t.payload,[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n||!n.id)throw new Error("No active tab found");const r=chrome.tabs.sendMessage(n.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),s=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),i=await Promise.race([r,s]);if(!i.success)throw new Error(i.error||"Capture failed");const c=i.data,l=c.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));return await m.createSnapshotV2(e,{html_content:c.html,title:a,url:o,images:l}),{success:!0,data:{message:"Snapshot created successfully (V2)",imageCount:l.length}}}case"GET_CONFIG":return{success:!0,data:await n.loadConfig()};default:throw new Error(`Unknown message type: ${e||"(empty)"} (runtimeId=${chrome.runtime.id})`)}}(t).then(t=>a(t)).catch(t=>{a({success:!1,error:t instanceof Error?t.message:"Unknown error"})}),!0)),chrome.action.onClicked.addListener(async()=>{});
