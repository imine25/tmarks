import{b as e}from"./prompts-CKcm-rRX.js";import{b as t,t as r}from"./urls-T86wRnwx.js";class o extends Error{constructor(e,t,r){super(t),this.code=e,this.details=r,this.name="AppError"}}class n{buildPrompt(t,r){const{page:o,context:n,options:s}=t;return r?r.replace(/\{title\}/g,o.title).replace(/\{url\}/g,o.url).replace(/\{description\}/g,o.description||"N/A").replace(/\{content\}/g,o.content?.substring(0,500)||"N/A").replace(/\{existingTags\}/g,n.existingTags.slice(0,100).join(", ")).replace(/\{recentBookmarks\}/g,n.recentBookmarks.slice(0,10).map(e=>`- ${e.title} [${e.tags.join(", ")}]`).join("\n")).replace(/\{maxTags\}/g,s.maxTags.toString()).replace(/\{preferExisting\}/g,s.preferExisting?"prefer":"allow"):e(t)}handleError(e,t){if(e instanceof o)return e;if(e instanceof TypeError||e&&"object"==typeof e&&"name"in e&&"NetworkError"===e.name)return new o("NETWORK_ERROR",`Network error when calling ${t}`,{originalError:e});if(e&&"object"==typeof e&&"status"in e){const r=e;if(401===r.status||403===r.status)return new o("API_KEY_INVALID",`Invalid API key for ${t}`,{status:r.status});if(429===r.status)return new o("RATE_LIMIT_ERROR",`Rate limit exceeded for ${t}`,{status:r.status})}const r=e&&"object"==typeof e&&"message"in e?String(e.message):"Unknown error";return new o("AI_SERVICE_ERROR",`AI service error (${t}): ${r}`,{originalError:e})}parseResponse(e){try{const t=e.match(/\{[\s\S]*\}/),r=t?t[0]:e,o=JSON.parse(r);if(!o.suggestedTags||!Array.isArray(o.suggestedTags))throw new Error("Invalid response format: suggestedTags not found");return{suggestedTags:o.suggestedTags.map(e=>{if(!e||"object"!=typeof e)return{name:"",isNew:!0,confidence:.5};const t=e;return{name:"string"==typeof t.name?t.name:"",isNew:"boolean"!=typeof t.isNew||t.isNew,confidence:"number"==typeof t.confidence?t.confidence:.5}}),reasoning:o.reasoning,translatedTitle:o.translatedTitle,translatedDescription:o.translatedDescription}}catch(t){throw new o("AI_SERVICE_ERROR","Failed to parse AI response",{content:e,error:t})}}}const s="You are an intelligent bookmark tag recommendation assistant. Prefer using existing tags, only suggest new tags when necessary. Response format must be JSON.",a=e=>{if(!e||"object"!=typeof e)return;const t=e,r=t.choices;if(!Array.isArray(r)||0===r.length)return;const o=r[0];if(!o||"object"!=typeof o)return;const n=o.message;if(!n||"object"!=typeof n)return;const s=n,a=s.content;if("string"==typeof a)return a.trim();if(Array.isArray(a)){const e=a.map(e=>{if(!e)return"";if("string"==typeof e)return e;if("object"==typeof e){const t=e;if("string"==typeof t.text)return t.text;if("string"==typeof t.content)return t.content;if("string"==typeof t.value)return t.value;if(t.text&&"object"==typeof t.text){const e=t.text;if("string"==typeof e.value)return e.value}}return""}).filter(Boolean).join("\n").trim();if(e)return e}if("string"==typeof s.text)return s.text.trim();if("string"==typeof t.output_text)return t.output_text.trim();if(t.output&&"object"==typeof t.output){const e=t.output;if("string"==typeof e.text)return e.text.trim()}},i=(e,t)=>{const r=e.trim();if(!r)return t;if(r.includes(t))return r;return`${r.replace(/\/$/,"")}${t.startsWith("/")?t:`/${t}`}`},p=(e,t,r)=>{const{apiKey:o,apiUrl:n,model:a,prompt:p,temperature:l,maxTokens:c}=t;let u=n?.trim()||e;u=u.replace(/\/$/,"");const d=i(u,"/chat/completions"),m={"Content-Type":"application/json"};o&&(m.Authorization=`Bearer ${o}`);const f={model:a,messages:[{role:"system",content:s},{role:"user",content:p}],temperature:"number"==typeof l?l:.7,max_tokens:c??r?.defaultMaxTokens??500};return r?.includeJsonResponseFormat&&(f.response_format={type:"json_object"}),r?.additionalBody&&Object.assign(f,r.additionalBody),{url:d,headers:m,body:f,maxTokens:f.max_tokens}},l={openai:{defaultBaseUrl:t.OPENAI,buildRequest:e=>p(t.OPENAI,e,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:a},claude:{defaultBaseUrl:t.CLAUDE,buildRequest:e=>{const r=e.apiUrl?.trim()||t.CLAUDE,o=i(r,"/messages"),n={"Content-Type":"application/json","x-api-key":e.apiKey,"anthropic-version":"2023-06-01"},a={model:e.model,system:s,max_tokens:e.maxTokens??1024,temperature:"number"==typeof e.temperature?e.temperature:.7,messages:[{role:"user",content:[{type:"text",text:e.prompt}]}]};return{url:o,headers:n,body:a,maxTokens:a.max_tokens}},extractContent:e=>{const t=e?.content;return Array.isArray(t)&&"text"===t[0]?.type&&"string"==typeof t[0]?.text?t[0].text.trim():"string"==typeof e?.output_text?e.output_text.trim():void 0}},deepseek:{defaultBaseUrl:t.DEEPSEEK,buildRequest:e=>p(t.DEEPSEEK,e,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:a},zhipu:{defaultBaseUrl:t.ZHIPU,buildRequest:e=>p(t.ZHIPU,e,{defaultMaxTokens:500}),extractContent:a},modelscope:{defaultBaseUrl:t.MODELSCOPE,buildRequest:e=>p(t.MODELSCOPE,e,{defaultMaxTokens:500,additionalBody:{result_format:"message"}}),extractContent:a},siliconflow:{defaultBaseUrl:t.SILICONFLOW,buildRequest:e=>p(t.SILICONFLOW,e,{defaultMaxTokens:500,additionalBody:{stream:!1}}),extractContent:a},iflow:{defaultBaseUrl:t.IFLOW,buildRequest:e=>p(t.IFLOW,e,{defaultMaxTokens:1e3}),extractContent:a},custom:{defaultBaseUrl:t.OPENAI,buildRequest:e=>p(e.apiUrl?.trim()||t.OPENAI,e,{defaultMaxTokens:500}),extractContent:a}};async function c(e){const t=l[e.provider];if(!t)throw new Error(`Unsupported AI provider: ${e.provider}`);const{url:r,headers:o,body:n}=t.buildRequest(e),s=await fetch(r,{method:"POST",headers:o,body:JSON.stringify(n)});if(!s.ok){let e;try{e=await s.text()}catch(p){e=p.message||"Unknown error"}throw new Error(`AI API 请求失败 (${s.status}): ${e.substring(0,200)}`)}const a=await s.json(),i=t.extractContent(a);if(!i)throw new Error(`AI 响应格式错误: ${JSON.stringify(a).substring(0,200)}`);return{content:i,raw:a}}class u extends n{name="openai";models=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];async generateTags(e,t,r="gpt-4o",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"openai",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"OpenAI")}}}class d extends n{name="claude";models=["claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229"];async generateTags(e,t,r="claude-3-5-sonnet-20241022",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"claude",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:1024,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"Claude")}}}class m extends n{name="deepseek";models=["deepseek-chat","deepseek-reasoner"];async generateTags(e,t,r="deepseek-chat",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"deepseek",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"DeepSeek")}}}class f extends n{name="zhipu";models=["glm-4-plus","glm-4-flash","glm-4-air","glm-4"];async generateTags(e,t,r="glm-4-flash",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"zhipu",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"ZhipuAI")}}}class g extends n{name="modelscope";models=["qwen-plus","qwen-turbo","qwen-max","qwen2.5-72b-instruct"];async generateTags(e,t,r="qwen-turbo",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"modelscope",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"ModelScope")}}}class h extends n{name="siliconflow";models=["deepseek-ai/DeepSeek-V3","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-72B-Instruct","THUDM/glm-4-9b-chat","meta-llama/Meta-Llama-3.1-8B-Instruct"];async generateTags(e,t,r="Qwen/Qwen2.5-7B-Instruct",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"siliconflow",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"SiliconFlow")}}}class y extends n{name="iflow";models=["TBStars2-200B-A13B","TBStars2-70B-A7B"];async generateTags(e,t,r="TBStars2-200B-A13B",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await c({provider:"iflow",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:1e3,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"iFlow")}}}class w extends n{name="custom";models=["custom-model"];async generateTags(e,t,o="gpt-4o",n,s){try{if(!n)throw new Error(r("error_custom_ai_url_required"));const a=this.buildPrompt(e,s),{content:i}=await c({provider:"custom",apiKey:t,apiUrl:n,model:o,prompt:a,maxTokens:500,temperature:.7});return this.parseResponse(i)}catch(a){throw this.handleError(a,"Custom")}}}const x=new Map([["openai",new u],["claude",new d],["deepseek",new m],["zhipu",new f],["modelscope",new g],["siliconflow",new h],["iflow",new y],["custom",new w]]);function b(e){const t=x.get(e);if(!t)throw new Error(`Unknown AI provider: ${e}`);return t}const E=Object.freeze(Object.defineProperty({__proto__:null,AIProvider:n,ClaudeProvider:d,CustomProvider:w,DeepSeekProvider:m,IFlowProvider:y,ModelScopeProvider:g,OpenAIProvider:u,SiliconFlowProvider:h,ZhipuProvider:f,getAIProvider:b},Symbol.toStringTag,{value:"Module"}));export{o as A,c,b as g,E as i};
