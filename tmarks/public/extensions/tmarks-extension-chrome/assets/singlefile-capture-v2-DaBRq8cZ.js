const F={inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:10485760,timeout:3e4};async function b(n){const t=await n.arrayBuffer(),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(r=>r.toString(16).padStart(2,"0")).join("").substring(0,16)}function A(n,t){const s={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg","image/bmp":"bmp"};if(s[n])return s[n];const o=t.match(/\.([a-z0-9]+)(?:\?|$)/i);return o?o[1].toLowerCase():"jpg"}async function I(n={}){const t={...F,...n},s=Date.now();try{console.log("[SingleFile V2] Starting capture with options:",t);const o=document.cloneNode(!0);console.log("[SingleFile V2] Document cloned");const r=[];if(t.inlineCSS&&(console.log("[SingleFile V2] Inlining CSS..."),await $(o,t.timeout)),t.extractImages){console.log("[SingleFile V2] Extracting images...");const u=await V(o,t.maxImageSize,t.timeout);r.push(...u)}t.inlineFonts&&(console.log("[SingleFile V2] Inlining fonts..."),await v(o,t.timeout)),t.removeScripts&&(console.log("[SingleFile V2] Removing scripts..."),k(o)),t.removeHiddenElements&&(console.log("[SingleFile V2] Removing hidden elements..."),void 0),console.log("[SingleFile V2] Adding metadata..."),E(o);const l=o.documentElement.outerHTML,m=new Blob([l]).size,h=Date.now()-s;console.log(`[SingleFile V2] Capture completed in ${h}ms`),console.log(`[SingleFile V2] HTML size: ${(m/1024).toFixed(1)}KB`),console.log(`[SingleFile V2] Images extracted: ${r.length}`);const S=r.reduce((u,y)=>u+y.blob.size,0);return console.log(`[SingleFile V2] Total image size: ${(S/1024).toFixed(1)}KB`),{html:l,images:r}}catch(o){throw console.error("[SingleFile V2] Capture error:",o),o}}async function V(n,t,s){const o=Date.now(),r=[],l=new Map,m=async e=>{if(!e||e.startsWith("data:"))return null;if(l.has(e))return l.get(e);try{const i=await fetch(e);if(!i.ok)return null;const c=await i.blob(),a=await b(c),g=A(c.type,e),f=`${a}.${g}`;return r.push({originalUrl:e,blob:c,hash:f,element:null}),l.set(e,f),console.log(`[SingleFile V2] Extracted: ${e.substring(0,80)} -> ${f}`),f}catch(i){return console.warn(`[SingleFile V2] Failed to fetch: ${e}`,i),null}},h=Array.from(n.querySelectorAll("img[src]"));console.log(`[SingleFile V2] Found ${h.length} <img src> elements`);for(const e of h){if(Date.now()-o>s)break;const i=e.src,c=await m(i);c&&(e.src=`/api/snapshot-images/${c}`,e.setAttribute("data-original-src",i))}const S=Array.from(n.querySelectorAll("img[srcset]"));console.log(`[SingleFile V2] Found ${S.length} <img srcset> elements`);for(const e of S){if(Date.now()-o>s)break;const i=e.srcset;if(!i)continue;const c=i.split(",").map(g=>g.trim()),a=[];for(const g of c){const[f,d]=g.split(/\s+/),p=await m(f);p?a.push(`/api/snapshot-images/${p} ${d||""}`.trim()):a.push(g)}a.length>0&&(e.srcset=a.join(", "))}const u=Array.from(n.querySelectorAll("picture source[srcset]"));console.log(`[SingleFile V2] Found ${u.length} <picture source> elements`);for(const e of u){if(Date.now()-o>s)break;const i=e.srcset;if(!i)continue;const c=i.split(",").map(g=>g.trim()),a=[];for(const g of c){const[f,d]=g.split(/\s+/),p=await m(f);p?a.push(`/api/snapshot-images/${p} ${d||""}`.trim()):a.push(g)}a.length>0&&(e.srcset=a.join(", "))}const y=Array.from(n.querySelectorAll("video[poster]"));console.log(`[SingleFile V2] Found ${y.length} <video poster> elements`);for(const e of y){if(Date.now()-o>s)break;const i=e.poster,c=await m(i);c&&(e.poster=`/api/snapshot-images/${c}`)}const w=Array.from(n.querySelectorAll('[style*="background"]'));console.log(`[SingleFile V2] Found ${w.length} elements with background styles`);for(const e of w){if(Date.now()-o>s)break;const i=e.style.cssText;if(!i)continue;const c=i.matchAll(/url\(['"]?([^'")\s]+)['"]?\)/g);let a=i;for(const g of c){const f=g[1];if(!f.startsWith("data:"))try{const d=new URL(f,document.baseURI).href,p=await m(d);p&&(a=a.replace(g[0],`url(/api/snapshot-images/${p})`))}catch{}}a!==i&&(e.style.cssText=a)}return console.log(`[SingleFile V2] Total images extracted: ${r.length}`),r}async function $(n,t){const s=Array.from(n.querySelectorAll('link[rel="stylesheet"]')),o=Date.now();for(const r of s){if(Date.now()-o>t){console.warn("[SingleFile V2] Stylesheet inlining timeout");break}try{const l=r.href;if(!l||l.startsWith("data:"))continue;const m=await fetch(l);if(!m.ok)continue;const h=await m.text(),S=await x(h,l),u=n.createElement("style");u.setAttribute("data-original-href",l),u.textContent=S,r.replaceWith(u)}catch(l){console.warn("[SingleFile V2] Failed to inline stylesheet",l)}}}async function x(n,t){const s=/url\(['"]?([^'")\s]+)['"]?\)/g,o=Array.from(n.matchAll(s));let r=n;for(const l of o){const m=l[1];if(!m.startsWith("data:"))try{const h=new URL(m,t).href;r=r.replace(l[0],`url(${h})`)}catch{}}return r}async function v(n,t){console.log("[SingleFile V2] Font inlining skipped")}function k(n){Array.from(n.querySelectorAll("script")).forEach(s=>s.remove())}function E(n){const t=n.createElement("meta");t.setAttribute("name","tmarks-snapshot-v2"),t.setAttribute("content",JSON.stringify({capturedAt:new Date().toISOString(),originalUrl:document.location.href,title:document.title,version:2}));const s=n.querySelector("head");s&&s.appendChild(t)}export{I as capturePageV2};
