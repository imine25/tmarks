class c extends Error{constructor(t,e,s,r,a){super(e),this.code=t,this.status=s,this.details=r,this.retryAfter=a,this.name="TMarksAPIError"}isAuthError(){return["MISSING_API_KEY","INVALID_API_KEY","INSUFFICIENT_PERMISSIONS"].includes(this.code)}isRateLimitError(){return this.code==="RATE_LIMIT_EXCEEDED"}isNotFoundError(){return this.code==="NOT_FOUND"}isDuplicateError(){return["DUPLICATE_URL","DUPLICATE_TAG"].includes(this.code)}isServerError(){return this.status>=500}}class o{apiKey;baseUrl;rateLimitInfo=null;constructor(t){this.apiKey=t.apiKey,this.baseUrl=t.baseUrl||"https://tmarks.669696.xyz/api"}getRateLimitInfo(){return this.rateLimitInfo}isNearRateLimit(t=.2){return this.rateLimitInfo?this.rateLimitInfo.remaining/this.rateLimitInfo.limit<t:!1}getRateLimitResetTime(){return this.rateLimitInfo?new Date(this.rateLimitInfo.reset*1e3):null}async request(t,e={}){const s=`${this.baseUrl}${t}`,r={"X-API-Key":this.apiKey,"Content-Type":"application/json",...e.headers};try{const a=await fetch(s,{...e,headers:r});if(this.extractRateLimitInfo(a),a.status===204)return;const i=await a.json();return a.ok||this.handleErrorResponse(a.status,i),i}catch(a){throw a instanceof c?a:a instanceof TypeError?new c("NETWORK_ERROR","Network error: Unable to connect to TMarks API",0,{originalError:a}):new c("UNKNOWN_ERROR",a instanceof Error?a.message:"Unknown error occurred",0,{originalError:a})}}async get(t,e){const s=e?`?${new URLSearchParams(this.cleanParams(e)).toString()}`:"";return this.request(`${t}${s}`,{method:"GET"})}async post(t,e){return this.request(t,{method:"POST",body:e?JSON.stringify(e):void 0})}async patch(t,e){return this.request(t,{method:"PATCH",body:JSON.stringify(e)})}async delete(t,e){return this.request(t,{method:"DELETE",body:e?JSON.stringify(e):void 0})}extractRateLimitInfo(t){const e=t.headers.get("X-RateLimit-Limit"),s=t.headers.get("X-RateLimit-Remaining"),r=t.headers.get("X-RateLimit-Reset");e&&s&&r&&(this.rateLimitInfo={limit:parseInt(e,10),remaining:parseInt(s,10),reset:parseInt(r,10)})}handleErrorResponse(t,e){const{code:s,message:r,details:a,retry_after:i}=e.error;throw new c(s,r,t,a,i)}cleanParams(t){const e={};for(const[s,r]of Object.entries(t))r!=null&&(e[s]=String(r));return e}}class u extends o{async getBookmarks(t){return this.get("/bookmarks",t)}async createBookmark(t){return this.post("/bookmarks",t)}async getBookmark(t){return this.get(`/bookmarks/${t}`)}async updateBookmark(t,e){return this.patch(`/bookmarks/${t}`,e)}async deleteBookmark(t){return this.delete(`/bookmarks/${t}`)}async getAllBookmarks(t){const e=[];let s=null;do{const r=await this.getBookmarks({...t,page_cursor:s||void 0,page_size:t?.page_size||100});e.push(...r.data.bookmarks),s=r.data.meta.next_cursor}while(s);return e}async getBookmarksByTags(t,e){return this.getBookmarks({...e,tags:t.join(",")})}async searchBookmarks(t,e){return this.getBookmarks({...e,keyword:t})}async getPinnedBookmarks(t){return this.getBookmarks({...t,pinned:!0})}async getArchivedBookmarks(t){return this.getBookmarks({...t,archived:!0})}async pinBookmark(t){return this.updateBookmark(t,{is_pinned:!0})}async unpinBookmark(t){return this.updateBookmark(t,{is_pinned:!1})}async archiveBookmark(t){return this.updateBookmark(t,{is_archived:!0})}async unarchiveBookmark(t){return this.updateBookmark(t,{is_archived:!1})}}class h extends o{async getTags(){return this.get("/tags")}async createTag(t){return this.post("/tags",t)}async getTag(t){return this.get(`/tags/${t}`)}async updateTag(t,e){return this.patch(`/tags/${t}`,e)}async deleteTag(t){return this.delete(`/tags/${t}`)}async findTagByName(t){return(await this.getTags()).data.tags.find(r=>r.name.toLowerCase()===t.toLowerCase())||null}async createTagIfNotExists(t){try{return await this.createTag(t)}catch(e){if(e.code==="DUPLICATE_TAG"){const s=await this.findTagByName(t.name);if(s)return{data:{tag:s}}}throw e}}async getTagsByPopularity(){return(await this.getTags()).data.tags.sort((e,s)=>(s.bookmark_count||0)-(e.bookmark_count||0))}async getUnusedTags(){return(await this.getTags()).data.tags.filter(e=>(e.bookmark_count||0)===0)}async deleteUnusedTags(){const t=await this.getUnusedTags();let e=0;for(const s of t)try{await this.deleteTag(s.id),e++}catch(r){console.error(`Failed to delete tag ${s.id}:`,r)}return{deleted:e}}async prepareMergeTags(t,e){const[s,r]=await Promise.all([this.getTag(t),this.getTag(e)]);return{sourceTag:s.data.tag,targetTag:r.data.tag}}}class g extends o{async getMe(){return this.get("/me")}async search(t){return this.get("/search",t)}async quickSearch(t){return this.search({q:t,limit:20})}async getStats(){return(await this.getMe()).data.user.stats}async validateApiKey(){try{return await this.getMe(),!0}catch{return!1}}}class d extends o{async getTabGroups(t){return this.get("/v1/tab-groups",t)}async createTabGroup(t){return this.post("/v1/tab-groups",t)}async getTabGroup(t){return this.get(`/v1/tab-groups/${t}`)}async updateTabGroup(t,e){return this.patch(`/v1/tab-groups/${t}`,e)}async deleteTabGroup(t){return this.delete(`/v1/tab-groups/${t}`)}async getAllTabGroups(t){const e=[];let s=null;do{const r=await this.getTabGroups({...t,page_cursor:s||void 0,page_size:t?.page_size||100});e.push(...r.data.tab_groups),s=r.data.meta.next_cursor}while(s);return e}}class k extends o{async createSnapshot(t,e){return this.post(`/v1/bookmarks/${t}/snapshots`,e)}async getSnapshots(t){return this.get(`/v1/bookmarks/${t}/snapshots`)}async deleteSnapshot(t,e){return this.delete(`/v1/bookmarks/${t}/snapshots/${e}`)}}class m{bookmarks;tags;user;tabGroups;snapshots;constructor(t){this.bookmarks=new u(t),this.tags=new h(t),this.user=new g(t),this.tabGroups=new d(t),this.snapshots=new k(t)}getRateLimitInfo(){return this.bookmarks.getRateLimitInfo()}}function l(n){return new m(n)}export{l as c};
