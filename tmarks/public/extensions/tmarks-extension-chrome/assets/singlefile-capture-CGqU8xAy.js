const F={inlineCSS:!0,inlineImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:5242880,timeout:3e4};async function C(o={}){const e={...F,...o},l=Date.now();try{console.log("[SingleFile] Starting capture with options:",e);const t=document.cloneNode(!0);console.log("[SingleFile] Document cloned"),e.inlineCSS&&(console.log("[SingleFile] Inlining CSS..."),await y(t,e.timeout)),e.inlineImages&&(console.log("[SingleFile] Inlining images..."),await w(t,e.maxImageSize,e.timeout)),e.inlineFonts&&(console.log("[SingleFile] Inlining fonts..."),await p(t,e.timeout)),e.removeScripts&&(console.log("[SingleFile] Removing scripts..."),b(t)),e.removeHiddenElements&&(console.log("[SingleFile] Removing hidden elements..."),$(t)),console.log("[SingleFile] Adding metadata..."),A(t);const i=t.documentElement.outerHTML,r=new Blob([i]).size,n=(i.match(/src="data:/g)||[]).length,c=Date.now()-l;return console.log(`[SingleFile] Capture completed in ${c}ms`),console.log(`[SingleFile] HTML size: ${(r/1024).toFixed(1)}KB`),console.log(`[SingleFile] Data URLs in HTML: ${n}`),i}catch(t){throw console.error("[SingleFile] Capture error:",t),t}}async function y(o,e){const l=Array.from(o.querySelectorAll('link[rel="stylesheet"]')),t=Date.now();for(const r of l){if(Date.now()-t>e){console.warn("[SingleFile] Stylesheet inlining timeout");break}try{const n=r.href;if(!n||n.startsWith("data:"))continue;const c=await fetch(n);if(!c.ok)continue;const g=await c.text(),s=await S(g,n),a=o.createElement("style");a.setAttribute("data-original-href",n),a.textContent=s,r.replaceWith(a),console.log(`[SingleFile] Inlined stylesheet: ${n}`)}catch(n){console.warn(`[SingleFile] Failed to inline stylesheet: ${r.href}`,n)}}const i=Array.from(o.querySelectorAll("style"));for(const r of i)r.textContent&&(r.textContent=await S(r.textContent,document.baseURI))}async function S(o,e){const l=/url\(['"]?([^'")\s]+)['"]?\)/g,t=Array.from(o.matchAll(l));let i=o;for(const r of t){const n=r[1];if(!n.startsWith("data:"))try{const c=new URL(n,e).href,g=await fetch(c);if(g.ok){const s=await g.blob();if(s.size<100*1024){const a=await d(s);i=i.replace(r[0],`url(${a})`);continue}}i=i.replace(r[0],`url(${c})`)}catch(c){console.warn(`[SingleFile] Failed to process CSS URL: ${n}`,c)}}return i}async function w(o,e,l){const t=Array.from(o.querySelectorAll("img[src]")),i=Date.now();let r=0,n=0,c=0;console.log(`[SingleFile] Found ${t.length} images to process`);for(const g of t){if(Date.now()-i>l){console.warn("[SingleFile] Image inlining timeout");break}try{const s=g.src;if(!s){n++;continue}if(s.startsWith("data:")){c++;continue}console.log(`[SingleFile] Processing image: ${s.substring(0,100)}...`);const a=await fetch(s);if(!a.ok){console.warn(`[SingleFile] Failed to fetch image (${a.status}): ${s}`),n++;continue}const m=await a.blob();if(console.log(`[SingleFile] Image fetched: ${m.type}, ${(m.size/1024).toFixed(1)}KB`),m.size>e){console.warn(`[SingleFile] Image too large (${(m.size/1024).toFixed(1)}KB), skipping: ${s}`),n++;continue}const u=await d(m),f=u.length;console.log(`[SingleFile] Image converted to base64: ${(f/1024).toFixed(1)}KB, starts with: ${u.substring(0,50)}...`),g.src=u,g.setAttribute("data-original-src",s),r++,console.log(`[SingleFile] Image inlined successfully: ${s.substring(0,100)}`)}catch(s){console.warn(`[SingleFile] Failed to inline image: ${g.src}`,s),n++}}console.log(`[SingleFile] Images summary: ${r} inlined, ${c} already inline, ${n} skipped, total: ${t.length}`)}async function p(o,e){const l=Array.from(o.querySelectorAll("style")),t=Date.now();for(const i of l){if(Date.now()-t>e){console.warn("[SingleFile] Font inlining timeout");break}if(!i.textContent)continue;const r=/@font-face\s*{[^}]*}/g,n=Array.from(i.textContent.matchAll(r));for(const c of n){const s=c[0].match(/url\(['"]?([^'")\s]+)['"]?\)/);if(s&&s[1]){const a=s[1];if(a.startsWith("data:"))continue;try{const m=new URL(a,document.baseURI).href,u=await fetch(m);if(!u.ok)continue;const f=await u.blob(),h=await d(f);i.textContent=i.textContent.replace(a,h),console.log(`[SingleFile] Inlined font: ${a}`)}catch(m){console.warn(`[SingleFile] Failed to inline font: ${a}`,m)}}}}}function b(o){const e=Array.from(o.querySelectorAll("script"));e.forEach(l=>l.remove()),console.log(`[SingleFile] Removed ${e.length} scripts`)}function $(o){const e=Array.from(o.querySelectorAll("*"));let l=0;for(const t of e){const i=window.getComputedStyle(t);(i.display==="none"||i.visibility==="hidden")&&(t.remove(),l++)}console.log(`[SingleFile] Removed ${l} hidden elements`)}function A(o){const e=o.createElement("meta");e.setAttribute("name","tmarks-snapshot"),e.setAttribute("content",JSON.stringify({capturedAt:new Date().toISOString(),originalUrl:document.location.href,title:document.title,userAgent:navigator.userAgent}));const l=o.querySelector("head");l&&l.appendChild(e)}function d(o){return new Promise((e,l)=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.onerror=l,t.readAsDataURL(o)})}export{C as capturePage};
