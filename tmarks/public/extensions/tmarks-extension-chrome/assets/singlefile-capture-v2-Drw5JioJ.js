const S={inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:10485760,timeout:3e4};async function p(n){const e=await n.arrayBuffer(),i=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join("").substring(0,16)}function d(n,e){const i={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg","image/bmp":"bmp"};if(i[n])return i[n];const t=e.match(/\.([a-z0-9]+)(?:\?|$)/i);return t?t[1].toLowerCase():"jpg"}async function $(n={}){const e={...S,...n},i=Date.now();try{console.log("[SingleFile V2] Starting capture with options:",e);const t=document.cloneNode(!0);console.log("[SingleFile V2] Document cloned");const l=[];if(e.inlineCSS&&(console.log("[SingleFile V2] Inlining CSS..."),await w(t,e.timeout)),e.extractImages){console.log("[SingleFile V2] Extracting images...");const c=await F(t,e.maxImageSize,e.timeout);l.push(...c)}e.inlineFonts&&(console.log("[SingleFile V2] Inlining fonts..."),await V(t,e.timeout)),e.removeScripts&&(console.log("[SingleFile V2] Removing scripts..."),x(t)),e.removeHiddenElements&&(console.log("[SingleFile V2] Removing hidden elements..."),void 0),console.log("[SingleFile V2] Adding metadata..."),b(t);const s=t.documentElement.outerHTML,r=new Blob([s]).size,a=Date.now()-i;console.log(`[SingleFile V2] Capture completed in ${a}ms`),console.log(`[SingleFile V2] HTML size: ${(r/1024).toFixed(1)}KB`),console.log(`[SingleFile V2] Images extracted: ${l.length}`);const o=l.reduce((c,g)=>c+g.blob.size,0);return console.log(`[SingleFile V2] Total image size: ${(o/1024).toFixed(1)}KB`),{html:s,images:l}}catch(t){throw console.error("[SingleFile V2] Capture error:",t),t}}async function F(n,e,i){const t=Array.from(n.querySelectorAll("img[src]")),l=Date.now(),s=[],r=new Map;console.log(`[SingleFile V2] Found ${t.length} images to extract`);for(const a of t){if(Date.now()-l>i){console.warn("[SingleFile V2] Image extraction timeout");break}try{const o=a.src;if(!o)continue;if(o.startsWith("data:")){console.log("[SingleFile V2] Skipping data URL");continue}if(r.has(o)){const u=r.get(o);a.src=`/api/snapshot-images/${u}`,console.log(`[SingleFile V2] Reusing cached image: ${u}`);continue}console.log(`[SingleFile V2] Fetching image: ${o.substring(0,100)}...`);const c=await fetch(o);if(!c.ok){console.warn(`[SingleFile V2] Failed to fetch (${c.status}): ${o}`);continue}const g=await c.blob();if(console.log(`[SingleFile V2] Image fetched: ${g.type}, ${(g.size/1024).toFixed(1)}KB`),g.size>e){console.warn(`[SingleFile V2] Image too large (${(g.size/1024).toFixed(1)}KB), skipping`);continue}const f=await p(g),h=d(g.type,o),m=`${f}.${h}`;console.log(`[SingleFile V2] Image hash: ${m}`),a.src=`/api/snapshot-images/${m}`,a.setAttribute("data-original-src",o),s.push({originalUrl:o,blob:g,hash:m,element:a}),r.set(o,m),console.log(`[SingleFile V2] Image extracted: ${o.substring(0,100)}`)}catch(o){console.warn(`[SingleFile V2] Failed to extract image: ${a.src}`,o)}}return console.log(`[SingleFile V2] Images extracted: ${s.length}`),s}async function w(n,e){const i=Array.from(n.querySelectorAll('link[rel="stylesheet"]')),t=Date.now();for(const l of i){if(Date.now()-t>e){console.warn("[SingleFile V2] Stylesheet inlining timeout");break}try{const s=l.href;if(!s||s.startsWith("data:"))continue;const r=await fetch(s);if(!r.ok)continue;const a=await r.text(),o=await y(a,s),c=n.createElement("style");c.setAttribute("data-original-href",s),c.textContent=o,l.replaceWith(c)}catch(s){console.warn("[SingleFile V2] Failed to inline stylesheet",s)}}}async function y(n,e){const i=/url\(['"]?([^'")\s]+)['"]?\)/g,t=Array.from(n.matchAll(i));let l=n;for(const s of t){const r=s[1];if(!r.startsWith("data:"))try{const a=new URL(r,e).href;l=l.replace(s[0],`url(${a})`)}catch{}}return l}async function V(n,e){console.log("[SingleFile V2] Font inlining skipped")}function x(n){Array.from(n.querySelectorAll("script")).forEach(i=>i.remove())}function b(n){const e=n.createElement("meta");e.setAttribute("name","tmarks-snapshot-v2"),e.setAttribute("content",JSON.stringify({capturedAt:new Date().toISOString(),originalUrl:document.location.href,title:document.title,version:2}));const i=n.querySelector("head");i&&i.appendChild(e)}export{$ as capturePageV2};
