const y={inlineCSS:!0,inlineImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:5242880,timeout:3e4};async function x(n={}){const e={...y,...n},o=Date.now();try{const t=document.cloneNode(!0);e.inlineCSS&&await w(t,e.timeout),e.inlineImages&&await p(t,e.maxImageSize,e.timeout),e.inlineFonts&&await b(t,e.timeout),e.removeScripts&&F(t),e.removeHiddenElements&&A(t),C(t);const i=Date.now()-o;return console.log(`[SingleFile] Capture completed in ${i}ms`),t.documentElement.outerHTML}catch(t){throw console.error("[SingleFile] Capture error:",t),t}}async function w(n,e){const o=Array.from(n.querySelectorAll('link[rel="stylesheet"]')),t=Date.now();for(const s of o){if(Date.now()-t>e){console.warn("[SingleFile] Stylesheet inlining timeout");break}try{const r=s.href;if(!r||r.startsWith("data:"))continue;const a=await fetch(r);if(!a.ok)continue;const c=await a.text(),f=await g(c,r),l=n.createElement("style");l.setAttribute("data-original-href",r),l.textContent=f,s.replaceWith(l),console.log(`[SingleFile] Inlined stylesheet: ${r}`)}catch(r){console.warn(`[SingleFile] Failed to inline stylesheet: ${s.href}`,r)}}const i=Array.from(n.querySelectorAll("style"));for(const s of i)s.textContent&&(s.textContent=await g(s.textContent,document.baseURI))}async function g(n,e){const o=/url\(['"]?([^'")\s]+)['"]?\)/g,t=Array.from(n.matchAll(o));let i=n;for(const s of t){const r=s[1];if(!r.startsWith("data:"))try{const a=new URL(r,e).href,c=await fetch(a);if(c.ok){const f=await c.blob();if(f.size<100*1024){const l=await u(f);i=i.replace(s[0],`url(${l})`);continue}}i=i.replace(s[0],`url(${a})`)}catch(a){console.warn(`[SingleFile] Failed to process CSS URL: ${r}`,a)}}return i}async function p(n,e,o){const t=Array.from(n.querySelectorAll("img[src]")),i=Date.now();let s=0,r=0;for(const a of t){if(Date.now()-i>o){console.warn("[SingleFile] Image inlining timeout");break}try{const c=a.src;if(!c||c.startsWith("data:"))continue;const f=await fetch(c);if(!f.ok)continue;const l=await f.blob();if(l.size>e){console.warn(`[SingleFile] Image too large (${(l.size/1024).toFixed(1)}KB), skipping: ${c}`),r++;continue}const m=await u(l);a.src=m,a.setAttribute("data-original-src",c),s++}catch(c){console.warn(`[SingleFile] Failed to inline image: ${a.src}`,c),r++}}console.log(`[SingleFile] Images: ${s} inlined, ${r} skipped`)}async function b(n,e){const o=Array.from(n.querySelectorAll("style")),t=Date.now();for(const i of o){if(Date.now()-t>e){console.warn("[SingleFile] Font inlining timeout");break}if(!i.textContent)continue;const s=/@font-face\s*{[^}]*}/g,r=Array.from(i.textContent.matchAll(s));for(const a of r){const f=a[0].match(/url\(['"]?([^'")\s]+)['"]?\)/);if(f&&f[1]){const l=f[1];if(l.startsWith("data:"))continue;try{const m=new URL(l,document.baseURI).href,d=await fetch(m);if(!d.ok)continue;const S=await d.blob(),h=await u(S);i.textContent=i.textContent.replace(l,h),console.log(`[SingleFile] Inlined font: ${l}`)}catch(m){console.warn(`[SingleFile] Failed to inline font: ${l}`,m)}}}}}function F(n){const e=Array.from(n.querySelectorAll("script"));e.forEach(o=>o.remove()),console.log(`[SingleFile] Removed ${e.length} scripts`)}function A(n){const e=Array.from(n.querySelectorAll("*"));let o=0;for(const t of e){const i=window.getComputedStyle(t);(i.display==="none"||i.visibility==="hidden")&&(t.remove(),o++)}console.log(`[SingleFile] Removed ${o} hidden elements`)}function C(n){const e=n.createElement("meta");e.setAttribute("name","tmarks-snapshot"),e.setAttribute("content",JSON.stringify({capturedAt:new Date().toISOString(),originalUrl:document.location.href,title:document.title,userAgent:navigator.userAgent}));const o=n.querySelector("head");o&&o.appendChild(e)}function u(n){return new Promise((e,o)=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.onerror=o,t.readAsDataURL(n)})}export{x as capturePage};
