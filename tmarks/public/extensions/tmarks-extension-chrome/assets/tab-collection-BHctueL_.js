import{d as t}from"./index-NQ3jknxk.js";import{c as e}from"./index-3rMDm5L8.js";import{t as r,n as a,E as i}from"./urls-T86wRnwx.js";async function o(){return new Promise(t=>{chrome.tabs.query({currentWindow:!0},e=>{t(e)})})}async function s(t){return new Promise(e=>{chrome.tabs.remove(t,()=>{e()})})}function n(t){if(!t||"string"!=typeof t)return"";try{const e=new URL(t);return`${i.GOOGLE_FAVICON}?domain=${e.hostname}&sz=32`}catch(e){return""}}async function c(i,s,c){try{let d=(await o()).filter(t=>t.url&&!t.url.startsWith("chrome://")&&!t.url.startsWith("chrome-extension://"));if(s&&s.size>0&&(d=d.filter(t=>t.id&&s.has(t.id))),0===d.length)return{success:!1,error:r("error_no_tabs_to_collect")};const _=d.map(t=>({title:t.title||"Untitled",url:t.url,favicon:n(t.url)}));try{const o=e({baseUrl:a(i.apiUrl),apiKey:i.apiKey}),s=c?.mode||"new";if("existing"===s&&c?.targetId)return await o.tabGroups.addItemsToGroup(c.targetId,{items:_}),{success:!0,groupId:c.targetId,message:r("msg_tabs_added_to_group",String(d.length))};{const e={title:c?.title,parent_id:"folder"===s?c?.targetId:null,items:_},a=await u(e),i=await o.tabGroups.createTabGroup(e);await t.tabGroups.update(a,{remoteId:i.data.tab_group.id});const n="folder"===s?r("msg_to_folder"):"";return{success:!0,groupId:i.data.tab_group.id,message:r("msg_tabs_collected",[String(d.length),n])}}}catch(l){const t=c?.mode||"new",e=l?.code||"",a=l?.status||0,i=l?.message||"",o="INVALID_API_KEY"===e||"MISSING_API_KEY"===e||"INSUFFICIENT_PERMISSIONS"===e||401===a||403===a||i.includes("auth")||i.includes("API Key");if(("NETWORK_ERROR"===e||0===a)&&!o&&(i.includes("Network")||i.includes("network")||i.includes("connect"))&&"existing"!==t){const e={title:c?.title,parent_id:"folder"===t?c?.targetId:null,items:_};return{success:!0,groupId:(await u(e)).toString(),offline:!0,message:r("msg_tabs_offline_saved",String(d.length))}}let s;return s=401===a||"INVALID_API_KEY"===e||"MISSING_API_KEY"===e?r("error_auth_failed"):403===a||"INSUFFICIENT_PERMISSIONS"===e?r("error_permission_denied"):429===a||"RATE_LIMIT_EXCEEDED"===e?r("error_rate_limit"):a>=500?r("error_server_error"):i||r("error_save_collection_failed"),{success:!1,error:s}}}catch(l){return{success:!1,error:l instanceof Error?l.message:r("error_collect_tabs_failed")}}}async function u(e){const r=Date.now(),a=e.title||(new Date).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(/\//g,"-"),i=await t.tabGroups.add({title:a,createdAt:r}),o=e.items.map((t,e)=>({groupId:i,title:t.title,url:t.url,favicon:t.favicon,position:e,createdAt:r}));return await t.tabGroupItems.bulkAdd(o),i}async function l(r){try{const o=await t.tabGroups.filter(t=>!t.remoteId).toArray();if(0===o.length)return 0;const s=e({baseUrl:a(r.apiUrl),apiKey:r.apiKey});let n=0;for(const e of o)try{const r=await t.tabGroupItems.where("groupId").equals(e.id).sortBy("position");if(0===r.length)continue;const a=await s.tabGroups.createTabGroup({title:e.title,items:r.map(t=>({title:t.title,url:t.url,favicon:t.favicon}))});await t.tabGroups.update(e.id,{remoteId:a.data.tab_group.id}),n++}catch(i){}return n}catch(i){return 0}}export{s as a,c,o as g,l as s};
