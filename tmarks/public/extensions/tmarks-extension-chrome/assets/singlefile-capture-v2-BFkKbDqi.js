const F={inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:10485760,timeout:3e4};async function A(n){const t=await n.arrayBuffer(),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(l=>l.toString(16).padStart(2,"0")).join("").substring(0,16)}async function I(n={}){const t={...F,...n},r=Date.now();try{console.log("[SingleFile V2] Starting capture with options:",t);const o=document.cloneNode(!0);console.log("[SingleFile V2] Document cloned");const l=[];if(t.inlineCSS&&(console.log("[SingleFile V2] Inlining CSS..."),await V(o,t.timeout)),t.extractImages){console.log("[SingleFile V2] Extracting images...");const f=await b(o,t.maxImageSize,t.timeout);l.push(...f)}t.inlineFonts&&(console.log("[SingleFile V2] Inlining fonts..."),await x(o,t.timeout)),t.removeScripts&&(console.log("[SingleFile V2] Removing scripts..."),k(o)),t.removeHiddenElements&&(console.log("[SingleFile V2] Removing hidden elements..."),void 0),console.log("[SingleFile V2] Adding metadata..."),v(o);const a=o.documentElement.outerHTML,g=new Blob([a]).size,u=Date.now()-r;console.log(`[SingleFile V2] Capture completed in ${u}ms`),console.log(`[SingleFile V2] HTML size: ${(g/1024).toFixed(1)}KB`),console.log(`[SingleFile V2] Images extracted: ${l.length}`);const p=l.reduce((f,y)=>f+y.blob.size,0);return console.log(`[SingleFile V2] Total image size: ${(p/1024).toFixed(1)}KB`),{html:a,images:l}}catch(o){throw console.error("[SingleFile V2] Capture error:",o),o}}async function b(n,t,r){const o=Date.now(),l=[],a=new Map,g=async e=>{if(!e||e.startsWith("data:"))return null;if(a.has(e))return a.get(e);try{const s=await fetch(e);if(!s.ok)return null;const c=await s.blob(),i=await A(c);return l.push({originalUrl:e,blob:c,hash:i,element:null}),a.set(e,i),console.log(`[SingleFile V2] Extracted: ${e.substring(0,80)} -> ${i}`),i}catch(s){return console.warn(`[SingleFile V2] Failed to fetch: ${e}`,s),null}},u=Array.from(n.querySelectorAll("img[src]"));console.log(`[SingleFile V2] Found ${u.length} <img src> elements`);for(const e of u){if(Date.now()-o>r)break;const s=e.src,c=await g(s);c&&(e.src=`/api/snapshot-images/${c}`,e.setAttribute("data-original-src",s))}const p=Array.from(n.querySelectorAll("img[srcset]"));console.log(`[SingleFile V2] Found ${p.length} <img srcset> elements`);for(const e of p){if(Date.now()-o>r)break;const s=e.srcset;if(!s)continue;const c=s.split(",").map(m=>m.trim()),i=[];for(const m of c){const[S,d]=m.split(/\s+/),h=await g(S);h?i.push(`/api/snapshot-images/${h} ${d||""}`.trim()):i.push(m)}i.length>0&&(e.srcset=i.join(", "))}const f=Array.from(n.querySelectorAll("picture source[srcset]"));console.log(`[SingleFile V2] Found ${f.length} <picture source> elements`);for(const e of f){if(Date.now()-o>r)break;const s=e.srcset;if(!s)continue;const c=s.split(",").map(m=>m.trim()),i=[];for(const m of c){const[S,d]=m.split(/\s+/),h=await g(S);h?i.push(`/api/snapshot-images/${h} ${d||""}`.trim()):i.push(m)}i.length>0&&(e.srcset=i.join(", "))}const y=Array.from(n.querySelectorAll("video[poster]"));console.log(`[SingleFile V2] Found ${y.length} <video poster> elements`);for(const e of y){if(Date.now()-o>r)break;const s=e.poster,c=await g(s);c&&(e.poster=`/api/snapshot-images/${c}`)}const w=Array.from(n.querySelectorAll('[style*="background"]'));console.log(`[SingleFile V2] Found ${w.length} elements with background styles`);for(const e of w){if(Date.now()-o>r)break;const s=e.style.cssText;if(!s)continue;const c=s.matchAll(/url\(['"]?([^'")\s]+)['"]?\)/g);let i=s;for(const m of c){const S=m[1];if(!S.startsWith("data:"))try{const d=new URL(S,document.baseURI).href,h=await g(d);h&&(i=i.replace(m[0],`url(/api/snapshot-images/${h})`))}catch{}}i!==s&&(e.style.cssText=i)}return console.log(`[SingleFile V2] Total images extracted: ${l.length}`),l}async function V(n,t){const r=Array.from(n.querySelectorAll('link[rel="stylesheet"]')),o=Date.now();for(const l of r){if(Date.now()-o>t){console.warn("[SingleFile V2] Stylesheet inlining timeout");break}try{const a=l.href;if(!a||a.startsWith("data:"))continue;const g=await fetch(a);if(!g.ok)continue;const u=await g.text(),p=await $(u,a),f=n.createElement("style");f.setAttribute("data-original-href",a),f.textContent=p,l.replaceWith(f)}catch(a){console.warn("[SingleFile V2] Failed to inline stylesheet",a)}}}async function $(n,t){const r=/url\(['"]?([^'")\s]+)['"]?\)/g,o=Array.from(n.matchAll(r));let l=n;for(const a of o){const g=a[1];if(!g.startsWith("data:"))try{const u=new URL(g,t).href;l=l.replace(a[0],`url(${u})`)}catch{}}return l}async function x(n,t){console.log("[SingleFile V2] Font inlining skipped")}function k(n){Array.from(n.querySelectorAll("script")).forEach(r=>r.remove())}function v(n){const t=n.createElement("meta");t.setAttribute("name","tmarks-snapshot-v2"),t.setAttribute("content",JSON.stringify({capturedAt:new Date().toISOString(),originalUrl:document.location.href,title:document.title,version:2}));const r=n.querySelector("head");r&&r.appendChild(t)}export{I as capturePageV2};
