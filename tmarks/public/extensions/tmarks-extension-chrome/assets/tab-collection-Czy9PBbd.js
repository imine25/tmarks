import{d as t}from"./index-CQ_a-bOA.js";import{c as e}from"./index-CLpTKzGv.js";import{n as r,E as a}from"./urls-CEh1Kean.js";async function i(){return new Promise(t=>{chrome.tabs.query({currentWindow:!0},e=>{t(e)})})}async function s(t){return new Promise(e=>{chrome.tabs.remove(t,()=>{e()})})}function n(t){if(!t||"string"!=typeof t)return"";try{const e=new URL(t);return`${a.GOOGLE_FAVICON}?domain=${e.hostname}&sz=32`}catch(e){return""}}async function o(a,s){try{let c=(await i()).filter(t=>t.url&&!t.url.startsWith("chrome://")&&!t.url.startsWith("chrome-extension://"));if(s&&s.size>0&&(c=c.filter(t=>t.id&&s.has(t.id))),0===c.length)return{success:!1,error:"当前窗口没有可收纳的标签页"};const u={items:c.map(t=>({title:t.title||"Untitled",url:t.url,favicon:n(t.url)}))},l=await async function(e){const r=Date.now(),a=e.title||(new Date).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(/\//g,"-"),i=await t.tabGroups.add({title:a,createdAt:r}),s=e.items.map((t,e)=>({groupId:i,title:t.title,url:t.url,favicon:t.favicon,position:e,createdAt:r}));return await t.tabGroupItems.bulkAdd(s),i}(u);try{const i=e({baseUrl:r(a.apiUrl),apiKey:a.apiKey}),s=await i.tabGroups.createTabGroup(u);return await t.tabGroups.update(l,{remoteId:s.data.tab_group.id}),{success:!0,groupId:s.data.tab_group.id,message:`成功收纳 ${c.length} 个标签页`}}catch(o){const t=o?.code||"",e=o?.status||0,r=o?.message||"",a="INVALID_API_KEY"===t||"MISSING_API_KEY"===t||"INSUFFICIENT_PERMISSIONS"===t||401===e||403===e||r.includes("认证")||r.includes("API Key");if(("NETWORK_ERROR"===t||0===e)&&!a&&(r.includes("Network")||r.includes("网络")||r.includes("connect")))return{success:!0,groupId:l.toString(),offline:!0,message:`网络不可用，已离线保存 ${c.length} 个标签页，将在网络恢复后自动同步`};let i;return i=401===e||"INVALID_API_KEY"===t||"MISSING_API_KEY"===t?"认证失败：API Key 无效或已过期，请在设置中检查您的 TMarks API Key":403===e||"INSUFFICIENT_PERMISSIONS"===t?"权限不足：您的 API Key 没有保存收纳的权限":429===e||"RATE_LIMIT_EXCEEDED"===t?"请求过于频繁，请稍后再试":e>=500?"TMarks 服务器错误，请稍后再试":r||"保存收纳失败",{success:!1,error:i}}}catch(o){return{success:!1,error:o instanceof Error?o.message:"收纳标签页失败"}}}async function c(a){try{const s=await t.tabGroups.filter(t=>!t.remoteId).toArray();if(0===s.length)return 0;const n=e({baseUrl:r(a.apiUrl),apiKey:a.apiKey});let o=0;for(const e of s)try{const r=await t.tabGroupItems.where("groupId").equals(e.id).sortBy("position");if(0===r.length)continue;const a=await n.tabGroups.createTabGroup({title:e.title,items:r.map(t=>({title:t.title,url:t.url,favicon:t.favicon}))});await t.tabGroups.update(e.id,{remoteId:a.data.tab_group.id}),o++}catch(i){}return o}catch(i){return 0}}export{s as a,o as c,i as g,c as s};
