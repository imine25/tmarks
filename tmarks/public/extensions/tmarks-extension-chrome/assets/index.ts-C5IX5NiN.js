import{_ as h}from"./preload-helper-BXl3LOEh.js";class m{extract(){const r=this.getAllThumbnails();return{title:this.getTitle(),url:window.location.href,description:this.getDescription(),content:this.getMainContent(),thumbnail:r[0]||"",thumbnails:r,favicon:this.getFavicon()}}getTitle(){return document.title||this.getMeta("og:title")||document.querySelector("h1")?.textContent?.trim()||"Untitled"}getDescription(){return this.getMeta("description")||this.getMeta("og:description")||this.getMeta("twitter:description")||""}getMainContent(){const r=document.querySelector("article")||document.querySelector("main")||document.querySelector('[role="main"]')||document.body;if(!r)return"";const e=r.cloneNode(!0);return e.querySelectorAll("script, style, nav, header, footer, iframe, noscript").forEach(o=>{o.remove()}),(e.textContent||"").replace(/\s+/g," ").trim().substring(0,1e3)}getFavicon(){const r=(e,t)=>{if(!e||typeof e!="string")return"";try{if(e=e.trim(),!e)return"";const o=new URL(e,t||window.location.href);return o.protocol!=="http:"&&o.protocol!=="https:"?"":o.href}catch{return""}};try{const e=Array.from(document.querySelectorAll('link[rel="apple-touch-icon"]'));if(e.length>0){let t,o=0;for(const n of e)if(n.href){const c=n.getAttribute("sizes");if(c){const a=parseInt(c.split("x")[0]);!isNaN(a)&&a>o&&(o=a,t=n)}else t||(t=n)}if(t&&t.href){const n=r(t.href);if(n)return console.log("[ContentScript] Found apple-touch-icon:",n),n}}}catch(e){console.error("[ContentScript] Error reading apple-touch-icon:",e)}try{const e=Array.from(document.querySelectorAll('link[rel*="icon"]'));if(e.length>0){let t,o=0;for(const n of e)if(n.href){const c=n.getAttribute("type")||"",a=n.getAttribute("sizes"),i=n.href.toLowerCase();if(c.includes("svg")||i.endsWith(".svg")){t=n;break}if(c.includes("png")||i.endsWith(".png"))if(a){const s=parseInt(a.split("x")[0]);!isNaN(s)&&s>o&&(o=s,t=n)}else(!t||o===0)&&(t=n);t||(t=n)}if(t&&t.href){const n=r(t.href);if(n)return console.log("[ContentScript] Found icon:",n),n}}}catch(e){console.error("[ContentScript] Error reading icon:",e)}try{const t=`chrome://favicon/size/64@2x/${window.location.origin}`;return console.log("[ContentScript] Using Chrome favicon API:",t),t}catch(e){console.error("[ContentScript] Error using Chrome favicon API:",e)}try{const e=new URL("/favicon.ico",window.location.origin).href;return console.log("[ContentScript] Fallback to favicon.ico:",e),e}catch(e){console.error("[ContentScript] Error constructing favicon.ico URL:",e)}return""}getAllThumbnails(){const r=[],e=(t,o)=>{if(!t||typeof t!="string")return"";try{if(t=t.trim(),!t)return"";const n=new URL(t,o||window.location.href);return n.protocol!=="http:"&&n.protocol!=="https:"?"":n.href}catch{return""}};try{const t=document.querySelector('meta[property="og:image"]');if(t instanceof HTMLMetaElement&&t.content){const o=e(t.content);o&&!r.includes(o)&&(console.log("[ContentScript] Found og:image:",o),r.push(o))}}catch(t){console.error("[ContentScript] Error reading og:image:",t)}try{const t=document.querySelector('meta[name="twitter:image"]');if(t instanceof HTMLMetaElement&&t.content){const o=e(t.content);o&&!r.includes(o)&&(console.log("[ContentScript] Found twitter:image:",o),r.push(o))}}catch(t){console.error("[ContentScript] Error reading twitter:image:",t)}try{const t=[document.querySelector("main"),document.querySelector('[role="main"]'),document.querySelector("article"),document.body].filter(Boolean),o=[];for(const c of t){if(!c)continue;const a=c.querySelectorAll("img");for(const i of a)try{if(!i.src||i.src.startsWith("data:")||i.src.startsWith("blob:"))continue;let s=i.naturalWidth,u=i.naturalHeight;if(s===0||u===0){const f=i.getAttribute("width"),g=i.getAttribute("height");if(f&&g){const d=parseInt(f),p=parseInt(g);!isNaN(d)&&!isNaN(p)&&(s=d,u=p)}(s===0||u===0)&&(s=i.width||i.offsetWidth||i.clientWidth,u=i.height||i.offsetHeight||i.clientHeight)}if(s>200&&u>200&&s<5e3&&u<5e3){const f=e(i.src);f&&!o.some(g=>g.url===f)&&o.push({url:f,area:s*u})}}catch(s){console.warn("[ContentScript] Error processing image:",s);continue}}o.sort((c,a)=>a.area-c.area);const n=o.slice(0,5);for(const{url:c}of n)r.includes(c)||(console.log("[ContentScript] Found large image:",c),r.push(c))}catch(t){console.error("[ContentScript] Error finding large images:",t)}return console.log("[ContentScript] Total thumbnails found:",r.length),r}getMeta(r){return(document.querySelector(`meta[name="${r}"]`)||document.querySelector(`meta[property="${r}"]`))?.getAttribute("content")||""}}const y=new m;window.__AITMARKS_CONTENT_SCRIPT_LOADED__?console.log("[ContentScript] Already loaded, skipping initialization"):(window.__AITMARKS_CONTENT_SCRIPT_LOADED__=!0,chrome.runtime.onMessage.addListener((l,r,e)=>{if(console.log("[ContentScript] Received message:",l.type),l.type==="PING"){try{e({success:!0,data:"pong"})}catch(t){console.error("[ContentScript] Failed to send PING response:",t)}return!0}return l.type==="EXTRACT_PAGE_INFO"?((async()=>{try{console.log("[ContentScript] Starting page info extraction..."),document.readyState==="loading"&&(console.log("[ContentScript] Document still loading, waiting..."),await new Promise(o=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o,{once:!0}):o(null)}));const t=y.extract();t.url||(console.warn("[ContentScript] Extracted page info missing URL"),t.url=window.location.href),t.title||(console.warn("[ContentScript] Extracted page info missing title"),t.title=document.title||"Untitled"),console.log("[ContentScript] Successfully extracted page info:",{title:t.title,url:t.url,hasDescription:!!t.description,hasThumbnail:!!t.thumbnail,contentLength:t.content?.length||0}),e({success:!0,data:t})}catch(t){console.error("[ContentScript] Failed to extract page info:",t),e({success:!0,data:{title:document.title||"Untitled",url:window.location.href,description:"",content:"",thumbnail:""}})}})(),!0):l.type==="CAPTURE_PAGE"?((async()=>{try{console.log("[ContentScript] Starting SingleFile capture...");const{capturePage:t}=await h(async()=>{const{capturePage:c}=await import("./singlefile-capture-BTS1DLau.js");return{capturePage:c}},[]),o=await t(l.options||{}),n=new Blob([o]).size;console.log(`[ContentScript] Capture successful: ${(n/1024).toFixed(1)}KB`),e({success:!0,html:o,size:n})}catch(t){console.error("[ContentScript] Capture failed:",t),e({success:!1,error:t instanceof Error?t.message:"Unknown error"})}})(),!0):(console.warn("[ContentScript] Unknown message type:",l.type),!1)}),console.log("[AITmarks] Content script loaded successfully"));
