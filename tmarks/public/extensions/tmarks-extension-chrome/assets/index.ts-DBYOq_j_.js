import{d as t}from"./index-CQ_a-bOA.js";import{A as e,g as a}from"./index-DHRMGLhe.js";import{S as s,g as r,P as o}from"./urls-CEh1Kean.js";import{c as n}from"./index-CLpTKzGv.js";import{s as i}from"./tab-collection-Czy9PBbd.js";import"./prompts-CKcm-rRX.js";const c=new class{client=null;async initialize(){const t=await s.getBookmarkSiteApiUrl(),a=await s.getBookmarkSiteApiKey();if(!a)throw new e("API_KEY_INVALID","API Key not found. Please configure your TMarks API key in the extension settings (Options page).");let o;o=t?t.endsWith("/api")?t:r(t).API_BASE:r().API_BASE,this.client=n({apiKey:a,baseUrl:o})}async ensureClient(){if(await this.initialize(),!this.client)throw new e("API_KEY_INVALID","API Key not found. Failed to initialize TMarks client. Please configure your API key in the extension settings.");return this.client}async getTags(){const t=await this.ensureClient();try{return(await t.tags.getTags()).data.tags.map(t=>({name:t.name,color:t.color,count:t.bookmark_count||0,createdAt:new Date(t.created_at).getTime()}))}catch(a){if("MISSING_API_KEY"===a.code)throw new e("API_KEY_INVALID","TMarks API key is required. Please configure your API key in the extension settings.",{originalError:a});throw new e("BOOKMARK_SITE_ERROR",`Failed to fetch tags: ${a.message}`,{originalError:a})}}async getBookmarks(t=1,a=100){const s=await this.ensureClient();try{const e=await s.bookmarks.getBookmarks({page_size:a,page_cursor:t>1?`page_${t}`:void 0});if(!e.data.bookmarks.length)return{bookmarks:[],hasMore:!1};return{bookmarks:e.data.bookmarks.map(t=>({url:t.url,title:t.title,description:t.description||"",tags:t.tags.map(t=>t.name),createdAt:new Date(t.created_at).getTime(),remoteId:t.id,isPublic:t.is_public})),hasMore:e.data.meta.has_more}}catch(r){throw new e("BOOKMARK_SITE_ERROR",`Failed to fetch bookmarks: ${r.message}`,{originalError:r})}}async addBookmark(t){const a=await this.ensureClient(),s={title:t.title,url:t.url,description:t.description,cover_image:t.thumbnail,favicon:t.favicon,tags:t.tags,is_public:t.isPublic??!1};try{const t=await a.bookmarks.createBookmark(s);if(!t.data.bookmark)throw new e("BOOKMARK_SITE_ERROR","Failed to add bookmark: No data returned");const r="BOOKMARK_EXISTS"===t.meta?.code;return r?{id:t.data.bookmark.id,isExisting:r,existingBookmark:t.data.bookmark}:{id:t.data.bookmark.id,isExisting:r}}catch(r){let t;const a=r.code||"",s=r.status||0;t="INVALID_API_KEY"===a||"MISSING_API_KEY"===a||401===s?"认证失败：API Key 无效或已过期，请在设置中检查您的 TMarks API Key":"INSUFFICIENT_PERMISSIONS"===a||403===s?"权限不足：您的 API Key 没有保存书签的权限":"RATE_LIMIT_EXCEEDED"===a||429===s?"请求过于频繁，请稍后再试":"NETWORK_ERROR"===a||0===s?"网络错误：无法连接到 TMarks 服务器，请检查网络连接":s>=500?"TMarks 服务器错误，请稍后再试":r.message||"保存书签失败";const o=new e("BOOKMARK_SITE_ERROR",t,{originalError:r});throw o.code=a,o.status=s,o}}async updateBookmarkTags(t,a){const s=await this.ensureClient();try{await s.bookmarks.updateBookmark(t,{tags:a})}catch(r){throw new e("BOOKMARK_SITE_ERROR",`Failed to update tags: ${r.message}`,{originalError:r})}}async updateBookmarkDescription(t,a){const s=await this.ensureClient();try{await s.bookmarks.updateBookmark(t,{description:a})}catch(r){throw new e("BOOKMARK_SITE_ERROR",`Failed to update description: ${r.message}`,{originalError:r})}}async createSnapshot(t,a){const s=await this.ensureClient();try{await s.snapshots.createSnapshot(t,a)}catch(r){throw new e("BOOKMARK_SITE_ERROR",`Failed to create snapshot: ${r.message}`,{originalError:r})}}async createSnapshotV2(t,a){await this.ensureClient();try{const e=await s.getBookmarkSiteApiKey(),o=await s.getBookmarkSiteApiUrl();let n;n=o?o.endsWith("/api")?o:r(o).API_BASE:r().API_BASE;const i=await fetch(`${n}/tab/bookmarks/${t}/snapshots-v2`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":e},body:JSON.stringify(a)});if(!i.ok){const t=await i.json();throw new Error(t.error?.message||"Failed to create snapshot")}}catch(o){throw new e("BOOKMARK_SITE_ERROR",`Failed to create snapshot (V2): ${o.message}`,{originalError:o})}}async testConnection(){try{const t=await this.ensureClient();return await t.user.getMe(),!0}catch(t){return!1}}};const u=new class{contextCache=null;contextPromise=null;async recommendTags(t){try{const e=s.loadConfig(),a=this.getContext(),r=await e,o=r.aiConfig.apiKeys[r.aiConfig.provider];if(!o)return this.fallbackRecommendation(t);const n=await a,i={page:{title:t.title,url:t.url,description:t.description,content:t.content?.substring(0,500)},context:n,options:{maxTags:r.preferences.maxSuggestedTags||5,preferExisting:!0}},c=r.aiConfig.apiUrls?.[r.aiConfig.provider],u=r.aiConfig.enableCustomPrompt?r.aiConfig.customPrompt:void 0,m=await this.callAIWithRetry(i,o,r.aiConfig.provider,r.aiConfig.model,c,u,1,void 0),l=n.existingTags,d=new Set(l.map(t=>t.trim().toLowerCase())),h=m.suggestedTags.map(t=>{const e=t.name.trim().toLowerCase(),a=d.has(e);return{...t,isNew:!a}});return{tags:this.deduplicateAndSort(h),source:"ai",timestamp:Date.now()}}catch(e){const a=e instanceof Error?e.message:"AI recommendation failed";return this.fallbackRecommendation(t,a)}}async getContext(){if(this.contextCache)return this.contextCache;if(this.contextPromise)return this.contextPromise;this.contextPromise=this.loadContextFromDB();try{const t=await this.contextPromise;return this.contextCache=t,t}finally{this.contextPromise=null}}async callAIWithRetry(t,e,s,r,o,n,i,c){const u=a(s);let m;for(let a=0;a<i;a++)try{if("number"==typeof c&&c>0){const a=new Promise((t,e)=>{setTimeout(()=>e(new Error("AI request timeout")),c)});return await Promise.race([u.generateTags(t,e,r,o,n),a])}return await u.generateTags(t,e,r,o,n)}catch(l){if(m=l,a<i-1){const t=1e3*Math.pow(2,a);await this.delay(t)}}throw m||new Error("AI request failed after retries")}async fallbackRecommendation(e,a){const s=this.extractKeywords(e.title+" "+(e.description||""));return{tags:(await t.tags.toArray()).filter(t=>s.some(e=>t.name.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(t.name.toLowerCase()))).sort((t,e)=>(e.count||0)-(t.count||0)).slice(0,3).map(t=>({name:t.name,isNew:!1,confidence:.6})),source:"fallback",timestamp:Date.now(),message:a||null}}extractKeywords(t){return t.split(/[\s\/\-_、，。！？]+/).map(t=>t.trim()).filter(t=>t.length>1).slice(0,20)}deduplicateAndSort(t){const e=new Set,a=[];for(const s of t){const t=s.name.toLowerCase().trim();e.has(t)||(e.add(t),a.push(s))}return a.sort((t,e)=>e.confidence-t.confidence)}delay(t){return new Promise(e=>setTimeout(e,t))}clearContextCache(){this.contextCache=null}async preloadContext(){if(this.contextPromise)return void(await this.contextPromise);const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}async refreshContextFromDB(){const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}updateContextWithBookmark(t){if(!this.contextCache)return;const e=new Set(this.contextCache.existingTags.map(t=>t.toLowerCase())),a=[];for(const s of t.tags){const t=s.trim();t&&(e.has(t.toLowerCase())||(e.add(t.toLowerCase()),a.push(t)))}a.length>0&&(this.contextCache.existingTags=[...this.contextCache.existingTags,...a].slice(-200)),this.contextCache.recentBookmarks=[{title:t.title,tags:t.tags},...this.contextCache.recentBookmarks].slice(0,20)}async loadContextFromDB(e=!1){if(!e&&this.contextCache)return this.contextCache;const[a,s]=await Promise.all([t.tags.orderBy("count").reverse().limit(200).toArray().then(t=>t.map(t=>t.name)),t.bookmarks.orderBy("createdAt").reverse().limit(20).toArray().then(t=>t.map(t=>({title:t.title,tags:t.tags})))]),r={existingTags:a,recentBookmarks:s};return this.contextCache=r,r}};const m=new class{async fullSync(){const e=Date.now();try{const a=await c.getTags();await t.tags.clear(),await t.tags.bulkAdd(a);let s=1,r=0;for(await t.bookmarks.clear();s<=o.MAX_PAGES;){const{bookmarks:e,hasMore:a}=await c.getBookmarks(s,o.DEFAULT_PAGE_SIZE);if(e.length>0&&(await t.bookmarks.bulkAdd(e),r+=e.length),!a)break;s++}await t.updateLastSyncTime(Date.now()),await t.metadata.put({key:"totalTags",value:a.length,updatedAt:Date.now()}),await t.metadata.put({key:"totalBookmarks",value:r,updatedAt:Date.now()}),await u.refreshContextFromDB();return{success:!0,duration:Date.now()-e,stats:{tags:a.length,bookmarks:r}}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async incrementalSync(){try{await t.getLastSyncTime();return this.fullSync()}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getStats(){return t.getStats()}async isCacheStale(e=24){const a=await t.getLastSyncTime();if(0===a)return!0;const s=60*e*60*1e3;return Date.now()-a>s}async autoSync(t=24){return await this.isCacheStale(t)?this.incrementalSync():null}async clearCache(){await t.clearAll(),u.clearContextCache()}};const l=new class{async saveBookmark(e){let a,s=!1;try{const r=await c.addBookmark(e);if(a=r.id,s=r.isExisting||!1,s&&r.existingBookmark)return{success:!0,existingBookmark:{...r.existingBookmark,needsDialog:!0},message:"书签已存在"};s||(await t.bookmarks.add({url:e.url,title:e.title,description:e.description,tags:e.tags,createdAt:Date.now(),remoteId:r.id,isPublic:e.isPublic??!1}),await this.updateTagCounts(e.tags),u.updateContextWithBookmark({title:e.title,tags:e.tags}))}catch(r){const t=r instanceof Error?r.message:"Unknown error",a=r?.code||"",s=r?.status||0,o="INVALID_API_KEY"===a||"MISSING_API_KEY"===a||"INSUFFICIENT_PERMISSIONS"===a||401===s||403===s||t.includes("认证")||t.includes("API Key");if(("NETWORK_ERROR"===a||0===s)&&!o&&(t.includes("Network")||t.includes("网络")||t.includes("connect")))return await this.queueForLaterSync(e),{success:!0,offline:!0,message:"网络不可用，已暂存到本地，将在网络恢复后自动同步"};throw r}if(e.createSnapshot&&a)try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t&&t.id){let s;try{const e=chrome.tabs.sendMessage(t.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),a=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),r=await Promise.race([e,a]);if(!r.success)throw new Error(r.error||"Capture failed");s=r.data}catch(r){throw r}const o=s.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));await c.createSnapshotV2(a,{html_content:s.html,title:e.title,url:e.url,images:o})}}catch(o){}return{success:!0,bookmarkId:a,message:s?"书签已存在，已为其创建新快照":void 0}}async updateTagCounts(e){for(const a of e){const e=await t.tags.where("name").equals(a).first();e&&e.id?await t.tags.update(e.id,{count:(e.count||0)+1}):await t.tags.add({name:a,count:1,createdAt:Date.now()})}}async queueForLaterSync(e){await t.metadata.add({key:`pending_${Date.now()}`,value:e,updatedAt:Date.now()})}async syncPendingBookmarks(){const e=await t.metadata.where("key").startsWith("pending_").toArray();let a=0;for(const r of e)try{if(r.value&&"object"==typeof r.value&&"url"in r.value&&"title"in r.value){const e=r.value;await c.addBookmark(e),await t.metadata.delete(r.key),a++}}catch(s){}return a}async getPendingCount(){return await t.metadata.where("key").startsWith("pending_").count()}};u.preloadContext().catch(()=>{}),chrome.runtime.onInstalled.addListener(async t=>{"install"===t.reason||t.reason}),async function(){const t=()=>{const e=function(){const t=new Date,e=new Date(t);return e.setHours(23,0,0,0),e<=t&&e.setDate(e.getDate()+1),e.getTime()-t.getTime()}();setTimeout(async()=>{await async function(){try{const t=await s.loadConfig();if(!t.preferences.autoSync)return;await m.autoSync(t.preferences.syncInterval)}catch(t){}}(),t()},e)};t()}().catch(()=>{}),l.syncPendingBookmarks().catch(()=>{}),(async()=>{try{const t=await s.loadConfig();t.bookmarkSite.apiKey&&await i(t.bookmarkSite)}catch(t){}})(),async function(){const t=async()=>{try{const e=(await chrome.storage.local.get("newtab")).newtab;if(!e?.settings?.autoRefreshPinnedBookmarks)return void setTimeout(t,36e5);const a=function(t){const e=new Date,a=new Date(e);return"morning"===t?a.setHours(8,0,0,0):a.setHours(22,0,0,0),a<=e&&a.setDate(a.getDate()+1),a.getTime()-e.getTime()}(e.settings.pinnedBookmarksRefreshTime||"morning");setTimeout(async()=>{await async function(){try{await chrome.storage.local.remove("tmarks_pinned_bookmarks_cache"),await chrome.runtime.sendMessage({type:"REFRESH_PINNED_BOOKMARKS",payload:{timestamp:Date.now(),source:"scheduled"}}).catch(()=>{})}catch(t){}}(),t()},a)}catch(e){setTimeout(t,36e5)}};t()}().catch(()=>{}),chrome.runtime.onMessage.addListener((t,e,a)=>(async function(t){switch(t.type){case"EXTRACT_PAGE_INFO":{const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!s||!s.id)throw new Error("No active tab found");const n=s.url||"";if(n.startsWith("chrome://")||n.startsWith("chrome-extension://")||n.startsWith("edge://")||n.startsWith("about:")||!n)return{success:!0,data:{title:s.title||"Untitled",url:n,description:"",content:"",thumbnail:""}};const i=async(t,e,a=3e3)=>Promise.race([chrome.tabs.sendMessage(t,e),new Promise((t,e)=>setTimeout(()=>e(new Error("Message timeout")),a))]),c=async t=>{try{const e=await chrome.tabs.get(t);return{success:!0,data:{title:e.title||"Untitled",url:e.url||"",description:"",content:"",thumbnail:""}}}catch(e){return{success:!0,data:{title:"Untitled",url:n,description:"",content:"",thumbnail:""}}}};let u=!1;try{await i(s.id,{type:"PING"},1e3),u=!0}catch(e){}if(!u)try{const t=chrome.runtime.getManifest(),e=t.content_scripts?.[0];if(!e||!e.js||0===e.js.length)return await c(s.id);const r=e.js[0];await chrome.scripting.executeScript({target:{tabId:s.id},files:[r]}),await new Promise(t=>setTimeout(t,300));try{await i(s.id,{type:"PING"},1e3),u=!0}catch(a){return await c(s.id)}}catch(r){return await c(s.id)}if(u)try{const e=await i(s.id,t,5e3);return e.success&&e.data?e:await c(s.id)}catch(o){return await c(s.id)}return await c(s.id)}case"RECOMMEND_TAGS":{const e=t.payload;return{success:!0,data:await u.recommendTags(e)}}case"SAVE_BOOKMARK":try{const e=t.payload;return{success:!0,data:await l.saveBookmark(e)}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to save bookmark"}}case"SYNC_CACHE":{const t=await m.fullSync();return{success:t.success,data:t,error:t.error}}case"GET_EXISTING_TAGS":try{return{success:!0,data:await c.getTags()}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to load tags"}}case"UPDATE_BOOKMARK_TAGS":try{const{bookmarkId:e,tags:a}=t.payload;return await c.updateBookmarkTags(e,a),{success:!0,data:{message:"Tags updated successfully"}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to update tags"}}case"UPDATE_BOOKMARK_DESCRIPTION":try{const{bookmarkId:e,description:a}=t.payload;return await c.updateBookmarkDescription(e,a),{success:!0,data:{message:"Description updated successfully"}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to update description"}}case"REFRESH_PINNED_BOOKMARKS":try{const e=await chrome.tabs.query({url:chrome.runtime.getURL("src/newtab/index.html")});for(const a of e)a.id&&chrome.tabs.sendMessage(a.id,{type:"REFRESH_PINNED_BOOKMARKS",payload:t.payload}).catch(()=>{});return{success:!0,data:{message:"Pinned bookmarks refresh triggered"}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to refresh pinned bookmarks"}}case"CREATE_SNAPSHOT":try{const{bookmarkId:e,title:a,url:s}=t.payload,[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r||!r.id)throw new Error("No active tab found");let o;try{const t=chrome.tabs.sendMessage(r.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),e=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),a=await Promise.race([t,e]);if(!a.success)throw new Error(a.error||"Capture failed");o=a.data}catch(n){throw n}const i=o.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));return await c.createSnapshotV2(e,{html_content:o.html,title:a,url:s,images:i}),{success:!0,data:{message:"Snapshot created successfully (V2)",imageCount:i.length}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to create snapshot"}}case"GET_CONFIG":return{success:!0,data:await s.loadConfig()};default:throw new Error(`Unknown message type: ${t.type}`)}}(t).then(t=>a(t)).catch(t=>{a({success:!1,error:t instanceof Error?t.message:"Unknown error"})}),!0)),chrome.action.onClicked.addListener(async()=>{});
