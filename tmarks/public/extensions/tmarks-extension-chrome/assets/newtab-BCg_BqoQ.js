import"./modulepreload-polyfill-YP0FEG5d.js";import{r as e,o as t,k as s,p as r,S as o,B as n,q as a,M as i,t as l,D as c,W as d,E as u,v as h,w as m,x as p,T as g,y as x,z as w,A as f,I as b,P as k,G as v,X as y,H as j,J as I,N as _,O as N,F as S,Q as C,U as B,e as F,V as D,Y as E,C as z,Z as G,_ as T,$ as L,a0 as R,a1 as A,a2 as M,a3 as P,a4 as $,a5 as O,a6 as U,a7 as W,a8 as H,a9 as K,aa as Y,ab as X,ac as q,ad as V,ae as J,af as Q,ag as Z,ah as ee,ai as te,aj as se,ak as re,al as oe,am as ne,an as ae,ao as ie,ap as le,aq as ce,ar as de,as as ue,at as he,au as me,av as pe,n as ge,R as xe}from"./react-vendor-1ZtHTM4k.js";import{S as we,g as fe,t as be,c as ke,d as ve,s as ye,a as je}from"./urls-T86wRnwx.js";import{D as Ie,a as _e,S as Ne,b as Se,F as Ce,H as Be,g as Fe,c as De,U as Ee,G as ze}from"./constants-CAUY5aFy.js";import{_ as Ge}from"./preload-helper-BhLMWRjL.js";import{c as Te}from"./index-3rMDm5L8.js";import{l as Le}from"./vendor-BSnXPJO2.js";import{S as Re,r as Ae,u as Me,s as Pe,h as $e}from"./dnd-kit-BEjcDWqN.js";import{a as Oe}from"./newtabPrompts-Br339DSM.js";import"./dexie-BAhLzSXZ.js";const Ue=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,We=()=>"undefined"!=typeof chrome&&!!chrome.bookmarks;function He(e,t,s){let r=e;const o=new Set,n=[];let a=!1;for(;;){const e=new Map;for(const s of r)s.parentId&&e.set(s.parentId,(e.get(s.parentId)??0)+1);const t=new Set;for(const o of r){if("bookmarkFolder"!==o.type)continue;if(0!==(e.get(o.id)??0))continue;if(!("home"===(o.groupId??"home")&&null===(o.parentId??null))){if(o.browserBookmarkId){if(s.has(o.browserBookmarkId))continue;n.push(o.browserBookmarkId)}t.add(o.id)}}if(0===t.size)break;a=!0,t.forEach(e=>o.add(e)),r=r.filter(e=>!t.has(e.id))}if(!a)return{items:e,currentFolderId:t,changed:!1,removedBrowserBookmarkIds:[]};const i=new Map;r.forEach(e=>{const t=`${e.groupId??"home"}|${e.parentId??"root"}`;i.has(t)||i.set(t,[]),i.get(t).push(e)});const l=new Map;i.forEach(e=>{e.sort((e,t)=>e.position-t.position),e.forEach((e,t)=>{l.set(e.id,t)})});return{items:r.map(e=>{const t=l.get(e.id);return void 0!==t&&t!==e.position?{...e,position:t}:e}),currentFolderId:t&&o.has(t)?null:t,changed:!0,removedBrowserBookmarkIds:n}}let Ke=null;function Ye(e){Ke&&clearTimeout(Ke),Ke=setTimeout(()=>{!async function(e){try{const t=await we.getBookmarkSiteApiUrl(),s=await we.getBookmarkSiteApiKey();if(!s)return;const r=t?.endsWith("/api")?t:fe(t||void 0).API_BASE,o=e.gridItems.filter(e=>"shortcut"===e.type&&e.shortcut?.url).map(e=>({id:e.id,title:e.shortcut.title,url:e.shortcut.url,group_id:e.groupId,position:e.position}));(await fetch(`${r}/tab/newtab/sync`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":s},body:JSON.stringify({groups:e.groups.map((e,t)=>({id:e.id,name:e.name,position:e.position??t})),shortcuts:o})})).ok}catch(t){}}(e)},2e3)}const Xe={shortcut:{type:"shortcut",name:"Shortcut",icon:"Link",description:"Website shortcut",sizeConfig:{type:"shortcut",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},bookmarkFolder:{type:"bookmarkFolder",name:"Folder",icon:"Folder",description:"Organize bookmarks and shortcuts",sizeConfig:{type:"bookmarkFolder",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},weather:{type:"weather",name:"Weather",icon:"Cloud",description:"Show current weather and forecast",sizeConfig:{type:"weather",defaultSize:"2x2",allowedSizes:["2x1","2x2","2x3"],minWidth:2,minHeight:1}},clock:{type:"clock",name:"Clock",icon:"Clock",description:"Display current time",sizeConfig:{type:"clock",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}},todo:{type:"todo",name:"Todo",icon:"CheckSquare",description:"Manage todo tasks",sizeConfig:{type:"todo",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},notes:{type:"notes",name:"Notes",icon:"StickyNote",description:"Quick notes",sizeConfig:{type:"notes",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},hotsearch:{type:"hotsearch",name:"Hot Search",icon:"TrendingUp",description:"Show trending searches",sizeConfig:{type:"hotsearch",defaultSize:"2x3",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},poetry:{type:"poetry",name:"Daily Poetry",icon:"BookOpen",description:"Show daily poetry",sizeConfig:{type:"poetry",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}}};function qe(e){return{shortcut:{type:"shortcut",name:be("widget_shortcut"),icon:"Link",description:be("widget_shortcut_desc"),sizeConfig:{type:"shortcut",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},bookmarkFolder:{type:"bookmarkFolder",name:be("widget_folder"),icon:"Folder",description:be("widget_folder_desc"),sizeConfig:{type:"bookmarkFolder",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},weather:{type:"weather",name:be("widget_weather"),icon:"Cloud",description:be("widget_weather_desc"),sizeConfig:{type:"weather",defaultSize:"2x2",allowedSizes:["2x1","2x2","2x3"],minWidth:2,minHeight:1}},clock:{type:"clock",name:be("widget_clock"),icon:"Clock",description:be("widget_clock_desc"),sizeConfig:{type:"clock",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}},todo:{type:"todo",name:be("widget_todo"),icon:"CheckSquare",description:be("widget_todo_desc"),sizeConfig:{type:"todo",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},notes:{type:"notes",name:be("widget_notes"),icon:"StickyNote",description:be("widget_notes_desc"),sizeConfig:{type:"notes",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},hotsearch:{type:"hotsearch",name:be("widget_hotsearch"),icon:"TrendingUp",description:be("widget_hotsearch_desc"),sizeConfig:{type:"hotsearch",defaultSize:"2x3",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},poetry:{type:"poetry",name:be("widget_poetry"),icon:"BookOpen",description:be("widget_poetry_desc"),sizeConfig:{type:"poetry",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}}}[e]}function Ve(e){const[t,s]=e.split("x").map(Number);return{cols:t,rows:s}}async function Je(){try{const e=await we.getTMarksConfig();return e?.bookmarkApiUrl&&e?.bookmarkApiKey?Te({baseUrl:e.bookmarkApiUrl,apiKey:e.bookmarkApiKey}):null}catch{return null}}function Qe(e,t,s){return{addGridItem:(r,o={})=>{const{shortcutGroups:n,gridItems:a,activeGroupId:i,currentFolderId:l,saveData:c}=t(),d=qe(r),u=function(e){switch(e){case"weather":return{weather:{city:"Beijing",unit:"C",showForecast:!0,autoLocation:!1}};case"clock":return{clock:{format:"24h",showDate:!0,showSeconds:!1,showLunar:!1}};case"todo":return{todo:{showCompleted:!1}};case"notes":return{notes:{content:""}};case"hotsearch":return{hotsearch:{type:"baidu"}};case"poetry":return{poetry:{autoRefresh:!0}};default:return{}}}(r),h=o.groupId??i??"home",m=o.parentId??l??null,p=a.filter(e=>(e.groupId??"home")===h&&(e.parentId??null)===m),g=p.length>0?Math.max(...p.map(e=>e.position)):-1,x={id:Ue(),type:r,size:o.size||d.sizeConfig.defaultSize,position:g+1,groupId:h,parentId:m??void 0,shortcut:o.shortcut,bookmarkFolder:o.bookmarkFolder,config:"shortcut"!==r?u:void 0,createdAt:Date.now()},w=[...a,x];e({gridItems:w}),c(),Ye({groups:n,gridItems:w});const{isApplyingBrowserBookmarks:f}=t();f||"shortcut"!==r&&"bookmarkFolder"!==r||(async()=>{try{const o=t(),n=await s({parentGridId:x.parentId??null,inferredGroupId:x.groupId??null});if(!n)return;if(o.setBrowserBookmarkWriteLockUntil(Date.now()+800),"bookmarkFolder"===r){const s=await chrome.bookmarks.create({parentId:n,title:x.bookmarkFolder?.title||be("default_folder_name")});e({gridItems:t().gridItems.map(e=>e.id===x.id?{...e,browserBookmarkId:s.id}:e)}),o.saveData()}if("shortcut"===r&&x.shortcut?.url){const s=await chrome.bookmarks.create({parentId:n,title:x.shortcut.title,url:x.shortcut.url});e({gridItems:t().gridItems.map(e=>e.id===x.id?{...e,browserBookmarkId:s.id}:e)}),o.saveData();(async function(e){if("shortcut"!==e.type||!e.shortcut?.url)return{success:!1,error:"Not a shortcut item"};const t=await Je();if(!t)return{success:!0};try{return{success:!0,tmarksBookmarkId:(await t.bookmarks.createBookmark({title:e.shortcut.title,url:e.shortcut.url,tags:[]})).data.bookmark.id}}catch(s){return{success:!1,error:s instanceof Error?s.message:be("error_sync_failed")}}})({...x,browserBookmarkId:s.id}).then(s=>{s.success&&s.tmarksBookmarkId&&(e({gridItems:t().gridItems.map(e=>e.id===x.id?{...e,tmarksBookmarkId:s.tmarksBookmarkId}:e)}),o.saveData())}).catch(e=>{})}}catch(o){}})(),"shortcut"===r&&o.shortcut?.url&&(async()=>{try{const{downloadFavicon:e}=await Ge(async()=>{const{downloadFavicon:e}=await Promise.resolve().then(()=>is);return{downloadFavicon:e}},void 0),s=await e(o.shortcut.url);if(s){const{updateGridItem:e}=t();e(x.id,{shortcut:{...o.shortcut,faviconBase64:s}})}}catch(e){}})()},updateGridItem:(s,r)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=t(),i=n.map(e=>e.id===s?{...e,...r}:e);e({gridItems:i}),a(),Ye({groups:o,gridItems:i});const{isApplyingBrowserBookmarks:l}=t(),c=n.find(e=>e.id===s);!l&&c?.browserBookmarkId&&("bookmarkFolder"===c.type&&r.bookmarkFolder?.title&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.update(c.browserBookmarkId,{title:r.bookmarkFolder.title})}catch(e){}})(),"shortcut"===c.type&&r.shortcut&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.update(c.browserBookmarkId,{title:r.shortcut?.title,url:r.shortcut?.url})}catch(e){}})())},removeGridItem:s=>{const{shortcutGroups:r,gridItems:o,currentFolderId:n,saveData:a,browserBookmarksRootId:i}=t(),l=o.find(e=>e.id===s);if(!l)return;let c=new Set([s]);if("bookmarkFolder"===l.type){let e=!0;for(;e;){e=!1;for(const t of o){const s=t.parentId;s&&c.has(s)&&!c.has(t.id)&&(c.add(t.id),e=!0)}}}const d=o.filter(e=>!c.has(e.id)),u=l.groupId??"home",h=l.parentId??null,m=d.filter(e=>(e.groupId??"home")===u&&(e.parentId??null)===h).sort((e,t)=>e.position-t.position),p=new Map(m.map((e,t)=>[e.id,t])),g=He(d.map(e=>{const t=p.get(e.id);return void 0===t?e:{...e,position:t}}),n&&c.has(n)?null:n,new Set([i].filter(Boolean)));e({gridItems:g.items,currentFolderId:g.currentFolderId}),a(),Ye({groups:r,gridItems:g.items});const{isApplyingBrowserBookmarks:x}=t();if(!x){const e=[];for(const t of o)c.has(t.id)&&t.browserBookmarkId&&e.push(t.browserBookmarkId);e.length>0&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const t of e)try{await chrome.bookmarks.removeTree(t)}catch{try{await chrome.bookmarks.remove(t)}catch{}}}catch(s){}})()}t().cleanupEmptyGroups()},removeGridFolder:(s,r)=>{const{shortcutGroups:o,gridItems:n,currentFolderId:a,saveData:i}=t(),l=n.find(e=>e.id===s);if(!l||"bookmarkFolder"!==l.type)return;if("all"===r)return void t().removeGridItem(s);const c=l.groupId??"home",d=l.parentId??null,u=new Set([s]);let h=!0;for(;h;){h=!1;for(const e of n)"bookmarkFolder"===e.type&&e.parentId&&u.has(e.parentId)&&!u.has(e.id)&&(u.add(e.id),h=!0)}const m=n.filter(e=>e.parentId&&u.has(e.parentId)).sort((e,t)=>e.position-t.position),p=n.filter(e=>!u.has(e.id)),g=p.filter(e=>(e.groupId??"home")===c&&(e.parentId??null)===d).sort((e,t)=>e.position-t.position),x=new Map(m.map((e,t)=>[e.id,{parentId:d??void 0,position:g.length+t}])),w=p.map(e=>{const t=x.get(e.id);return t?{...e,parentId:t.parentId,position:t.position}:e}),f=w.filter(e=>(e.groupId??"home")===c&&(e.parentId??null)===d).sort((e,t)=>e.position-t.position),b=new Map(f.map((e,t)=>[e.id,t])),k=He(w.map(e=>{const t=b.get(e.id);return void 0===t?e:{...e,position:t}}),a&&u.has(a)?null:a,new Set);e({gridItems:k.items,currentFolderId:k.currentFolderId}),i(),Ye({groups:o,gridItems:k.items});const v=t();!v.isApplyingBrowserBookmarks&&k.removedBrowserBookmarkIds.length>0&&(async()=>{try{v.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of k.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),t().cleanupEmptyGroups()},reorderGridItems:(s,r)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=t(),i=[...n],[l]=i.splice(s,1);i.splice(r,0,l);const c=i.map((e,t)=>({...e,position:t}));e({gridItems:c}),a(),Ye({groups:o,gridItems:c})},getFilteredGridItems:()=>{const{gridItems:e,activeGroupId:s,currentFolderId:r}=t(),o=s??"home",n=r?e.find(e=>e.id===r):null;return r?!!n?.browserBookmarkId?e.filter(e=>{const t=(e.parentId??null)===(r??null);return!!e.browserBookmarkId&&t}).sort((e,t)=>e.position-t.position):e.filter(e=>{const t=(e.groupId??"home")===o,s=(e.parentId??null)===(r??null);return t&&s}).sort((e,t)=>e.position-t.position):e.filter(e=>{const t=(e.groupId??"home")===o,s=null===(e.parentId??null);return t&&s}).sort((e,t)=>e.position-t.position)}}}function Ze(e,t,s,r){return{setBrowserBookmarksRootId:t=>{e(e=>({browserBookmarksRootId:t,homeBrowserFolderId:t?e.homeBrowserFolderId:null}))},setHomeBrowserFolderId:t=>{e({homeBrowserFolderId:t})},setGroupBookmarkFolderId:(s,r)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=t(),i=o.map(e=>e.id===s?{...e,bookmarkFolderId:r??void 0}:e);e({shortcutGroups:i}),a(),Ye({groups:i,gridItems:n})},setIsApplyingBrowserBookmarks:t=>{e({isApplyingBrowserBookmarks:t})},setBrowserBookmarkWriteLockUntil:t=>{e({browserBookmarkWriteLockUntil:t})},replaceBrowserBookmarkGridItems:(s,r)=>{const{gridItems:o,saveData:n}=t(),a=Array.from(new Set(s.map(e=>e.groupId??"home"))),i=new Set(r?.groupIds&&r.groupIds.length>0?r.groupIds:a),l=[...o.filter(e=>{if(!e.browserBookmarkId)return!0;if(0===i.size)return!1;const t=e.groupId??"home";return!i.has(t)}),...s.map(e=>({...e,parentId:e.parentId??null,groupId:e.groupId??"home"}))];e({gridItems:l}),n(),t().cleanupEmptyGroups()},upsertBrowserBookmarkNode:o=>{const{gridItems:n,saveData:a,browserBookmarksRootId:i}=t();if(!i)return;const l=`bb-${o.id}`,c=n.find(e=>e.id===l),d=o.parentId,u=s(d);let h;d&&(h=r(d)?null:d===i?void 0:`bb-${d}`);const m="number"==typeof o.index?o.index:c?.position??0,p={id:l,type:o.url?"shortcut":"bookmarkFolder",size:c?.size??"1x1",position:m,groupId:u,parentId:h,browserBookmarkId:o.id,shortcut:o.url?{url:o.url,title:o.title||o.url,favicon:c?.shortcut?.favicon,faviconBase64:c?.shortcut?.faviconBase64}:void 0,bookmarkFolder:o.url?void 0:{title:o.title||c?.bookmarkFolder?.title||be("default_folder_name")},config:c?.config,createdAt:c?.createdAt??Date.now()},g=[...n.filter(e=>!e.browserBookmarkId),...n.filter(e=>e.browserBookmarkId&&e.id!==l),p];e({gridItems:g}),a()},removeBrowserBookmarkById:s=>{const{gridItems:r,currentFolderId:o,saveData:n,browserBookmarksRootId:a}=t(),i=`bb-${s}`,l=r.find(e=>e.id===i);if(!l)return;let c=new Set([i]);if("bookmarkFolder"===l.type){let e=!0;for(;e;){e=!1;for(const t of r){const s=t.parentId;s&&c.has(s)&&!c.has(t.id)&&(c.add(t.id),e=!0)}}}const d=[];for(const e of r)c.has(e.id)&&e.tmarksBookmarkId&&d.push(e.tmarksBookmarkId);const u=He(r.filter(e=>!c.has(e.id)),o&&c.has(o)?null:o,new Set([a].filter(Boolean)));e({gridItems:u.items,currentFolderId:u.currentFolderId}),n(),d.length>0&&async function(e){if(0===e.length)return{success:!0};const t=await Je();if(!t)return{success:!0};const s=[];for(const o of e)try{await t.bookmarks.trashBookmark(o)}catch(r){s.push(`${o}: ${r instanceof Error?r.message:be("error_unknown")}`)}return s.length>0?{success:!1,error:be("error_partial_delete",s.join(", "))}:{success:!0}}(d).catch(e=>{}),t().cleanupEmptyGroups()},applyBrowserBookmarkChildrenOrder:(s,r)=>{const{gridItems:o,saveData:n}=t(),a=new Map(r.map((e,t)=>[`bb-${e}`,t])),i=o.map(e=>{const t=a.get(e.id);return void 0!==t?{...e,position:t}:e});e({gridItems:i}),n()}}}function et(e,t,s){return{setCurrentFolderId:t=>{e({currentFolderId:t})},moveGridItemToFolder:(r,o)=>{const{shortcutGroups:n,gridItems:a,saveData:i,browserBookmarksRootId:l}=t(),c=a.find(e=>e.id===r);if(!c)return;const d=e=>{if(!e)return 0;const t=a.find(t=>t.id===e);return t?1+d(t.parentId??null):0},u=d(o),h=e=>{const t=a.filter(t=>t.parentId===e);return 0===t.length?0:1+Math.max(...t.map(e=>h(e.id)))};if(u+1+("bookmarkFolder"===c.type?h(c.id):0)>5)return;const m=o??null,p=!!c.browserBookmarkId,g=(()=>{if(p)return c.groupId??"home";const e=t().activeGroupId??"home",s=o?a.find(e=>e.id===o):null,r=c.parentId?a.find(e=>e.id===c.parentId):null;return s?.groupId??r?.groupId??c.groupId??e})(),x=a.filter(e=>e.id!==r&&((e.parentId??null)===m&&(p?!!e.browserBookmarkId:!e.browserBookmarkId&&(e.groupId??"home")===g))).sort((e,t)=>e.position-t.position).length,w=a.map(e=>e.id!==r?e:{...e,groupId:g,parentId:m??void 0,position:x}),f=new Set([l].filter(Boolean)),b=He(w,t().currentFolderId,f);e({gridItems:b.items,currentFolderId:b.currentFolderId}),i(),Ye({groups:n,gridItems:b.items});const k=t();!k.isApplyingBrowserBookmarks&&b.removedBrowserBookmarkIds.length>0&&(async()=>{try{k.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of b.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),p||"home"!==g||null!==m||t().mirrorHomeItemsToBrowser([r]),t().cleanupEmptyGroups();const v=t();!v.isApplyingBrowserBookmarks&&c.browserBookmarkId&&(async()=>{try{const e=await s({parentGridId:o,inferredGroupId:g});if(!e)return;v.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(c.browserBookmarkId,{parentId:e,index:x})}catch(e){}})()},reorderGridItemsInCurrentScope:(r,o)=>{const{shortcutGroups:n,gridItems:a,activeGroupId:i,currentFolderId:l,saveData:c}=t(),d=i??"home",u=a.filter(e=>(e.groupId??"home")===d&&(e.parentId??null)===(l??null)).sort((e,t)=>e.position-t.position),h=u.findIndex(e=>e.id===r),m=u.findIndex(e=>e.id===o);if(-1===h||-1===m||h===m)return;const p=[...u],[g]=p.splice(h,1);p.splice(m,0,g);const x=new Map(p.map((e,t)=>[e.id,t])),w=a.map(e=>{const t=x.get(e.id);return void 0===t?e:{...e,position:t}});e({gridItems:w}),c(),Ye({groups:n,gridItems:w});const f=t(),b=u[h];!f.isApplyingBrowserBookmarks&&b?.browserBookmarkId&&(async()=>{try{const e=await s({parentGridId:f.currentFolderId,inferredGroupId:d});if(!e)return;f.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(b.browserBookmarkId,{parentId:e,index:m})}catch(e){}})()},reorderGridItemsInFolderScope:(r,o,n)=>{const{shortcutGroups:a,gridItems:i,saveData:l}=t(),c=i.find(e=>e.id===r);if(!c)return;const d=c.groupId??"home",u=i.filter(e=>(e.groupId??"home")===d&&(e.parentId??null)===r).sort((e,t)=>e.position-t.position),h=u.findIndex(e=>e.id===o),m=u.findIndex(e=>e.id===n);if(-1===h||-1===m||h===m)return;const p=[...u],[g]=p.splice(h,1);p.splice(m,0,g);const x=new Map(p.map((e,t)=>[e.id,t])),w=i.map(e=>{const t=x.get(e.id);return void 0===t?e:{...e,position:t}});e({gridItems:w}),l(),Ye({groups:a,gridItems:w});const f=t(),b=u[h];!f.isApplyingBrowserBookmarks&&b?.browserBookmarkId&&(async()=>{try{const e=await s({parentGridId:r,inferredGroupId:f.gridItems.find(e=>e.id===r)?.groupId??null});if(!e)return;f.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(b.browserBookmarkId,{parentId:e,index:m})}catch(e){}})()},mergeFolders:(s,r)=>{const{shortcutGroups:o,gridItems:n,saveData:a,browserBookmarksRootId:i}=t(),l=n.find(e=>e.id===s&&"bookmarkFolder"===e.type),c=n.find(e=>e.id===r&&"bookmarkFolder"===e.type);if(!l||!c)return;if(s===r)return;const d=n.filter(e=>(e.parentId??null)===s).sort((e,t)=>e.position-t.position),u=n.filter(e=>(e.parentId??null)===r).sort((e,t)=>e.position-t.position).length;let h=n.map(e=>{if((e.parentId??null)===s){const t=u+d.findIndex(t=>t.id===e.id);return{...e,parentId:r,groupId:c.groupId??"home",position:t}}return e});h=h.filter(e=>e.id!==s);const m=h.filter(e=>(e.parentId??null)===r).sort((e,t)=>e.position-t.position),p=new Map(m.map((e,t)=>[e.id,t]));h=h.map(e=>{const t=p.get(e.id);return void 0!==t?{...e,position:t}:e});const g=new Set([i].filter(Boolean)),x=He(h,t().currentFolderId,g);e({gridItems:x.items,currentFolderId:x.currentFolderId}),a(),Ye({groups:o,gridItems:x.items});const w=t();w.isApplyingBrowserBookmarks||(async()=>{try{if(c.browserBookmarkId){w.setBrowserBookmarkWriteLockUntil(Date.now()+2e3);for(let t=0;t<d.length;t++){const s=d[t];if(s.browserBookmarkId)try{await chrome.bookmarks.move(s.browserBookmarkId,{parentId:c.browserBookmarkId,index:u+t})}catch(e){}}}if(l.browserBookmarkId)try{await chrome.bookmarks.removeTree(l.browserBookmarkId)}catch{try{await chrome.bookmarks.remove(l.browserBookmarkId)}catch{}}if(x.removedBrowserBookmarkIds.length>0)for(const e of x.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch(e){}})(),t().cleanupEmptyGroups()},createFolderFromShortcuts:(r,o,n)=>{const{shortcutGroups:a,gridItems:i,saveData:l}=t(),c=i.find(e=>e.id===r),d=i.find(e=>e.id===o);if(!c||!d)return null;if("shortcut"!==c.type||"shortcut"!==d.type)return null;if(r===o)return null;const u=d.groupId??"home",h=d.parentId??null,m=d.position,p=n||be("default_new_folder"),g=Ue(),x={id:g,type:"bookmarkFolder",size:"1x1",position:m,groupId:u,parentId:h??void 0,bookmarkFolder:{title:p},createdAt:Date.now()};let w=i.map(e=>e.id===r?{...e,parentId:g,groupId:u,position:0}:e.id===o?{...e,parentId:g,groupId:u,position:1}:e);w=[...w,x];const f=w.filter(e=>(e.groupId??"home")===u&&(e.parentId??null)===h&&e.id!==r&&e.id!==o).sort((e,t)=>e.position-t.position),b=new Map;f.forEach((e,t)=>{e.id===g?b.set(e.id,m):e.position>=m?b.set(e.id,t):b.set(e.id,e.position)});f.sort((e,t)=>(b.get(e.id)??e.position)-(b.get(t.id)??t.position)).forEach((e,t)=>{b.set(e.id,t)}),w=w.map(e=>{const t=b.get(e.id);return void 0!==t?{...e,position:t}:e}),e({gridItems:w}),l(),Ye({groups:a,gridItems:w});const k=t();return k.isApplyingBrowserBookmarks||(async()=>{try{const o=await s({parentGridId:h,inferredGroupId:u});if(o){k.setBrowserBookmarkWriteLockUntil(Date.now()+2e3);const s=await chrome.bookmarks.create({parentId:o,title:p,index:m});if(e({gridItems:t().gridItems.map(e=>e.id===g?{...e,browserBookmarkId:s.id}:e)}),k.saveData(),c.browserBookmarkId)try{await chrome.bookmarks.move(c.browserBookmarkId,{parentId:s.id,index:0})}catch(r){}if(d.browserBookmarkId)try{await chrome.bookmarks.move(d.browserBookmarkId,{parentId:s.id,index:1})}catch(r){}}}catch(r){}})(),g},cleanupEmptySecondLevelFolders:()=>{const{gridItems:s,currentFolderId:r,shortcutGroups:o,saveData:n}=t(),{items:a,currentFolderId:i,changed:l}=function(e,t){const s=new Map(e.map(e=>[e.id,e])),r=new Map;for(const l of e)l.parentId&&r.set(l.parentId,(r.get(l.parentId)??0)+1);const o=new Set;for(const l of e){if("bookmarkFolder"!==l.type||l.browserBookmarkId||!l.parentId)continue;const e=s.get(l.parentId);e&&null===(e.parentId??null)&&0===(r.get(l.id)??0)&&o.add(l.id)}if(0===o.size)return{items:e,currentFolderId:t,changed:!1};const n=e.filter(e=>!o.has(e.id)),a=new Map;n.forEach(e=>{const t=`${e.groupId??"home"}|${e.parentId??"root"}`;a.has(t)||a.set(t,[]),a.get(t).push(e)});const i=new Map;return a.forEach(e=>{e.sort((e,t)=>e.position-t.position),e.forEach((e,t)=>{i.set(e.id,t)})}),{items:n.map(e=>{const t=i.get(e.id);return void 0!==t&&t!==e.position?{...e,position:t}:e}),currentFolderId:t&&o.has(t)?null:t,changed:!0}}(s,r);l&&(e({gridItems:a,currentFolderId:i}),n(),Ye({groups:o,gridItems:a}),t().cleanupEmptyGroups())},cleanupAllEmptyFolders:()=>{const{gridItems:s,currentFolderId:r,shortcutGroups:o,saveData:n,browserBookmarksRootId:a}=t(),i=He(s,r,new Set([a].filter(Boolean)));if(!i.changed)return;e({gridItems:i.items,currentFolderId:i.currentFolderId}),n(),Ye({groups:o,gridItems:i.items});const l=t();!l.isApplyingBrowserBookmarks&&i.removedBrowserBookmarkIds.length>0&&(async()=>{try{l.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of i.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),t().cleanupEmptyGroups()},migrateToGridItems:()=>{}}}const tt="TMarks",st="NewTab Home",rt="tmarks_root_bookmark_id",ot="tmarks_home_bookmark_id",nt=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),at=new Set([st]);function it(){return"undefined"!=typeof chrome&&!!chrome.bookmarks}function lt(e){return!e.url}async function ct(e){if(!it())return null;try{const t=await chrome.bookmarks.get(e);return t?.[0]??null}catch{return null}}async function dt(e){if(!it())return[];try{return await chrome.bookmarks.getChildren(e)}catch{return[]}}async function ut(e){if(!it())return null;try{const t=await chrome.bookmarks.getSubTree(e);return t?.[0]??null}catch{return null}}async function ht(e){if(!it())return null;try{return await chrome.bookmarks.create(e)}catch(t){return null}}async function mt(e){const t=await ct(e);return t&&!t.url?t:null}async function pt(e){try{await chrome.storage.local.set({[rt]:e})}catch(t){}}async function gt(e){try{await chrome.storage.local.set({[ot]:e})}catch(t){}}async function xt(){if(!it())return null;const e=await async function(){if(!it())return null;try{const e=(await chrome.bookmarks.getTree())[0],t=e.children?.find(e=>"1"===e.id&&!e.url);if(t)return t.id;const s=e.children?.find(e=>!e.url&&nt.has(e.title));if(s)return s.id;const r=e.children?.find(e=>!e.url);return r?.id??null}catch{return null}}();if(!e)return null;const t=await async function(){try{const e=(await chrome.storage.local.get(rt))[rt];return"string"==typeof e?e:null}catch{return null}}();if(t){if(await mt(t))return{id:t,wasRecreated:!1}}const s=(await dt(e)).find(e=>!e.url&&e.title===tt);if(s)return await pt(s.id),{id:s.id,wasRecreated:!1};const r=await ht({parentId:e,title:tt});if(!r)return null;await pt(r.id);const o=null!==t;return{id:r.id,wasRecreated:o}}async function wt(e){if(!it()||!e)return null;const t=await async function(){try{const e=(await chrome.storage.local.get(ot))[ot];return"string"==typeof e?e:null}catch{return null}}();if(t){const s=await mt(t);if(s){return s.parentId!==e&&await async function(e,t){if(!it())return null;try{return await chrome.bookmarks.move(e,t)}catch(s){return null}}(s.id,{parentId:e}),await gt(s.id),{id:s.id,wasRecreated:!1}}}const s=(await dt(e)).find(e=>!e.url&&e.title===st);if(s)return await gt(s.id),{id:s.id,wasRecreated:!1};const r=await ht({parentId:e,title:st});return r?(await gt(r.id),{id:r.id,wasRecreated:null!==t}):null}function ft(e){return`bb-${e}`}function bt(){return"1x1"}function kt(e,t){const s=[];for(let r=0;r<e.length;r++){const o=e[r];if(lt(o)){const e={id:ft(o.id),type:"bookmarkFolder",size:bt(),position:r,groupId:t.groupId,parentId:t.parentGridId??void 0,browserBookmarkId:o.id,bookmarkFolder:{title:o.title},createdAt:Date.now()};s.push(e);const n=o.children||[];n.length>0&&s.push(...kt(n,{groupId:t.groupId,parentGridId:e.id}))}else s.push({id:ft(o.id),type:"shortcut",size:"1x1",position:r,groupId:t.groupId,parentId:t.parentGridId??void 0,browserBookmarkId:o.id,shortcut:{url:o.url||"",title:o.title||o.url||""},createdAt:Date.now()})}return s}function vt(){const{isLoading:t,ensureGroupBookmarkFolderId:s,removeGroup:r,setBrowserBookmarksRootId:o,setHomeBrowserFolderId:n,setIsApplyingBrowserBookmarks:a,replaceBrowserBookmarkGridItems:i,upsertBrowserBookmarkNode:l,removeBrowserBookmarkById:c,applyBrowserBookmarkChildrenOrder:d}=jt(),u=e.useRef(!1);e.useEffect(()=>{if(t)return;if(!it())return;let e=!1;const h=e=>{const t=jt.getState(),s=t.browserBookmarksRootId,r=t.homeBrowserFolderId;return!(!s||!e)&&(e===s||e===r||(!!t.shortcutGroups.some(t=>t.bookmarkFolderId===e)||t.gridItems.some(t=>t.browserBookmarkId===e&&"bookmarkFolder"===t.type)))},m=async e=>{try{const t=(await dt(e)).map(e=>e.id);a(!0),d(e,t)}finally{a(!1)}},p=()=>{jt.getState().shortcutGroups.filter(e=>"home"!==e.id).forEach(e=>r(e.id,{skipBrowserBookmarkDeletion:!0})),(()=>{const e=jt.getState(),t=e.gridItems.filter(e=>!e.browserBookmarkId),s=e.currentFolderId&&t.some(t=>t.id===e.currentFolderId)?e.currentFolderId:null;jt.setState({gridItems:t,currentFolderId:s}),e.saveData(),jt.getState().cleanupEmptyGroups()})(),o(null),n(null)},g=async()=>{if(!u.current){u.current=!0;try{const t=await xt();if(!t||e)return;const{id:r,wasRecreated:l}=t;l&&p(),o(r);const c=await wt(r);c&&n(c.id);const d=jt.getState();await async function(e,t,s,r){const o={created:[],linked:[],skipped:[]};try{const n=(await dt(e)).filter(lt);for(const e of n){if(at.has(e.title)){o.skipped.push(e.title);continue}const n=r();if(n.find(t=>t.bookmarkFolderId===e.id)){o.skipped.push(e.title);continue}const a=n.find(t=>t.name===e.title);a?a.bookmarkFolderId?o.skipped.push(e.title):(s(a.id,e.id),o.linked.push(e.title)):(t(e.title,"Folder",{bookmarkFolderId:e.id,skipBookmarkFolderCreation:!0}),o.created.push(e.title))}}catch(n){}return o}(r,d.addGroup,d.setGroupBookmarkFolderId,()=>jt.getState().shortcutGroups),l&&window.dispatchEvent(new CustomEvent("tmarks-folder-recreated",{detail:{message:"TMarks 书签文件夹已重建"}}));const u=["home",...jt.getState().shortcutGroups.filter(e=>"home"!==e.id).map(e=>e.id)],h=[],m=[];for(const e of u){let t=null;if(t="home"===e?c?.id??d.homeBrowserFolderId??await s(e):await s(e),!t)continue;m.push(e);const r=await ut(t);r&&h.push(...kt(r.children||[],{groupId:e,parentGridId:null}))}a(!0),i(h,{groupIds:m})}finally{a(!1),u.current=!1}}};g();const x=function(e){if(!it()||!chrome.bookmarks?.onCreated)return()=>{};const{onCreated:t,onRemoved:s,onChanged:r,onMoved:o,onChildrenReordered:n}=e;return t&&chrome.bookmarks.onCreated.addListener(t),s&&chrome.bookmarks.onRemoved.addListener(s),r&&chrome.bookmarks.onChanged.addListener(r),o&&chrome.bookmarks.onMoved.addListener(o),n&&chrome.bookmarks.onChildrenReordered.addListener(n),()=>{t&&chrome.bookmarks.onCreated.removeListener(t),s&&chrome.bookmarks.onRemoved.removeListener(s),r&&chrome.bookmarks.onChanged.removeListener(r),o&&chrome.bookmarks.onMoved.removeListener(o),n&&chrome.bookmarks.onChildrenReordered.removeListener(n)}}({onCreated:(e,t)=>{if(!(Date.now()<jt.getState().browserBookmarkWriteLockUntil)&&h(t.parentId)){a(!0);try{l({id:e,parentId:t.parentId,title:t.title,url:t.url,index:t.index})}finally{a(!1)}t.parentId&&m(t.parentId)}},onRemoved:(e,t)=>{if(Date.now()<jt.getState().browserBookmarkWriteLockUntil)return;const s=jt.getState();if(s.browserBookmarksRootId&&e===s.browserBookmarksRootId)return p(),void g();if(!h(t?.parentId))return;const o=s.shortcutGroups.find(t=>t.bookmarkFolderId===e);o&&"home"!==o.id&&r(o.id,{skipBrowserBookmarkDeletion:!0}),a(!0);try{c(e)}finally{a(!1)}t?.parentId&&m(t.parentId)},onChanged:async(e,t)=>{if(Date.now()<jt.getState().browserBookmarkWriteLockUntil)return;const s=await ct(e);if(s&&h(s.parentId)){a(!0);try{l({id:e,parentId:s.parentId,title:t.title??s.title,url:t.url??s.url,index:s.index})}finally{a(!1)}}},onMoved:async(e,t)=>{if(Date.now()<jt.getState().browserBookmarkWriteLockUntil)return;const s=h(t.parentId),r=h(t.oldParentId);if(!s&&!r)return;if(r&&!s){a(!0);try{c(e)}finally{a(!1)}return void(await m(t.oldParentId))}const o=await ct(e);if(o&&s){a(!0);try{l({id:e,parentId:t.parentId,title:o.title,url:o.url,index:t.index})}finally{a(!1)}}r&&await m(t.oldParentId),s&&await m(t.parentId)},onChildrenReordered:e=>{Date.now()<jt.getState().browserBookmarkWriteLockUntil||h(e)&&m(e)}});return()=>{e=!0,x()}},[t])}let yt=null;const jt=t((e,t)=>{const s=async()=>{const e=t();if(!e.browserBookmarksRootId)return null;let s=e.homeBrowserFolderId;if(s)return s;const r=await wt(e.browserBookmarksRootId);return r?(s=r.id,e.setHomeBrowserFolderId(s),s):null},r=async(e,r)=>{const o=t();if(!We())return null;if(!o.browserBookmarksRootId)return null;if("home"===e)return s();const n=o.shortcutGroups.find(t=>t.id===e);if(!n)return null;const a=await(async e=>{if(!e)return null;try{const t=await chrome.bookmarks.get(e),s=t?.[0];if(s&&!s.url)return e}catch{}return null})(r?.bookmarkFolderIdOverride??n.bookmarkFolderId??void 0);if(a)return a;const i=o.browserBookmarksRootId;if(!i)return null;try{const t=(await chrome.bookmarks.getChildren(i)).find(e=>!e.url&&e.title===n.name);if(t)return o.setGroupBookmarkFolderId(e,t.id),t.id}catch{}if(r?.createIfMissing)try{o.setBrowserBookmarkWriteLockUntil(Date.now()+1200);const t=await chrome.bookmarks.create({parentId:i,title:n.name});if(t?.id)return o.setGroupBookmarkFolderId(e,t.id),t.id}catch(l){}return null},o=async e=>{const o=t();if(!o.browserBookmarksRootId)return null;if(e.parentGridId){const t=o.gridItems.find(t=>t.id===e.parentGridId);if(t?.browserBookmarkId)return t.browserBookmarkId}const n=e.inferredGroupId??o.activeGroupId??"home";if(null===(e.parentGridId??null))if("home"===n){const e=await s();if(e)return e}else{const e=await r(n);if(e)return e}if("home"===n){const e=await s();if(e)return e}else{const e=await r(n);if(e)return e}return await async function(e){return e?"0"!==e?e:yt||(yt=(async()=>{try{if(!We())return null;const e=(await chrome.bookmarks.getTree())[0],t=e.children?.find(e=>"1"===e.id&&!e.url);if(t)return t.id;const s=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),r=e.children?.find(e=>!e.url&&s.has(e.title));if(r)return r.id;const o=e.children?.find(e=>!e.url);return o?.id||null}catch{return null}})(),yt):null}(o.browserBookmarksRootId)??o.browserBookmarksRootId},n=async r=>{const o=t();if(!We())return;if(!o.browserBookmarksRootId)return;const n=o.gridItems.find(e=>e.id===r);if(!n)return;if(n.browserBookmarkId)return;if(!(e=>"home"===(e.groupId??"home")&&null===(e.parentId??null))(n))return;if("shortcut"===n.type&&!n.shortcut?.url)return;const a=await s();if(a){o.setBrowserBookmarkWriteLockUntil(Date.now()+1200);try{let s;if("bookmarkFolder"===n.type?s=await chrome.bookmarks.create({parentId:a,title:n.bookmarkFolder?.title||be("default_folder_name")}):"shortcut"===n.type&&(s=await chrome.bookmarks.create({parentId:a,title:n.shortcut?.title||n.shortcut?.url||be("default_shortcut_name"),url:n.shortcut?.url})),!s?.id)return;e({gridItems:t().gridItems.map(e=>e.id===n.id?{...e,browserBookmarkId:s.id}:e)}),o.saveData()}catch(i){}}},a=function(e,t){return{addShortcut:s=>{const{shortcuts:r,shortcutGroups:o,gridItems:n,saveData:a}=e(),i={...s,id:Ue(),position:r.length,createdAt:Date.now(),clickCount:0},l=[...r,i];t({shortcuts:l}),a(),(async()=>{try{const{downloadFavicon:t}=await Ge(async()=>{const{downloadFavicon:e}=await Promise.resolve().then(()=>is);return{downloadFavicon:e}},void 0),s=await t(i.url);if(s){const{updateShortcut:t}=e();t(i.id,{faviconBase64:s})}}catch(t){}})(),Ye({groups:o,gridItems:n})},updateShortcut:(s,r)=>{const{shortcuts:o,shortcutGroups:n,gridItems:a,saveData:i}=e(),l=o.map(e=>e.id===s?{...e,...r}:e);t({shortcuts:l}),i(),Ye({groups:n,gridItems:a})},removeShortcut:s=>{const{shortcuts:r,shortcutGroups:o,gridItems:n,saveData:a}=e(),i=r.filter(e=>e.id!==s).map((e,t)=>({...e,position:t}));t({shortcuts:i}),a(),Ye({groups:o,gridItems:n})},reorderShortcuts:(s,r)=>{const{shortcuts:o,shortcutGroups:n,gridItems:a,saveData:i}=e(),l=[...o],[c]=l.splice(s,1);l.splice(r,0,c);const d=l.map((e,t)=>({...e,position:t}));t({shortcuts:d}),i(),Ye({groups:n,gridItems:a})},incrementClickCount:s=>{const{shortcuts:r,saveData:o}=e();t({shortcuts:r.map(e=>e.id===s?{...e,clickCount:e.clickCount+1}:e)}),o()},getFilteredShortcuts:()=>{const{shortcuts:t,activeGroupId:s}=e(),r=s??"home";return t.filter(e=>e.groupId===r&&!e.folderId)}}}(t,e),i=function(e,t,s){return{setActiveGroup:s=>{const{saveData:r}=e();t({activeGroupId:s,currentFolderId:null}),r()},addGroup:(r,o,n)=>{const{shortcutGroups:a,gridItems:i,saveData:l}=e(),c={id:Ue(),name:r,icon:o,position:a.length,bookmarkFolderId:n?.bookmarkFolderId??void 0},d=[...a,c];t({shortcutGroups:d}),l(),Ye({groups:d,gridItems:i}),n?.skipBookmarkFolderCreation||s(c.id,{createIfMissing:!n?.bookmarkFolderId,bookmarkFolderIdOverride:n?.bookmarkFolderId??void 0})},updateGroup:(s,r)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=e(),i=o.map(e=>e.id===s?{...e,...r}:e);t({shortcutGroups:i}),a(),Ye({groups:i,gridItems:n})},removeGroup:(s,r)=>{const{shortcutGroups:o,shortcuts:n,activeGroupId:a,gridItems:i,saveData:l,setBrowserBookmarkWriteLockUntil:c}=e();if("home"===s)return;const d=o.find(e=>e.id===s);if(!d)return;const u=!!d.bookmarkFolderId,h=u?n.filter(e=>e.groupId!==s):n.map(e=>e.groupId===s?{...e,groupId:"home"}:e),m=u?i.filter(e=>e.groupId!==s):i.map(e=>e.groupId===s?{...e,groupId:"home",parentId:null}:e),p=o.filter(e=>e.id!==s).map((e,t)=>({...e,position:t}));t({shortcutGroups:p,shortcuts:h,gridItems:m,activeGroupId:a===s?"home":a,...a===s?{currentFolderId:null}:{}}),l(),Ye({groups:p,gridItems:m}),d.bookmarkFolderId&&!r?.skipBrowserBookmarkDeletion&&(async()=>{try{c(Date.now()+1200);try{await chrome.bookmarks.removeTree(d.bookmarkFolderId)}catch{try{await chrome.bookmarks.remove(d.bookmarkFolderId)}catch{}}}catch{}})()},setGroupBookmarkFolderId:(s,r)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=e(),i=o.map(e=>e.id===s?{...e,bookmarkFolderId:r??void 0}:e);t({shortcutGroups:i}),a(),Ye({groups:i,gridItems:n})},cleanupEmptyGroups:()=>{const{shortcutGroups:s,activeGroupId:r,gridItems:o,saveData:n,setBrowserBookmarkWriteLockUntil:a}=e(),i=s.filter(e=>"home"!==e.id&&!o.some(t=>(t.groupId??"home")===e.id&&null===(t.parentId??null))).map(e=>e.id);if(0===i.length)return;const l=[];i.forEach(e=>{const t=s.find(t=>t.id===e);t?.bookmarkFolderId&&l.push(t.bookmarkFolderId)});const c=s.filter(e=>!i.includes(e.id)).map((e,t)=>({...e,position:t})),d=i.includes(r??"")?"home":r,u=i.includes(r??"");t({shortcutGroups:c,activeGroupId:d,...u?{currentFolderId:null}:{}}),n(),Ye({groups:c,gridItems:o}),l.length>0&&(async()=>{try{a(Date.now()+1200);for(const e of l)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})()}}}(t,e,r),l=function(e,t){return{addFolder:(s,r)=>{const{shortcutGroups:o,shortcutFolders:n,activeGroupId:a,gridItems:i,saveData:l}=e(),c={id:Ue(),name:s,position:n.length,groupId:r??a??void 0,createdAt:Date.now()},d=[...n,c];return t({shortcutFolders:d}),l(),Ye({groups:o,gridItems:i}),c.id},updateFolder:(s,r)=>{const{shortcutGroups:o,shortcutFolders:n,gridItems:a,saveData:i}=e(),l=n.map(e=>e.id===s?{...e,...r}:e);t({shortcutFolders:l}),i(),Ye({groups:o,gridItems:a})},removeFolder:s=>{const{shortcuts:r,shortcutGroups:o,shortcutFolders:n,gridItems:a,saveData:i}=e(),l=r.map(e=>e.folderId===s?{...e,folderId:void 0}:e),c=n.filter(e=>e.id!==s);t({shortcutFolders:c,shortcuts:l}),i(),Ye({groups:o,gridItems:a})},getFolderShortcuts:t=>{const{shortcuts:s}=e();return s.filter(e=>e.folderId===t)},moveShortcutToFolder:(s,r)=>{const{shortcuts:o,shortcutGroups:n,gridItems:a,saveData:i}=e(),l=o.map(e=>e.id===s?{...e,folderId:r}:e);t({shortcuts:l}),i(),Ye({groups:n,gridItems:a})}}}(t,e),c=Qe(e,t,o),d=Ze(e,t,e=>{const s=t();if(!e)return"home";if(e===s.homeBrowserFolderId)return"home";const r=s.shortcutGroups.find(t=>t.bookmarkFolderId===e);if(r)return r.id;const o=s.gridItems.find(t=>t.browserBookmarkId===e&&"bookmarkFolder"===t.type);return o?.groupId??"home"},e=>{if(!e)return!1;const s=t();return e===s.homeBrowserFolderId||s.shortcutGroups.some(t=>t.bookmarkFolderId===e)}),u=et(e,t,o);return{shortcuts:[],shortcutGroups:_e,shortcutFolders:[],activeGroupId:"home",settings:Ie,isLoading:!0,gridItems:[],currentFolderId:null,browserBookmarksRootId:null,homeBrowserFolderId:null,isApplyingBrowserBookmarks:!1,browserBookmarkWriteLockUntil:0,loadData:async()=>{try{const s=(await chrome.storage.local.get(Ne))[Ne],r=s?.shortcutGroups?.length?s.shortcutGroups:_e;let o=s?.activeGroupId;o&&r.some(e=>e.id===o)||(o=r[0]?.id||"home");const n={...Ie,...s?.settings||{}};if(e({shortcuts:s?.shortcuts||[],shortcutGroups:r,shortcutFolders:s?.shortcutFolders||[],activeGroupId:o,settings:n,gridItems:s?.gridItems||[],currentFolderId:null,browserBookmarksRootId:null,homeBrowserFolderId:null,isApplyingBrowserBookmarks:!1,browserBookmarkWriteLockUntil:0,isLoading:!1}),!s){const{saveData:e}=t();e()}}catch(s){e({isLoading:!1})}},saveData:async()=>{const{shortcuts:e,shortcutGroups:s,shortcutFolders:r,activeGroupId:o,settings:n,gridItems:a}=t(),i={shortcuts:e,shortcutGroups:s,shortcutFolders:r,activeGroupId:o,settings:n,gridItems:a};try{await chrome.storage.local.set({[Ne]:i})}catch(l){}},updateSettings:s=>{const{shortcutGroups:r,settings:o,gridItems:n,saveData:a}=t(),i={...o,...s};e({settings:i}),a(),Ye({groups:r,gridItems:n})},...a,...i,ensureGroupBookmarkFolderId:r,...l,...c,...d,...u,mirrorHomeItemsToBrowser:e=>{for(const t of e)n(t)}}});function It({format:t,showDate:r,showSeconds:o,showLunar:n=!1}){const[a,i]=e.useState(new Date);e.useEffect(()=>{const e=setInterval(()=>i(new Date),1e3);return()=>clearInterval(e)},[]);const l=e.useMemo(()=>{if(!n)return null;const e=Le.Lunar.fromDate(a);let t="";try{const s=e.getFestivals?.()||[],r=e.getJieQi?.()||"";t=s[0]||r||""}catch{}return{date:`${e.getMonthInChinese()}月${e.getDayInChinese()}`,festival:t}},[a,n]);return s.jsxs("div",{className:"text-center text-white select-none",children:[s.jsx("div",{className:"text-7xl font-light tracking-wider text-shadow-lg",children:(()=>{let e=a.getHours();const s=a.getMinutes().toString().padStart(2,"0"),r=a.getSeconds().toString().padStart(2,"0");let n="";"12h"===t&&(n=e>=12?" PM":" AM",e=e%12||12);let i=`${e.toString().padStart(2,"0")}:${s}`;return o&&(i+=`:${r}`),"12h"===t&&(i+=n),i})()}),(r||n)&&s.jsxs("div",{className:"mt-2 text-lg text-white/90 text-shadow flex items-center justify-center gap-3",children:[r&&s.jsx("span",{children:a.toLocaleDateString("zh-CN",{weekday:"short",month:"numeric",day:"numeric"})}),r&&n&&s.jsx("span",{className:"text-white/50",children:"|"}),n&&l&&s.jsxs(s.Fragment,{children:[s.jsx("span",{children:l.date}),l.festival&&s.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 text-sm",children:l.festival})]})]})]})}const _t=(...e)=>{},Nt=(...e)=>{},St="tmarks_pinned_bookmarks";let Ct=null,Bt=null;async function Ft(){const e=await we.getBookmarkSiteApiUrl(),t=await we.getBookmarkSiteApiKey();if(!t)throw new Error("API Key not configured");let s;return s=e?e.endsWith("/api")?e:fe(e).API_BASE:fe().API_BASE,Ct&&Bt&&Bt.apiKey===t&&Bt.apiBaseUrl===s||(Ct=Te({apiKey:t,baseUrl:s}),Bt={apiKey:t,apiBaseUrl:s}),Ct}function Dt(){const[t,s]=e.useState({isSyncing:!1,lastSyncAt:null,error:null}),[r,o]=e.useState([]),n=e.useRef(null),a=e.useCallback(async()=>{try{const e=(await chrome.storage.local.get(St))[St];return e&&e.bookmarks?(_t("Loaded pinned bookmarks from cache:",e.bookmarks.length),e.bookmarks):null}catch(e){return null}},[]),i=e.useCallback(async e=>{try{const t={bookmarks:e,timestamp:Date.now()};await chrome.storage.local.set({[St]:t}),_t("Pinned bookmarks cached")}catch(t){}},[]),l=e.useCallback(async(e=!1)=>{if(!e){const e=await a();if(e)return o(e),s({isSyncing:!1,lastSyncAt:Date.now(),error:null}),e}s(e=>({...e,isSyncing:!0,error:null}));try{const e=await Ft(),t=await e.bookmarks.getPinnedBookmarks({page_size:20});if(Nt("Fetch pinned bookmarks response:",{total:t.data?.bookmarks?.length,bookmarks:t.data?.bookmarks?.map(e=>({id:e.id,title:e.title,is_pinned:e.is_pinned}))}),t.data?.bookmarks){const e=t.data.bookmarks.filter(e=>!0===e.is_pinned);_t("Filtered pinned bookmarks:",e.length);const s=e.map(e=>({id:e.id,url:e.url,title:e.title,favicon:e.favicon||void 0,is_pinned:!0}));o(s),await i(s)}return s({isSyncing:!1,lastSyncAt:Date.now(),error:null}),t.data?.bookmarks||[]}catch(t){const e=t instanceof Error?t.message:be("error_sync_failed");return s(t=>({...t,isSyncing:!1,error:e})),[]}},[a,i]),c=e.useCallback(async e=>{if(!e.trim())return[];try{const t=await Ft(),s=await t.bookmarks.searchBookmarks(e,{page_size:10});return(s.data?.bookmarks||[]).map(e=>({id:e.id,url:e.url,title:e.title,favicon:e.favicon||void 0}))}catch{return[]}},[]),d=e.useCallback(async()=>{try{const e=await Ft();return await e.bookmarks.getBookmarks({page_size:1}),!0}catch{return!1}},[]);e.useEffect(()=>{n.current=l},[l]),e.useEffect(()=>{const e=e=>{"REFRESH_PINNED_BOOKMARKS"===e.type&&n.current&&n.current(!0)};return chrome.runtime.onMessage.addListener(e),()=>{chrome.runtime.onMessage.removeListener(e)}},[]);const u=e.useCallback(async e=>{try{const t=e.map(e=>r.find(t=>t.id===e)).filter(e=>void 0!==e);o(t),await i(t);const s=await Ft();await s.bookmarks.reorderPinnedBookmarks(e),_t("Pinned bookmarks order updated and synced")}catch(t){await l(!0)}},[r,i,l]),h=e.useCallback(async e=>{try{const t=await Ft();await t.bookmarks.recordClick(e),Nt("Recorded bookmark click:",e)}catch(t){}},[]),m=e.useCallback(async e=>{try{const t=await Ft();await t.tags.incrementClick(e),Nt("Recorded tag click:",e)}catch(t){}},[]);return{syncState:t,pinnedBookmarks:r,fetchPinnedBookmarks:l,searchBookmarks:c,checkApiConfigured:d,reorderPinnedBookmarks:u,recordBookmarkClick:h,recordTagClick:m}}function Et({icon:e,name:t,size:r="md"}){const o="sm"===r?"w-4 h-4":"w-5 h-5";return s.jsx("img",{src:e,alt:t,className:`${o} object-contain`,onError:e=>{e.currentTarget.style.display="none";const t=e.currentTarget.parentElement;if(t&&!t.querySelector(".fallback-icon")){const e=document.createElement("span");e.className=`fallback-icon ${o} flex items-center justify-center`,e.innerHTML=`<svg class="${o} text-white/60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`,t.appendChild(e)}}})}function zt({current:t,onChange:o}){const[n,a]=e.useState(!1),i=Se.find(e=>e.id===t)||Se[0];return s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>a(!n),className:"flex items-center gap-1.5 px-2 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 active:scale-95 transition-all focus:outline-none focus:ring-2 focus:ring-white/20",children:[s.jsx(Et,{icon:i.icon,name:i.name}),s.jsx(r,{className:"w-3 h-3 text-white/60 transition-transform "+(n?"rotate-180":"")})]}),n&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>a(!1)}),s.jsx("div",{className:"absolute top-full left-0 mt-2 w-40 rounded-xl glass-dark overflow-hidden z-50 animate-scaleIn",children:Se.map(e=>s.jsxs("button",{onClick:()=>{o(e.id),a(!1)},className:"w-full flex items-center gap-3 px-3 py-2.5 text-left transition-colors "+(e.id===t?"bg-white/20":"hover:bg-white/10"),children:[s.jsx(Et,{icon:e.icon,name:e.name}),s.jsx("span",{className:"text-sm text-white/80",children:e.name})]},e.id))})]})]})}function Gt(e,t){if(e)return e;try{const e=new URL(t).hostname;return`${Ce}${e}&sz=64`}catch{return""}}function Tt({engine:t,enableSuggestions:r=!0,onEngineChange:a}){const[i,l]=e.useState(""),[c,d]=e.useState(!1),[u,h]=e.useState([]),[m,p]=e.useState(-1),[g,x]=e.useState(!1),w=e.useRef(null),f=e.useRef(),{shortcuts:b}=jt(),{searchBookmarks:k,recordBookmarkClick:v}=Dt(),y=Se.find(e=>e.id===t)||Se[0],j=e.useCallback(e=>{const t=e.toLowerCase();return b.filter(e=>e.title.toLowerCase().includes(t)||e.url.toLowerCase().includes(t)).slice(0,5).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"shortcut"}))},[b]);e.useEffect(()=>{if(i.trim())return f.current&&clearTimeout(f.current),f.current=setTimeout(async()=>{if(g){const e=j(i),t=(await k(i)).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"bookmark"})),s=[...e];t.forEach(e=>{s.some(t=>t.url===e.url)||s.push(e)}),h(s.slice(0,10))}else if(r){const e=j(i),t=(await k(i)).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"bookmark"})),s=[...e];t.forEach(e=>{s.some(t=>t.url===e.url)||s.push(e)}),h(s.slice(0,8))}},200),()=>{f.current&&clearTimeout(f.current)};h([])},[i,j,k,g,r]);const I=e.useCallback(()=>{if(!i.trim())return;const e=y.url+encodeURIComponent(i.trim());window.location.href=e},[i,y]),_=e=>{"bookmark"===e.source&&v(e.id),window.location.href=e.url},N=(g||r)&&c&&u.length>0;return s.jsxs("div",{className:"relative",children:[s.jsxs("div",{className:`\n          flex items-center gap-3 px-4 py-3 rounded-full\n          glass transition-all duration-200\n          ${c?"ring-2 ring-white/30 bg-white/15":"hover:bg-white/15"}\n        `,children:[a?s.jsx(zt,{current:t,onChange:a}):s.jsx(o,{className:"w-5 h-5 text-white/60 flex-shrink-0"}),s.jsx("input",{ref:w,type:"text",value:i,onChange:e=>{l(e.target.value),p(-1)},onKeyDown:e=>{"Enter"===e.key?m>=0&&u[m]?_(u[m]):g||I():"ArrowDown"===e.key?(e.preventDefault(),p(e=>Math.min(e+1,u.length-1))):"ArrowUp"===e.key?(e.preventDefault(),p(e=>Math.max(e-1,-1))):"Escape"===e.key&&(h([]),p(-1))},onFocus:()=>d(!0),onBlur:()=>setTimeout(()=>d(!1),150),placeholder:g?be("search_bookmark_placeholder"):be("search_engine_placeholder",y.name),className:"flex-1 bg-transparent text-white placeholder-white/50 outline-none text-base"}),s.jsx("button",{onClick:()=>x(!g),className:"p-2 rounded-full transition-all active:scale-90 "+(g?"bg-blue-500/30 text-blue-400":"text-white/40 hover:text-white/70 hover:bg-white/10"),title:be(g?"switch_to_search_engine":"switch_to_bookmark_search"),children:s.jsx(n,{className:"w-4 h-4"})})]}),N&&s.jsx("div",{className:"absolute top-full left-0 right-0 mt-2 rounded-xl glass-dark overflow-hidden animate-scaleIn z-[100]",children:u.map((e,t)=>s.jsxs("button",{onClick:()=>_(e),className:`\n                w-full flex items-center gap-3 px-4 py-3 text-left\n                transition-colors\n                ${t===m?"bg-white/20":"hover:bg-white/10"}\n              `,children:[s.jsx("img",{src:Gt(e.favicon,e.url),alt:"",className:"w-5 h-5 rounded",onError:e=>{e.target.style.display="none"}}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"text-sm text-white truncate",children:e.title}),s.jsx("div",{className:"text-xs text-white/50 truncate",children:e.url})]}),s.jsx("span",{className:"text-xs text-white/30",children:"shortcut"===e.source?be("source_shortcut"):be("source_bookmark")})]},e.id))})]})}const Lt=100,Rt=110,At=120,Mt=1e3,Pt="newtab_weather",$t={sunny:h,cloudy:a,rainy:m,snowy:p,windy:d};function Ot(e){const t=e.toLowerCase();return t.includes("sun")||t.includes("clear")||t.includes("晴")?$t.sunny:t.includes("rain")||t.includes("雨")?$t.rainy:t.includes("snow")||t.includes("雪")?$t.snowy:t.includes("wind")||t.includes("风")?$t.windy:$t.cloudy}const Ut=e.memo(function({item:t,onUpdate:r,onRemove:o,isEditing:n}){const[h,m]=e.useState(null),[p,g]=e.useState(!1),[x,w]=e.useState(null),[f,b]=e.useState(!1),[k,v]=e.useState(""),{rows:y}=Ve(t.size),j=t.config?.weather?.city||"Beijing",I=t.config?.weather?.unit||"C",_=y>=2,N=async(e,t=!1)=>{if(!t)try{const t=(await chrome.storage.local.get(Pt))[Pt];if(t&&t.city===e&&Date.now()-t.data.updateTime<18e5)return void m(t.data)}catch{}g(!0),w(null);try{const t=await fetch(`https://api.vvhan.com/api/weather?city=${encodeURIComponent(e)}`);if(!t.ok)throw new Error(be("widget_weather_fetch_failed"));const s=await t.json();if(!s.success)throw new Error(s.message||be("widget_weather_fetch_failed"));const r={city:s.data.city||e,temp:parseInt(s.data.tem)||0,condition:s.data.wea||be("widget_weather_unknown"),icon:s.data.wea_img||"cloudy",humidity:parseInt(s.data.humidity)||0,windSpeed:parseInt(s.data.win_speed)||0,visibility:10,updateTime:Date.now(),forecast:_&&s.data.forecast?s.data.forecast.slice(0,3).map(e=>({date:e.date,tempMax:parseInt(e.tem_day)||0,tempMin:parseInt(e.tem_night)||0,condition:e.wea||be("widget_weather_unknown"),icon:e.wea_img||"cloudy"})):void 0};m(r),chrome.storage.local.set({[Pt]:{city:e,data:r}})}catch(s){w(s instanceof Error?s.message:be("widget_weather_fetch_failed"))}finally{g(!1)}};e.useEffect(()=>{N(j)},[j]);const S=h?Ot(h.condition):a;return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("button",{onClick:()=>b(!f),className:"flex items-center gap-2 text-white/80 hover:text-white transition-colors",children:[s.jsx(i,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm font-medium",children:h?.city||j})]}),s.jsx("button",{onClick:()=>N(j,!0),disabled:p,className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(l,{className:"w-3 h-3 text-white/50 "+(p?"animate-spin":"")})})]}),f&&s.jsx("div",{className:"mb-2",children:s.jsx("input",{type:"text",value:k,onChange:e=>v(e.target.value),onKeyDown:e=>"Enter"===e.key&&void(k.trim()&&r&&(r(t.id,{config:{...t.config,weather:{...t.config?.weather,city:k.trim()}}}),b(!1),v(""))),placeholder:be("widget_weather_city_placeholder"),className:"w-full bg-white/10 text-white text-xs rounded px-2 py-1 outline-none border border-white/20 focus:border-blue-500/50",autoFocus:!0})}),p&&!h?s.jsx("div",{className:"flex-1 flex items-center justify-center text-white/40 text-sm",children:be("loading")}):x?s.jsx("div",{className:"flex-1 flex items-center justify-center text-red-400 text-sm",children:x}):h?s.jsxs("div",{className:"flex-1 flex flex-col",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[s.jsx(S,{className:"w-12 h-12 text-yellow-400"}),s.jsxs("div",{children:[s.jsxs("div",{className:"text-3xl font-bold text-white",children:[h.temp,"°",I]}),s.jsx("div",{className:"text-sm text-white/60",children:h.condition})]})]}),s.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs text-white/60 mb-3",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(c,{className:"w-3 h-3"}),s.jsxs("span",{children:[h.humidity,"%"]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(d,{className:"w-3 h-3"}),s.jsxs("span",{children:[h.windSpeed,"km/h"]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(u,{className:"w-3 h-3"}),s.jsxs("span",{children:[h.visibility,"km"]})]})]}),_&&h.forecast&&h.forecast.length>0&&s.jsxs("div",{className:"flex-1 border-t border-white/10 pt-2",children:[s.jsx("div",{className:"text-xs text-white/60 mb-2",children:be("widget_weather_forecast")}),s.jsx("div",{className:"space-y-1",children:h.forecast.map((e,t)=>{const r=Ot(e.condition);return s.jsxs("div",{className:"flex items-center justify-between text-xs",children:[s.jsx("span",{className:"text-white/60",children:e.date}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(r,{className:"w-3 h-3 text-white/60"}),s.jsxs("span",{className:"text-white/80",children:[e.tempMax,"° / ",e.tempMin,"°"]})]})]},t)})})]})]}):null]})}),Wt=e.memo(function({item:t,onRemove:r,isEditing:o}){const[n,a]=e.useState(new Date),{rows:i}=Ve(t.size),l=i>=2,c=t.config?.clock||{format:"24h",showDate:!0,showSeconds:!1,showLunar:!1};e.useEffect(()=>{const e=setInterval(()=>a(new Date),1e3);return()=>clearInterval(e)},[]);const d=e.useMemo(()=>{if(!c.showLunar)return null;try{const e=Le.Lunar.fromDate(n),t=e.getMonthInChinese(),s=e.getDayInChinese(),r=e.getFestivals?.()||[],o=e.getJieQi?.()||null;return{date:`${t}月${s}`,festival:r.length>0?r[0]:o||null}}catch{return null}},[n.toDateString(),c.showLunar]);return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col items-center justify-center",children:[s.jsx("div",{className:"text-white font-light tracking-wider "+(l?"text-5xl":"text-3xl"),children:(()=>{let e=n.getHours();const t=n.getMinutes().toString().padStart(2,"0"),s=n.getSeconds().toString().padStart(2,"0");let r="";"12h"===c.format&&(r=e>=12?" PM":" AM",e=e%12||12);let o=`${e.toString().padStart(2,"0")}:${t}`;return c.showSeconds&&(o+=`:${s}`),"12h"===c.format&&(o+=r),o})()}),c.showDate&&s.jsx("div",{className:"text-white/70 "+(l?"text-base mt-2":"text-sm mt-1"),children:(()=>{const e=be(`weekday_${n.getDay()}`);return`${n.getMonth()+1}/${n.getDate()} ${e}`})()}),c.showLunar&&d&&s.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[s.jsx("span",{className:"text-sm text-white/60",children:d.date}),d.festival&&s.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 text-xs text-white/70",children:d.festival})]})]})}),Ht={default:s.jsx(b,{className:"w-8 h-8"}),search:s.jsx(o,{className:"w-8 h-8"}),bookmark:s.jsx(f,{className:"w-8 h-8"}),todo:s.jsx(w,{className:"w-8 h-8"}),notes:s.jsx(x,{className:"w-8 h-8"}),hotsearch:s.jsx(g,{className:"w-8 h-8"})},Kt=e=>({default:be("empty_default"),search:be("empty_search"),bookmark:be("empty_bookmark"),todo:be("empty_todo"),notes:be("empty_notes"),hotsearch:be("empty_hotsearch")}[e]);function Yt({type:e="default",message:t,description:r}){return s.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-white/40",children:[s.jsx("div",{className:"mb-2 opacity-50",children:Ht[e]}),s.jsx("p",{className:"text-sm",children:t||Kt(e)}),r&&s.jsx("p",{className:"text-xs text-white/30 mt-1",children:r})]})}const Xt="newtab_todos",qt=t((e,t)=>({todos:[],loadTodos:async()=>{try{const t=(await chrome.storage.local.get(Xt))[Xt];t&&e({todos:t})}catch(t){}},addTodo:s=>{const{todos:r}=t(),o=[{id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,text:s,completed:!1,createdAt:Date.now()},...r];e({todos:o}),chrome.storage.local.set({[Xt]:o})},toggleTodo:s=>{const{todos:r}=t(),o=r.map(e=>e.id===s?{...e,completed:!e.completed}:e);e({todos:o}),chrome.storage.local.set({[Xt]:o})},removeTodo:s=>{const{todos:r}=t(),o=r.filter(e=>e.id!==s);e({todos:o}),chrome.storage.local.set({[Xt]:o})},clearCompleted:()=>{const{todos:s}=t(),r=s.filter(e=>!e.completed);e({todos:r}),chrome.storage.local.set({[Xt]:r})}}));qt.getState().loadTodos();const Vt=e.memo(function({item:t,onRemove:r,isEditing:o}){const{todos:n,addTodo:a,toggleTodo:i,removeTodo:l}=qt(),[c,d]=e.useState(""),[u,h]=e.useState(!1),{rows:m}=Ve(t.size),p=()=>{c.trim()&&(a(c.trim()),d(""))},g=n.filter(e=>!e.completed),x=n.filter(e=>e.completed),f=u?n:g,b=m<=2?4:m<=3?6:10;return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2 text-white/80",children:[s.jsx(w,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm font-medium",children:be("widget_todo_title")}),g.length>0&&s.jsx("span",{className:"px-1.5 py-0.5 text-xs bg-white/20 rounded-full",children:g.length})]}),x.length>0&&s.jsx("button",{onClick:()=>h(!u),className:"text-xs text-white/50 hover:text-white/80 transition-colors",children:u?be("widget_todo_hide"):`${x.length} ${be("widget_todo_completed")}`})]}),s.jsxs("div",{className:"flex gap-2 mb-2",children:[s.jsx("input",{type:"text",value:c,onChange:e=>d(e.target.value),onKeyDown:e=>{"Enter"===e.key&&p()},placeholder:be("widget_todo_placeholder"),className:"flex-1 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none \r\n                     border border-white/10 focus:border-white/30 placeholder-white/40"}),s.jsx("button",{onClick:p,className:"p-1.5 rounded-xl bg-white/10 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-white/20",children:s.jsx(k,{className:"w-4 h-4 text-white/70"})})]}),s.jsxs("div",{className:"flex-1 space-y-1 overflow-y-auto",children:[0===f.length?s.jsx(Yt,{type:"todo"}):f.slice(0,b).map(e=>s.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded-lg hover:bg-white/10 group/item transition-colors "+(e.completed?"opacity-50":""),children:[s.jsx("button",{onClick:()=>i(e.id),className:"w-4 h-4 rounded-full border flex items-center justify-center transition-colors flex-shrink-0 "+(e.completed?"bg-green-500/50 border-green-500/50":"border-white/30 hover:border-white/50"),children:e.completed&&s.jsx(v,{className:"w-2.5 h-2.5 text-white"})}),s.jsx("span",{className:"flex-1 text-sm text-white/80 truncate "+(e.completed?"line-through":""),children:e.text}),s.jsx("button",{onClick:()=>l(e.id),className:"p-0.5 rounded opacity-0 group-hover/item:opacity-100 hover:bg-white/20 transition-all",children:s.jsx(y,{className:"w-3 h-3 text-white/50"})})]},e.id)),f.length>b&&s.jsx("div",{className:"text-center text-white/40 text-xs py-1",children:be("widget_todo_more",[(f.length-b).toString()])})]})]})}),Jt="newtab_notes",Qt=e.memo(function({item:t,onRemove:r,isEditing:o}){const[n,a]=e.useState(""),[i,l]=e.useState(!1),c=e.useRef(null),d=e.useRef();e.useEffect(()=>{chrome.storage.local.get(Jt).then(e=>{const t=e[Jt];t?.content&&a(t.content)})},[]);return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2 text-white/80",children:[s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm font-medium",children:be("widget_notes_title")})]}),i&&s.jsx("span",{className:"text-xs text-white/40",children:be("btn_saving")})]}),s.jsx("textarea",{ref:c,value:n,onChange:e=>{return t=e.target.value,a(t),l(!0),d.current&&clearTimeout(d.current),void(d.current=setTimeout(()=>{chrome.storage.local.set({[Jt]:{content:t,updatedAt:Date.now()}}),l(!1)},500));var t},placeholder:be("widget_notes_placeholder"),className:"flex-1 w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none \r\n                   border border-white/10 focus:border-white/30 placeholder-white/40 resize-none"})]})}),Zt="newtab_hotsearch",es={baidu:"https://api.vvhan.com/api/hotlist/baiduRD",weibo:"https://api.vvhan.com/api/hotlist/wbHot",zhihu:"https://api.vvhan.com/api/hotlist/zhihuHot",bilibili:"https://api.vvhan.com/api/hotlist/bili"},ts=e.memo(function({item:t,onUpdate:o,onRemove:n,isEditing:a}){const[i,c]=e.useState([]),[d,u]=e.useState(!1),[h,m]=e.useState(!1),{rows:p}=Ve(t.size),g=t.config?.hotsearch?.type||"baidu",x=Be.find(e=>e.id===g)||Be[0],w=p<=2?5:p<=3?10:15,f=async(e=!1)=>{if(!e)try{const e=(await chrome.storage.local.get(Zt))[Zt];if(e&&e.type===g&&Date.now()-e.timestamp<6e5)return void c(e.items)}catch{}u(!0);try{const e=await fetch(es[g]),t=await e.json();let s=[];t.success&&t.data&&(s=t.data.slice(0,15).map(e=>({title:e.title||e.name||e.desc,hot:e.hot||e.hotValue||e.index||"",url:e.url||e.link||"#"}))),c(s),chrome.storage.local.set({[Zt]:{type:g,items:s,timestamp:Date.now()}})}catch(t){}finally{u(!1)}};e.useEffect(()=>{f()},[g]);return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(I,{className:"w-4 h-4 text-orange-400"}),s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>m(!h),className:"text-sm font-medium text-white/80 hover:text-white flex items-center gap-1",children:[Fe(x.id),s.jsx(r,{className:"w-3 h-3 transition-transform "+(h?"rotate-180":"")})]}),h&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>m(!1)}),s.jsx("div",{className:"absolute top-full left-0 mt-1 w-24 rounded-lg glass-dark overflow-hidden z-50",children:Be.map(e=>s.jsx("button",{onClick:()=>{return s=e.id,o?.(t.id,{config:{...t.config,hotsearch:{type:s}}}),void m(!1);var s},className:"w-full px-3 py-1.5 text-left text-sm transition-colors "+(e.id===g?"bg-white/20 text-white":"text-white/70 hover:bg-white/10"),children:Fe(e.id)},e.id))})]})]})]}),s.jsx("button",{onClick:()=>f(!0),disabled:d,className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(l,{className:"w-3 h-3 text-white/50 "+(d?"animate-spin":"")})})]}),s.jsx("div",{className:"flex-1 space-y-0.5 overflow-y-auto",children:0===i.length?d?s.jsx("div",{className:"text-center text-white/40 text-sm py-4",children:be("loading")}):s.jsx(Yt,{type:"hotsearch"}):i.slice(0,w).map((e,t)=>s.jsxs("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-1.5 rounded-lg hover:bg-white/10 transition-colors group/item",children:[s.jsx("span",{className:"w-4 h-4 flex items-center justify-center text-xs font-bold rounded flex-shrink-0 "+(t<3?"bg-orange-500/80 text-white":"bg-white/10 text-white/60"),children:t+1}),s.jsx("span",{className:"flex-1 text-sm text-white/80 truncate group-hover/item:text-white",children:e.title}),s.jsx(_,{className:"w-3 h-3 text-white/30 opacity-0 group-hover/item:opacity-100 flex-shrink-0"})]},t))})]})}),ss="newtab_poetry",rs=e.memo(function({item:t,onRemove:r,isEditing:o}){const[n,a]=e.useState(null),{rows:i}=Ve(t.size),c=i>=2,d=()=>{const e=Math.floor(Math.random()*De.length),t=De[e];a(t);const s=(new Date).toDateString();chrome.storage.local.set({[ss]:{poetry:t,date:s}})};return e.useEffect(()=>{chrome.storage.local.get(ss).then(e=>{const t=e[ss],s=(new Date).toDateString();t&&t.date===s?a(t.poetry):d()})},[]),n?s.jsx("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col items-center justify-center",children:c?s.jsxs("div",{className:"flex flex-col items-center gap-2 text-center",children:[s.jsx(N,{className:"w-5 h-5 text-white/60"}),s.jsxs("p",{className:"text-base text-white/90 font-light tracking-wide",children:["「",n.content,"」"]}),s.jsxs("p",{className:"text-sm text-white/60",children:["—— ",n.author,"《",n.title,"》"]}),s.jsx("button",{onClick:d,className:"mt-2 p-1.5 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all",title:be("widget_poetry_refresh"),children:s.jsx(l,{className:"w-3 h-3 text-white/50"})})]}):s.jsxs("div",{className:"flex items-center gap-2 w-full",children:[s.jsxs("div",{className:"flex-1 text-center",children:[s.jsxs("span",{className:"text-sm text-white/80 font-light tracking-wide",children:["「",n.content,"」"]}),s.jsxs("span",{className:"text-xs text-white/50 ml-2",children:["—— ",n.author]})]}),s.jsx("button",{onClick:d,className:"p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all flex-shrink-0",title:be("widget_poetry_refresh"),children:s.jsx(l,{className:"w-3 h-3 text-white/50"})})]})}):null});async function os(e,t=10){try{if(e.size<=1024*t)return await async function(e){return new Promise((t,s)=>{const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=s,r.readAsDataURL(e)})}(e);const s=new Image,r=URL.createObjectURL(e);await new Promise((e,t)=>{s.onload=e,s.onerror=t,s.src=r});const o=document.createElement("canvas"),n=o.getContext("2d");if(!n)return null;o.width=s.width,o.height=s.height,n.drawImage(s,0,0);let a=.8,i="";for(;a>.1;){i=o.toDataURL("image/jpeg",a);if(3*i.length/4/1024<=t)break;a-=.1}URL.revokeObjectURL(r);return 3*i.length/4/1024>1.5*t?null:i}catch(s){return null}}async function ns(e,t=10){try{const s=`https://icon.ooo/${new URL(e).hostname}?size=32&v=${Date.now()}`,r=await fetch(s);if(!r.ok)return null;const o=await r.blob();if(o.size<100)return null;return await os(o,t)}catch(s){return null}}function as(e){if(e.faviconBase64)return e.faviconBase64;if(e.favicon&&(!e.favicon.includes("icon.ooo")||!e.favicon.includes("&sz=")))return e.favicon;try{const t=new URL(e.url),s="undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"",r=!s.includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id,o="undefined"!=typeof location?location.href:"",n=o.includes("/src/newtab/")||o.includes("/newtab/");if(r&&n)return`chrome://favicon2/?size=64&page_url=${encodeURIComponent(t.href)}`;return`https://icon.ooo/${t.hostname}?size=64&v=1`}catch{return""}}const is=Object.freeze(Object.defineProperty({__proto__:null,batchDownloadFavicons:async function(e,t){const s=new Map;let r=0;for(const o of e){if(o.faviconBase64){r++,t?.(r,e.length);continue}const n=await ns(o.url);n&&s.set(o.id,n),r++,t?.(r,e.length),await new Promise(e=>setTimeout(e,100))}return s},downloadFavicon:ns,getFaviconUrl:as},Symbol.toStringTag,{value:"Module"}));function ls({shortcut:t}){const r=as(t),[o,n]=e.useState(r),[a,i]=e.useState(!1),l=e.useRef(!1),c=e.useRef(!1),d=((t.title||t.url||"?").trim().charAt(0)||"?").toUpperCase(),u=e.useCallback(()=>{const e="undefined"!=typeof location?location.href:"",s=e.includes("/src/newtab/")||e.includes("/newtab/");if(!("undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"").includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id&&s&&!l.current){l.current=!0;try{const e=`chrome://favicon2/?size=64&page_url=${encodeURIComponent(t.url)}`;if(e!==o)return n(e),void i(!1)}catch{}}if(!c.current){c.current=!0;try{const e=`https://icon.ooo/${new URL(t.url).hostname}?size=64&v=1`;if(e!==o)return n(e),void i(!1)}catch{}}i(!0)},[o,t.url]);return e.useEffect(()=>{n(r),i(!1),l.current=r.startsWith("chrome://favicon2/"),c.current=r.includes("icon.ooo")},[r]),s.jsx("div",{className:"aspect-square rounded-[4px] overflow-hidden liquid-glass-mini flex items-center justify-center",children:!a&&o?s.jsx("img",{src:o,alt:"",className:"w-full h-full object-cover rounded-[4px]",onError:u}):s.jsx("span",{className:"text-[8px] font-bold text-white/80",children:d})})}const cs={shortcut:e.memo(function({item:t,onRemove:r,isEditing:o,isBatchMode:n,isSelected:a,onToggleSelect:i,shortcutStyle:l="icon"}){const c=t.shortcut;if(!c)return null;const d=(c.title||"").trim()||(c.url||"").trim(),u=e=>{if(!o)return n?(e.preventDefault(),e.stopPropagation(),void i?.(t.id)):void 0;e.preventDefault()},h=as(c),[m,p]=e.useState(h),[g,x]=e.useState(!1),[w,f]=e.useState(!0),b=e.useRef(null),k=e.useRef(!1),v=e.useRef(!1),y=e.useCallback(()=>f(!1),[]),j=e.useCallback(()=>{const e="undefined"!=typeof location?location.href:"",t=e.includes("/src/newtab/")||e.includes("/newtab/");if(!("undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"").includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id&&t&&!k.current){k.current=!0;try{const e=`chrome://favicon2/?size=64&page_url=${encodeURIComponent(c.url)}`;if(e!==m)return p(e),x(!1),void f(!0)}catch{}}if(!v.current){v.current=!0;try{const e=`https://icon.ooo/${new URL(c.url).hostname}?size=64&v=1`;if(e!==m)return p(e),x(!1),void f(!0)}catch{}}x(!0),f(!1)},[m,c.url]);e.useEffect(()=>{p(h),x(!1),f(!0),k.current=h.startsWith("chrome://favicon2/"),v.current=h.includes("icon.ooo")},[h]),e.useEffect(()=>{const e=b.current;if(!e)return;const t=t=>{const s=e.getBoundingClientRect(),r=(t.clientX-s.left)/s.width*100,o=(t.clientY-s.top)/s.height*100;e.style.setProperty("--mouse-x",`${r}%`),e.style.setProperty("--mouse-y",`${o}%`)};return e.addEventListener("mousemove",t),()=>e.removeEventListener("mousemove",t)},[]);const I=(d.charAt(0)||"?").toUpperCase(),_=o||n?"div":"a",N=o||n?{role:"link",tabIndex:0}:{href:c.url};if("card"===l)return s.jsxs(_,{...N,onClick:u,className:"group relative flex items-center gap-3 h-full p-3 rounded-xl glass-card transition-all duration-200 cursor-pointer hover:scale-[1.02] active:scale-[0.98]",children:[n&&s.jsx("div",{className:"absolute top-2 right-2 z-30",children:a?s.jsx("div",{className:"w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center",children:s.jsx("svg",{className:"w-2.5 h-2.5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):s.jsx("div",{className:"w-4 h-4 rounded-full border border-white/40 bg-black/20"})}),s.jsxs("div",{ref:b,className:"relative flex-shrink-0 rounded-lg overflow-hidden",style:{width:"40px",height:"40px"},children:[w&&!g&&m&&s.jsx("div",{className:"absolute inset-0 bg-white/10 animate-pulse rounded-lg"}),!g&&m?s.jsx("img",{src:m,alt:d,draggable:!1,onDragStart:e=>e.preventDefault(),className:"w-full h-full object-cover transition-opacity duration-200 "+(w?"opacity-0":"opacity-100"),onLoad:y,onError:j}):s.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white/10 rounded-lg",children:s.jsx("span",{className:"text-sm font-medium text-white/80",children:I})})]}),s.jsx("span",{className:"flex-1 text-sm text-white truncate",title:d,children:d})]});return s.jsxs(_,{...N,onClick:u,className:"group relative flex flex-col items-center justify-start h-full pt-2 px-2 rounded-xl transition-all duration-200 cursor-pointer",children:[s.jsxs("div",{ref:b,className:"relative liquid-glass-icon rounded-[12px] overflow-hidden hover:scale-110 active:scale-95 transition-all duration-200",style:{width:"56px",height:"56px"},children:[s.jsx("div",{className:"glass-refraction"}),n&&s.jsx("div",{className:"absolute top-1 right-1 z-30",children:a?s.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-blue-500 flex items-center justify-center",children:s.jsx("svg",{className:"w-2 h-2 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):s.jsx("div",{className:"w-3.5 h-3.5 rounded-full border border-white/40 bg-black/20"})}),w&&!g&&m&&s.jsx("div",{className:"absolute inset-0 z-20 bg-white/10 animate-pulse rounded-[12px]"}),!g&&m?s.jsx("img",{src:m,alt:d,draggable:!1,onDragStart:e=>{e.preventDefault()},className:"w-full h-full object-cover relative z-10 transition-opacity duration-200 "+(w?"opacity-0":"opacity-100"),onLoad:y,onError:j}):s.jsx("div",{className:"w-full h-full flex items-center justify-center relative z-10",children:s.jsx("span",{className:"text-lg font-medium text-white/80",children:I})})]}),s.jsx("span",{className:"mt-1.5 text-xs text-white truncate max-w-full px-1 drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]",title:d,style:{textShadow:"0 1px 3px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.5)"},children:d})]})}),bookmarkFolder:e.memo(function({item:t,onRemove:r,isEditing:o,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l}){const{setCurrentFolderId:c,gridItems:d}=jt(),u=t.bookmarkFolder?.title||be("default_folder_name"),h=e.useRef(null),m=e.useMemo(()=>d.filter(e=>(e.parentId??null)===t.id&&"shortcut"===e.type&&!!e.shortcut?.url).sort((e,t)=>e.position-t.position).slice(0,9).map(e=>e.shortcut),[d,t.id]);e.useEffect(()=>{const e=h.current;if(!e)return;const t=t=>{const s=e.getBoundingClientRect(),r=(t.clientX-s.left)/s.width*100,o=(t.clientY-s.top)/s.height*100;e.style.setProperty("--mouse-x",`${r}%`),e.style.setProperty("--mouse-y",`${o}%`)};return e.addEventListener("mousemove",t),()=>e.removeEventListener("mousemove",t)},[]);return s.jsxs("button",{type:"button",onClick:e=>o?(e.preventDefault(),void e.stopPropagation()):a?(e.preventDefault(),e.stopPropagation(),void l?.(t.id)):(e.preventDefault(),void n?.(t.id)),onDoubleClick:e=>{e.preventDefault(),e.stopPropagation(),n?n(t.id):c(t.id)},className:"group relative flex flex-col items-center justify-start h-full pt-2 px-2 rounded-xl transition-all duration-200 cursor-pointer w-full","aria-label":u,children:[s.jsxs("div",{ref:h,className:"relative liquid-glass-folder rounded-[12px] overflow-hidden hover:scale-110 active:scale-95 transition-all duration-200",style:{width:"56px",height:"56px"},children:[s.jsx("div",{className:"glass-refraction"}),a&&s.jsx("div",{className:"absolute top-1 right-1 z-30",children:i?s.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-blue-500 flex items-center justify-center",children:s.jsx("svg",{className:"w-2 h-2 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):s.jsx("div",{className:"w-3.5 h-3.5 rounded-full border border-white/40 bg-black/20"})}),m.length>0?s.jsxs("div",{className:"w-full h-full grid grid-cols-3 gap-0.5 content-start relative z-10",children:[m.slice(0,9).map((e,r)=>s.jsx(ls,{shortcut:e},`${t.id}-thumb-${r}`)),Array.from({length:Math.max(0,9-m.length)}).map((e,t)=>s.jsx("div",{className:"aspect-square rounded-[4px] bg-white/5"},`empty-${t}`))]}):s.jsx("div",{className:"w-full h-full flex items-center justify-center relative z-10",children:s.jsx(S,{className:"w-6 h-6 text-white/60"})})]}),s.jsx("span",{className:"mt-1.5 text-xs text-white truncate max-w-full px-1 drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]",style:{textShadow:"0 1px 3px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.5)"},children:u})]})}),weather:Ut,clock:Wt,todo:Vt,notes:Qt,hotsearch:ts,poetry:rs},ds=e.memo(function({item:e,onUpdate:t,onRemove:r,isEditing:o=!1,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l,shortcutStyle:c}){const d=cs[e.type],{cols:u,rows:h}=Ve(e.size);return d?s.jsx("div",{className:"widget-container h-full",style:{gridColumn:`span ${u}`,gridRow:`span ${h}`},children:s.jsx(d,{item:e,onUpdate:t,onRemove:r,isEditing:o,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l,shortcutStyle:c})}):s.jsxs("div",{className:"flex items-center justify-center h-full text-white/50",children:["未知组件类型: ",e.type]})}),us=e=>({"1x1":be("widget_size_small"),"2x1":be("widget_size_wide"),"1x2":be("widget_size_tall"),"2x2":be("widget_size_medium"),"2x3":be("widget_size_large"),"2x4":be("widget_size_xlarge")}[e]),hs=e.memo(function({item:t,isOpen:r,onClose:o,onUpdate:n,onRemove:a}){const[i,l]=e.useState(t.config||{}),c=Xe[t.type];if(!r)return null;const d=(e,s)=>{const r={...i,[t.type]:{...i[t.type],...s}};l(r),n(t.id,{config:r})};return C.createPortal(s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm animate-fadeIn",onClick:o}),s.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[110] w-[360px] max-w-[90vw]",style:{animation:"modalScale 0.2s ease-out"},children:s.jsxs("div",{className:"glass-modal rounded-2xl p-5 border border-white/10",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("h3",{className:"text-base font-medium text-white",children:[c.name," ",be("widget_settings")]}),s.jsx("button",{onClick:o,className:"p-1.5 rounded-xl hover:bg-white/10 transition-colors focus:outline-none focus:ring-2 focus:ring-white/20",children:s.jsx(y,{className:"w-4 h-4 text-white/60"})})]}),s.jsxs("div",{className:"space-y-4",children:[c.sizeConfig.allowedSizes.length>1&&s.jsxs("div",{children:[s.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[s.jsx(B,{className:"w-4 h-4"}),be("widget_size")]}),s.jsx("div",{className:"grid grid-cols-3 gap-2",children:c.sizeConfig.allowedSizes.map(e=>{const{cols:r,rows:o}=Ve(e);return s.jsxs("button",{onClick:()=>(e=>{n(t.id,{size:e})})(e),className:"p-2 rounded-lg border transition-all "+(t.size===e?"bg-blue-500/30 border-blue-500/50 text-white":"bg-white/5 border-white/10 text-white/70 hover:bg-white/10"),children:[s.jsx("div",{className:"flex justify-center mb-1",children:s.jsx("div",{className:"grid gap-0.5",style:{gridTemplateColumns:`repeat(${r}, 8px)`,gridTemplateRows:`repeat(${o}, 8px)`},children:Array.from({length:r*o}).map((r,o)=>s.jsx("div",{className:"rounded-sm "+(t.size===e?"bg-blue-400":"bg-white/40")},o))})}),s.jsx("span",{className:"text-xs",children:us(e)})]},e)})})]}),"clock"===t.type&&s.jsx(ms,{config:i.clock||{},onChange:e=>d(0,e)}),"weather"===t.type&&s.jsx(ps,{config:i.weather||{},onChange:e=>d(0,e)}),"todo"===t.type&&s.jsx(gs,{config:i.todo||{},onChange:e=>d(0,e)}),s.jsx("button",{onClick:()=>{a(t.id),o()},className:"w-full py-2 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors text-sm focus:outline-none focus:ring-2 focus:ring-red-500/30",children:be("widget_delete")})]})]})})]}),document.body)});function ms({config:e,onChange:t}){return s.jsxs("div",{className:"space-y-3",children:[s.jsx(xs,{label:be("widget_show_date"),checked:!1!==e.showDate,onChange:e=>t({showDate:e})}),s.jsx(xs,{label:be("widget_show_seconds"),checked:!0===e.showSeconds,onChange:e=>t({showSeconds:e})}),s.jsx(xs,{label:be("widget_show_lunar"),checked:!0===e.showLunar,onChange:e=>t({showLunar:e})}),s.jsx(ws,{label:be("widget_time_format"),value:e.format||"24h",options:[{value:"24h",label:be("widget_24h")},{value:"12h",label:be("widget_12h")}],onChange:e=>t({format:e})})]})}function ps({config:e,onChange:t}){return s.jsx("div",{className:"space-y-3",children:s.jsx(ws,{label:be("widget_temp_unit"),value:e.unit||"C",options:[{value:"C",label:be("widget_celsius")},{value:"F",label:be("widget_fahrenheit")}],onChange:e=>t({unit:e})})})}function gs({config:e,onChange:t}){return s.jsx("div",{className:"space-y-3",children:s.jsx(xs,{label:be("widget_show_completed"),checked:!0===e.showCompleted,onChange:e=>t({showCompleted:e})})})}function xs({label:e,checked:t,onChange:r}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("button",{onClick:()=>r(!t),className:"w-9 h-5 rounded-full transition-colors "+(t?"bg-blue-500":"bg-white/20"),children:s.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-white transition-transform mx-0.5 "+(t?"translate-x-4":"translate-x-0")})})]})}function ws({label:e,value:t,options:r,onChange:o}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("select",{value:t,onChange:e=>o(e.target.value),className:"bg-white/10 text-white text-sm rounded-lg px-2 py-1 outline-none border border-white/10",children:r.map(e=>s.jsx("option",{value:e.value,className:"bg-gray-800",children:e.label},e.value))})]})}function fs({isOpen:t,title:r,message:o,actions:n,cancelText:a,onCancel:i}){const[l,c]=e.useState(!1),d=a||be("btn_cancel");if(e.useEffect(()=>{t?requestAnimationFrame(()=>c(!0)):c(!1)},[t]),e.useEffect(()=>{if(!t)return;const e=e=>{"Escape"===e.key&&i()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,i]),!t)return null;const u=()=>{c(!1),setTimeout(i,150)};return C.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-end justify-center px-2 pb-24 transition-all duration-200 "+(l?"bg-black/60 backdrop-blur-sm opacity-100":"opacity-0"),style:{zIndex:Lt+10},onClick:u,children:s.jsxs("div",{role:"dialog","aria-label":r||be("ui_action"),className:"w-full max-w-[400px] transition-all duration-300 ease-out "+(l?"opacity-100 translate-y-0":"opacity-0 translate-y-4"),style:{zIndex:Rt+10},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"backdrop-blur-xl rounded-[14px] overflow-hidden mb-2",style:{backgroundColor:"var(--ios-sheet-bg)"},children:[(r||o)&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"px-4 py-4 text-center",children:[r&&s.jsx("h3",{className:"text-[13px] font-semibold mb-0.5",style:{color:"var(--ios-text-muted)"},children:r}),o&&s.jsx("p",{className:"text-[13px] leading-relaxed",style:{color:"var(--ios-text-muted)"},children:o})]}),s.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}})]}),n.map((e,t)=>s.jsxs("div",{children:[s.jsx("button",{type:"button",onClick:()=>(e=>{c(!1),setTimeout(()=>e.onClick(),150)})(e),className:"w-full py-[18px] text-[20px] font-normal transition-colors",style:{color:"danger"===e.variant?"var(--ios-action-danger)":"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:e.label}),t<n.length-1&&s.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}})]},t))]}),s.jsx("div",{className:"backdrop-blur-xl rounded-[14px] overflow-hidden",style:{backgroundColor:"var(--ios-sheet-bg)"},children:s.jsx("button",{type:"button",onClick:u,"aria-label":d,className:"w-full py-[18px] text-[20px] font-semibold transition-colors focus:outline-none",style:{color:"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:d})})]})}),document.body)}function bs({isOpen:t,title:r,message:o,confirmText:n,cancelText:a,confirmVariant:i="default",onConfirm:l,onCancel:c}){const[d,u]=e.useState(!1),h=n||be("btn_confirm"),m=a||be("btn_cancel");if(e.useEffect(()=>{t?requestAnimationFrame(()=>u(!0)):u(!1)},[t]),e.useEffect(()=>{if(!t)return;const e=e=>{"Escape"===e.key&&c()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,c]),!t)return null;const p=()=>{u(!1),setTimeout(c,150)};return C.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4 transition-all duration-200 "+(d?"bg-black/60 backdrop-blur-md opacity-100":"opacity-0"),style:{zIndex:Lt+10},onClick:p,children:s.jsx("div",{role:"alertdialog","aria-labelledby":"confirm-title","aria-describedby":"confirm-message",className:"relative w-full max-w-[280px] rounded-[14px] overflow-hidden transition-all duration-200 ease-out "+(d?"opacity-100 scale-100":"opacity-0 scale-95"),style:{zIndex:Rt+10},onClick:e=>e.stopPropagation(),children:s.jsxs("div",{className:"backdrop-blur-xl",style:{backgroundColor:"var(--ios-sheet-bg)"},children:[s.jsxs("div",{className:"px-4 pt-5 pb-4 text-center",children:[s.jsx("h3",{id:"confirm-title",className:"text-[17px] font-semibold mb-1",style:{color:"var(--ios-text-primary)"},children:r}),s.jsx("p",{id:"confirm-message",className:"text-[13px] leading-relaxed",style:{color:"var(--ios-text-secondary)"},children:o})]}),s.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}}),s.jsxs("div",{className:"flex",children:[s.jsx("button",{type:"button",onClick:p,"aria-label":m,className:"flex-1 py-[11px] text-[17px] font-normal transition-colors focus:outline-none",style:{color:"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:m}),s.jsx("div",{className:"w-px",style:{backgroundColor:"var(--ios-divider)"}}),s.jsx("button",{type:"button",onClick:()=>{u(!1),setTimeout(l,150)},"aria-label":h,className:"flex-1 py-[11px] text-[17px] font-semibold transition-colors focus:outline-none",style:{color:"danger"===i?"var(--ios-action-danger)":"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:h})]})]})})}),document.body)}function ks({item:e,onOpenFolder:t,isBatchMode:r,isSelected:o,onToggleSelect:n}){const{attributes:a,listeners:i,setNodeRef:l,transform:c,transition:d,isDragging:u}=Me({id:e.id}),h={transform:z.Transform.toString(c),transition:d,opacity:u?.5:1};return s.jsx("div",{ref:l,style:h,...a,...i,onPointerUp:t=>{r&&n&&(u||(t.preventDefault(),t.stopPropagation(),n(e.id)))},className:"touch-none cursor-grab active:cursor-grabbing",children:s.jsx("div",{className:"h-[88px] w-[80px]",children:s.jsx(ds,{item:e,onOpenFolder:t,isEditing:!0,isBatchMode:r,isSelected:o,onToggleSelect:n})})})}function vs({folder:t,items:r,isOpen:o,onClose:n,onOpenFolder:a,isBatchMode:i,batchSelectedIds:l,onBatchSelectedIdsChange:c}){const{removeGridFolder:d,updateGridItem:u,browserBookmarksRootId:h,homeBrowserFolderId:m}=jt(),[p,g]=e.useState(!1),[x,w]=e.useState(t.bookmarkFolder?.title||be("folder_default_name")),[f,b]=e.useState(!1),[k,v]=e.useState(!1),[j,I]=e.useState(!1),[_,N]=e.useState(t.parentId??null),S=e.useRef(null),B=e.useRef(null),z=!!t.browserBookmarkId,G=e.useMemo(()=>`folder-modal:${t.id}`,[t.id]),T=e.useMemo(()=>`folder-modal-outside:${t.id}`,[t.id]),L=e.useMemo(()=>`folder-modal-undock-parent:${t.id}:${_??"root"}`,[t.id,_]),{setNodeRef:R,isOver:A}=F({id:G}),{setNodeRef:M,isOver:P}=F({id:T}),{setNodeRef:$,isOver:O}=F({id:L,disabled:!1});if(e.useEffect(()=>{if(!o)return;requestAnimationFrame(()=>g(!0));const e=e=>{"Escape"===e.key&&n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[o,n]),e.useEffect(()=>{o&&(w(t.bookmarkFolder?.title||be("folder_default_name")),b(!1))},[t.bookmarkFolder?.title,o]),e.useEffect(()=>{N(t.parentId??null)},[t.parentId]),e.useEffect(()=>{o&&t.browserBookmarkId&&null===(t.parentId??null)&&"undefined"!=typeof chrome&&chrome.bookmarks&&(async()=>{try{const e=await chrome.bookmarks.get(t.browserBookmarkId),s=e?.[0],r=s?.parentId??null;if(!r)return;if(r===h||r===m)return void N(null);const o=jt.getState(),n=t.groupId&&"home"!==t.groupId?o.shortcutGroups.find(e=>e.id===t.groupId)?.bookmarkFolderId:void 0;if(n&&r===n)return void N(null);N(`bb-${r}`)}catch{}})()},[o,t.browserBookmarkId,t.parentId,t.groupId,h,m]),e.useEffect(()=>{f&&S.current&&(S.current.focus(),S.current.select())},[f]),e.useEffect(()=>{o||g(!1)},[o]),!o)return null;const U=_?be("folder_parent_hint_up"):t.groupId&&"home"!==t.groupId?be("folder_parent_hint_group"):be("folder_parent_hint_home"),W=()=>{b(!1);const e=x.trim(),s=t.bookmarkFolder?.title||be("folder_default_name");e&&e!==s?u(t.id,{bookmarkFolder:{...t.bookmarkFolder??{},title:e}}):w(s)},H=()=>{g(!1),setTimeout(n,200)};return C.createPortal(s.jsxs("div",{"data-folder-modal":"1",ref:M,className:`fixed inset-0 flex items-center justify-center p-4 transition-all duration-200 ${p?"bg-black/60 backdrop-blur-md opacity-100":"opacity-0"} ${P?"bg-black/70":""}`,style:{zIndex:Lt},onMouseDown:e=>{e.target===e.currentTarget&&H()},children:[s.jsxs("div",{role:"dialog","aria-label":x,className:"liquid-glass rounded-3xl w-full max-w-2xl shadow-2xl transition-all duration-200 ease-[cubic-bezier(0.33,1,0.68,1)] "+(p?"opacity-100 scale-100":"opacity-0 scale-95"),style:{zIndex:Rt},children:[s.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-white/10",children:[s.jsx("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:f?s.jsx("input",{ref:S,type:"text",value:x,onChange:e=>w(e.target.value),onBlur:W,onKeyDown:e=>{"Enter"===e.key&&W(),"Escape"===e.key&&(w(t.bookmarkFolder?.title||be("folder_default_name")),b(!1))},className:"liquid-glass-mini border border-white/30 rounded-lg px-3 py-1.5 text-white text-lg font-medium focus:outline-none focus:ring-2 focus:ring-white/40 w-full max-w-[320px] transition-all"}):s.jsxs("button",{type:"button",onClick:()=>b(!0),className:"text-lg font-medium text-white truncate flex items-center gap-2 hover:text-blue-300 transition-colors",title:be("folder_click_rename"),children:[s.jsx("span",{className:"truncate",children:x}),s.jsx(D,{className:"w-4 h-4 opacity-60"})]})}),s.jsxs("div",{className:"flex items-center gap-2",children:[!z&&s.jsx("button",{type:"button",onClick:()=>{z||v(!0)},className:"p-2 rounded-full hover:bg-white/10 transition-colors text-red-400","aria-label":be("folder_delete"),title:be("folder_delete"),children:s.jsx(E,{className:"w-5 h-5"})}),s.jsx("button",{type:"button",onClick:H,className:"p-2 rounded-full hover:bg-white/10 transition-colors","aria-label":be("options_close"),children:s.jsx(y,{className:"w-5 h-5 text-white/70"})})]})]}),s.jsxs("div",{className:"px-6 py-5",children:[s.jsx("div",{ref:R,className:"rounded-2xl p-4 transition-colors "+(A?"bg-white/10":"bg-white/5"),children:s.jsx(Re,{items:r.map(e=>e.id),strategy:Ae,children:s.jsx("div",{ref:B,onWheel:e=>{const t=e.currentTarget;if(t.scrollHeight<=t.clientHeight+1)return;e.preventDefault(),t.scrollBy({top:104*Math.sign(e.deltaY),behavior:"smooth"})},className:"overflow-y-auto pr-1",style:{height:"296px"},children:s.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-5 gap-4 min-h-[140px]",children:0===r.length?s.jsx("div",{className:"col-span-full text-center py-10 text-white/50 text-sm",children:be("folder_empty")}):r.map(e=>s.jsx(ks,{item:e,onOpenFolder:a,isBatchMode:i,isSelected:l?.has(e.id),onToggleSelect:e=>{if(!c)return;const t=new Set(l??[]);t.has(e)?t.delete(e):t.add(e),c(t)}},e.id))})})})}),s.jsx("div",{className:"mt-4",children:s.jsx("div",{ref:$,className:"rounded-2xl px-4 py-3 text-sm text-white/70 border border-dashed transition-colors "+(O?"bg-white/10 border-white/40":"bg-white/5 border-white/20"),title:t.parentId?be("folder_parent_hint_up"):be("folder_parent_hint_home"),children:be("folder_move_up",U)})})]})]}),s.jsx(fs,{isOpen:k,title:be("folder_delete_title"),message:be("folder_delete_message"),actions:[{label:be("folder_delete_keep"),onClick:()=>{v(!1),d(t.id,"keep"),g(!1),setTimeout(n,200)}},{label:be("folder_delete_all"),onClick:()=>{v(!1),I(!0)},variant:"danger"}],onCancel:()=>v(!1)}),s.jsx(bs,{isOpen:j,title:be("folder_delete_confirm_title"),message:be("folder_delete_confirm_message"),confirmText:be("ui_delete"),cancelText:be("btn_cancel"),confirmVariant:"danger",onConfirm:()=>{I(!1),d(t.id,"all"),g(!1),setTimeout(n,200)},onCancel:()=>I(!1)})]}),document.body)}function ys({item:e,onUpdate:t,onRemove:r,isEditing:o,onConfigClick:n,onOpenFolder:a,isBatchMode:i,isSelected:l,onToggleSelect:c,shortcutStyle:d}){const{cols:u,rows:h}=Ve(e.size),{attributes:m,listeners:p,setNodeRef:g,transform:x,transition:w,isDragging:f}=Me({id:e.id}),b={transform:z.Transform.toString(x),transition:w,gridColumn:`span ${u}`,gridRow:`span ${h}`,opacity:f?.5:1};return s.jsx("div",{ref:g,style:b,...m,...p,className:"touch-none cursor-grab active:cursor-grabbing",onDoubleClick:t=>{o&&"shortcut"!==e.type&&(t.preventDefault(),t.stopPropagation(),n?.(e))},children:s.jsx(ds,{item:e,onUpdate:t,onRemove:r,isEditing:o,onOpenFolder:a,isBatchMode:i,isSelected:l,onToggleSelect:c,shortcutStyle:d})})}const js=e.memo(function({currentPage:e,totalPages:t,onPageChange:r}){return s.jsx("div",{className:"fixed bottom-28 left-1/2 -translate-x-1/2 flex justify-center items-center gap-3 py-2 px-4 rounded-full bg-black/20 backdrop-blur-sm",children:t<=1?s.jsx("div",{className:"w-3 h-3 rounded-full bg-white/50",style:{boxShadow:"0 1px 3px rgba(0,0,0,0.3)"}}):Array.from({length:t}).map((t,o)=>s.jsx("button",{onClick:()=>r(o),className:"rounded-full transition-all duration-300 "+(o===e?"w-8 h-3 bg-white":"w-3 h-3 bg-white/50 hover:bg-white/70"),style:{boxShadow:o===e?"0 0 12px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.3)":"0 1px 3px rgba(0,0,0,0.3)"},"aria-label":`切换到第 ${o+1} 页`},o))})}),Is=e.memo(function({isEditing:e,onToggle:t}){return s.jsx("div",{className:"fixed bottom-6 right-6 z-40",children:s.jsx("button",{onClick:t,className:"p-3 rounded-full shadow-lg transition-all "+(e?"bg-green-500 hover:bg-green-600 text-white":"glass hover:bg-white/20 text-white/70"),title:be(e?"newtab_edit_done":"newtab_edit_layout"),children:e?s.jsx(v,{className:"w-5 h-5"}):s.jsx(G,{className:"w-5 h-5"})})})}),_s=e.memo(function({filteredItems:e,batchSelectedIds:t,onBatchSelectedIdsChange:r}){const o=e.length>0&&e.every(e=>t.has(e.id));return s.jsx("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2 z-40 px-4 py-2 rounded-full glass text-sm text-white/80 animate-fadeIn",children:s.jsx("button",{onClick:()=>{const s=new Set(t);o?e.forEach(e=>s.delete(e.id)):e.forEach(e=>s.add(e.id)),r(s)},className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors",children:be(o?"newtab_deselect_all_group":"newtab_select_all_group")})})}),Ns={6:"grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6",8:"grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8",10:"grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10"};function Ss({columns:t,rows:r=4,isBatchMode:o,batchSelectedIds:n,onBatchSelectedIdsChange:a,isEditing:i=!1,onEditingChange:l}){const{gridItems:c,updateGridItem:d,removeGridItem:u,getFilteredGridItems:h,migrateToGridItems:m,currentFolderId:p,setCurrentFolderId:g,moveGridItemToFolder:x,mergeFolders:w,createFolderFromShortcuts:f,reorderGridItemsInCurrentScope:b,reorderGridItemsInFolderScope:k,settings:v}=jt(),[y,j]=e.useState(null),[I,_]=e.useState(null),[N,S]=e.useState(null),[B,F]=e.useState(null),[D,E]=e.useState(null),[z,G]=e.useState(null),{pushDndDebug:U}={pushDndDebug:e.useCallback(e=>{if("undefined"==typeof window)return;const t=window,s=t.__DND_DEBUG__??[];s.push(e),s.length>200&&s.splice(0,s.length-200),t.__DND_DEBUG__=s,t.__DND_DEBUG_LAST__=e},[])};!function(t,s){e.useEffect(()=>{if(!t)return;if("undefined"==typeof window)return;const e=()=>{s({type:"window.blur",id:t,ts:Date.now()})},r=()=>{s({type:"document.visibilitychange",id:t,state:document.visibilityState,ts:Date.now()})},o=e=>{s({type:"window.mouseup",id:t,button:e.button,buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,ts:Date.now()})},n=e=>{s({type:"window.pointercancel",id:t,pointerType:e.pointerType,clientX:e.clientX,clientY:e.clientY,ts:Date.now()})},a=()=>{s({type:"window.contextmenu",id:t,ts:Date.now()})},i=e=>{"Escape"===e.key&&s({type:"window.keydown.esc",id:t,ts:Date.now()})};return window.addEventListener("blur",e),document.addEventListener("visibilitychange",r),window.addEventListener("mouseup",o,!0),window.addEventListener("pointercancel",n,!0),window.addEventListener("contextmenu",a,!0),window.addEventListener("keydown",i,!0),()=>{window.removeEventListener("blur",e),document.removeEventListener("visibilitychange",r),window.removeEventListener("mouseup",o,!0),window.removeEventListener("pointercancel",n,!0),window.removeEventListener("contextmenu",a,!0),window.removeEventListener("keydown",i,!0)}},[t,s])}(y,U),e.useEffect(()=>{m()},[m]);const W=h(),{currentPage:H,totalPages:K,paginatedItems:Y,setCurrentPage:X,goToNextPage:q,goToPrevPage:V,handleTouchStart:J,handleTouchMove:Q,handleTouchEnd:Z,handleWheel:ee}=function({items:t,columns:s,rows:r}){const[o,n]=e.useState(0),a=e.useRef(0),i=e.useRef(0),l=e.useRef(!1),c=e.useRef(),d=s*r,u=e.useMemo(()=>Math.max(1,Math.ceil(t.length/d)),[t.length,d]),h=e.useMemo(()=>{const e=o*d,s=e+d;return t.slice(e,s)},[t,o,d]);e.useMemo(()=>{o>=u&&u>0&&n(u-1)},[o,u]);const m=e.useCallback(()=>{n(e=>Math.min(e+1,u-1))},[u]),p=e.useCallback(()=>{n(e=>Math.max(e-1,0))},[]),g=e.useCallback(e=>{a.current=e.touches[0].clientX},[]),x=e.useCallback(e=>{i.current=e.touches[0].clientX},[]),w=e.useCallback(()=>{const e=a.current-i.current;e>50?m():e<-50&&p()},[m,p]),f=e.useCallback(e=>{if(l.current)return;const t=e.clientX,s=window.innerWidth;if(t>=.3*s&&t<=.7*s)Math.abs(e.deltaY)>30&&(l.current=!0,e.stopPropagation(),e.deltaY>0?m():p(),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{l.current=!1},300));else{const t=Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:e.shiftKey?e.deltaY:0;Math.abs(t)>30&&(l.current=!0,t>0?m():p(),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{l.current=!1},300))}},[m,p]);return{currentPage:o,totalPages:u,paginatedItems:h,setCurrentPage:n,goToNextPage:m,goToPrevPage:p,handleTouchStart:g,handleTouchMove:x,handleTouchEnd:w,handleWheel:f}}({items:W,columns:t,rows:r});e.useEffect(()=>{const e=e=>{e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||("ArrowLeft"===e.key?(e.preventDefault(),V()):"ArrowRight"===e.key&&(e.preventDefault(),q()))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[q,V]);const{handleDragStart:te,handleDragCancel:se,handleDragOver:re,handleDragEnd:oe}=function({gridItems:t,openFolderId:s,pushDndDebug:r,moveGridItemToFolder:o,reorderGridItemsInCurrentScope:n,reorderGridItemsInFolderScope:a,setFolderMergePrompt:i,setShortcutMergePrompt:l,setActiveId:c,setActiveItemSnapshot:d}){const u=e.useRef(null);return{handleDragStart:e.useCallback(e=>{const s=String(e.active.id);c(s);const o=t.find(e=>e.id===s)??null;d(o),u.current=null,r({type:"start",id:s,hasSnapshot:!!o,snapshotType:o?.type??null,ts:Date.now()})},[t,r,c,d]),handleDragCancel:e.useCallback(e=>{r({type:"cancel",id:String(e.active.id),lastOverId:u.current,ts:Date.now()}),c(null),d(null),u.current=null},[r,c,d]),handleDragOver:e.useCallback(e=>{const t=e.over?.id?String(e.over.id):null;u.current!==t&&(u.current=t,r({type:"over",id:String(e.active.id),overId:t,ts:Date.now()}))},[r]),handleDragEnd:e.useCallback(e=>{const{active:h,over:m}=e;if(r({type:"end",id:String(h.id),overId:m?.id?String(m.id):null,ts:Date.now()}),c(null),d(null),u.current=null,!m||h.id===m.id)return;const p=String(m.id);if(p.startsWith("folder-modal-undock-parent:")){const e=p.replace("folder-modal-undock-parent:",""),[s,r]=e.split(":"),n=r&&"root"!==r?r:null;if(!r){const e=t.find(e=>e.id===s);return void o(h.id,e?.parentId??null)}return void o(h.id,n)}if(s){const e=t.find(e=>e.id===String(h.id)),r=t.find(e=>e.id===String(m.id));if(e&&r&&(e.parentId??null)===s&&(r.parentId??null)===s)return void a(s,String(h.id),String(m.id))}const g=t.find(e=>e.id===m.id);if("bookmarkFolder"===g?.type){const e=t.find(e=>e.id===h.id);return"bookmarkFolder"===e?.type?void i({sourceId:String(h.id),targetId:g.id,sourceName:e.bookmarkFolder?.title||be("widget_folder"),targetName:g.bookmarkFolder?.title||be("widget_folder")}):void o(h.id,g.id)}const x=t.find(e=>e.id===h.id);"shortcut"!==x?.type||"shortcut"!==g?.type?n(h.id,m.id):l({sourceId:String(h.id),targetId:String(m.id),sourceName:x.shortcut?.title||be("widget_shortcut"),targetName:g.shortcut?.title||be("widget_shortcut")})},[t,s,r,o,n,a,i,l,c,d])}}({gridItems:c,openFolderId:B,pushDndDebug:U,moveGridItemToFolder:x,reorderGridItemsInCurrentScope:b,reorderGridItemsInFolderScope:k,setFolderMergePrompt:E,setShortcutMergePrompt:G,setActiveId:j,setActiveItemSnapshot:_}),ne=e.useMemo(()=>B?c.find(e=>e.id===B&&"bookmarkFolder"===e.type)??null:null,[c,B]),ae=e.useMemo(()=>ne?c.filter(e=>(e.parentId??null)===ne.id).sort((e,t)=>e.position-t.position):[],[c,ne]),ie=T(L(O,{activationConstraint:{distance:6}}),L($,{activationConstraint:{delay:150,tolerance:5}}),L(P,{coordinateGetter:Pe})),le=e.useCallback(()=>{D&&(w(D.sourceId,D.targetId),E(null))},[D,w]),ce=e.useCallback(()=>{z&&(f(z.sourceId,z.targetId),G(null))},[z,f]),de=e.useCallback(()=>{z&&(b(z.sourceId,z.targetId),G(null))},[z,b]),ue=e.useCallback(()=>{D&&(x(D.sourceId,D.targetId),E(null))},[D,x]),he=e.useCallback(e=>{F(e)},[]),me=e.useCallback(e=>{if(!a)return;const t=new Set(n??new Set);t.has(e)?t.delete(e):t.add(e),a(t)},[n,a]);e.useEffect(()=>{p&&(F(p),g(null))},[p,g]);const pe=I??(y?c.find(e=>e.id===y):null);return 0===W.length?s.jsx("div",{className:"flex flex-col items-center gap-3 text-white/50",children:s.jsx("span",{className:"text-sm",children:be("empty_group")})}):s.jsxs(s.Fragment,{children:[s.jsxs(R,{sensors:ie,collisionDetection:A,onDragStart:te,onDragOver:re,onDragCancel:se,onDragEnd:oe,children:[s.jsx(Re,{items:Y.map(e=>e.id),strategy:Ae,children:s.jsxs("div",{className:"relative",onTouchStart:J,onTouchMove:Q,onTouchEnd:Z,onWheel:ee,children:[s.jsx("div",{className:`grid ${Ns[t]} gap-4 auto-rows-[80px]`,children:Y.map(e=>s.jsx(ys,{item:e,onUpdate:d,onRemove:u,isEditing:i,onConfigClick:S,onOpenFolder:he,isBatchMode:o,isSelected:!!n?.has(e.id),onToggleSelect:me,shortcutStyle:v.shortcutStyle},e.id))}),s.jsx(js,{currentPage:H,totalPages:K,onPageChange:X})]})}),"undefined"!=typeof document&&C.createPortal(s.jsx(M,{zIndex:Mt,children:pe?s.jsx("div",{className:"opacity-80 pointer-events-none",children:s.jsx(ds,{item:pe,onOpenFolder:he,isEditing:!0,isBatchMode:o,isSelected:!!n?.has(pe.id),onToggleSelect:me,shortcutStyle:v.shortcutStyle})}):null}),document.body),ne&&s.jsx(vs,{folder:ne,items:ae,isOpen:!0,onClose:()=>F(null),onOpenFolder:he,isBatchMode:o,batchSelectedIds:n,onBatchSelectedIdsChange:a})]}),N&&s.jsx(hs,{item:N,isOpen:!!N,onClose:()=>S(null),onUpdate:d,onRemove:u}),s.jsx(Is,{isEditing:i,onToggle:()=>l?.(!i)}),o&&n&&a&&s.jsx(_s,{filteredItems:W,batchSelectedIds:n,onBatchSelectedIdsChange:a}),s.jsx(fs,{isOpen:!!D,title:be("newtab_folder_action"),message:be("newtab_drag_to",[D?.sourceName||"",D?.targetName||""]),actions:[{label:be("newtab_merge_folders"),onClick:le},{label:be("newtab_move_to_folder"),onClick:ue}],onCancel:()=>E(null)}),s.jsx(fs,{isOpen:!!z,title:be("newtab_create_folder"),message:be("newtab_drag_to",[z?.sourceName||"",z?.targetName||""]),actions:[{label:be("newtab_merge_to_folder"),onClick:ce},{label:be("newtab_reorder_only"),onClick:de}],onCancel:()=>G(null)})]})}const Cs="newtab_wallpaper_cache",Bs="newtab_bing_info_cache";function Fs({config:t,onRefresh:r}){const[o,n]=e.useState(null),[a,i]=e.useState(null),[c,d]=e.useState(!1),[u,h]=e.useState(!1);e.useEffect(()=>{"bing"===t.type?m():"unsplash"===t.type?p():"image"===t.type&&n(t.value)},[t.type,t.value,t.bingHistoryIndex]);const m=async(e=!1)=>{try{const s=t.bingHistoryIndex||0,r=`bing_${s}`;if(!e){const e=await g(r),t=await w(s);if(e&&t)return n(e),void i(t)}const o=`https://www.bing.com/HPImageArchive.aspx?format=js&idx=${s}&n=1&mkt=zh-CN`,a=await fetch(o),l=await a.json();if(l.images?.[0]){const t=l.images[0];let o=`https://www.bing.com${t.url}`;e&&(o+=`${o.includes("?")?"&":"?"}t=${Date.now()}`);const a={url:o,title:t.title||"",copyright:t.copyright||"",date:t.startdate||""};n(o),i(a),await x(r,o),await f(s,a)}}catch(s){}},p=async(e=!1)=>{try{if(!e){const e=await g("unsplash");if(e)return void n(e)}const t=`${Ee}?random=${Date.now()}`;n(t),await x("unsplash",t)}catch(t){}},g=async e=>{try{const t=(await chrome.storage.local.get(Cs))[Cs];if(t?.[e]){const s=Date.now()-t[e].timestamp;if(s<(e.startsWith("bing")?216e5:36e5))return t[e].url}}catch{}return null},x=async(e,t)=>{try{const s=(await chrome.storage.local.get(Cs))[Cs]||{};s[e]={url:t,timestamp:Date.now()},await chrome.storage.local.set({[Cs]:s})}catch(s){}},w=async e=>{try{const t=(await chrome.storage.local.get(Bs))[Bs];if(t?.[e]){const s=Date.now()-t[e].timestamp;if(s<216e5)return t[e].info}}catch{}return null},f=async(e,t)=>{try{const s=(await chrome.storage.local.get(Bs))[Bs]||{};s[e]={info:t,timestamp:Date.now()},await chrome.storage.local.set({[Bs]:s})}catch(s){}},b={filter:`blur(${t.blur}px) brightness(${t.brightness}%)`};if("color"===t.type)return s.jsx("div",{className:"absolute inset-0 z-0",style:{...b,backgroundColor:t.value}});const k="bing"===t.type||"unsplash"===t.type?o:t.value;return k?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute inset-0 z-0 bg-cover bg-center bg-no-repeat",style:{...b,backgroundImage:`url(${k})`}}),("bing"===t.type||"unsplash"===t.type)&&s.jsxs("div",{className:"fixed bottom-6 right-24 z-50 flex items-center gap-2",children:["bing"===t.type&&t.showBingInfo&&a&&s.jsx("button",{onClick:()=>d(!c),className:"p-2 rounded-full glass-light hover:bg-white/20 transition-all group",title:be("newtab_image_info"),children:s.jsx(U,{className:"w-4 h-4 text-white/80 group-hover:text-white"})}),s.jsx("button",{onClick:async()=>{if(!u){h(!0);try{"bing"===t.type?await m(!0):"unsplash"===t.type&&await p(!0),r?.()}catch(e){}finally{setTimeout(()=>h(!1),1e3)}}},disabled:u,className:"p-2 rounded-full glass-light hover:bg-white/20 transition-all group disabled:opacity-50",title:be("newtab_refresh_wallpaper"),children:s.jsx(l,{className:"w-4 h-4 text-white/80 group-hover:text-white "+(u?"animate-spin":"")})})]}),"bing"===t.type&&t.showBingInfo&&c&&a&&s.jsxs("div",{className:"fixed bottom-20 right-24 z-50 w-80 glass-modal-dark rounded-xl p-4 animate-fadeIn",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-medium text-white",children:be("newtab_image_info")}),s.jsx("button",{onClick:()=>d(!1),className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/70"})})]}),s.jsxs("div",{className:"space-y-2 text-xs",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-white/50 mb-1",children:be("label_title")}),s.jsx("div",{className:"text-white/90",children:a.title})]}),s.jsxs("div",{children:[s.jsx("div",{className:"text-white/50 mb-1",children:be("wallpaper_copyright")}),s.jsx("div",{className:"text-white/90 leading-relaxed",children:a.copyright})]}),s.jsxs("div",{children:[s.jsx("div",{className:"text-white/50 mb-1",children:be("wallpaper_date")}),s.jsx("div",{className:"text-white/90",children:a.date.replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")})]})]})]})]}):s.jsx("div",{className:"absolute inset-0 z-0",style:{backgroundColor:"var(--background)"}})}function Ds(e,t){if(t)return t;try{return`https://www.google.com/s2/favicons?domain=${new URL(e).hostname}&sz=64`}catch{return""}}function Es({bookmark:e,isHovered:t,onHover:r,wasDragged:o,onRecordClick:n}){const{attributes:a,listeners:i,setNodeRef:l,transform:c,transition:d,isDragging:u}=Me({id:e.id}),h={transform:z.Transform.toString(c),transition:u?"none":d||"transform 0.2s",opacity:u?.5:1};return s.jsx("div",{ref:l,style:h,...a,...i,className:"relative cursor-grab active:cursor-grabbing",children:s.jsxs("a",{href:e.url,className:"relative block w-11 h-11 rounded-xl bg-white/10 hover:bg-white/20 active:scale-90 transition-all duration-200 overflow-hidden",style:{transform:t&&!u?"translateY(-8px) scale(1.15)":"translateY(0) scale(1)"},onMouseEnter:()=>r(e.id),onMouseLeave:()=>r(null),onClick:t=>{u||o?t.preventDefault():n(e.id)},children:[t&&!u&&s.jsx("div",{className:"absolute -top-10 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-lg bg-black/90 text-white text-xs whitespace-nowrap z-50 animate-fadeIn pointer-events-none",children:e.title}),s.jsx("img",{src:Ds(e.url,e.favicon),alt:e.title,className:"w-full h-full object-cover",onError:t=>{const s=t.currentTarget,r=`https://www.google.com/s2/favicons?domain=${new URL(e.url).hostname}&sz=64`;if(s.src.includes("google.com/s2/favicons")){s.style.display="none";const t=s.parentElement;if(t&&!t.querySelector(".fallback-letter")){const s=document.createElement("span");s.className="fallback-letter text-lg font-medium text-white/70",s.textContent=e.title.charAt(0).toUpperCase(),t.appendChild(s)}}else s.src=r}})]})})}function zs(){const{syncState:t,pinnedBookmarks:r,fetchPinnedBookmarks:o,reorderPinnedBookmarks:n,recordBookmarkClick:a}=Dt(),[i,l]=e.useState(!1),[c,d]=e.useState(null),[u,h]=e.useState(!1),[m,p]=e.useState(!1),[g,x]=e.useState([]),[w,f]=e.useState(!1),b=e.useRef(!0),k=e.useRef(),v=T(L(W,{activationConstraint:{distance:8}}),L(P,{coordinateGetter:Pe}));e.useEffect(()=>{x(r)},[r]),e.useEffect(()=>{o().finally(()=>{l(!0),b.current&&(b.current=!1,requestAnimationFrame(()=>{p(!0)}))})},[o]);return!i||t.error||0===g.length?null:s.jsx("div",{"data-dock-bar":"1",className:"fixed bottom-4 left-1/2 -translate-x-1/2 z-40 transition-opacity duration-300 "+(m?"opacity-100":"opacity-0"),children:s.jsx(R,{sensors:v,collisionDetection:A,onDragEnd:async e=>{const{active:t,over:s}=e;if(f(!0),k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{f(!1)},200),!s||t.id===s.id)return;const r=g.findIndex(e=>e.id===t.id),o=g.findIndex(e=>e.id===s.id);if(-1!==r&&-1!==o){const e=[...g],[t]=e.splice(r,1);e.splice(o,0,t),x(e),await n(e.map(e=>e.id))}},children:s.jsx(Re,{items:g.map(e=>e.id),strategy:$e,children:s.jsx("div",{className:"flex items-center gap-2 px-4 py-3 rounded-2xl glass-dark "+(u?"animate-pulse":""),onDoubleClick:async()=>{u||(h(!0),await o(!0),setTimeout(()=>h(!1),500))},title:be("dock_drag_sort_hint"),children:g.map(e=>s.jsx(Es,{bookmark:e,isHovered:c===e.id,onHover:d,wasDragged:w,onRecordClick:a},e.id))})})})})}function Gs({userName:t}){const r=e.useMemo(()=>{const e=(new Date).getHours();return e>=5&&e<12?{text:"早上好",icon:"🌅"}:e>=12&&e<14?{text:"中午好",icon:"☀️"}:e>=14&&e<18?{text:"下午好",icon:"🌤️"}:e>=18&&e<22?{text:"晚上好",icon:"🌆"}:{text:"夜深了",icon:"🌙"}},[]);return s.jsx("div",{className:"text-center text-white select-none",children:s.jsxs("h2",{className:"text-2xl font-light text-shadow",children:[r.text,t&&s.jsx("span",{className:"ml-2",children:t})]})})}function Ts(){const t=e.useMemo(()=>{const e=Le.Lunar.fromDate(new Date);let t="";try{const s=e.getFestivals?.()||[],r=e.getJieQi?.()||"";t=s[0]||r||""}catch{}return{date:`${e.getMonthInChinese()}月${e.getDayInChinese()}`,year:`${e.getYearInGanZhi()}${e.getYearShengXiao()}年`,festival:t}},[]);return s.jsxs("div",{className:"text-center text-white/70 text-sm select-none",children:[s.jsxs("span",{children:[t.year," ",t.date]}),t.festival&&s.jsx("span",{className:"ml-2 px-2 py-0.5 rounded-full bg-white/10 text-xs",children:t.festival})]})}const Ls="newtab_poetry";function Rs(){const[t,r]=e.useState(null),o=()=>{const e=Math.floor(Math.random()*De.length),t=De[e];r(t);const s=(new Date).toDateString();chrome.storage.local.set({[Ls]:{poetry:t,date:s}})};return e.useEffect(()=>{chrome.storage.local.get(Ls).then(e=>{const t=e[Ls],s=(new Date).toDateString();t&&t.date===s?r(t.poetry):o()})},[]),t?s.jsxs("div",{className:"text-center text-white select-none group flex items-center justify-center gap-2",children:[s.jsxs("span",{className:"text-sm font-light tracking-wide text-shadow-sm",children:["「",t.content,"」"]}),s.jsxs("span",{className:"text-xs text-white/70 text-shadow-sm",children:["—— ",t.author,"《",t.title,"》"]}),s.jsx("button",{onClick:o,className:"p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all inline-flex items-center",title:"换一首",children:s.jsx(l,{className:"w-3 h-3 text-white/50"})})]}):null}const As={Home:oe,Briefcase:re,GraduationCap:se,Gamepad2:te,Wrench:ee,Code:Z,Music:Q,Film:J,ShoppingCart:V,Heart:q,Star:X,Bookmark:f,Folder:S,Globe:Y,Zap:K};function Ms(e){return As[e]||S}function Ps({onOpenSettings:t}){const{shortcutGroups:r,activeGroupId:o,setActiveGroup:a,addGroup:i,removeGroup:l}=jt(),[c,d]=e.useState(!1),[u,h]=e.useState(""),[m,p]=e.useState("Folder"),[g,x]=e.useState(""),[w,f]=e.useState(null),[b,v]=e.useState(null);e.useEffect(()=>{(async()=>{const e=await we.getTMarksConfig();if(e?.bookmarkApiUrl){const t=e.bookmarkApiUrl.replace(/\/api\/?$/,"");x(t)}else x(fe().BASE_URL)})()},[]);const j=()=>{u.trim()&&(i(u.trim(),m),h(""),p("Folder"),d(!1))};return s.jsxs("div",{className:"fixed left-3 top-1/2 -translate-y-1/2 z-20 glass rounded-2xl p-2 animate-fadeIn flex flex-col gap-1",children:[r.map(e=>{const t="home"!==e.id,r=Ms(e.icon);return s.jsxs("div",{className:"relative",onMouseEnter:()=>f(e.id),onMouseLeave:()=>f(null),children:[s.jsx("button",{onClick:()=>a(e.id),"data-group-id":e.id,className:"w-11 h-11 rounded-xl flex items-center justify-center transition-all active:scale-90 "+(o===e.id?"bg-white/20 text-white":"text-white/50 hover:text-white/80 hover:bg-white/10"),title:e.name,children:s.jsx(r,{className:"w-4 h-4"})}),w===e.id&&s.jsxs("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50 flex items-center gap-2",children:[e.name,t&&s.jsx(y,{className:"w-3 h-3 hover:text-red-400 cursor-pointer",onClick:t=>((e,t)=>{e.stopPropagation(),e.preventDefault(),v(t)})(t,e.id)})]})]},e.id)}),s.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>d(!c),onMouseEnter:()=>f("add"),onMouseLeave:()=>f(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all active:scale-90",title:be("sidebar_new_group"),children:[s.jsx(k,{className:"w-4 h-4"}),"add"===w&&!c&&s.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:be("sidebar_new_group")})]}),c&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>d(!1)}),s.jsxs("div",{className:"absolute left-full top-0 ml-2 w-56 p-3 rounded-xl glass-modal border border-white/10 shadow-2xl z-50 animate-scaleIn",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("span",{className:"text-sm font-medium text-white",children:be("sidebar_new_group")}),s.jsx("button",{onClick:()=>d(!1),className:"p-1 rounded hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-3 h-3 text-white/60"})})]}),s.jsx("input",{type:"text",value:u,onChange:e=>h(e.target.value),placeholder:be("sidebar_group_name"),className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 mb-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/40",autoFocus:!0,onKeyDown:e=>"Enter"===e.key&&j()}),s.jsx("div",{className:"grid grid-cols-5 gap-1.5 mb-3",children:ze.map(e=>{const t=Ms(e);return s.jsx("button",{onClick:()=>p(e),className:"p-1.5 rounded-lg transition-all "+(m===e?"bg-blue-500/30 text-blue-400 ring-1 ring-blue-500/50":"text-white/50 hover:bg-white/10 hover:text-white/80"),children:s.jsx(t,{className:"w-4 h-4 mx-auto"})},e)})}),s.jsx("button",{onClick:j,disabled:!u.trim(),className:"w-full py-1.5 rounded-lg bg-blue-500/80 hover:bg-blue-500 text-white text-sm transition-colors disabled:opacity-40 disabled:cursor-not-allowed",children:be("btn_create")})]})]})]}),g&&s.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),g&&s.jsxs("button",{onClick:()=>window.open(g,"_blank"),onMouseEnter:()=>f("tmarks"),onMouseLeave:()=>f(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all",title:be("sidebar_tmarks"),children:[s.jsx(n,{className:"w-4 h-4"}),"tmarks"===w&&s.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:be("sidebar_bookmark_manage")})]}),s.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),s.jsxs("button",{onClick:t,onMouseEnter:()=>f("settings"),onMouseLeave:()=>f(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all",title:be("widget_settings"),children:[s.jsx(H,{className:"w-4 h-4"}),"settings"===w&&s.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:be("widget_settings")})]}),s.jsx(bs,{isOpen:!!b,title:be("sidebar_delete_group"),message:(()=>{const e=r.find(e=>e.id===b);return be(e?.bookmarkFolderId?"sidebar_delete_group_with_content":"sidebar_delete_group_move_home")})(),confirmText:be("ui_delete"),cancelText:be("btn_cancel"),confirmVariant:"danger",onConfirm:()=>{b&&(l(b),v(null))},onCancel:()=>v(null)})]})}function $s({title:e,children:t}){return s.jsxs("div",{className:"bg-white/5 rounded-xl p-4",children:[s.jsx("h3",{className:"text-sm font-medium text-white/80 mb-4",children:e}),s.jsx("div",{className:"space-y-3",children:t})]})}function Os({label:e,checked:t,onChange:r,disabled:o=!1}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("button",{onClick:()=>{o||r(!t)},disabled:o,className:"w-10 h-6 rounded-full transition-colors "+(o?"bg-white/10 cursor-not-allowed":t?"bg-blue-500":"bg-white/20"),children:s.jsx("div",{className:"w-4 h-4 rounded-full bg-white transition-transform mx-1 "+(t?"translate-x-4":"translate-x-0")})})]})}function Us({label:e,value:t,options:r,onChange:o}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("select",{value:t,onChange:e=>o(e.target.value),className:"bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10",children:r.map(e=>s.jsx("option",{value:e.value,className:"bg-gray-800",children:e.label},e.value))})]})}function Ws({label:e,value:t,onChange:r}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("input",{type:"color",value:t,onChange:e=>r(e.target.value),className:"w-8 h-8 rounded cursor-pointer"})]})}function Hs({label:e,value:t,placeholder:r,onChange:o}){return s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("span",{className:"text-sm text-white/80 flex-shrink-0",children:e}),s.jsx("input",{type:"text",value:t,placeholder:r,onChange:e=>o(e.target.value),className:"flex-1 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})}function Ks({label:e,value:t,min:r,max:o,onChange:n}){return s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"range",value:t,min:r,max:o,onChange:e=>n(Number(e.target.value)),className:"w-24"}),s.jsx("span",{className:"text-xs text-white/60 w-8",children:t})]})]})}function Ys(){const{shortcuts:t,updateShortcut:r,gridItems:o,updateGridItem:n}=jt(),[a,i]=e.useState(!1),[l,c]=e.useState({current:0,total:0}),[d,u]=e.useState(null);e.useEffect(()=>{(async()=>{try{const e=await chrome.storage.local.getBytesInUse(),t=chrome.storage.local.QUOTA_BYTES||10485760;u({used:e,total:t})}catch(e){}})()},[a]);const h=t.length+o.filter(e=>"shortcut"===e.type).length,m=t.filter(e=>e.faviconBase64).length+o.filter(e=>"shortcut"===e.type&&e.shortcut?.faviconBase64).length,p=e=>e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1024/1024).toFixed(2)} MB`;return s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_cache_download")}),s.jsx("div",{className:"text-xs text-white/50 mt-1",children:be("settings_cache_count",[m.toString(),h.toString()])}),d&&s.jsx("div",{className:"text-xs text-white/40 mt-0.5",children:be("settings_storage_usage",[p(d.used),p(d.total),(d.used/d.total*100).toFixed(1)])})]}),s.jsx("button",{onClick:async()=>{i(!0),c({current:0,total:0});try{const{batchDownloadFavicons:e}=await Ge(async()=>{const{batchDownloadFavicons:e}=await Promise.resolve().then(()=>is);return{batchDownloadFavicons:e}},void 0);let s=0;if(t.length>0){const o=await e(t,(e,t)=>{c({current:e,total:t})});o.forEach((e,t)=>{r(t,{faviconBase64:e})}),s+=o.size}const a=o.filter(e=>"shortcut"===e.type&&e.shortcut);if(a.length>0){const r=await e(a.map(e=>({id:e.id,url:e.shortcut.url,favicon:e.shortcut.favicon,faviconBase64:e.shortcut.faviconBase64})),(e,s)=>{c({current:e+t.length,total:s+t.length})});r.forEach((e,t)=>{const s=o.find(e=>e.id===t);s?.shortcut&&n(t,{shortcut:{...s.shortcut,faviconBase64:e}})}),s+=r.size}alert(be("settings_cache_success",s.toString()))}catch(e){alert(be("settings_cache_failed"))}finally{i(!1),c({current:0,total:0})}},disabled:a,className:"px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:be(a?"settings_caching":"settings_cache_now")})]}),a&&l.total>0&&s.jsxs("div",{className:"space-y-1",children:[s.jsx("div",{className:"w-full bg-white/10 rounded-full h-2 overflow-hidden",children:s.jsx("div",{className:"h-full bg-blue-500 transition-all duration-300",style:{width:l.current/l.total*100+"%"}})}),s.jsxs("div",{className:"text-xs text-white/50 text-center",children:[l.current," / ",l.total]})]}),s.jsx("div",{className:"text-xs text-white/40 leading-relaxed",children:be("settings_cache_hint")})]})}function Xs(){const{settings:t,updateSettings:r}=jt(),[o,n]=e.useState(ke());return s.jsxs("div",{className:"space-y-6",children:[s.jsxs($s,{title:be("settings_language"),children:[s.jsx(Us,{label:be("settings_language_select"),value:o,options:ve.map(e=>({value:e.code,label:e.nativeName})),onChange:e=>(async e=>{await ye(e),n(e),window.location.reload()})(e)}),s.jsx("div",{className:"text-xs text-white/50 mt-1",children:be("settings_language_hint")})]}),s.jsxs($s,{title:be("settings_personalization"),children:[s.jsx(Os,{label:be("settings_show_greeting"),checked:t.showGreeting,onChange:e=>r({showGreeting:e})}),s.jsx(Hs,{label:be("settings_your_name"),value:t.userName,placeholder:be("settings_optional"),onChange:e=>r({userName:e})})]}),s.jsxs($s,{title:be("settings_clock"),children:[s.jsx(Os,{label:be("settings_show_clock"),checked:t.showClock,onChange:e=>r({showClock:e})}),t.showClock&&s.jsxs(s.Fragment,{children:[s.jsx(Os,{label:be("settings_show_date"),checked:t.showDate,onChange:e=>r({showDate:e})}),s.jsx(Os,{label:be("settings_show_seconds"),checked:t.showSeconds,onChange:e=>r({showSeconds:e})}),s.jsx(Os,{label:be("settings_show_lunar"),checked:t.showLunar,onChange:e=>r({showLunar:e})}),s.jsx(Us,{label:be("settings_time_format"),value:t.clockFormat,options:[{value:"24h",label:be("settings_24h")},{value:"12h",label:be("settings_12h")}],onChange:e=>r({clockFormat:e})})]})]}),s.jsx($s,{title:be("settings_poetry"),children:s.jsx(Os,{label:be("settings_show_poetry"),checked:t.showPoetry,onChange:e=>r({showPoetry:e})})}),s.jsxs($s,{title:be("settings_search"),children:[s.jsx(Os,{label:be("settings_show_search"),checked:t.showSearch,onChange:e=>r({showSearch:e})}),s.jsx(Us,{label:be("settings_search_engine"),value:t.searchEngine,options:Se.map(e=>({value:e.id,label:e.name})),onChange:e=>r({searchEngine:e})})]}),s.jsx($s,{title:be("settings_offline_cache"),children:s.jsx(Ys,{})}),s.jsx($s,{title:be("settings_usage_guide"),children:s.jsxs("div",{className:"text-sm text-white/70 leading-relaxed space-y-2",children:[s.jsx("div",{children:be("settings_guide_1")}),s.jsx("div",{children:be("settings_guide_2")}),s.jsx("div",{children:be("settings_guide_3")})]})})]})}function qs(){const{settings:e,updateSettings:t}=jt();return s.jsxs("div",{className:"space-y-6",children:[s.jsxs($s,{title:be("settings_shortcuts"),children:[s.jsx(Os,{label:be("settings_show_shortcuts"),checked:e.showShortcuts,onChange:e=>t({showShortcuts:e})}),s.jsx(Us,{label:be("settings_per_row"),value:String(e.shortcutColumns),options:[{value:"6",label:be("settings_count_items","6")},{value:"8",label:be("settings_count_items","8")},{value:"10",label:be("settings_count_items","10")}],onChange:e=>t({shortcutColumns:Number(e)})}),s.jsx(Us,{label:be("settings_style"),value:e.shortcutStyle,options:[{value:"icon",label:be("settings_style_icon")},{value:"card",label:be("settings_style_card")}],onChange:e=>t({shortcutStyle:e})})]}),s.jsxs($s,{title:be("settings_wallpaper"),children:[s.jsx(Us,{label:be("settings_wallpaper_type"),value:e.wallpaper.type,options:[{value:"color",label:be("settings_wallpaper_color")},{value:"bing",label:be("settings_wallpaper_bing")},{value:"unsplash",label:be("settings_wallpaper_unsplash")},{value:"image",label:be("settings_wallpaper_custom")}],onChange:s=>t({wallpaper:{...e.wallpaper,type:s}})}),"color"===e.wallpaper.type&&s.jsx(Ws,{label:be("settings_bg_color"),value:e.wallpaper.value,onChange:s=>t({wallpaper:{...e.wallpaper,value:s}})}),"bing"===e.wallpaper.type&&s.jsxs(s.Fragment,{children:[s.jsx(Us,{label:be("settings_history_image"),value:String(e.wallpaper.bingHistoryIndex||0),options:[{value:"0",label:be("settings_today")},{value:"1",label:be("settings_yesterday")},{value:"2",label:be("settings_days_ago","2")},{value:"3",label:be("settings_days_ago","3")},{value:"4",label:be("settings_days_ago","4")},{value:"5",label:be("settings_days_ago","5")},{value:"6",label:be("settings_days_ago","6")},{value:"7",label:be("settings_days_ago","7")}],onChange:s=>t({wallpaper:{...e.wallpaper,bingHistoryIndex:Number(s)}})}),s.jsx(Os,{label:be("settings_show_image_info"),checked:e.wallpaper.showBingInfo||!1,onChange:s=>t({wallpaper:{...e.wallpaper,showBingInfo:s}})})]}),"image"===e.wallpaper.type&&s.jsx(Hs,{label:be("settings_image_url"),value:e.wallpaper.value,placeholder:"https://...",onChange:s=>t({wallpaper:{...e.wallpaper,value:s}})}),s.jsx(Ks,{label:be("settings_blur"),value:e.wallpaper.blur,min:0,max:20,onChange:s=>t({wallpaper:{...e.wallpaper,blur:s}})}),s.jsx(Ks,{label:be("settings_brightness"),value:e.wallpaper.brightness,min:20,max:100,onChange:s=>t({wallpaper:{...e.wallpaper,brightness:s}})})]})]})}function Vs(){const{settings:t,updateSettings:r}=jt(),[o,n]=e.useState("");return e.useEffect(()=>{(async()=>{const e=await we.getTMarksConfig();if(e?.bookmarkApiUrl){const t=e.bookmarkApiUrl.replace(/\/api\/?$/,"");n(t)}else n(fe().BASE_URL)})()},[]),s.jsxs("div",{className:"space-y-6",children:[s.jsxs($s,{title:be("settings_tmarks_sync"),children:[s.jsx(Os,{label:be("settings_show_pinned_bookmarks"),checked:t.showPinnedBookmarks,onChange:e=>r({showPinnedBookmarks:e})}),s.jsx(Os,{label:be("settings_search_suggestions"),checked:t.enableSearchSuggestions,onChange:e=>r({enableSearchSuggestions:e})}),o&&s.jsxs("a",{href:o,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-between p-3 mt-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",children:[s.jsx("span",{className:"text-sm text-white/70",children:be("settings_open_tmarks")}),s.jsx(_,{className:"w-4 h-4 text-white/50"})]}),s.jsx("div",{className:"text-xs text-white/40 mt-2",children:be("settings_api_key_hint")})]}),s.jsxs($s,{title:be("settings_auto_refresh"),children:[s.jsx(Os,{label:be("settings_auto_refresh_pinned"),checked:t.autoRefreshPinnedBookmarks,onChange:e=>r({autoRefreshPinnedBookmarks:e})}),t.autoRefreshPinnedBookmarks&&s.jsxs(s.Fragment,{children:[s.jsx(Us,{label:be("settings_refresh_time"),value:t.pinnedBookmarksRefreshTime,options:[{value:"morning",label:be("settings_morning_8")},{value:"evening",label:be("settings_evening_22")}],onChange:e=>r({pinnedBookmarksRefreshTime:e})}),s.jsx("div",{className:"text-xs text-white/40 -mt-1 ml-1",children:be("settings_auto_refresh_hint")})]})]})]})}function Js(){const{settings:t,updateSettings:r}=jt(),[o,n]=e.useState(!1),[a,i]=e.useState(null),[l,c]=e.useState(null),[d,u]=e.useState(!1),[h,m]=e.useState(null),[p,g]=e.useState([]),[x,w]=e.useState(!0);e.useEffect(()=>{if(!h)return;const e=e=>{if("AI_ORGANIZE_PROGRESS"!==String(e?.type??"").trim().toUpperCase())return;const t=e?.payload;t&&t.sessionId===h&&g(e=>{const s=[...e,t];return s.length>500?s.slice(s.length-500):s})};return chrome.runtime.onMessage.addListener(e),()=>{try{chrome.runtime.onMessage.removeListener(e)}catch{}}},[h]);const f=e.useCallback(()=>{g([])},[]),b=e.useCallback(()=>{u(!1),f()},[f]);return s.jsxs("div",{className:"space-y-6",children:[s.jsxs($s,{title:be("settings_ai_organize"),children:[s.jsx(Os,{label:be("settings_enable_ai_organize"),checked:t.enableWorkspaceAiOrganize??!0,onChange:e=>r({enableWorkspaceAiOrganize:e})}),s.jsx(Qs,{settings:t,updateSettings:r}),s.jsx(Zs,{settings:t,updateSettings:r}),s.jsx(er,{settings:t,updateSettings:r}),s.jsx(tr,{settings:t,updateSettings:r}),s.jsx(sr,{settings:t,updateSettings:r}),s.jsx("button",{"data-ai-organize-btn":!0,onClick:async()=>{try{i(null),c(null);const e=`${Date.now()}-${Math.random().toString(16).slice(2)}`;m(e),g([{ts:Date.now(),level:"info",step:"ui",message:be("settings_task_started")}]),u(!0),n(!0);const s=await chrome.runtime.sendMessage({type:"AI_ORGANIZE_NEWTAB_WORKSPACE",payload:{sessionId:e,rules:t.workspaceAiOrganizeRules??"",maxBookmarks:t.workspaceAiOrganizeMaxBookmarks??300,enableHistoryHeat:t.enableHistoryHeat??!1,historyDays:t.historyDays??30,historyHeatTopN:t.historyHeatTopN??20,strictHierarchy:t.workspaceAiOrganizeStrictHierarchy??!1,allowNewFolders:!t.workspaceAiOrganizeStrictHierarchy&&(t.workspaceAiOrganizeAllowNewFolders??!0),preferOriginalPaths:t.workspaceAiOrganizePreferOriginalPaths??!0,verboseLogs:t.workspaceAiOrganizeVerboseLogs??!0,topLevelCount:t.workspaceAiOrganizeTopLevelCount??5,promptTemplate:t.enableWorkspaceAiOrganizeCustomPrompt?t.workspaceAiOrganizePrompt??"":void 0}});if(!s?.success)throw new Error(s?.error||"AI 整理失败");const r=s.data?.createdFolders??0,o=s.data?.createdBookmarks??0,a=s.data?.processed??s.data?.total??0,l=s.data?.truncated?be("settings_truncated"):"";i(be("settings_organize_complete",[a.toString(),l,r.toString(),o.toString()]))}catch(e){c(e instanceof Error?e.message:be("settings_ai_organize_failed"))}finally{n(!1),m(null)}},disabled:o,className:"w-full px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:be(o?"settings_organizing":"settings_start_ai_organize")}),s.jsx("button",{onClick:()=>u(!0),className:"w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-white/80 text-sm transition-colors",children:be("settings_view_terminal")}),a&&s.jsx("div",{className:"text-xs text-green-400",children:a}),l&&s.jsx("div",{className:"text-xs text-red-400",children:l}),s.jsx("div",{className:"text-xs text-white/40 leading-relaxed",children:be("settings_ai_organize_warning")})]}),d&&s.jsx(rr,{logs:p,sessionId:h,autoScroll:x,onAutoScrollChange:w,onClear:f,onClose:b})]})}function Qs({settings:e,updateSettings:t}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_custom_rules")}),s.jsx("textarea",{value:e.workspaceAiOrganizeRules??"",onChange:e=>t({workspaceAiOrganizeRules:e.target.value}),rows:6,placeholder:be("settings_custom_rules_placeholder"),className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none border border-white/10 font-mono"}),s.jsx("div",{className:"text-xs text-white/50",children:be("settings_custom_rules_hint")})]})}function Zs({settings:e,updateSettings:t}){const r=e.enableWorkspaceAiOrganizeCustomPrompt??!1;return s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_custom_prompt")}),s.jsx("button",{type:"button",onClick:()=>t({enableWorkspaceAiOrganizeCustomPrompt:!r}),className:"px-3 py-1 rounded-lg text-xs font-medium transition-colors "+(r?"bg-blue-500 text-white hover:bg-blue-600":"bg-white/10 text-white/70 hover:bg-white/15"),children:be(r?"settings_enabled":"settings_disabled")})]}),r&&s.jsxs(s.Fragment,{children:[s.jsx("textarea",{value:e.workspaceAiOrganizePrompt??"",onChange:e=>t({workspaceAiOrganizePrompt:e.target.value}),rows:10,placeholder:be("settings_prompt_variables_hint"),className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none border border-white/10 font-mono"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{type:"button",onClick:()=>t({workspaceAiOrganizePrompt:Oe}),className:"text-xs px-2 py-1 rounded-md bg-blue-500 hover:bg-blue-600 text-white transition-colors",children:be("settings_use_default_template")}),s.jsx("button",{type:"button",onClick:()=>t({workspaceAiOrganizePrompt:""}),className:"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/15 text-white/80 transition-colors",children:be("settings_clear")})]}),s.jsx("div",{className:"text-xs text-white/50",children:be("settings_prompt_json_hint")})]})]})}function er({settings:e,updateSettings:t}){return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex flex-col gap-4",children:[s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_domain_limit")}),s.jsx("input",{type:"number",min:50,max:2e3,value:e.workspaceAiOrganizeMaxBookmarks??300,onChange:e=>t({workspaceAiOrganizeMaxBookmarks:Number(e.target.value)}),className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]}),s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_top_level_count")}),s.jsx("input",{type:"number",min:2,max:7,value:e.workspaceAiOrganizeTopLevelCount??5,onChange:e=>{const s=Number(e.target.value);if(Number.isNaN(s))return;const r=Math.max(2,Math.min(7,Math.round(s)));t({workspaceAiOrganizeTopLevelCount:r})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})]}),s.jsxs("div",{className:"text-xs text-white/50 -mt-1 space-y-1",children:[s.jsx("p",{children:be("settings_domain_limit_hint")}),s.jsx("p",{children:be("settings_batch_hint")}),s.jsx("p",{children:be("settings_top_level_hint")})]})]})}function tr({settings:e,updateSettings:t}){const r=e.enableHistoryHeat??!1;return s.jsxs(s.Fragment,{children:[s.jsx(Os,{label:be("settings_history_heat"),checked:r,onChange:e=>t({enableHistoryHeat:e})}),r&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_history_days")}),s.jsx("input",{type:"number",min:1,max:90,value:e.historyDays??30,onChange:e=>{const s=Number(e.target.value);Number.isNaN(s)||t({historyDays:s})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]}),s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_history_top_n")}),s.jsx("input",{type:"number",min:5,max:100,value:e.historyHeatTopN??20,onChange:e=>{const s=Number(e.target.value);Number.isNaN(s)||t({historyHeatTopN:s})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})]}),s.jsxs("div",{className:"text-xs text-white/50 -mt-1 space-y-1",children:[s.jsx("p",{children:be("settings_history_heat_hint_1")}),s.jsx("p",{children:be("settings_history_heat_hint_2")})]})]})]})}function sr({settings:e,updateSettings:t}){return s.jsxs("div",{className:"space-y-3 pt-2",children:[s.jsx("div",{className:"text-sm text-white/80",children:be("settings_hierarchy_strategy")}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Os,{label:be("settings_strict_hierarchy"),checked:e.workspaceAiOrganizeStrictHierarchy??!1,onChange:e=>{t({workspaceAiOrganizeStrictHierarchy:e,...e?{workspaceAiOrganizeAllowNewFolders:!1}:{}})}}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:be("settings_strict_hierarchy_hint")})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Os,{label:be("settings_allow_new_folders"),checked:e.workspaceAiOrganizeAllowNewFolders??!0,onChange:e=>t({workspaceAiOrganizeAllowNewFolders:e}),disabled:e.workspaceAiOrganizeStrictHierarchy??!1}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:be("settings_allow_new_folders_hint")})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Os,{label:be("settings_prefer_original_paths"),checked:e.workspaceAiOrganizePreferOriginalPaths??!0,onChange:e=>t({workspaceAiOrganizePreferOriginalPaths:e})}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:be("settings_prefer_original_paths_hint")})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Os,{label:be("settings_verbose_logs"),checked:e.workspaceAiOrganizeVerboseLogs??!0,onChange:e=>t({workspaceAiOrganizeVerboseLogs:e})}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:be("settings_verbose_logs_hint")})]})]})}function rr({logs:e,sessionId:t,autoScroll:r,onAutoScrollChange:o,onClear:n,onClose:a}){return s.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center",style:{zIndex:Rt+1},onClick:a,children:s.jsxs("div",{className:"w-[900px] max-w-[95%] h-[460px] rounded-2xl bg-black/80 border border-white/10 overflow-hidden flex flex-col",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[s.jsx("div",{className:"text-sm font-medium text-white/90",children:be("settings_ai_terminal")}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/70 select-none",children:[s.jsx("input",{type:"checkbox",checked:r,onChange:e=>o(e.target.checked),className:"accent-blue-500"}),be("settings_auto_scroll")]}),s.jsx("button",{onClick:n,className:"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/15 text-white/80",children:be("settings_clear")}),s.jsx("button",{onClick:a,className:"p-2 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/70"})})]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3 font-mono text-xs leading-relaxed",ref:e=>{e&&r&&setTimeout(()=>{try{e.scrollTop=e.scrollHeight}catch{}},0)},children:0===e.length?s.jsx("div",{className:"text-white/50",children:be("settings_no_logs")}):s.jsx("div",{className:"space-y-2",children:e.map((e,t)=>{const r="number"==typeof e.ts?new Date(e.ts).toLocaleTimeString():"",o=String(e.level||"info"),n="error"===o?"text-red-300":"warn"===o?"text-yellow-300":"success"===o?"text-green-300":"text-white/80";return s.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[s.jsxs("div",{className:n,children:["[",r,"] [",o,"] [",String(e.step||""),"] ",String(e.message||"")]}),void 0!==e.detail&&null!==e.detail&&s.jsx("div",{className:"text-white/50 mt-1",children:(()=>{try{return JSON.stringify(e.detail,null,2)}catch{return String(e.detail)}})()})]},t)})})}),s.jsxs("div",{className:"px-4 py-3 border-t border-white/10 flex items-center justify-between gap-3",children:[s.jsxs("div",{className:"text-xs text-white/50 truncate",children:[be("session_label"),": ",t||"-"]}),s.jsx("button",{onClick:()=>{try{const t=e.map(e=>{const t=`[${"number"==typeof e.ts?new Date(e.ts).toISOString():""}] [${String(e.level||"")}] [${String(e.step||"")}] ${String(e.message||"")}`;if(void 0===e.detail||null===e.detail)return t;try{return`${t}\n${JSON.stringify(e.detail,null,2)}`}catch{return`${t}\n${String(e.detail)}`}}).join("\n");navigator.clipboard.writeText(t)}catch{}},className:"text-xs px-3 py-1.5 rounded-md bg-blue-500 hover:bg-blue-600 text-white",children:be("settings_copy_logs")})]})]})})}const or=[{id:"general",labelKey:"settings_general",icon:ne},{id:"appearance",labelKey:"settings_appearance",icon:ae},{id:"sync",labelKey:"settings_sync",icon:a},{id:"ai",labelKey:"settings_ai",icon:ie}];function nr({onClose:t}){const[r,o]=e.useState("general");return C.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 animate-fadeIn",style:{zIndex:Lt},onClick:t,children:s.jsxs("div",{className:"relative w-full max-w-4xl h-[600px] rounded-2xl glass-modal-dark flex flex-col overflow-hidden",style:{zIndex:Rt,animation:"modalScale 0.2s ease-out"},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-white/10",children:[s.jsx("h2",{className:"text-lg font-medium text-white",children:be("options_title")}),s.jsx("button",{onClick:t,className:"p-2 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-5 h-5 text-white/70"})})]}),s.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[s.jsx("div",{className:"w-48 flex-shrink-0 border-r border-white/10 py-2",children:or.map(e=>{const t=e.icon;return s.jsxs("button",{onClick:()=>o(e.id),className:"w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors relative "+(r===e.id?"text-white bg-white/10":"text-white/60 hover:text-white hover:bg-white/5"),children:[s.jsx(t,{className:"w-4 h-4"}),be(e.labelKey),r===e.id&&s.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 bg-blue-500"})]},e.id)})}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:["general"===r&&s.jsx(Xs,{}),"appearance"===r&&s.jsx(qs,{}),"sync"===r&&s.jsx(Vs,{}),"ai"===r&&s.jsx(Js,{})]})]})]})}),document.body)}function ar({isOpen:t,onClose:r,onAdd:o,groupName:n}){const[a,i]=e.useState(""),[l,c]=e.useState(""),[d,u]=e.useState("");if(!t)return null;const h=()=>{if(u(""),a.trim())try{const e=a.startsWith("http")?a:`https://${a}`;new URL(e);const t=new URL(e).hostname,s=l.trim()||t;o(e,s),i(""),c(""),r()}catch{u(be("error_invalid_url"))}else u(be("error_enter_url"))},m=e=>{"Enter"===e.key?h():"Escape"===e.key&&r()};return C.createPortal(s.jsxs("div",{className:"fixed inset-0 flex items-center justify-center animate-fadeIn",style:{zIndex:Lt},children:[s.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:r}),s.jsx("div",{className:"relative w-[400px] max-w-[90vw]",style:{zIndex:Rt,animation:"modalScale 0.2s ease-out"},children:s.jsxs("div",{className:"glass-modal rounded-2xl p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("h3",{className:"text-lg font-medium text-white",children:[be("modal_add_shortcut"),n&&s.jsx("span",{className:"ml-2 text-sm text-white/50",children:be("modal_add_shortcut_to",n)})]}),s.jsx("button",{onClick:r,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-5 h-5 text-white/60"})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[s.jsx(le,{className:"w-4 h-4"}),be("label_url")]}),s.jsx("input",{type:"text",value:a,onChange:e=>i(e.target.value),onKeyDown:m,placeholder:"https://example.com",className:"w-full bg-white/10 text-white text-sm rounded-xl px-4 py-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/30 transition-colors",autoFocus:!0})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[s.jsx(ce,{className:"w-4 h-4"}),be("label_name")," ",s.jsx("span",{className:"text-white/30",children:be("label_optional")})]}),s.jsx("input",{type:"text",value:l,onChange:e=>c(e.target.value),onKeyDown:m,placeholder:be("placeholder_auto_domain"),className:"w-full bg-white/10 text-white text-sm rounded-xl px-4 py-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/30 transition-colors"})]}),d&&s.jsx("p",{className:"text-sm text-red-400",children:d})]}),s.jsxs("div",{className:"flex gap-3 mt-6",children:[s.jsx("button",{onClick:r,className:"flex-1 py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white/70 text-sm transition-colors",children:be("btn_cancel")}),s.jsx("button",{onClick:h,className:"flex-1 py-2.5 rounded-xl bg-blue-500/80 hover:bg-blue-500 text-white text-sm transition-colors",children:be("btn_add")})]})]})})]}),document.body)}function ir({isOpen:t,onClose:r,onSave:o,initialName:n}){const[a,i]=e.useState("");if(e.useEffect(()=>{i(n||"")},[n,t]),!t)return null;return C.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 animate-fadeIn",style:{zIndex:Lt},onClick:r,children:s.jsxs("div",{className:"relative w-80 rounded-2xl glass-modal-dark overflow-hidden",style:{zIndex:Rt,animation:"modalScale 0.2s ease-out"},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(S,{className:"w-5 h-5 text-white/70"}),s.jsx("h3",{className:"text-base font-medium text-white",children:be("modal_new_folder")})]}),s.jsx("button",{onClick:r,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/60"})})]}),s.jsxs("form",{onSubmit:e=>{e.preventDefault(),a.trim()&&(o(a.trim()),i(""),r())},className:"p-4",children:[s.jsx("input",{type:"text",value:a,onChange:e=>i(e.target.value),placeholder:be("placeholder_folder_name"),className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2.5 outline-none border border-white/10 focus:border-white/30 placeholder-white/40",autoFocus:!0}),s.jsxs("div",{className:"flex gap-2 mt-4",children:[s.jsx("button",{type:"button",onClick:r,className:"flex-1 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-white/70 text-sm",children:be("btn_cancel")}),s.jsx("button",{type:"submit",disabled:!a.trim(),className:"flex-1 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-white text-sm",children:be("btn_create")})]})]})]})}),document.body)}function lr({isOpen:t,onClose:r,selectedIds:o,onSelectedIdsChange:n}){const{shortcutGroups:a,getFilteredGridItems:i,removeGridItem:l,updateGridItem:c,activeGroupId:d,currentFolderId:u,gridItems:h,cleanupAllEmptyFolders:m,cleanupEmptyGroups:p}=jt(),[g,x]=e.useState(""),[w,f]=e.useState(!1),b=e.useMemo(()=>i().sort((e,t)=>e.position-t.position),[i,d,u,h]);if(e.useEffect(()=>{t||x("")},[t]),!t)return null;const k=()=>{n(new Set),x(""),r()},v=b.length>0&&b.every(e=>o.has(e.id));return C.createPortal(s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2",style:{zIndex:At},children:s.jsxs("div",{className:"flex items-center justify-between gap-3 px-4 py-3 rounded-2xl glass-dark shadow-2xl w-[min(920px,calc(100vw-32px))]",style:{backdropFilter:"blur(16px) saturate(180%)",WebkitBackdropFilter:"blur(16px) saturate(180%)",border:"1px solid rgba(255,255,255,0.12)",boxShadow:"0 18px 42px rgba(0,0,0,0.42)"},children:[s.jsx("button",{onClick:()=>{if(b.length>0&&b.every(e=>o.has(e.id))){const e=new Set(o);b.forEach(t=>e.delete(t.id)),n(e)}else{const e=new Set(o);b.forEach(t=>e.add(t.id)),n(e)}},className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-xs text-white/80",children:be(v?"batch_deselect_all":"batch_select_all")}),s.jsxs("span",{className:"flex items-center gap-1 text-xs text-white/70 min-w-[76px]",children:[s.jsx(de,{className:"w-3.5 h-3.5"}),be("batch_selected_count",o.size.toString())]}),s.jsx("div",{className:"h-5 w-px bg-white/15"}),s.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[s.jsx("button",{onClick:k,className:"px-3 py-1.5 rounded-full bg-green-500/20 text-green-300 hover:bg-green-500/30 transition-colors text-xs",children:be("batch_complete")}),s.jsx("button",{onClick:k,className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-xs text-white/80",children:be("btn_cancel")}),s.jsx("button",{onClick:()=>{0!==o.size&&f(!0)},disabled:0===o.size,className:"px-3 py-1.5 rounded-full bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-colors disabled:opacity-30 text-xs",children:be("ui_delete")})]}),s.jsx("div",{className:"h-5 w-px bg-white/15"}),s.jsxs("div",{className:"flex items-center gap-2 flex-1 justify-end min-w-0",children:[s.jsx(ue,{className:"w-4 h-4 text-white/70"}),s.jsxs("select",{value:g,onChange:e=>x(e.target.value),className:"bg-white/10 text-white text-xs rounded-xl px-3 py-2 outline-none border border-white/15 min-w-[140px] max-w-[280px]",children:[s.jsx("option",{value:"",children:be("batch_select_group")}),a.map(e=>s.jsx("option",{value:e.id,className:"bg-slate-900 text-white",children:e.name},e.id))]}),s.jsx("button",{onClick:()=>{0!==o.size&&g&&(o.forEach(e=>{const t=h.find(t=>t.id===e);t&&(t.groupId!==g||t.parentId)&&c(e,{groupId:g,parentId:void 0})}),setTimeout(()=>{m(),p()},100),n(new Set),r())},disabled:!g||0===o.size,className:"px-4 py-2 rounded-xl bg-white text-slate-900 text-xs font-medium transition-colors disabled:opacity-40",children:be("batch_move")})]})]})}),s.jsx(bs,{isOpen:w,title:be("batch_delete_confirm_title"),message:be("batch_delete_confirm_message",o.size.toString()),confirmText:be("ui_delete"),cancelText:be("btn_cancel"),confirmVariant:"danger",onConfirm:()=>{o.forEach(e=>l(e)),n(new Set),f(!1)},onCancel:()=>f(!1)})]}),document.body)}const cr="tmarks_batch_edit_tip_dismissed";function dr({isOpen:t,onClose:r}){const[o,n]=e.useState(!1),[a,i]=e.useState(!1);e.useEffect(()=>{if(t){const e=localStorage.getItem(cr);i("true"!==e)}},[t]);const l=()=>{o&&localStorage.setItem(cr,"true"),r()};return t&&a?C.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn",style:{zIndex:Lt},onClick:l,children:s.jsxs("div",{className:"relative w-[min(420px,calc(100vw-32px))] rounded-2xl glass-modal p-6 shadow-2xl",onClick:e=>e.stopPropagation(),children:[s.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-1.5 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/60"})}),s.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[s.jsx("div",{className:"p-2.5 rounded-xl bg-blue-500/20",children:s.jsx(he,{className:"w-5 h-5 text-blue-400"})}),s.jsx("h3",{className:"text-lg font-semibold text-white",children:be("batch_edit_mode")})]}),s.jsxs("div",{className:"space-y-3 text-sm text-white/80",children:[s.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[s.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-blue-500/30 text-blue-300 flex items-center justify-center text-xs font-medium",children:"1"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-white/90",children:be("batch_tip_click")}),s.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:be("batch_tip_click_desc")})]})]}),s.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[s.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/30 text-purple-300 flex items-center justify-center text-xs font-medium",children:"2"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-white/90",children:be("batch_tip_double_click")}),s.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:be("batch_tip_double_click_desc")})]})]}),s.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[s.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/30 text-amber-300 flex items-center justify-center text-xs font-medium",children:"!"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-white/90",children:be("batch_tip_auto_delete")}),s.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:be("batch_tip_auto_delete_desc")})]})]})]}),s.jsx("div",{className:"mt-5 pt-4 border-t border-white/10",children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer select-none",children:[s.jsx("input",{type:"checkbox",checked:o,onChange:e=>n(e.target.checked),className:"w-4 h-4 rounded border-white/30 bg-white/10 text-blue-500 focus:ring-blue-500/50"}),s.jsx("span",{className:"text-xs text-white/60",children:be("batch_tip_dont_show")})]})}),s.jsx("button",{onClick:l,className:"mt-4 w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white text-sm font-medium transition-colors",children:be("batch_tip_got_it")})]})}),document.body):null}function ur({x:t,y:r,items:o,onClose:n}){const a=e.useRef(null);return e.useEffect(()=>{const e=e=>{a.current&&!a.current.contains(e.target)&&n()},t=e=>{"Escape"===e.key&&n()};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),document.addEventListener("contextmenu",n),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t),document.removeEventListener("contextmenu",n)}},[n]),e.useEffect(()=>{if(a.current){const e=a.current.getBoundingClientRect(),s=t+e.width>window.innerWidth?window.innerWidth-e.width-10:t,o=r+e.height>window.innerHeight?window.innerHeight-e.height-10:r;a.current.style.left=`${s}px`,a.current.style.top=`${o}px`}},[t,r]),C.createPortal(s.jsx("div",{ref:a,className:"fixed z-[9999] min-w-[180px] rounded-2xl glass-dark border border-white/10 shadow-xl py-2 animate-fadeIn overflow-hidden",style:{left:t,top:r},children:o.map((e,t)=>s.jsxs("div",{children:[s.jsxs("button",{onClick:()=>{e.onClick(),n()},className:`\n              w-full flex items-center gap-3 px-4 py-2 text-sm transition-colors\n              ${e.danger?"text-red-400 hover:bg-red-500/20":"text-white/80 hover:bg-white/10"}\n            `,children:[s.jsx("span",{className:"w-4 h-4 flex-shrink-0",children:e.icon}),s.jsx("span",{children:e.label})]}),e.divider&&s.jsx("div",{className:"h-px bg-white/10 my-1"})]},t))}),document.body)}function hr(){const{settings:t,isLoading:r,loadData:o,updateSettings:n,shortcutGroups:a,activeGroupId:i,setActiveGroup:l,addGridItem:c}=jt(),[d,u]=e.useState(!1),[h,m]=e.useState(!1),[p,g]=e.useState(!1),[x,w]=e.useState(!1),[f,b]=e.useState(!1),[v,y]=e.useState(new Set),[j,I]=e.useState(null),[_,N]=e.useState(!1),S=e.useRef(),C=e.useRef(!1),B=e.useRef(null),F=e.useRef(null),D=e.useRef({shortcutGroups:a,activeGroupId:i,setActiveGroup:l});D.current={shortcutGroups:a,activeGroupId:i,setActiveGroup:l},vt(),e.useEffect(()=>{o()},[o]);const E=e.useCallback(e=>{const{shortcutGroups:t,activeGroupId:s,setActiveGroup:r}=D.current;if(C.current)return;const o=e.target.closest(".overflow-y-auto, .overflow-auto");if(o){const{scrollTop:t,scrollHeight:s,clientHeight:r}=o;if(s>r){if(e.deltaY<0&&t>0)return;if(e.deltaY>0&&t+r<s)return}}const n=e.clientX,a=window.innerWidth;if(n>=.3*a&&n<=.7*a)return;const i=t.map(e=>e.id);if(0===i.length)return;const l=i.indexOf(s||"");if(-1===l)return void r(i[0]);let c=l;e.deltaY>0?c=Math.min(l+1,i.length-1):e.deltaY<0&&(c=Math.max(l-1,0)),c!==l&&(e.preventDefault(),r(i[c]),C.current=!0,S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{C.current=!1},300))},[]),z=e.useCallback(e=>{const t=e.target,s=t.closest('[role="dialog"]')||t.closest(".glass-modal")||t.closest(".glass-modal-dark"),r="INPUT"===t.tagName||"TEXTAREA"===t.tagName;s||r||(e.preventDefault(),I({x:e.clientX,y:e.clientY}))},[]),G=e.useCallback(()=>{B.current&&(window.clearTimeout(B.current),B.current=null),F.current=null},[]),T=e.useCallback(e=>{if(0!==e.button)return;const t=e.target,s=t.closest('[role="dialog"]')||t.closest(".glass-modal")||t.closest(".glass-modal-dark"),r=t.closest("button")||t.closest("a")||t.closest("input")||t.closest("textarea"),o=t.closest("[data-shortcut-item]");s||r||o||(G(),F.current={x:e.clientX,y:e.clientY},B.current=window.setTimeout(()=>{N(e=>!e),G()},2e3))},[G]),L=e.useCallback(e=>{if(!F.current)return;const t=e.clientX-F.current.x,s=e.clientY-F.current.y;Math.hypot(t,s)>10&&G()},[G]),R=e.useCallback(()=>{G()},[G]);e.useEffect(()=>{if(t.showShortcuts)return window.addEventListener("wheel",E,{passive:!1}),()=>{window.removeEventListener("wheel",E),S.current&&clearTimeout(S.current)}},[E,t.showShortcuts]),e.useEffect(()=>(window.addEventListener("contextmenu",z),()=>{window.removeEventListener("contextmenu",z)}),[z]);const A=e.useCallback(()=>{},[]);return r?s.jsx("div",{className:"w-full h-full flex items-center justify-center bg-[#1a1a2e]",children:s.jsx("div",{className:"w-8 h-8 border-2 border-white/30 border-t-white rounded-full animate-spin"})}):s.jsxs("div",{className:"relative w-full h-full overflow-hidden",onPointerDown:T,onPointerMove:L,onPointerUp:R,onPointerLeave:R,children:[s.jsx(Fs,{config:t.wallpaper,onRefresh:A}),s.jsxs("div",{className:"relative z-10 w-full h-full flex flex-col items-center px-4 pt-[12vh] pb-8 overflow-y-auto",children:[t.showGreeting&&s.jsx("div",{className:"mb-1 animate-fadeIn",children:s.jsx(Gs,{userName:t.userName})}),t.showClock&&s.jsx("div",{className:"mb-3 animate-fadeIn",children:s.jsx(It,{format:t.clockFormat,showDate:t.showDate,showSeconds:t.showSeconds,showLunar:t.showLunar})}),!t.showClock&&t.showLunar&&s.jsx("div",{className:"mb-3 animate-fadeIn",children:s.jsx(Ts,{})}),t.showPoetry&&s.jsx("div",{className:"mb-6 animate-fadeIn",children:s.jsx(Rs,{})}),t.showSearch&&s.jsx("div",{className:"w-full max-w-2xl mb-6 animate-fadeIn px-4 relative z-50",children:s.jsx(Tt,{engine:t.searchEngine,enableSuggestions:t.enableSearchSuggestions,onEngineChange:e=>n({searchEngine:e})})}),t.showShortcuts&&s.jsx("div",{className:"w-full max-w-5xl animate-fadeIn px-4 shortcut-area",children:s.jsx("div",{className:"flex items-start gap-4",children:s.jsx(Ss,{columns:t.shortcutColumns,isBatchMode:x,batchSelectedIds:v,onBatchSelectedIdsChange:y,isEditing:_,onEditingChange:N})})})]}),s.jsx(Ps,{onOpenSettings:()=>u(!0)}),t.showPinnedBookmarks&&s.jsx(zs,{}),d&&s.jsx(nr,{onClose:()=>u(!1)}),h&&s.jsx(ar,{isOpen:h,onClose:()=>m(!1),onAdd:(e,t)=>{const s=new URL(e).hostname;c("shortcut",{groupId:i||void 0,shortcut:{url:e,title:t,favicon:`${Ce}${s}&sz=64`}})},groupName:i?a.find(e=>e.id===i)?.name:void 0}),s.jsx(lr,{isOpen:x,onClose:()=>{w(!1),y(new Set)},selectedIds:v,onSelectedIdsChange:y}),s.jsx(dr,{isOpen:f,onClose:()=>b(!1)}),s.jsx(ir,{isOpen:p,onClose:()=>g(!1),onSave:e=>c("bookmarkFolder",{groupId:i??void 0,bookmarkFolder:{title:e}})}),j&&s.jsx(ur,{x:j.x,y:j.y,items:[{label:be("newtab_context_add_shortcut"),icon:s.jsx(k,{className:"w-4 h-4"}),onClick:()=>m(!0)},{label:be("newtab_context_add_folder"),icon:s.jsx(me,{className:"w-4 h-4"}),onClick:()=>g(!0)},{label:be("newtab_context_batch_edit"),icon:s.jsx(pe,{className:"w-4 h-4"}),onClick:()=>{y(new Set),w(!0),b(!0)},divider:!0}],onClose:()=>I(null)})]})}const mr=document.getElementById("root");mr&&je().then(()=>{ge.createRoot(mr).render(s.jsx(xe.StrictMode,{children:s.jsx(hr,{})}))});
