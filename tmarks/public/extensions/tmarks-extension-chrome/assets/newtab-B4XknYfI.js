import"./modulepreload-polyfill-YP0FEG5d.js";import{r as e,o as t,k as s,p as r,S as o,B as n,q as a,M as i,t as l,D as c,W as d,E as u,v as m,w as h,x as p,T as x,y as g,z as f,A as w,I as b,P as k,G as v,X as y,H as j,J as I,N,O as C,F as S,Q as B,U as F,e as D,V as E,Y as z,C as G,Z as T,_ as L,$ as A,a0 as R,a1 as M,a2 as $,a3 as O,a4 as _,a5 as P,a6 as U,a7 as H,a8 as W,a9 as K,aa as Y,ab as q,ac as V,ad as X,ae as J,af as Q,ag as Z,ah as ee,ai as te,aj as se,ak as re,al as oe,am as ne,an as ae,ao as ie,ap as le,aq as ce,ar as de,as as ue,at as me,au as he,av as pe,n as xe,R as ge}from"./react-vendor-D4eyb16t.js";import{D as fe,a as we,S as be,b as ke,F as ve,H as ye,c as je,U as Ie,G as Ne}from"./constants-LJ5_wtHo.js";import{S as Ce,g as Se}from"./urls-DpCSGfkZ.js";import{_ as Be}from"./preload-helper-BhLMWRjL.js";import{l as Fe}from"./vendor-BSnXPJO2.js";import{c as De}from"./index-CK9CFPi6.js";import{S as Ee,r as ze,u as Ge,s as Te,h as Le}from"./dnd-kit-Cq_WP-7G.js";import{b as Ae}from"./newtabPrompts-5mIaLKQk.js";import"./dexie-BAhLzSXZ.js";const Re=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,Me=()=>"undefined"!=typeof chrome&&!!chrome.bookmarks;function $e(e,t,s){let r=e;const o=new Set,n=[];let a=!1;for(;;){const e=new Map;for(const s of r)s.parentId&&e.set(s.parentId,(e.get(s.parentId)??0)+1);const t=new Set;for(const o of r){if("bookmarkFolder"!==o.type)continue;if(0!==(e.get(o.id)??0))continue;if(!("home"===(o.groupId??"home")&&null===(o.parentId??null))){if(o.browserBookmarkId){if(s.has(o.browserBookmarkId))continue;n.push(o.browserBookmarkId)}t.add(o.id)}}if(0===t.size)break;a=!0,t.forEach(e=>o.add(e)),r=r.filter(e=>!t.has(e.id))}if(!a)return{items:e,currentFolderId:t,changed:!1,removedBrowserBookmarkIds:[]};const i=new Map;r.forEach(e=>{const t=`${e.groupId??"home"}|${e.parentId??"root"}`;i.has(t)||i.set(t,[]),i.get(t).push(e)});const l=new Map;i.forEach(e=>{e.sort((e,t)=>e.position-t.position),e.forEach((e,t)=>{l.set(e.id,t)})});return{items:r.map(e=>{const t=l.get(e.id);return void 0!==t&&t!==e.position?{...e,position:t}:e}),currentFolderId:t&&o.has(t)?null:t,changed:!0,removedBrowserBookmarkIds:n}}let Oe=null;function _e(e){Oe&&clearTimeout(Oe),Oe=setTimeout(()=>{!async function(e){try{const t=await Ce.getBookmarkSiteApiUrl(),s=await Ce.getBookmarkSiteApiKey();if(!s)return;const r=t?.endsWith("/api")?t:Se(t||void 0).API_BASE;(await fetch(`${r}/tab/newtab/sync`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":s},body:JSON.stringify({shortcuts:e.shortcuts.map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,group_id:e.groupId,folder_id:e.folderId,position:e.position})),groups:e.groups.map(e=>({id:e.id,name:e.name,icon:e.icon,position:e.position})),folders:e.folders.map(e=>({id:e.id,name:e.name,icon:e.icon,group_id:e.groupId,position:e.position})),settings:{columns:e.settings.shortcutColumns,style:e.settings.shortcutStyle,showTitle:!0,backgroundType:e.settings.wallpaper.type,backgroundValue:e.settings.wallpaper.value,backgroundBlur:e.settings.wallpaper.blur,backgroundDim:e.settings.wallpaper.brightness,showSearch:e.settings.showSearch,showClock:e.settings.showClock,showPinnedBookmarks:e.settings.showPinnedBookmarks,searchEngine:e.settings.searchEngine},gridItems:e.gridItems.map(e=>({id:e.id,type:e.type,size:e.size,position:e.position,group_id:e.groupId,shortcut:e.shortcut,config:e.config}))})})).ok}catch(t){}}(e)},2e3)}const Pe={shortcut:{type:"shortcut",name:"快捷方式",icon:"Link",description:"网站快捷方式",sizeConfig:{type:"shortcut",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},bookmarkFolder:{type:"bookmarkFolder",name:"文件夹",icon:"Folder",description:"用于组织书签与快捷方式",sizeConfig:{type:"bookmarkFolder",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},weather:{type:"weather",name:"天气",icon:"Cloud",description:"显示当前天气和未来预报",sizeConfig:{type:"weather",defaultSize:"2x2",allowedSizes:["2x1","2x2","2x3"],minWidth:2,minHeight:1}},clock:{type:"clock",name:"时钟",icon:"Clock",description:"显示当前时间",sizeConfig:{type:"clock",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}},todo:{type:"todo",name:"待办事项",icon:"CheckSquare",description:"管理待办任务",sizeConfig:{type:"todo",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},notes:{type:"notes",name:"备忘录",icon:"StickyNote",description:"快速记录笔记",sizeConfig:{type:"notes",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},hotsearch:{type:"hotsearch",name:"热搜",icon:"TrendingUp",description:"显示热门搜索",sizeConfig:{type:"hotsearch",defaultSize:"2x3",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},poetry:{type:"poetry",name:"每日诗词",icon:"BookOpen",description:"显示每日诗词",sizeConfig:{type:"poetry",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}}};function Ue(e){const[t,s]=e.split("x").map(Number);return{cols:t,rows:s}}function He(e,t,s){return{addGridItem:(r,o={})=>{const{shortcuts:n,shortcutGroups:a,shortcutFolders:i,settings:l,gridItems:c,activeGroupId:d,currentFolderId:u,saveData:m}=t(),h=function(e){return Pe[e]}(r),p=function(e){switch(e){case"weather":return{weather:{city:"北京",unit:"C",showForecast:!0,autoLocation:!1}};case"clock":return{clock:{format:"24h",showDate:!0,showSeconds:!1,showLunar:!1}};case"todo":return{todo:{showCompleted:!1}};case"notes":return{notes:{content:""}};case"hotsearch":return{hotsearch:{type:"baidu"}};case"poetry":return{poetry:{autoRefresh:!0}};default:return{}}}(r),x=o.groupId??d??"home",g=o.parentId??u??null,f=c.filter(e=>(e.groupId??"home")===x&&(e.parentId??null)===g),w=f.length>0?Math.max(...f.map(e=>e.position)):-1,b={id:Re(),type:r,size:o.size||h.sizeConfig.defaultSize,position:w+1,groupId:x,parentId:g??void 0,shortcut:o.shortcut,bookmarkFolder:o.bookmarkFolder,config:"shortcut"!==r?p:void 0,createdAt:Date.now()},k=[...c,b];e({gridItems:k}),m(),_e({shortcuts:n,groups:a,folders:i,settings:l,gridItems:k});const{isApplyingBrowserBookmarks:v}=t();v||"shortcut"!==r&&"bookmarkFolder"!==r||(async()=>{try{const o=t(),n=await s({parentGridId:b.parentId??null,inferredGroupId:b.groupId??null});if(!n)return;if(o.setBrowserBookmarkWriteLockUntil(Date.now()+800),"bookmarkFolder"===r){const s=await chrome.bookmarks.create({parentId:n,title:b.bookmarkFolder?.title||"文件夹"});e({gridItems:t().gridItems.map(e=>e.id===b.id?{...e,browserBookmarkId:s.id}:e)}),o.saveData()}if("shortcut"===r&&b.shortcut?.url){const s=await chrome.bookmarks.create({parentId:n,title:b.shortcut.title,url:b.shortcut.url});e({gridItems:t().gridItems.map(e=>e.id===b.id?{...e,browserBookmarkId:s.id}:e)}),o.saveData()}}catch(o){}})(),"shortcut"===r&&o.shortcut?.url&&(async()=>{try{const{downloadFavicon:e}=await Be(async()=>{const{downloadFavicon:e}=await Promise.resolve().then(()=>qt);return{downloadFavicon:e}},void 0),s=await e(o.shortcut.url);if(s){const{updateGridItem:e}=t();e(b.id,{shortcut:{...o.shortcut,faviconBase64:s}})}}catch(e){}})()},updateGridItem:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=t(),d=l.map(e=>e.id===s?{...e,...r}:e);e({gridItems:d}),c(),_e({shortcuts:o,groups:n,folders:a,settings:i,gridItems:d});const{isApplyingBrowserBookmarks:u}=t(),m=l.find(e=>e.id===s);!u&&m?.browserBookmarkId&&("bookmarkFolder"===m.type&&r.bookmarkFolder?.title&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.update(m.browserBookmarkId,{title:r.bookmarkFolder.title})}catch(e){}})(),"shortcut"===m.type&&r.shortcut&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.update(m.browserBookmarkId,{title:r.shortcut?.title,url:r.shortcut?.url})}catch(e){}})())},removeGridItem:s=>{const{shortcuts:r,shortcutGroups:o,shortcutFolders:n,settings:a,gridItems:i,currentFolderId:l,saveData:c,browserBookmarksRootId:d}=t(),u=i.find(e=>e.id===s);if(!u)return;let m=new Set([s]);if("bookmarkFolder"===u.type){let e=!0;for(;e;){e=!1;for(const t of i){const s=t.parentId;s&&m.has(s)&&!m.has(t.id)&&(m.add(t.id),e=!0)}}}const h=i.filter(e=>!m.has(e.id)),p=u.groupId??"home",x=u.parentId??null,g=h.filter(e=>(e.groupId??"home")===p&&(e.parentId??null)===x).sort((e,t)=>e.position-t.position),f=new Map(g.map((e,t)=>[e.id,t])),w=$e(h.map(e=>{const t=f.get(e.id);return void 0===t?e:{...e,position:t}}),l&&m.has(l)?null:l,new Set([d].filter(Boolean)));e({gridItems:w.items,currentFolderId:w.currentFolderId}),c(),_e({shortcuts:r,groups:o,folders:n,settings:a,gridItems:w.items});const{isApplyingBrowserBookmarks:b}=t();if(!b){const e=[];for(const t of i)m.has(t.id)&&t.browserBookmarkId&&e.push(t.browserBookmarkId);e.length>0&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const t of e)try{await chrome.bookmarks.removeTree(t)}catch{try{await chrome.bookmarks.remove(t)}catch{}}}catch(s){}})()}t().cleanupEmptyGroups()},removeGridFolder:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,currentFolderId:c,saveData:d}=t(),u=l.find(e=>e.id===s);if(!u||"bookmarkFolder"!==u.type)return;if("all"===r)return void t().removeGridItem(s);const m=u.groupId??"home",h=u.parentId??null,p=new Set([s]);let x=!0;for(;x;){x=!1;for(const e of l)"bookmarkFolder"===e.type&&e.parentId&&p.has(e.parentId)&&!p.has(e.id)&&(p.add(e.id),x=!0)}const g=l.filter(e=>e.parentId&&p.has(e.parentId)).sort((e,t)=>e.position-t.position),f=l.filter(e=>!p.has(e.id)),w=f.filter(e=>(e.groupId??"home")===m&&(e.parentId??null)===h).sort((e,t)=>e.position-t.position),b=new Map(g.map((e,t)=>[e.id,{parentId:h??void 0,position:w.length+t}])),k=f.map(e=>{const t=b.get(e.id);return t?{...e,parentId:t.parentId,position:t.position}:e}),v=k.filter(e=>(e.groupId??"home")===m&&(e.parentId??null)===h).sort((e,t)=>e.position-t.position),y=new Map(v.map((e,t)=>[e.id,t])),j=$e(k.map(e=>{const t=y.get(e.id);return void 0===t?e:{...e,position:t}}),c&&p.has(c)?null:c,new Set);e({gridItems:j.items,currentFolderId:j.currentFolderId}),d(),_e({shortcuts:o,groups:n,folders:a,settings:i,gridItems:j.items});const I=t();!I.isApplyingBrowserBookmarks&&j.removedBrowserBookmarkIds.length>0&&(async()=>{try{I.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of j.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),t().cleanupEmptyGroups()},reorderGridItems:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=t(),d=[...l],[u]=d.splice(s,1);d.splice(r,0,u);const m=d.map((e,t)=>({...e,position:t}));e({gridItems:m}),c(),_e({shortcuts:o,groups:n,folders:a,settings:i,gridItems:m})},getFilteredGridItems:()=>{const{gridItems:e,activeGroupId:s,currentFolderId:r}=t(),o=s??"home",n=r?e.find(e=>e.id===r):null;return r?!!n?.browserBookmarkId?e.filter(e=>{const t=(e.parentId??null)===(r??null);return!!e.browserBookmarkId&&t}).sort((e,t)=>e.position-t.position):e.filter(e=>{const t=(e.groupId??"home")===o,s=(e.parentId??null)===(r??null);return t&&s}).sort((e,t)=>e.position-t.position):e.filter(e=>{const t=(e.groupId??"home")===o,s=null===(e.parentId??null);return t&&s}).sort((e,t)=>e.position-t.position)}}}function We(e,t,s){return{setCurrentFolderId:t=>{e({currentFolderId:t})},moveGridItemToFolder:(r,o)=>{const{shortcuts:n,shortcutGroups:a,shortcutFolders:i,settings:l,gridItems:c,saveData:d,browserBookmarksRootId:u}=t(),m=c.find(e=>e.id===r);if(!m)return;const h=e=>{if(!e)return 0;const t=c.find(t=>t.id===e);return t?1+h(t.parentId??null):0},p=h(o),x=e=>{const t=c.filter(t=>t.parentId===e);return 0===t.length?0:1+Math.max(...t.map(e=>x(e.id)))};if(p+1+("bookmarkFolder"===m.type?x(m.id):0)>5)return;const g=o??null,f=!!m.browserBookmarkId,w=(()=>{if(f)return m.groupId??"home";const e=t().activeGroupId??"home",s=o?c.find(e=>e.id===o):null,r=m.parentId?c.find(e=>e.id===m.parentId):null;return s?.groupId??r?.groupId??m.groupId??e})(),b=c.filter(e=>e.id!==r&&((e.parentId??null)===g&&(f?!!e.browserBookmarkId:!e.browserBookmarkId&&(e.groupId??"home")===w))).sort((e,t)=>e.position-t.position).length,k=c.map(e=>e.id!==r?e:{...e,groupId:w,parentId:g??void 0,position:b}),v=new Set([u].filter(Boolean)),y=$e(k,t().currentFolderId,v);e({gridItems:y.items,currentFolderId:y.currentFolderId}),d(),_e({shortcuts:n,groups:a,folders:i,settings:l,gridItems:y.items});const j=t();!j.isApplyingBrowserBookmarks&&y.removedBrowserBookmarkIds.length>0&&(async()=>{try{j.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of y.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),f||"home"!==w||null!==g||t().mirrorHomeItemsToBrowser([r]),t().cleanupEmptyGroups();const I=t();!I.isApplyingBrowserBookmarks&&m.browserBookmarkId&&(async()=>{try{const e=await s({parentGridId:o,inferredGroupId:w});if(!e)return;I.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(m.browserBookmarkId,{parentId:e,index:b})}catch(e){}})()},reorderGridItemsInCurrentScope:(r,o)=>{const{shortcuts:n,shortcutGroups:a,shortcutFolders:i,settings:l,gridItems:c,activeGroupId:d,currentFolderId:u,saveData:m}=t(),h=d??"home",p=c.filter(e=>(e.groupId??"home")===h&&(e.parentId??null)===(u??null)).sort((e,t)=>e.position-t.position),x=p.findIndex(e=>e.id===r),g=p.findIndex(e=>e.id===o);if(-1===x||-1===g||x===g)return;const f=[...p],[w]=f.splice(x,1);f.splice(g,0,w);const b=new Map(f.map((e,t)=>[e.id,t])),k=c.map(e=>{const t=b.get(e.id);return void 0===t?e:{...e,position:t}});e({gridItems:k}),m(),_e({shortcuts:n,groups:a,folders:i,settings:l,gridItems:k});const v=t(),y=p[x];!v.isApplyingBrowserBookmarks&&y?.browserBookmarkId&&(async()=>{try{const e=await s({parentGridId:v.currentFolderId,inferredGroupId:h});if(!e)return;v.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(y.browserBookmarkId,{parentId:e,index:g})}catch(e){}})()},reorderGridItemsInFolderScope:(r,o,n)=>{const{shortcuts:a,shortcutGroups:i,shortcutFolders:l,settings:c,gridItems:d,saveData:u}=t(),m=d.find(e=>e.id===r);if(!m)return;const h=m.groupId??"home",p=d.filter(e=>(e.groupId??"home")===h&&(e.parentId??null)===r).sort((e,t)=>e.position-t.position),x=p.findIndex(e=>e.id===o),g=p.findIndex(e=>e.id===n);if(-1===x||-1===g||x===g)return;const f=[...p],[w]=f.splice(x,1);f.splice(g,0,w);const b=new Map(f.map((e,t)=>[e.id,t])),k=d.map(e=>{const t=b.get(e.id);return void 0===t?e:{...e,position:t}});e({gridItems:k}),u(),_e({shortcuts:a,groups:i,folders:l,settings:c,gridItems:k});const v=t(),y=p[x];!v.isApplyingBrowserBookmarks&&y?.browserBookmarkId&&(async()=>{try{const e=await s({parentGridId:r,inferredGroupId:v.gridItems.find(e=>e.id===r)?.groupId??null});if(!e)return;v.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(y.browserBookmarkId,{parentId:e,index:g})}catch(e){}})()},mergeFolders:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c,browserBookmarksRootId:d}=t(),u=l.find(e=>e.id===s&&"bookmarkFolder"===e.type),m=l.find(e=>e.id===r&&"bookmarkFolder"===e.type);if(!u||!m)return;if(s===r)return;const h=l.filter(e=>(e.parentId??null)===s).sort((e,t)=>e.position-t.position),p=l.filter(e=>(e.parentId??null)===r).sort((e,t)=>e.position-t.position).length;let x=l.map(e=>{if((e.parentId??null)===s){const t=p+h.findIndex(t=>t.id===e.id);return{...e,parentId:r,groupId:m.groupId??"home",position:t}}return e});x=x.filter(e=>e.id!==s);const g=x.filter(e=>(e.parentId??null)===r).sort((e,t)=>e.position-t.position),f=new Map(g.map((e,t)=>[e.id,t]));x=x.map(e=>{const t=f.get(e.id);return void 0!==t?{...e,position:t}:e});const w=new Set([d].filter(Boolean)),b=$e(x,t().currentFolderId,w);e({gridItems:b.items,currentFolderId:b.currentFolderId}),c(),_e({shortcuts:o,groups:n,folders:a,settings:i,gridItems:b.items});const k=t();k.isApplyingBrowserBookmarks||(async()=>{try{if(m.browserBookmarkId){k.setBrowserBookmarkWriteLockUntil(Date.now()+2e3);for(let t=0;t<h.length;t++){const s=h[t];if(s.browserBookmarkId)try{await chrome.bookmarks.move(s.browserBookmarkId,{parentId:m.browserBookmarkId,index:p+t})}catch(e){}}}if(u.browserBookmarkId)try{await chrome.bookmarks.removeTree(u.browserBookmarkId)}catch{try{await chrome.bookmarks.remove(u.browserBookmarkId)}catch{}}if(b.removedBrowserBookmarkIds.length>0)for(const e of b.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch(e){}})(),t().cleanupEmptyGroups()},createFolderFromShortcuts:(r,o,n)=>{const{shortcuts:a,shortcutGroups:i,shortcutFolders:l,settings:c,gridItems:d,saveData:u}=t(),m=d.find(e=>e.id===r),h=d.find(e=>e.id===o);if(!m||!h)return null;if("shortcut"!==m.type||"shortcut"!==h.type)return null;if(r===o)return null;const p=h.groupId??"home",x=h.parentId??null,g=h.position,f=n||"新文件夹",w=Re(),b={id:w,type:"bookmarkFolder",size:"1x1",position:g,groupId:p,parentId:x??void 0,bookmarkFolder:{title:f},createdAt:Date.now()};let k=d.map(e=>e.id===r?{...e,parentId:w,groupId:p,position:0}:e.id===o?{...e,parentId:w,groupId:p,position:1}:e);k=[...k,b];const v=k.filter(e=>(e.groupId??"home")===p&&(e.parentId??null)===x&&e.id!==r&&e.id!==o).sort((e,t)=>e.position-t.position),y=new Map;v.forEach((e,t)=>{e.id===w?y.set(e.id,g):e.position>=g?y.set(e.id,t):y.set(e.id,e.position)});v.sort((e,t)=>(y.get(e.id)??e.position)-(y.get(t.id)??t.position)).forEach((e,t)=>{y.set(e.id,t)}),k=k.map(e=>{const t=y.get(e.id);return void 0!==t?{...e,position:t}:e}),e({gridItems:k}),u(),_e({shortcuts:a,groups:i,folders:l,settings:c,gridItems:k});const j=t();return j.isApplyingBrowserBookmarks||(async()=>{try{const o=await s({parentGridId:x,inferredGroupId:p});if(o){j.setBrowserBookmarkWriteLockUntil(Date.now()+2e3);const s=await chrome.bookmarks.create({parentId:o,title:f,index:g});if(e({gridItems:t().gridItems.map(e=>e.id===w?{...e,browserBookmarkId:s.id}:e)}),j.saveData(),m.browserBookmarkId)try{await chrome.bookmarks.move(m.browserBookmarkId,{parentId:s.id,index:0})}catch(r){}if(h.browserBookmarkId)try{await chrome.bookmarks.move(h.browserBookmarkId,{parentId:s.id,index:1})}catch(r){}}}catch(r){}})(),w},cleanupEmptySecondLevelFolders:()=>{const{gridItems:s,currentFolderId:r,shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,saveData:l}=t(),{items:c,currentFolderId:d,changed:u}=function(e,t){const s=new Map(e.map(e=>[e.id,e])),r=new Map;for(const l of e)l.parentId&&r.set(l.parentId,(r.get(l.parentId)??0)+1);const o=new Set;for(const l of e){if("bookmarkFolder"!==l.type||l.browserBookmarkId||!l.parentId)continue;const e=s.get(l.parentId);e&&null===(e.parentId??null)&&0===(r.get(l.id)??0)&&o.add(l.id)}if(0===o.size)return{items:e,currentFolderId:t,changed:!1};const n=e.filter(e=>!o.has(e.id)),a=new Map;n.forEach(e=>{const t=`${e.groupId??"home"}|${e.parentId??"root"}`;a.has(t)||a.set(t,[]),a.get(t).push(e)});const i=new Map;return a.forEach(e=>{e.sort((e,t)=>e.position-t.position),e.forEach((e,t)=>{i.set(e.id,t)})}),{items:n.map(e=>{const t=i.get(e.id);return void 0!==t&&t!==e.position?{...e,position:t}:e}),currentFolderId:t&&o.has(t)?null:t,changed:!0}}(s,r);u&&(e({gridItems:c,currentFolderId:d}),l(),_e({shortcuts:o,groups:n,folders:a,settings:i,gridItems:c}),t().cleanupEmptyGroups())},cleanupAllEmptyFolders:()=>{const{gridItems:s,currentFolderId:r,shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,saveData:l,browserBookmarksRootId:c}=t(),d=$e(s,r,new Set([c].filter(Boolean)));if(!d.changed)return;e({gridItems:d.items,currentFolderId:d.currentFolderId}),l(),_e({shortcuts:o,groups:n,folders:a,settings:i,gridItems:d.items});const u=t();!u.isApplyingBrowserBookmarks&&d.removedBrowserBookmarkIds.length>0&&(async()=>{try{u.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of d.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),t().cleanupEmptyGroups()},migrateToGridItems:()=>{}}}const Ke="TMarks",Ye="NewTab Home",qe="tmarks_root_bookmark_id",Ve="tmarks_home_bookmark_id",Xe=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),Je=new Set([Ye]);function Qe(){return"undefined"!=typeof chrome&&!!chrome.bookmarks}function Ze(e){return!e.url}async function et(e){if(!Qe())return null;try{const t=await chrome.bookmarks.get(e);return t?.[0]??null}catch{return null}}async function tt(e){if(!Qe())return[];try{return await chrome.bookmarks.getChildren(e)}catch{return[]}}async function st(e){if(!Qe())return null;try{const t=await chrome.bookmarks.getSubTree(e);return t?.[0]??null}catch{return null}}async function rt(e){if(!Qe())return null;try{return await chrome.bookmarks.create(e)}catch(t){return null}}async function ot(e){const t=await et(e);return t&&!t.url?t:null}async function nt(e){try{await chrome.storage.local.set({[qe]:e})}catch(t){}}async function at(e){try{await chrome.storage.local.set({[Ve]:e})}catch(t){}}async function it(){if(!Qe())return null;const e=await async function(){if(!Qe())return null;try{const e=(await chrome.bookmarks.getTree())[0],t=e.children?.find(e=>"1"===e.id&&!e.url);if(t)return t.id;const s=e.children?.find(e=>!e.url&&Xe.has(e.title));if(s)return s.id;const r=e.children?.find(e=>!e.url);return r?.id??null}catch{return null}}();if(!e)return null;const t=await async function(){try{const e=(await chrome.storage.local.get(qe))[qe];return"string"==typeof e?e:null}catch{return null}}();if(t){if(await ot(t))return{id:t,wasRecreated:!1}}const s=(await tt(e)).find(e=>!e.url&&e.title===Ke);if(s)return await nt(s.id),{id:s.id,wasRecreated:!1};const r=await rt({parentId:e,title:Ke});if(!r)return null;await nt(r.id);const o=null!==t;return{id:r.id,wasRecreated:o}}async function lt(e){if(!Qe()||!e)return null;const t=await async function(){try{const e=(await chrome.storage.local.get(Ve))[Ve];return"string"==typeof e?e:null}catch{return null}}();if(t){const s=await ot(t);if(s){return s.parentId!==e&&await async function(e,t){if(!Qe())return null;try{return await chrome.bookmarks.move(e,t)}catch(s){return null}}(s.id,{parentId:e}),await at(s.id),{id:s.id,wasRecreated:!1}}}const s=(await tt(e)).find(e=>!e.url&&e.title===Ye);if(s)return await at(s.id),{id:s.id,wasRecreated:!1};const r=await rt({parentId:e,title:Ye});return r?(await at(r.id),{id:r.id,wasRecreated:null!==t}):null}function ct(e){return`bb-${e}`}function dt(){return"1x1"}function ut(e,t){const s=[];for(let r=0;r<e.length;r++){const o=e[r];if(Ze(o)){const e={id:ct(o.id),type:"bookmarkFolder",size:dt(),position:r,groupId:t.groupId,parentId:t.parentGridId??void 0,browserBookmarkId:o.id,bookmarkFolder:{title:o.title},createdAt:Date.now()};s.push(e);const n=o.children||[];n.length>0&&s.push(...ut(n,{groupId:t.groupId,parentGridId:e.id}))}else s.push({id:ct(o.id),type:"shortcut",size:"1x1",position:r,groupId:t.groupId,parentId:t.parentGridId??void 0,browserBookmarkId:o.id,shortcut:{url:o.url||"",title:o.title||o.url||""},createdAt:Date.now()})}return s}function mt(){const{isLoading:t,ensureGroupBookmarkFolderId:s,removeGroup:r,setBrowserBookmarksRootId:o,setHomeBrowserFolderId:n,setIsApplyingBrowserBookmarks:a,replaceBrowserBookmarkGridItems:i,upsertBrowserBookmarkNode:l,removeBrowserBookmarkById:c,applyBrowserBookmarkChildrenOrder:d}=pt(),u=e.useRef(!1);e.useEffect(()=>{if(t)return;if(!Qe())return;let e=!1;const m=e=>{const t=pt.getState(),s=t.browserBookmarksRootId,r=t.homeBrowserFolderId;return!(!s||!e)&&(e===s||e===r||(!!t.shortcutGroups.some(t=>t.bookmarkFolderId===e)||t.gridItems.some(t=>t.browserBookmarkId===e&&"bookmarkFolder"===t.type)))},h=async e=>{try{const t=(await tt(e)).map(e=>e.id);a(!0),d(e,t)}finally{a(!1)}},p=()=>{pt.getState().shortcutGroups.filter(e=>"home"!==e.id).forEach(e=>r(e.id,{skipBrowserBookmarkDeletion:!0})),(()=>{const e=pt.getState(),t=e.gridItems.filter(e=>!e.browserBookmarkId),s=e.currentFolderId&&t.some(t=>t.id===e.currentFolderId)?e.currentFolderId:null;pt.setState({gridItems:t,currentFolderId:s}),e.saveData(),pt.getState().cleanupEmptyGroups()})(),o(null),n(null)},x=async()=>{if(!u.current){u.current=!0;try{const t=await it();if(!t||e)return;const{id:r,wasRecreated:l}=t;l&&p(),o(r);const c=await lt(r);c&&n(c.id);const d=pt.getState();await async function(e,t,s,r){const o={created:[],linked:[],skipped:[]};try{const n=(await tt(e)).filter(Ze);for(const e of n){if(Je.has(e.title)){o.skipped.push(e.title);continue}const n=r();if(n.find(t=>t.bookmarkFolderId===e.id)){o.skipped.push(e.title);continue}const a=n.find(t=>t.name===e.title);a?a.bookmarkFolderId?o.skipped.push(e.title):(s(a.id,e.id),o.linked.push(e.title)):(t(e.title,"Folder",{bookmarkFolderId:e.id,skipBookmarkFolderCreation:!0}),o.created.push(e.title))}}catch(n){}return o}(r,d.addGroup,d.setGroupBookmarkFolderId,()=>pt.getState().shortcutGroups),l&&window.dispatchEvent(new CustomEvent("tmarks-folder-recreated",{detail:{message:"TMarks 书签文件夹已重建"}}));const u=["home",...pt.getState().shortcutGroups.filter(e=>"home"!==e.id).map(e=>e.id)],m=[],h=[];for(const e of u){let t=null;if(t="home"===e?c?.id??d.homeBrowserFolderId??await s(e):await s(e),!t)continue;h.push(e);const r=await st(t);r&&m.push(...ut(r.children||[],{groupId:e,parentGridId:null}))}a(!0),i(m,{groupIds:h})}finally{a(!1),u.current=!1}}};x();const g=function(e){if(!Qe()||!chrome.bookmarks?.onCreated)return()=>{};const{onCreated:t,onRemoved:s,onChanged:r,onMoved:o,onChildrenReordered:n}=e;return t&&chrome.bookmarks.onCreated.addListener(t),s&&chrome.bookmarks.onRemoved.addListener(s),r&&chrome.bookmarks.onChanged.addListener(r),o&&chrome.bookmarks.onMoved.addListener(o),n&&chrome.bookmarks.onChildrenReordered.addListener(n),()=>{t&&chrome.bookmarks.onCreated.removeListener(t),s&&chrome.bookmarks.onRemoved.removeListener(s),r&&chrome.bookmarks.onChanged.removeListener(r),o&&chrome.bookmarks.onMoved.removeListener(o),n&&chrome.bookmarks.onChildrenReordered.removeListener(n)}}({onCreated:(e,t)=>{if(!(Date.now()<pt.getState().browserBookmarkWriteLockUntil)&&m(t.parentId)){a(!0);try{l({id:e,parentId:t.parentId,title:t.title,url:t.url,index:t.index})}finally{a(!1)}t.parentId&&h(t.parentId)}},onRemoved:(e,t)=>{if(Date.now()<pt.getState().browserBookmarkWriteLockUntil)return;const s=pt.getState();if(s.browserBookmarksRootId&&e===s.browserBookmarksRootId)return p(),void x();if(!m(t?.parentId))return;const o=s.shortcutGroups.find(t=>t.bookmarkFolderId===e);o&&"home"!==o.id&&r(o.id,{skipBrowserBookmarkDeletion:!0}),a(!0);try{c(e)}finally{a(!1)}t?.parentId&&h(t.parentId)},onChanged:async(e,t)=>{if(Date.now()<pt.getState().browserBookmarkWriteLockUntil)return;const s=await et(e);if(s&&m(s.parentId)){a(!0);try{l({id:e,parentId:s.parentId,title:t.title??s.title,url:t.url??s.url,index:s.index})}finally{a(!1)}}},onMoved:async(e,t)=>{if(Date.now()<pt.getState().browserBookmarkWriteLockUntil)return;const s=m(t.parentId),r=m(t.oldParentId);if(!s&&!r)return;if(r&&!s){a(!0);try{c(e)}finally{a(!1)}return void(await h(t.oldParentId))}const o=await et(e);if(o&&s){a(!0);try{l({id:e,parentId:t.parentId,title:o.title,url:o.url,index:t.index})}finally{a(!1)}}r&&await h(t.oldParentId),s&&await h(t.parentId)},onChildrenReordered:e=>{Date.now()<pt.getState().browserBookmarkWriteLockUntil||m(e)&&h(e)}});return()=>{e=!0,g()}},[t])}let ht=null;const pt=t((e,t)=>{const s=async()=>{const e=t();if(!e.browserBookmarksRootId)return null;let s=e.homeBrowserFolderId;if(s)return s;const r=await lt(e.browserBookmarksRootId);return r?(s=r.id,e.setHomeBrowserFolderId(s),s):null},r=async(e,r)=>{const o=t();if(!Me())return null;if(!o.browserBookmarksRootId)return null;if("home"===e)return s();const n=o.shortcutGroups.find(t=>t.id===e);if(!n)return null;const a=await(async e=>{if(!e)return null;try{const t=await chrome.bookmarks.get(e),s=t?.[0];if(s&&!s.url)return e}catch{}return null})(r?.bookmarkFolderIdOverride??n.bookmarkFolderId??void 0);if(a)return a;const i=o.browserBookmarksRootId;if(!i)return null;try{const t=(await chrome.bookmarks.getChildren(i)).find(e=>!e.url&&e.title===n.name);if(t)return o.setGroupBookmarkFolderId(e,t.id),t.id}catch{}if(r?.createIfMissing)try{o.setBrowserBookmarkWriteLockUntil(Date.now()+1200);const t=await chrome.bookmarks.create({parentId:i,title:n.name});if(t?.id)return o.setGroupBookmarkFolderId(e,t.id),t.id}catch(l){}return null},o=async e=>{const o=t();if(!o.browserBookmarksRootId)return null;if(e.parentGridId){const t=o.gridItems.find(t=>t.id===e.parentGridId);if(t?.browserBookmarkId)return t.browserBookmarkId}const n=e.inferredGroupId??o.activeGroupId??"home";if(null===(e.parentGridId??null))if("home"===n){const e=await s();if(e)return e}else{const e=await r(n);if(e)return e}if("home"===n){const e=await s();if(e)return e}else{const e=await r(n);if(e)return e}return await async function(e){return e?"0"!==e?e:ht||(ht=(async()=>{try{if(!Me())return null;const e=(await chrome.bookmarks.getTree())[0],t=e.children?.find(e=>"1"===e.id&&!e.url);if(t)return t.id;const s=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),r=e.children?.find(e=>!e.url&&s.has(e.title));if(r)return r.id;const o=e.children?.find(e=>!e.url);return o?.id||null}catch{return null}})(),ht):null}(o.browserBookmarksRootId)??o.browserBookmarksRootId},n=async r=>{const o=t();if(!Me())return;if(!o.browserBookmarksRootId)return;const n=o.gridItems.find(e=>e.id===r);if(!n)return;if(n.browserBookmarkId)return;if(!(e=>"home"===(e.groupId??"home")&&null===(e.parentId??null))(n))return;if("shortcut"===n.type&&!n.shortcut?.url)return;const a=await s();if(a){o.setBrowserBookmarkWriteLockUntil(Date.now()+1200);try{let s;if("bookmarkFolder"===n.type?s=await chrome.bookmarks.create({parentId:a,title:n.bookmarkFolder?.title||"文件夹"}):"shortcut"===n.type&&(s=await chrome.bookmarks.create({parentId:a,title:n.shortcut?.title||n.shortcut?.url||"快捷方式",url:n.shortcut?.url})),!s?.id)return;e({gridItems:t().gridItems.map(e=>e.id===n.id?{...e,browserBookmarkId:s.id}:e)}),o.saveData()}catch(i){}}},a=function(e,t){return{addShortcut:s=>{const{shortcuts:r,shortcutGroups:o,settings:n,gridItems:a,saveData:i}=e(),l={...s,id:Re(),position:r.length,createdAt:Date.now(),clickCount:0},c=[...r,l];t({shortcuts:c}),i(),(async()=>{try{const{downloadFavicon:t}=await Be(async()=>{const{downloadFavicon:e}=await Promise.resolve().then(()=>qt);return{downloadFavicon:e}},void 0),s=await t(l.url);if(s){const{updateShortcut:t}=e();t(l.id,{faviconBase64:s})}}catch(t){}})();const{shortcutFolders:d}=e();_e({shortcuts:c,groups:o,folders:d,settings:n,gridItems:a})},updateShortcut:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=e(),d=o.map(e=>e.id===s?{...e,...r}:e);t({shortcuts:d}),c(),_e({shortcuts:d,groups:n,folders:a,settings:i,gridItems:l})},removeShortcut:s=>{const{shortcuts:r,shortcutGroups:o,shortcutFolders:n,settings:a,gridItems:i,saveData:l}=e(),c=r.filter(e=>e.id!==s).map((e,t)=>({...e,position:t}));t({shortcuts:c}),l(),_e({shortcuts:c,groups:o,folders:n,settings:a,gridItems:i})},reorderShortcuts:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=e(),d=[...o],[u]=d.splice(s,1);d.splice(r,0,u);const m=d.map((e,t)=>({...e,position:t}));t({shortcuts:m}),c(),_e({shortcuts:m,groups:n,folders:a,settings:i,gridItems:l})},incrementClickCount:s=>{const{shortcuts:r,saveData:o}=e();t({shortcuts:r.map(e=>e.id===s?{...e,clickCount:e.clickCount+1}:e)}),o()},getFilteredShortcuts:()=>{const{shortcuts:t,activeGroupId:s}=e(),r=s??"home";return t.filter(e=>e.groupId===r&&!e.folderId)}}}(t,e),i=function(e,t,s){return{setActiveGroup:s=>{const{saveData:r}=e();t({activeGroupId:s,currentFolderId:null}),r()},addGroup:(r,o,n)=>{const{shortcuts:a,shortcutGroups:i,shortcutFolders:l,settings:c,gridItems:d,saveData:u}=e(),m={id:Re(),name:r,icon:o,position:i.length,bookmarkFolderId:n?.bookmarkFolderId??void 0},h=[...i,m];t({shortcutGroups:h}),u(),_e({shortcuts:a,groups:h,folders:l,settings:c,gridItems:d}),n?.skipBookmarkFolderCreation||s(m.id,{createIfMissing:!n?.bookmarkFolderId,bookmarkFolderIdOverride:n?.bookmarkFolderId??void 0})},updateGroup:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=e(),d=n.map(e=>e.id===s?{...e,...r}:e);t({shortcutGroups:d}),c(),_e({shortcuts:o,groups:d,folders:a,settings:i,gridItems:l})},removeGroup:(s,r)=>{const{shortcutGroups:o,shortcutFolders:n,shortcuts:a,activeGroupId:i,settings:l,gridItems:c,saveData:d,setBrowserBookmarkWriteLockUntil:u}=e();if("home"===s)return;const m=o.find(e=>e.id===s);if(!m)return;const h=!!m.bookmarkFolderId,p=h?a.filter(e=>e.groupId!==s):a.map(e=>e.groupId===s?{...e,groupId:"home"}:e),x=h?c.filter(e=>e.groupId!==s):c.map(e=>e.groupId===s?{...e,groupId:"home",parentId:null}:e),g=o.filter(e=>e.id!==s).map((e,t)=>({...e,position:t}));t({shortcutGroups:g,shortcuts:p,gridItems:x,activeGroupId:i===s?"home":i,...i===s?{currentFolderId:null}:{}}),d(),_e({shortcuts:p,groups:g,folders:n,settings:l,gridItems:x}),m.bookmarkFolderId&&!r?.skipBrowserBookmarkDeletion&&(async()=>{try{u(Date.now()+1200);try{await chrome.bookmarks.removeTree(m.bookmarkFolderId)}catch{try{await chrome.bookmarks.remove(m.bookmarkFolderId)}catch{}}}catch{}})()},setGroupBookmarkFolderId:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=e(),d=n.map(e=>e.id===s?{...e,bookmarkFolderId:r??void 0}:e);t({shortcutGroups:d}),c(),_e({shortcuts:o,groups:d,folders:a,settings:i,gridItems:l})},cleanupEmptyGroups:()=>{const{shortcutGroups:s,shortcutFolders:r,shortcuts:o,activeGroupId:n,settings:a,gridItems:i,saveData:l,setBrowserBookmarkWriteLockUntil:c}=e(),d=s.filter(e=>"home"!==e.id&&!i.some(t=>(t.groupId??"home")===e.id&&null===(t.parentId??null))).map(e=>e.id);if(0===d.length)return;const u=[];d.forEach(e=>{const t=s.find(t=>t.id===e);t?.bookmarkFolderId&&u.push(t.bookmarkFolderId)});const m=s.filter(e=>!d.includes(e.id)).map((e,t)=>({...e,position:t})),h=d.includes(n??"")?"home":n,p=d.includes(n??"");t({shortcutGroups:m,activeGroupId:h,...p?{currentFolderId:null}:{}}),l(),_e({shortcuts:o,groups:m,folders:r,settings:a,gridItems:i}),u.length>0&&(async()=>{try{c(Date.now()+1200);for(const e of u)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})()}}}(t,e,r),l=function(e,t){return{addFolder:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,activeGroupId:i,settings:l,gridItems:c,saveData:d}=e(),u={id:Re(),name:s,position:a.length,groupId:r??i??void 0,createdAt:Date.now()},m=[...a,u];return t({shortcutFolders:m}),d(),_e({shortcuts:o,groups:n,folders:m,settings:l,gridItems:c}),u.id},updateFolder:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=e(),d=a.map(e=>e.id===s?{...e,...r}:e);t({shortcutFolders:d}),c(),_e({shortcuts:o,groups:n,folders:d,settings:i,gridItems:l})},removeFolder:s=>{const{shortcuts:r,shortcutGroups:o,shortcutFolders:n,settings:a,gridItems:i,saveData:l}=e(),c=r.map(e=>e.folderId===s?{...e,folderId:void 0}:e),d=n.filter(e=>e.id!==s);t({shortcutFolders:d,shortcuts:c}),l(),_e({shortcuts:c,groups:o,folders:d,settings:a,gridItems:i})},getFolderShortcuts:t=>{const{shortcuts:s}=e();return s.filter(e=>e.folderId===t)},moveShortcutToFolder:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=e(),d=o.map(e=>e.id===s?{...e,folderId:r}:e);t({shortcuts:d}),c(),_e({shortcuts:d,groups:n,folders:a,settings:i,gridItems:l})}}}(t,e),c=He(e,t,o),d=function(e,t,s,r){return{setBrowserBookmarksRootId:t=>{e(e=>({browserBookmarksRootId:t,homeBrowserFolderId:t?e.homeBrowserFolderId:null}))},setHomeBrowserFolderId:t=>{e({homeBrowserFolderId:t})},setGroupBookmarkFolderId:(s,r)=>{const{shortcuts:o,shortcutGroups:n,shortcutFolders:a,settings:i,gridItems:l,saveData:c}=t(),d=n.map(e=>e.id===s?{...e,bookmarkFolderId:r??void 0}:e);e({shortcutGroups:d}),c(),_e({shortcuts:o,groups:d,folders:a,settings:i,gridItems:l})},setIsApplyingBrowserBookmarks:t=>{e({isApplyingBrowserBookmarks:t})},setBrowserBookmarkWriteLockUntil:t=>{e({browserBookmarkWriteLockUntil:t})},replaceBrowserBookmarkGridItems:(s,r)=>{const{gridItems:o,saveData:n}=t(),a=Array.from(new Set(s.map(e=>e.groupId??"home"))),i=new Set(r?.groupIds&&r.groupIds.length>0?r.groupIds:a),l=[...o.filter(e=>{if(!e.browserBookmarkId)return!0;if(0===i.size)return!1;const t=e.groupId??"home";return!i.has(t)}),...s.map(e=>({...e,parentId:e.parentId??null,groupId:e.groupId??"home"}))];e({gridItems:l}),n(),t().cleanupEmptyGroups()},upsertBrowserBookmarkNode:o=>{const{gridItems:n,saveData:a,browserBookmarksRootId:i}=t();if(!i)return;const l=`bb-${o.id}`,c=n.find(e=>e.id===l),d=o.parentId,u=s(d);let m;d&&(m=r(d)?null:d===i?void 0:`bb-${d}`);const h="number"==typeof o.index?o.index:c?.position??0,p={id:l,type:o.url?"shortcut":"bookmarkFolder",size:c?.size??"1x1",position:h,groupId:u,parentId:m,browserBookmarkId:o.id,shortcut:o.url?{url:o.url,title:o.title||o.url,favicon:c?.shortcut?.favicon,faviconBase64:c?.shortcut?.faviconBase64}:void 0,bookmarkFolder:o.url?void 0:{title:o.title||c?.bookmarkFolder?.title||"文件夹"},config:c?.config,createdAt:c?.createdAt??Date.now()},x=[...n.filter(e=>!e.browserBookmarkId),...n.filter(e=>e.browserBookmarkId&&e.id!==l),p];e({gridItems:x}),a()},removeBrowserBookmarkById:s=>{const{gridItems:r,currentFolderId:o,saveData:n,browserBookmarksRootId:a}=t(),i=`bb-${s}`,l=r.find(e=>e.id===i);if(!l)return;let c=new Set([i]);if("bookmarkFolder"===l.type){let e=!0;for(;e;){e=!1;for(const t of r){const s=t.parentId;s&&c.has(s)&&!c.has(t.id)&&(c.add(t.id),e=!0)}}}const d=$e(r.filter(e=>!c.has(e.id)),o&&c.has(o)?null:o,new Set([a].filter(Boolean)));e({gridItems:d.items,currentFolderId:d.currentFolderId}),n(),t().cleanupEmptyGroups()},applyBrowserBookmarkChildrenOrder:(s,r)=>{const{gridItems:o,saveData:n}=t(),a=new Map(r.map((e,t)=>[`bb-${e}`,t])),i=o.map(e=>{const t=a.get(e.id);return void 0!==t?{...e,position:t}:e});e({gridItems:i}),n()}}}(e,t,e=>{const s=t();if(!e)return"home";if(e===s.homeBrowserFolderId)return"home";const r=s.shortcutGroups.find(t=>t.bookmarkFolderId===e);if(r)return r.id;const o=s.gridItems.find(t=>t.browserBookmarkId===e&&"bookmarkFolder"===t.type);return o?.groupId??"home"},e=>{if(!e)return!1;const s=t();return e===s.homeBrowserFolderId||s.shortcutGroups.some(t=>t.bookmarkFolderId===e)}),u=We(e,t,o);return{shortcuts:[],shortcutGroups:we,shortcutFolders:[],activeGroupId:"home",settings:fe,isLoading:!0,gridItems:[],currentFolderId:null,browserBookmarksRootId:null,homeBrowserFolderId:null,isApplyingBrowserBookmarks:!1,browserBookmarkWriteLockUntil:0,loadData:async()=>{try{const s=(await chrome.storage.local.get(be))[be],r=s?.shortcutGroups?.length?s.shortcutGroups:we;let o=s?.activeGroupId;o&&r.some(e=>e.id===o)||(o=r[0]?.id||"home");const n={...fe,...s?.settings||{}};if(e({shortcuts:s?.shortcuts||[],shortcutGroups:r,shortcutFolders:s?.shortcutFolders||[],activeGroupId:o,settings:n,gridItems:s?.gridItems||[],currentFolderId:null,browserBookmarksRootId:null,homeBrowserFolderId:null,isApplyingBrowserBookmarks:!1,browserBookmarkWriteLockUntil:0,isLoading:!1}),!s){const{saveData:e}=t();e()}}catch(s){e({isLoading:!1})}},saveData:async()=>{const{shortcuts:e,shortcutGroups:s,shortcutFolders:r,activeGroupId:o,settings:n,gridItems:a}=t(),i={shortcuts:e,shortcutGroups:s,shortcutFolders:r,activeGroupId:o,settings:n,gridItems:a};try{await chrome.storage.local.set({[be]:i})}catch(l){}},updateSettings:s=>{const{shortcuts:r,shortcutGroups:o,shortcutFolders:n,settings:a,gridItems:i,saveData:l}=t(),c={...a,...s};e({settings:c}),l(),_e({shortcuts:r,groups:o,folders:n,settings:c,gridItems:i})},...a,...i,ensureGroupBookmarkFolderId:r,...l,...c,...d,...u,mirrorHomeItemsToBrowser:e=>{for(const t of e)n(t)}}});function xt({format:t,showDate:r,showSeconds:o,showLunar:n=!1}){const[a,i]=e.useState(new Date);e.useEffect(()=>{const e=setInterval(()=>i(new Date),1e3);return()=>clearInterval(e)},[]);const l=e.useMemo(()=>{if(!n)return null;const e=Fe.Lunar.fromDate(a);let t="";try{const s=e.getFestivals?.()||[],r=e.getJieQi?.()||"";t=s[0]||r||""}catch{}return{date:`${e.getMonthInChinese()}月${e.getDayInChinese()}`,festival:t}},[a,n]);return s.jsxs("div",{className:"text-center text-white select-none",children:[s.jsx("div",{className:"text-7xl font-light tracking-wider text-shadow-lg",children:(()=>{let e=a.getHours();const s=a.getMinutes().toString().padStart(2,"0"),r=a.getSeconds().toString().padStart(2,"0");let n="";"12h"===t&&(n=e>=12?" PM":" AM",e=e%12||12);let i=`${e.toString().padStart(2,"0")}:${s}`;return o&&(i+=`:${r}`),"12h"===t&&(i+=n),i})()}),(r||n)&&s.jsxs("div",{className:"mt-2 text-lg text-white/90 text-shadow flex items-center justify-center gap-3",children:[r&&s.jsx("span",{children:a.toLocaleDateString("zh-CN",{weekday:"short",month:"numeric",day:"numeric"})}),r&&n&&s.jsx("span",{className:"text-white/50",children:"|"}),n&&l&&s.jsxs(s.Fragment,{children:[s.jsx("span",{children:l.date}),l.festival&&s.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 text-sm",children:l.festival})]})]})]})}const gt="tmarks_pinned_bookmarks";async function ft(){const e=await Ce.getBookmarkSiteApiUrl(),t=await Ce.getBookmarkSiteApiKey();if(!t)throw new Error("API Key 未配置");let s;return s=e?e.endsWith("/api")?e:Se(e).API_BASE:Se().API_BASE,De({apiKey:t,baseUrl:s})}function wt(){const[t,s]=e.useState({isSyncing:!1,lastSyncAt:null,error:null}),[r,o]=e.useState([]),n=e.useRef(null),a=e.useCallback(async()=>{try{const e=(await chrome.storage.local.get(gt))[gt];return e&&e.bookmarks?e.bookmarks:null}catch(e){return null}},[]),i=e.useCallback(async e=>{try{const t={bookmarks:e,timestamp:Date.now()};await chrome.storage.local.set({[gt]:t})}catch(t){}},[]),l=e.useCallback(async(e=!1)=>{if(!e){const e=await a();if(e)return o(e),s({isSyncing:!1,lastSyncAt:Date.now(),error:null}),e}s(e=>({...e,isSyncing:!0,error:null}));try{const e=await ft(),t=await e.bookmarks.getPinnedBookmarks({page_size:20});if(t.data?.bookmarks){const e=t.data.bookmarks.filter(e=>!0===e.is_pinned).map(e=>({id:e.id,url:e.url,title:e.title,favicon:e.favicon||void 0,is_pinned:!0}));o(e),await i(e)}return s({isSyncing:!1,lastSyncAt:Date.now(),error:null}),t.data?.bookmarks||[]}catch(t){const e=t instanceof Error?t.message:"同步失败";return s(t=>({...t,isSyncing:!1,error:e})),[]}},[a,i]),c=e.useCallback(async e=>{if(!e.trim())return[];try{const t=await ft(),s=await t.bookmarks.searchBookmarks(e,{page_size:10});return(s.data?.bookmarks||[]).map(e=>({id:e.id,url:e.url,title:e.title,favicon:e.favicon||void 0}))}catch{return[]}},[]),d=e.useCallback(async()=>{try{const e=await ft();return await e.bookmarks.getBookmarks({page_size:1}),!0}catch{return!1}},[]);e.useEffect(()=>{n.current=l},[l]),e.useEffect(()=>{const e=e=>{"REFRESH_PINNED_BOOKMARKS"===e.type&&n.current&&n.current(!0)};return chrome.runtime.onMessage.addListener(e),()=>{chrome.runtime.onMessage.removeListener(e)}},[]);const u=e.useCallback(async e=>{try{const t=e.map(e=>r.find(t=>t.id===e)).filter(e=>void 0!==e);o(t),await i(t);const s=await ft();await s.bookmarks.reorderPinnedBookmarks(e)}catch(t){await l(!0)}},[r,i,l]);return{syncState:t,pinnedBookmarks:r,fetchPinnedBookmarks:l,searchBookmarks:c,checkApiConfigured:d,reorderPinnedBookmarks:u}}function bt({icon:e,name:t,size:r="md"}){const o="sm"===r?"w-4 h-4":"w-5 h-5";return s.jsx("img",{src:e,alt:t,className:`${o} object-contain`,onError:e=>{e.currentTarget.style.display="none";const t=e.currentTarget.parentElement;if(t&&!t.querySelector(".fallback-icon")){const e=document.createElement("span");e.className=`fallback-icon ${o} flex items-center justify-center`,e.innerHTML=`<svg class="${o} text-white/60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`,t.appendChild(e)}}})}function kt({current:t,onChange:o}){const[n,a]=e.useState(!1),i=ke.find(e=>e.id===t)||ke[0];return s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>a(!n),className:"flex items-center gap-1.5 px-2 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 active:scale-95 transition-all focus:outline-none focus:ring-2 focus:ring-white/20",children:[s.jsx(bt,{icon:i.icon,name:i.name}),s.jsx(r,{className:"w-3 h-3 text-white/60 transition-transform "+(n?"rotate-180":"")})]}),n&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>a(!1)}),s.jsx("div",{className:"absolute top-full left-0 mt-2 w-40 rounded-xl glass-dark overflow-hidden z-50 animate-scaleIn",children:ke.map(e=>s.jsxs("button",{onClick:()=>{o(e.id),a(!1)},className:"w-full flex items-center gap-3 px-3 py-2.5 text-left transition-colors "+(e.id===t?"bg-white/20":"hover:bg-white/10"),children:[s.jsx(bt,{icon:e.icon,name:e.name}),s.jsx("span",{className:"text-sm text-white/80",children:e.name})]},e.id))})]})]})}function vt(e,t){if(e)return e;try{const e=new URL(t).hostname;return`${ve}${e}&sz=64`}catch{return""}}function yt({engine:t,enableSuggestions:r=!0,onEngineChange:a}){const[i,l]=e.useState(""),[c,d]=e.useState(!1),[u,m]=e.useState([]),[h,p]=e.useState(-1),[x,g]=e.useState(!1),f=e.useRef(null),w=e.useRef(),{shortcuts:b}=pt(),{searchBookmarks:k}=wt(),v=ke.find(e=>e.id===t)||ke[0],y=e.useCallback(e=>{const t=e.toLowerCase();return b.filter(e=>e.title.toLowerCase().includes(t)||e.url.toLowerCase().includes(t)).slice(0,5).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"shortcut"}))},[b]);e.useEffect(()=>{if(i.trim())return w.current&&clearTimeout(w.current),w.current=setTimeout(async()=>{if(x){const e=y(i),t=(await k(i)).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"bookmark"})),s=[...e];t.forEach(e=>{s.some(t=>t.url===e.url)||s.push(e)}),m(s.slice(0,10))}else if(r){const e=y(i),t=(await k(i)).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"bookmark"})),s=[...e];t.forEach(e=>{s.some(t=>t.url===e.url)||s.push(e)}),m(s.slice(0,8))}},200),()=>{w.current&&clearTimeout(w.current)};m([])},[i,y,k,x,r]);const j=e.useCallback(()=>{if(!i.trim())return;const e=v.url+encodeURIComponent(i.trim());window.location.href=e},[i,v]),I=e=>{window.location.href=e.url},N=(x||r)&&c&&u.length>0;return s.jsxs("div",{className:"relative",children:[s.jsxs("div",{className:`\n          flex items-center gap-3 px-4 py-3 rounded-full\n          glass transition-all duration-200\n          ${c?"ring-2 ring-white/30 bg-white/15":"hover:bg-white/15"}\n        `,children:[a?s.jsx(kt,{current:t,onChange:a}):s.jsx(o,{className:"w-5 h-5 text-white/60 flex-shrink-0"}),s.jsx("input",{ref:f,type:"text",value:i,onChange:e=>{l(e.target.value),p(-1)},onKeyDown:e=>{"Enter"===e.key?h>=0&&u[h]?I(u[h]):x||j():"ArrowDown"===e.key?(e.preventDefault(),p(e=>Math.min(e+1,u.length-1))):"ArrowUp"===e.key?(e.preventDefault(),p(e=>Math.max(e-1,-1))):"Escape"===e.key&&(m([]),p(-1))},onFocus:()=>d(!0),onBlur:()=>setTimeout(()=>d(!1),150),placeholder:x?"搜索书签...":`在 ${v.name} 中搜索...`,className:"flex-1 bg-transparent text-white placeholder-white/50 outline-none text-base"}),s.jsx("button",{onClick:()=>g(!x),className:"p-2 rounded-full transition-all active:scale-90 "+(x?"bg-blue-500/30 text-blue-400":"text-white/40 hover:text-white/70 hover:bg-white/10"),title:x?"切换到搜索引擎":"切换到书签搜索",children:s.jsx(n,{className:"w-4 h-4"})})]}),N&&s.jsx("div",{className:"absolute top-full left-0 right-0 mt-2 rounded-xl glass-dark overflow-hidden animate-scaleIn z-[100]",children:u.map((e,t)=>s.jsxs("button",{onClick:()=>I(e),className:`\n                w-full flex items-center gap-3 px-4 py-3 text-left\n                transition-colors\n                ${t===h?"bg-white/20":"hover:bg-white/10"}\n              `,children:[s.jsx("img",{src:vt(e.favicon,e.url),alt:"",className:"w-5 h-5 rounded",onError:e=>{e.target.style.display="none"}}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"text-sm text-white truncate",children:e.title}),s.jsx("div",{className:"text-xs text-white/50 truncate",children:e.url})]}),s.jsx("span",{className:"text-xs text-white/30",children:"shortcut"===e.source?"快捷方式":"书签"})]},e.id))})]})}const jt=40,It=100,Nt=110,Ct=1e3,St="newtab_weather",Bt={sunny:m,cloudy:a,rainy:h,snowy:p,windy:d};function Ft(e){const t=e.toLowerCase();return t.includes("sun")||t.includes("clear")||t.includes("晴")?Bt.sunny:t.includes("rain")||t.includes("雨")?Bt.rainy:t.includes("snow")||t.includes("雪")?Bt.snowy:t.includes("wind")||t.includes("风")?Bt.windy:Bt.cloudy}const Dt=e.memo(function({item:t,onUpdate:r,onRemove:o,isEditing:n}){const[m,h]=e.useState(null),[p,x]=e.useState(!1),[g,f]=e.useState(null),[w,b]=e.useState(!1),[k,v]=e.useState(""),{rows:y}=Ue(t.size),j=t.config?.weather?.city||"北京",I=t.config?.weather?.unit||"C",N=y>=2,C=async(e,t=!1)=>{if(!t)try{const t=(await chrome.storage.local.get(St))[St];if(t&&t.city===e&&Date.now()-t.data.updateTime<18e5)return void h(t.data)}catch{}x(!0),f(null);try{const t=await fetch(`https://api.vvhan.com/api/weather?city=${encodeURIComponent(e)}`);if(!t.ok)throw new Error("获取天气失败");const s=await t.json();if(!s.success)throw new Error(s.message||"获取天气失败");const r={city:s.data.city||e,temp:parseInt(s.data.tem)||0,condition:s.data.wea||"未知",icon:s.data.wea_img||"cloudy",humidity:parseInt(s.data.humidity)||0,windSpeed:parseInt(s.data.win_speed)||0,visibility:10,updateTime:Date.now(),forecast:N&&s.data.forecast?s.data.forecast.slice(0,3).map(e=>({date:e.date,tempMax:parseInt(e.tem_day)||0,tempMin:parseInt(e.tem_night)||0,condition:e.wea||"未知",icon:e.wea_img||"cloudy"})):void 0};h(r),chrome.storage.local.set({[St]:{city:e,data:r}})}catch(s){f(s instanceof Error?s.message:"获取天气失败")}finally{x(!1)}};e.useEffect(()=>{C(j)},[j]);const S=m?Ft(m.condition):a;return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("button",{onClick:()=>b(!w),className:"flex items-center gap-2 text-white/80 hover:text-white transition-colors",children:[s.jsx(i,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm font-medium",children:m?.city||j})]}),s.jsx("button",{onClick:()=>C(j,!0),disabled:p,className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(l,{className:"w-3 h-3 text-white/50 "+(p?"animate-spin":"")})})]}),w&&s.jsx("div",{className:"mb-2",children:s.jsx("input",{type:"text",value:k,onChange:e=>v(e.target.value),onKeyDown:e=>"Enter"===e.key&&void(k.trim()&&r&&(r(t.id,{config:{...t.config,weather:{...t.config?.weather,city:k.trim()}}}),b(!1),v(""))),placeholder:"输入城市名称",className:"w-full bg-white/10 text-white text-xs rounded px-2 py-1 outline-none border border-white/20 focus:border-blue-500/50",autoFocus:!0})}),p&&!m?s.jsx("div",{className:"flex-1 flex items-center justify-center text-white/40 text-sm",children:"加载中..."}):g?s.jsx("div",{className:"flex-1 flex items-center justify-center text-red-400 text-sm",children:g}):m?s.jsxs("div",{className:"flex-1 flex flex-col",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[s.jsx(S,{className:"w-12 h-12 text-yellow-400"}),s.jsxs("div",{children:[s.jsxs("div",{className:"text-3xl font-bold text-white",children:[m.temp,"°",I]}),s.jsx("div",{className:"text-sm text-white/60",children:m.condition})]})]}),s.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs text-white/60 mb-3",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(c,{className:"w-3 h-3"}),s.jsxs("span",{children:[m.humidity,"%"]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(d,{className:"w-3 h-3"}),s.jsxs("span",{children:[m.windSpeed,"km/h"]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(u,{className:"w-3 h-3"}),s.jsxs("span",{children:[m.visibility,"km"]})]})]}),N&&m.forecast&&m.forecast.length>0&&s.jsxs("div",{className:"flex-1 border-t border-white/10 pt-2",children:[s.jsx("div",{className:"text-xs text-white/60 mb-2",children:"未来预报"}),s.jsx("div",{className:"space-y-1",children:m.forecast.map((e,t)=>{const r=Ft(e.condition);return s.jsxs("div",{className:"flex items-center justify-between text-xs",children:[s.jsx("span",{className:"text-white/60",children:e.date}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(r,{className:"w-3 h-3 text-white/60"}),s.jsxs("span",{className:"text-white/80",children:[e.tempMax,"° / ",e.tempMin,"°"]})]})]},t)})})]})]}):null]})}),Et=e.memo(function({item:t,onRemove:r,isEditing:o}){const[n,a]=e.useState(new Date),{rows:i}=Ue(t.size),l=i>=2,c=t.config?.clock||{format:"24h",showDate:!0,showSeconds:!1,showLunar:!1};e.useEffect(()=>{const e=setInterval(()=>a(new Date),1e3);return()=>clearInterval(e)},[]);const d=e.useMemo(()=>{if(!c.showLunar)return null;try{const e=Fe.Lunar.fromDate(n),t=e.getMonthInChinese(),s=e.getDayInChinese(),r=e.getFestivals?.()||[],o=e.getJieQi?.()||null;return{date:`${t}月${s}`,festival:r.length>0?r[0]:o||null}}catch{return null}},[n.toDateString(),c.showLunar]);return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col items-center justify-center",children:[s.jsx("div",{className:"text-white font-light tracking-wider "+(l?"text-5xl":"text-3xl"),children:(()=>{let e=n.getHours();const t=n.getMinutes().toString().padStart(2,"0"),s=n.getSeconds().toString().padStart(2,"0");let r="";"12h"===c.format&&(r=e>=12?" PM":" AM",e=e%12||12);let o=`${e.toString().padStart(2,"0")}:${t}`;return c.showSeconds&&(o+=`:${s}`),"12h"===c.format&&(o+=r),o})()}),c.showDate&&s.jsx("div",{className:"text-white/70 "+(l?"text-base mt-2":"text-sm mt-1"),children:`${n.getMonth()+1}月${n.getDate()}日 ${["周日","周一","周二","周三","周四","周五","周六"][n.getDay()]}`}),c.showLunar&&d&&s.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[s.jsx("span",{className:"text-sm text-white/60",children:d.date}),d.festival&&s.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 text-xs text-white/70",children:d.festival})]})]})}),zt={default:s.jsx(b,{className:"w-8 h-8"}),search:s.jsx(o,{className:"w-8 h-8"}),bookmark:s.jsx(w,{className:"w-8 h-8"}),todo:s.jsx(f,{className:"w-8 h-8"}),notes:s.jsx(g,{className:"w-8 h-8"}),hotsearch:s.jsx(x,{className:"w-8 h-8"})},Gt={default:"暂无内容",search:"未找到结果",bookmark:"暂无书签",todo:"暂无待办事项",notes:"暂无笔记",hotsearch:"暂无数据"};function Tt({type:e="default",message:t,description:r}){return s.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-white/40",children:[s.jsx("div",{className:"mb-2 opacity-50",children:zt[e]}),s.jsx("p",{className:"text-sm",children:t||Gt[e]}),r&&s.jsx("p",{className:"text-xs text-white/30 mt-1",children:r})]})}const Lt="newtab_todos",At=t((e,t)=>({todos:[],loadTodos:async()=>{try{const t=(await chrome.storage.local.get(Lt))[Lt];t&&e({todos:t})}catch(t){}},addTodo:s=>{const{todos:r}=t(),o=[{id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,text:s,completed:!1,createdAt:Date.now()},...r];e({todos:o}),chrome.storage.local.set({[Lt]:o})},toggleTodo:s=>{const{todos:r}=t(),o=r.map(e=>e.id===s?{...e,completed:!e.completed}:e);e({todos:o}),chrome.storage.local.set({[Lt]:o})},removeTodo:s=>{const{todos:r}=t(),o=r.filter(e=>e.id!==s);e({todos:o}),chrome.storage.local.set({[Lt]:o})},clearCompleted:()=>{const{todos:s}=t(),r=s.filter(e=>!e.completed);e({todos:r}),chrome.storage.local.set({[Lt]:r})}}));At.getState().loadTodos();const Rt=e.memo(function({item:t,onRemove:r,isEditing:o}){const{todos:n,addTodo:a,toggleTodo:i,removeTodo:l}=At(),[c,d]=e.useState(""),[u,m]=e.useState(!1),{rows:h}=Ue(t.size),p=()=>{c.trim()&&(a(c.trim()),d(""))},x=n.filter(e=>!e.completed),g=n.filter(e=>e.completed),w=u?n:x,b=h<=2?4:h<=3?6:10;return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2 text-white/80",children:[s.jsx(f,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm font-medium",children:"待办事项"}),x.length>0&&s.jsx("span",{className:"px-1.5 py-0.5 text-xs bg-white/20 rounded-full",children:x.length})]}),g.length>0&&s.jsx("button",{onClick:()=>m(!u),className:"text-xs text-white/50 hover:text-white/80 transition-colors",children:u?"隐藏":`${g.length} 完成`})]}),s.jsxs("div",{className:"flex gap-2 mb-2",children:[s.jsx("input",{type:"text",value:c,onChange:e=>d(e.target.value),onKeyDown:e=>{"Enter"===e.key&&p()},placeholder:"添加待办...",className:"flex-1 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none \r\n                     border border-white/10 focus:border-white/30 placeholder-white/40"}),s.jsx("button",{onClick:p,className:"p-1.5 rounded-xl bg-white/10 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-white/20",children:s.jsx(k,{className:"w-4 h-4 text-white/70"})})]}),s.jsxs("div",{className:"flex-1 space-y-1 overflow-y-auto",children:[0===w.length?s.jsx(Tt,{type:"todo"}):w.slice(0,b).map(e=>s.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded-lg hover:bg-white/10 group/item transition-colors "+(e.completed?"opacity-50":""),children:[s.jsx("button",{onClick:()=>i(e.id),className:"w-4 h-4 rounded-full border flex items-center justify-center transition-colors flex-shrink-0 "+(e.completed?"bg-green-500/50 border-green-500/50":"border-white/30 hover:border-white/50"),children:e.completed&&s.jsx(v,{className:"w-2.5 h-2.5 text-white"})}),s.jsx("span",{className:"flex-1 text-sm text-white/80 truncate "+(e.completed?"line-through":""),children:e.text}),s.jsx("button",{onClick:()=>l(e.id),className:"p-0.5 rounded opacity-0 group-hover/item:opacity-100 hover:bg-white/20 transition-all",children:s.jsx(y,{className:"w-3 h-3 text-white/50"})})]},e.id)),w.length>b&&s.jsxs("div",{className:"text-center text-white/40 text-xs py-1",children:["还有 ",w.length-b," 项..."]})]})]})}),Mt="newtab_notes",$t=e.memo(function({item:t,onRemove:r,isEditing:o}){const[n,a]=e.useState(""),[i,l]=e.useState(!1),c=e.useRef(null),d=e.useRef();e.useEffect(()=>{chrome.storage.local.get(Mt).then(e=>{const t=e[Mt];t?.content&&a(t.content)})},[]);return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2 text-white/80",children:[s.jsx(j,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm font-medium",children:"备忘录"})]}),i&&s.jsx("span",{className:"text-xs text-white/40",children:"保存中..."})]}),s.jsx("textarea",{ref:c,value:n,onChange:e=>{return t=e.target.value,a(t),l(!0),d.current&&clearTimeout(d.current),void(d.current=setTimeout(()=>{chrome.storage.local.set({[Mt]:{content:t,updatedAt:Date.now()}}),l(!1)},500));var t},placeholder:"记录一些想法...",className:"flex-1 w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none \r\n                   border border-white/10 focus:border-white/30 placeholder-white/40 resize-none"})]})}),Ot="newtab_hotsearch",_t={baidu:"https://api.vvhan.com/api/hotlist/baiduRD",weibo:"https://api.vvhan.com/api/hotlist/wbHot",zhihu:"https://api.vvhan.com/api/hotlist/zhihuHot",bilibili:"https://api.vvhan.com/api/hotlist/bili"},Pt=e.memo(function({item:t,onUpdate:o,onRemove:n,isEditing:a}){const[i,c]=e.useState([]),[d,u]=e.useState(!1),[m,h]=e.useState(!1),{rows:p}=Ue(t.size),x=t.config?.hotsearch?.type||"baidu",g=ye.find(e=>e.id===x)||ye[0],f=p<=2?5:p<=3?10:15,w=async(e=!1)=>{if(!e)try{const e=(await chrome.storage.local.get(Ot))[Ot];if(e&&e.type===x&&Date.now()-e.timestamp<6e5)return void c(e.items)}catch{}u(!0);try{const e=await fetch(_t[x]),t=await e.json();let s=[];t.success&&t.data&&(s=t.data.slice(0,15).map(e=>({title:e.title||e.name||e.desc,hot:e.hot||e.hotValue||e.index||"",url:e.url||e.link||"#"}))),c(s),chrome.storage.local.set({[Ot]:{type:x,items:s,timestamp:Date.now()}})}catch(t){}finally{u(!1)}};e.useEffect(()=>{w()},[x]);return s.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(I,{className:"w-4 h-4 text-orange-400"}),s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>h(!m),className:"text-sm font-medium text-white/80 hover:text-white flex items-center gap-1",children:[g.name,s.jsx(r,{className:"w-3 h-3 transition-transform "+(m?"rotate-180":"")})]}),m&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>h(!1)}),s.jsx("div",{className:"absolute top-full left-0 mt-1 w-24 rounded-lg glass-dark overflow-hidden z-50",children:ye.map(e=>s.jsx("button",{onClick:()=>{return s=e.id,o?.(t.id,{config:{...t.config,hotsearch:{type:s}}}),void h(!1);var s},className:"w-full px-3 py-1.5 text-left text-sm transition-colors "+(e.id===x?"bg-white/20 text-white":"text-white/70 hover:bg-white/10"),children:e.name},e.id))})]})]})]}),s.jsx("button",{onClick:()=>w(!0),disabled:d,className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(l,{className:"w-3 h-3 text-white/50 "+(d?"animate-spin":"")})})]}),s.jsx("div",{className:"flex-1 space-y-0.5 overflow-y-auto",children:0===i.length?d?s.jsx("div",{className:"text-center text-white/40 text-sm py-4",children:"加载中..."}):s.jsx(Tt,{type:"hotsearch"}):i.slice(0,f).map((e,t)=>s.jsxs("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-1.5 rounded-lg hover:bg-white/10 transition-colors group/item",children:[s.jsx("span",{className:"w-4 h-4 flex items-center justify-center text-xs font-bold rounded flex-shrink-0 "+(t<3?"bg-orange-500/80 text-white":"bg-white/10 text-white/60"),children:t+1}),s.jsx("span",{className:"flex-1 text-sm text-white/80 truncate group-hover/item:text-white",children:e.title}),s.jsx(N,{className:"w-3 h-3 text-white/30 opacity-0 group-hover/item:opacity-100 flex-shrink-0"})]},t))})]})}),Ut="newtab_poetry",Ht=e.memo(function({item:t,onRemove:r,isEditing:o}){const[n,a]=e.useState(null),{rows:i}=Ue(t.size),c=i>=2,d=()=>{const e=Math.floor(Math.random()*je.length),t=je[e];a(t);const s=(new Date).toDateString();chrome.storage.local.set({[Ut]:{poetry:t,date:s}})};return e.useEffect(()=>{chrome.storage.local.get(Ut).then(e=>{const t=e[Ut],s=(new Date).toDateString();t&&t.date===s?a(t.poetry):d()})},[]),n?s.jsx("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col items-center justify-center",children:c?s.jsxs("div",{className:"flex flex-col items-center gap-2 text-center",children:[s.jsx(C,{className:"w-5 h-5 text-white/60"}),s.jsxs("p",{className:"text-base text-white/90 font-light tracking-wide",children:["「",n.content,"」"]}),s.jsxs("p",{className:"text-sm text-white/60",children:["—— ",n.author,"《",n.title,"》"]}),s.jsx("button",{onClick:d,className:"mt-2 p-1.5 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all",title:"换一首",children:s.jsx(l,{className:"w-3 h-3 text-white/50"})})]}):s.jsxs("div",{className:"flex items-center gap-2 w-full",children:[s.jsxs("div",{className:"flex-1 text-center",children:[s.jsxs("span",{className:"text-sm text-white/80 font-light tracking-wide",children:["「",n.content,"」"]}),s.jsxs("span",{className:"text-xs text-white/50 ml-2",children:["—— ",n.author]})]}),s.jsx("button",{onClick:d,className:"p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all flex-shrink-0",title:"换一首",children:s.jsx(l,{className:"w-3 h-3 text-white/50"})})]})}):null});async function Wt(e,t=10){try{if(e.size<=1024*t)return await async function(e){return new Promise((t,s)=>{const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=s,r.readAsDataURL(e)})}(e);const s=new Image,r=URL.createObjectURL(e);await new Promise((e,t)=>{s.onload=e,s.onerror=t,s.src=r});const o=document.createElement("canvas"),n=o.getContext("2d");if(!n)return null;o.width=s.width,o.height=s.height,n.drawImage(s,0,0);let a=.8,i="";for(;a>.1;){i=o.toDataURL("image/jpeg",a);if(3*i.length/4/1024<=t)break;a-=.1}URL.revokeObjectURL(r);return 3*i.length/4/1024>1.5*t?null:i}catch(s){return null}}async function Kt(e,t=10){try{const s=`https://icon.ooo/${new URL(e).hostname}?size=32&v=${Date.now()}`,r=await fetch(s);if(!r.ok)return null;const o=await r.blob();if(o.size<100)return null;return await Wt(o,t)}catch(s){return null}}function Yt(e){if(e.faviconBase64)return e.faviconBase64;if(e.favicon&&(!e.favicon.includes("icon.ooo")||!e.favicon.includes("&sz=")))return e.favicon;try{const t=new URL(e.url),s="undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"",r=!s.includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id,o="undefined"!=typeof location?location.href:"",n=o.includes("/src/newtab/")||o.includes("/newtab/");if(r&&n)return`chrome://favicon2/?size=64&page_url=${encodeURIComponent(t.href)}`;return`https://icon.ooo/${t.hostname}?size=64&v=1`}catch{return""}}const qt=Object.freeze(Object.defineProperty({__proto__:null,batchDownloadFavicons:async function(e,t){const s=new Map;let r=0;for(const o of e){if(o.faviconBase64){r++,t?.(r,e.length);continue}const n=await Kt(o.url);n&&s.set(o.id,n),r++,t?.(r,e.length),await new Promise(e=>setTimeout(e,100))}return s},downloadFavicon:Kt,getFaviconUrl:Yt},Symbol.toStringTag,{value:"Module"}));function Vt({shortcut:t}){const r=Yt(t),[o,n]=e.useState(r),[a,i]=e.useState(!1),l=e.useRef(!1),c=e.useRef(!1),d=((t.title||t.url||"?").trim().charAt(0)||"?").toUpperCase(),u=e.useCallback(()=>{const e="undefined"!=typeof location?location.href:"",s=e.includes("/src/newtab/")||e.includes("/newtab/");if(!("undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"").includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id&&s&&!l.current){l.current=!0;try{const e=`chrome://favicon2/?size=64&page_url=${encodeURIComponent(t.url)}`;if(e!==o)return n(e),void i(!1)}catch{}}if(!c.current){c.current=!0;try{const e=`https://icon.ooo/${new URL(t.url).hostname}?size=64&v=1`;if(e!==o)return n(e),void i(!1)}catch{}}i(!0)},[o,t.url]);return e.useEffect(()=>{n(r),i(!1),l.current=r.startsWith("chrome://favicon2/"),c.current=r.includes("icon.ooo")},[r]),s.jsx("div",{className:"aspect-square rounded-[4px] overflow-hidden liquid-glass-mini flex items-center justify-center",children:!a&&o?s.jsx("img",{src:o,alt:"",className:"w-full h-full object-cover rounded-[4px]",onError:u}):s.jsx("span",{className:"text-[8px] font-bold text-white/80",children:d})})}const Xt={shortcut:e.memo(function({item:t,onRemove:r,isEditing:o,isBatchMode:n,isSelected:a,onToggleSelect:i}){const l=t.shortcut;if(!l)return null;const c=(l.title||"").trim()||(l.url||"").trim(),d=Yt(l),[u,m]=e.useState(d),[h,p]=e.useState(!1),[x,g]=e.useState(!0),f=e.useRef(null),w=e.useRef(!1),b=e.useRef(!1),k=e.useCallback(()=>g(!1),[]),v=e.useCallback(()=>{const e="undefined"!=typeof location?location.href:"",t=e.includes("/src/newtab/")||e.includes("/newtab/");if(!("undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"").includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id&&t&&!w.current){w.current=!0;try{const e=`chrome://favicon2/?size=64&page_url=${encodeURIComponent(l.url)}`;if(e!==u)return m(e),p(!1),void g(!0)}catch{}}if(!b.current){b.current=!0;try{const e=`https://icon.ooo/${new URL(l.url).hostname}?size=64&v=1`;if(e!==u)return m(e),p(!1),void g(!0)}catch{}}p(!0),g(!1)},[u,l.url]);e.useEffect(()=>{m(d),p(!1),g(!0),w.current=d.startsWith("chrome://favicon2/"),b.current=d.includes("icon.ooo")},[d]),e.useEffect(()=>{const e=f.current;if(!e)return;const t=t=>{const s=e.getBoundingClientRect(),r=(t.clientX-s.left)/s.width*100,o=(t.clientY-s.top)/s.height*100;e.style.setProperty("--mouse-x",`${r}%`),e.style.setProperty("--mouse-y",`${o}%`)};return e.addEventListener("mousemove",t),()=>e.removeEventListener("mousemove",t)},[]);const y=(c.charAt(0)||"?").toUpperCase(),j=o||n?"div":"a",I=o||n?{role:"link",tabIndex:0}:{href:l.url};return s.jsxs(j,{...I,onClick:e=>{if(!o)return n?(e.preventDefault(),e.stopPropagation(),void i?.(t.id)):void 0;e.preventDefault()},className:"group relative flex flex-col items-center justify-start h-full pt-2 px-2 rounded-xl transition-all duration-200 cursor-pointer",children:[s.jsxs("div",{ref:f,className:"relative liquid-glass-icon rounded-[12px] overflow-hidden hover:scale-110 active:scale-95 transition-all duration-200",style:{width:"56px",height:"56px"},children:[s.jsx("div",{className:"glass-refraction"}),n&&s.jsx("div",{className:"absolute top-1.5 right-1.5 z-30",children:a?s.jsx("div",{className:"w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center",children:s.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):s.jsx("div",{className:"w-5 h-5 rounded-full border border-white/40 bg-black/20"})}),x&&!h&&u&&s.jsx("div",{className:"absolute inset-0 z-20 bg-white/10 animate-pulse rounded-[12px]"}),!h&&u?s.jsx("img",{src:u,alt:c,draggable:!1,onDragStart:e=>{e.preventDefault()},className:"w-full h-full object-cover relative z-10 transition-opacity duration-200 "+(x?"opacity-0":"opacity-100"),onLoad:k,onError:v}):s.jsx("div",{className:"w-full h-full flex items-center justify-center relative z-10",children:s.jsx("span",{className:"text-lg font-medium text-white/80",children:y})})]}),s.jsx("span",{className:"mt-1.5 text-xs text-white/90 truncate max-w-full px-1",title:c,children:c})]})}),bookmarkFolder:e.memo(function({item:t,onRemove:r,isEditing:o,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l}){const{setCurrentFolderId:c,gridItems:d}=pt(),u=t.bookmarkFolder?.title||"文件夹",m=e.useRef(null),h=e.useMemo(()=>d.filter(e=>(e.parentId??null)===t.id&&"shortcut"===e.type&&!!e.shortcut?.url).sort((e,t)=>e.position-t.position).slice(0,9).map(e=>e.shortcut),[d,t.id]);e.useEffect(()=>{const e=m.current;if(!e)return;const t=t=>{const s=e.getBoundingClientRect(),r=(t.clientX-s.left)/s.width*100,o=(t.clientY-s.top)/s.height*100;e.style.setProperty("--mouse-x",`${r}%`),e.style.setProperty("--mouse-y",`${o}%`)};return e.addEventListener("mousemove",t),()=>e.removeEventListener("mousemove",t)},[]);return s.jsxs("button",{type:"button",onClick:e=>o?(e.preventDefault(),void e.stopPropagation()):a?(e.preventDefault(),e.stopPropagation(),void l?.(t.id)):(e.preventDefault(),void n?.(t.id)),onDoubleClick:e=>{e.preventDefault(),e.stopPropagation(),n?n(t.id):c(t.id)},className:"group relative flex flex-col items-center justify-start h-full pt-2 px-2 rounded-xl transition-all duration-200 cursor-pointer w-full","aria-label":u,children:[s.jsxs("div",{ref:m,className:"relative liquid-glass-folder rounded-[12px] overflow-hidden hover:scale-110 active:scale-95 transition-all duration-200",style:{width:"56px",height:"56px"},children:[s.jsx("div",{className:"glass-refraction"}),a&&s.jsx("div",{className:"absolute top-1.5 right-1.5 z-30",children:i?s.jsx("div",{className:"w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center",children:s.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):s.jsx("div",{className:"w-5 h-5 rounded-full border border-white/40 bg-black/20"})}),h.length>0?s.jsxs("div",{className:"w-full h-full grid grid-cols-3 gap-0.5 content-start relative z-10",children:[h.slice(0,9).map((e,r)=>s.jsx(Vt,{shortcut:e},`${t.id}-thumb-${r}`)),Array.from({length:Math.max(0,9-h.length)}).map((e,t)=>s.jsx("div",{className:"aspect-square rounded-[4px] bg-white/5"},`empty-${t}`))]}):s.jsx("div",{className:"w-full h-full flex items-center justify-center relative z-10",children:s.jsx(S,{className:"w-6 h-6 text-white/60"})})]}),s.jsx("span",{className:"mt-1.5 text-xs text-white/80 truncate max-w-full px-1",children:u})]})}),weather:Dt,clock:Et,todo:Rt,notes:$t,hotsearch:Pt,poetry:Ht},Jt=e.memo(function({item:e,onUpdate:t,onRemove:r,isEditing:o=!1,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l}){const c=Xt[e.type],{cols:d,rows:u}=Ue(e.size);return c?s.jsx("div",{className:"widget-container h-full",style:{gridColumn:`span ${d}`,gridRow:`span ${u}`},children:s.jsx(c,{item:e,onUpdate:t,onRemove:r,isEditing:o,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l})}):s.jsxs("div",{className:"flex items-center justify-center h-full text-white/50",children:["未知组件类型: ",e.type]})}),Qt={"1x1":"小 (1×1)","2x1":"宽 (2×1)","1x2":"高 (1×2)","2x2":"中 (2×2)","2x3":"大 (2×3)","2x4":"超大 (2×4)"},Zt=e.memo(function({item:t,isOpen:r,onClose:o,onUpdate:n,onRemove:a}){const[i,l]=e.useState(t.config||{}),c=Pe[t.type];if(!r)return null;const d=(e,s)=>{const r={...i,[t.type]:{...i[t.type],...s}};l(r),n(t.id,{config:r})};return B.createPortal(s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm animate-fadeIn",onClick:o}),s.jsx("div",{className:"fixed top-1/2 left-1/2 z-[110] w-[360px] max-w-[90vw] animate-modalScaleIn",children:s.jsxs("div",{className:"glass rounded-2xl p-5 border border-white/10",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("h3",{className:"text-base font-medium text-white",children:[c.name," 设置"]}),s.jsx("button",{onClick:o,className:"p-1.5 rounded-xl hover:bg-white/10 transition-colors focus:outline-none focus:ring-2 focus:ring-white/20",children:s.jsx(y,{className:"w-4 h-4 text-white/60"})})]}),s.jsxs("div",{className:"space-y-4",children:[c.sizeConfig.allowedSizes.length>1&&s.jsxs("div",{children:[s.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[s.jsx(F,{className:"w-4 h-4"}),"组件尺寸"]}),s.jsx("div",{className:"grid grid-cols-3 gap-2",children:c.sizeConfig.allowedSizes.map(e=>{const{cols:r,rows:o}=Ue(e);return s.jsxs("button",{onClick:()=>(e=>{n(t.id,{size:e})})(e),className:"p-2 rounded-lg border transition-all "+(t.size===e?"bg-blue-500/30 border-blue-500/50 text-white":"bg-white/5 border-white/10 text-white/70 hover:bg-white/10"),children:[s.jsx("div",{className:"flex justify-center mb-1",children:s.jsx("div",{className:"grid gap-0.5",style:{gridTemplateColumns:`repeat(${r}, 8px)`,gridTemplateRows:`repeat(${o}, 8px)`},children:Array.from({length:r*o}).map((r,o)=>s.jsx("div",{className:"rounded-sm "+(t.size===e?"bg-blue-400":"bg-white/40")},o))})}),s.jsx("span",{className:"text-xs",children:Qt[e]})]},e)})})]}),"clock"===t.type&&s.jsx(es,{config:i.clock||{},onChange:e=>d(0,e)}),"weather"===t.type&&s.jsx(ts,{config:i.weather||{},onChange:e=>d(0,e)}),"todo"===t.type&&s.jsx(ss,{config:i.todo||{},onChange:e=>d(0,e)}),s.jsx("button",{onClick:()=>{a(t.id),o()},className:"w-full py-2 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors text-sm focus:outline-none focus:ring-2 focus:ring-red-500/30",children:"删除组件"})]})]})})]}),document.body)});function es({config:e,onChange:t}){return s.jsxs("div",{className:"space-y-3",children:[s.jsx(rs,{label:"显示日期",checked:!1!==e.showDate,onChange:e=>t({showDate:e})}),s.jsx(rs,{label:"显示秒数",checked:!0===e.showSeconds,onChange:e=>t({showSeconds:e})}),s.jsx(rs,{label:"显示农历",checked:!0===e.showLunar,onChange:e=>t({showLunar:e})}),s.jsx(os,{label:"时间格式",value:e.format||"24h",options:[{value:"24h",label:"24 小时制"},{value:"12h",label:"12 小时制"}],onChange:e=>t({format:e})})]})}function ts({config:e,onChange:t}){return s.jsx("div",{className:"space-y-3",children:s.jsx(os,{label:"温度单位",value:e.unit||"C",options:[{value:"C",label:"摄氏度 (°C)"},{value:"F",label:"华氏度 (°F)"}],onChange:e=>t({unit:e})})})}function ss({config:e,onChange:t}){return s.jsx("div",{className:"space-y-3",children:s.jsx(rs,{label:"显示已完成",checked:!0===e.showCompleted,onChange:e=>t({showCompleted:e})})})}function rs({label:e,checked:t,onChange:r}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("button",{onClick:()=>r(!t),className:"w-9 h-5 rounded-full transition-colors "+(t?"bg-blue-500":"bg-white/20"),children:s.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-white transition-transform mx-0.5 "+(t?"translate-x-4":"translate-x-0")})})]})}function os({label:e,value:t,options:r,onChange:o}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("select",{value:t,onChange:e=>o(e.target.value),className:"bg-white/10 text-white text-sm rounded-lg px-2 py-1 outline-none border border-white/10",children:r.map(e=>s.jsx("option",{value:e.value,className:"bg-gray-800",children:e.label},e.value))})]})}function ns({isOpen:t,title:r,message:o,actions:n,cancelText:a="取消",onCancel:i}){const[l,c]=e.useState(!1);if(e.useEffect(()=>{t?requestAnimationFrame(()=>c(!0)):c(!1)},[t]),e.useEffect(()=>{if(!t)return;const e=e=>{"Escape"===e.key&&i()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,i]),!t)return null;const d=()=>{c(!1),setTimeout(i,150)};return B.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-end justify-center px-2 pb-24 transition-all duration-200 "+(l?"bg-black/60 backdrop-blur-sm opacity-100":"opacity-0"),style:{zIndex:It+10},onClick:d,children:s.jsxs("div",{role:"dialog","aria-label":r||"操作",className:"w-full max-w-[400px] transition-all duration-300 ease-out "+(l?"opacity-100 translate-y-0":"opacity-0 translate-y-4"),style:{zIndex:Nt+10},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"backdrop-blur-xl rounded-[14px] overflow-hidden mb-2",style:{backgroundColor:"var(--ios-sheet-bg)"},children:[(r||o)&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"px-4 py-4 text-center",children:[r&&s.jsx("h3",{className:"text-[13px] font-semibold mb-0.5",style:{color:"var(--ios-text-muted)"},children:r}),o&&s.jsx("p",{className:"text-[13px] leading-relaxed",style:{color:"var(--ios-text-muted)"},children:o})]}),s.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}})]}),n.map((e,t)=>s.jsxs("div",{children:[s.jsx("button",{type:"button",onClick:()=>(e=>{c(!1),setTimeout(()=>e.onClick(),150)})(e),className:"w-full py-[18px] text-[20px] font-normal transition-colors",style:{color:"danger"===e.variant?"var(--ios-action-danger)":"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:e.label}),t<n.length-1&&s.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}})]},t))]}),s.jsx("div",{className:"backdrop-blur-xl rounded-[14px] overflow-hidden",style:{backgroundColor:"var(--ios-sheet-bg)"},children:s.jsx("button",{type:"button",onClick:d,"aria-label":a,className:"w-full py-[18px] text-[20px] font-semibold transition-colors focus:outline-none",style:{color:"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:a})})]})}),document.body)}function as({isOpen:t,title:r,message:o,confirmText:n="确定",cancelText:a="取消",confirmVariant:i="default",onConfirm:l,onCancel:c}){const[d,u]=e.useState(!1);if(e.useEffect(()=>{t?requestAnimationFrame(()=>u(!0)):u(!1)},[t]),e.useEffect(()=>{if(!t)return;const e=e=>{"Escape"===e.key&&c()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,c]),!t)return null;const m=()=>{u(!1),setTimeout(c,150)};return B.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4 transition-all duration-200 "+(d?"bg-black/60 backdrop-blur-md opacity-100":"opacity-0"),style:{zIndex:It+10},onClick:m,children:s.jsx("div",{role:"alertdialog","aria-labelledby":"confirm-title","aria-describedby":"confirm-message",className:"relative w-full max-w-[280px] rounded-[14px] overflow-hidden transition-all duration-200 ease-out "+(d?"opacity-100 scale-100":"opacity-0 scale-95"),style:{zIndex:Nt+10},onClick:e=>e.stopPropagation(),children:s.jsxs("div",{className:"backdrop-blur-xl",style:{backgroundColor:"var(--ios-sheet-bg)"},children:[s.jsxs("div",{className:"px-4 pt-5 pb-4 text-center",children:[s.jsx("h3",{id:"confirm-title",className:"text-[17px] font-semibold mb-1",style:{color:"var(--ios-text-primary)"},children:r}),s.jsx("p",{id:"confirm-message",className:"text-[13px] leading-relaxed",style:{color:"var(--ios-text-secondary)"},children:o})]}),s.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}}),s.jsxs("div",{className:"flex",children:[s.jsx("button",{type:"button",onClick:m,"aria-label":a,className:"flex-1 py-[11px] text-[17px] font-normal transition-colors focus:outline-none",style:{color:"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:a}),s.jsx("div",{className:"w-px",style:{backgroundColor:"var(--ios-divider)"}}),s.jsx("button",{type:"button",onClick:()=>{u(!1),setTimeout(l,150)},"aria-label":n,className:"flex-1 py-[11px] text-[17px] font-semibold transition-colors focus:outline-none",style:{color:"danger"===i?"var(--ios-action-danger)":"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:n})]})]})})}),document.body)}function is({item:e,onOpenFolder:t,isBatchMode:r,isSelected:o,onToggleSelect:n}){const{attributes:a,listeners:i,setNodeRef:l,transform:c,transition:d,isDragging:u}=Ge({id:e.id}),m={transform:G.Transform.toString(c),transition:d,opacity:u?.5:1};return s.jsx("div",{ref:l,style:m,...a,...i,className:"touch-none cursor-grab active:cursor-grabbing",children:s.jsx("div",{className:"h-[88px] w-[80px]",children:s.jsx(Jt,{item:e,onOpenFolder:t,isEditing:!0,isBatchMode:r,isSelected:o,onToggleSelect:n})})})}function ls({folder:t,items:r,isOpen:o,onClose:n,onOpenFolder:a,isBatchMode:i,batchSelectedIds:l,onBatchSelectedIdsChange:c}){const{removeGridFolder:d,updateGridItem:u,browserBookmarksRootId:m,homeBrowserFolderId:h}=pt(),[p,x]=e.useState(!1),[g,f]=e.useState(t.bookmarkFolder?.title||"文件夹"),[w,b]=e.useState(!1),[k,v]=e.useState(!1),[j,I]=e.useState(!1),[N,C]=e.useState(t.parentId??null),S=e.useRef(null),F=e.useRef(null),G=!!t.browserBookmarkId,T=e.useMemo(()=>`folder-modal:${t.id}`,[t.id]),L=e.useMemo(()=>`folder-modal-outside:${t.id}`,[t.id]),A=e.useMemo(()=>`folder-modal-undock-parent:${t.id}:${N??"root"}`,[t.id,N]),{setNodeRef:R,isOver:M}=D({id:T}),{setNodeRef:$,isOver:O}=D({id:L}),{setNodeRef:_,isOver:P}=D({id:A,disabled:!1});if(e.useEffect(()=>{if(!o)return;requestAnimationFrame(()=>x(!0));const e=e=>{"Escape"===e.key&&n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[o,n]),e.useEffect(()=>{o&&(f(t.bookmarkFolder?.title||"文件夹"),b(!1))},[t.bookmarkFolder?.title,o]),e.useEffect(()=>{C(t.parentId??null)},[t.parentId]),e.useEffect(()=>{o&&t.browserBookmarkId&&null===(t.parentId??null)&&"undefined"!=typeof chrome&&chrome.bookmarks&&(async()=>{try{const e=await chrome.bookmarks.get(t.browserBookmarkId),s=e?.[0],r=s?.parentId??null;if(!r)return;if(r===m||r===h)return void C(null);const o=pt.getState(),n=t.groupId&&"home"!==t.groupId?o.shortcutGroups.find(e=>e.id===t.groupId)?.bookmarkFolderId:void 0;if(n&&r===n)return void C(null);C(`bb-${r}`)}catch{}})()},[o,t.browserBookmarkId,t.parentId,t.groupId,m,h]),e.useEffect(()=>{w&&S.current&&(S.current.focus(),S.current.select())},[w]),e.useEffect(()=>{o||x(!1)},[o]),!o)return null;const U=N?"上一级":t.groupId&&"home"!==t.groupId?"分组":"首页",H=()=>{b(!1);const e=g.trim(),s=t.bookmarkFolder?.title||"文件夹";e&&e!==s?u(t.id,{bookmarkFolder:{...t.bookmarkFolder??{},title:e}}):f(s)},W=()=>{x(!1),setTimeout(n,200)};return B.createPortal(s.jsxs("div",{"data-folder-modal":"1",ref:$,className:`fixed inset-0 flex items-center justify-center p-4 transition-all duration-200 ${p?"bg-black/60 backdrop-blur-md opacity-100":"opacity-0"} ${O?"bg-black/70":""}`,style:{zIndex:It},onMouseDown:e=>{e.target===e.currentTarget&&W()},children:[s.jsxs("div",{role:"dialog","aria-label":g,className:"liquid-glass rounded-3xl w-full max-w-2xl shadow-2xl transition-all duration-200 ease-[cubic-bezier(0.33,1,0.68,1)] "+(p?"opacity-100 scale-100":"opacity-0 scale-95"),style:{zIndex:Nt},children:[s.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-white/10",children:[s.jsx("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:w?s.jsx("input",{ref:S,type:"text",value:g,onChange:e=>f(e.target.value),onBlur:H,onKeyDown:e=>{"Enter"===e.key&&H(),"Escape"===e.key&&(f(t.bookmarkFolder?.title||"文件夹"),b(!1))},className:"liquid-glass-mini border border-white/30 rounded-lg px-3 py-1.5 text-white text-lg font-medium focus:outline-none focus:ring-2 focus:ring-white/40 w-full max-w-[320px] transition-all"}):s.jsxs("button",{type:"button",onClick:()=>b(!0),className:"text-lg font-medium text-white truncate flex items-center gap-2 hover:text-blue-300 transition-colors",title:"点击重命名",children:[s.jsx("span",{className:"truncate",children:g}),s.jsx(E,{className:"w-4 h-4 opacity-60"})]})}),s.jsxs("div",{className:"flex items-center gap-2",children:[!G&&s.jsx("button",{type:"button",onClick:()=>{G||v(!0)},className:"p-2 rounded-full hover:bg-white/10 transition-colors text-red-400","aria-label":"删除文件夹",title:"删除文件夹",children:s.jsx(z,{className:"w-5 h-5"})}),s.jsx("button",{type:"button",onClick:W,className:"p-2 rounded-full hover:bg-white/10 transition-colors","aria-label":"关闭",children:s.jsx(y,{className:"w-5 h-5 text-white/70"})})]})]}),s.jsxs("div",{className:"px-6 py-5",children:[s.jsx("div",{ref:R,className:"rounded-2xl p-4 transition-colors "+(M?"bg-white/10":"bg-white/5"),children:s.jsx(Ee,{items:r.map(e=>e.id),strategy:ze,children:s.jsx("div",{ref:F,onWheel:e=>{const t=e.currentTarget;if(t.scrollHeight<=t.clientHeight+1)return;e.preventDefault(),t.scrollBy({top:104*Math.sign(e.deltaY),behavior:"smooth"})},className:"overflow-y-auto pr-1",style:{height:"296px"},children:s.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-5 gap-4 min-h-[140px]",children:0===r.length?s.jsx("div",{className:"col-span-full text-center py-10 text-white/50 text-sm",children:"文件夹为空"}):r.map(e=>s.jsx(is,{item:e,onOpenFolder:a,isBatchMode:i,isSelected:l?.has(e.id),onToggleSelect:e=>{if(!c)return;const t=new Set(l??[]);t.has(e)?t.delete(e):t.add(e),c(t)}},e.id))})})})}),s.jsx("div",{className:"mt-4",children:s.jsxs("div",{ref:_,className:"rounded-2xl px-4 py-3 text-sm text-white/70 border border-dashed transition-colors "+(P?"bg-white/10 border-white/40":"bg-white/5 border-white/20"),title:t.parentId?"移到上一级文件夹":"移到首页",children:["移到上一级（",U,"）"]})})]})]}),s.jsx(ns,{isOpen:k,title:"删除文件夹",message:"选择删除方式",actions:[{label:"保留内容（移出文件夹）",onClick:()=>{v(!1),d(t.id,"keep"),x(!1),setTimeout(n,200)}},{label:"删除文件夹及全部内容",onClick:()=>{v(!1),I(!0)},variant:"danger"}],onCancel:()=>v(!1)}),s.jsx(as,{isOpen:j,title:"确认删除",message:"确定删除文件夹及全部内容吗？此操作不可恢复。",confirmText:"删除",cancelText:"取消",confirmVariant:"danger",onConfirm:()=>{I(!1),d(t.id,"all"),x(!1),setTimeout(n,200)},onCancel:()=>I(!1)})]}),document.body)}function cs({item:e,onUpdate:t,onRemove:r,isEditing:o,onConfigClick:n,onOpenFolder:a,isBatchMode:i,isSelected:l,onToggleSelect:c}){const{cols:d,rows:u}=Ue(e.size),{attributes:m,listeners:h,setNodeRef:p,transform:x,transition:g,isDragging:f}=Ge({id:e.id}),w={transform:G.Transform.toString(x),transition:g,gridColumn:`span ${d}`,gridRow:`span ${u}`,opacity:f?.5:1};return s.jsx("div",{ref:p,style:w,...m,...h,className:"touch-none cursor-grab active:cursor-grabbing",onDoubleClick:t=>{o&&"shortcut"!==e.type&&(t.preventDefault(),t.stopPropagation(),n?.(e))},children:s.jsx(Jt,{item:e,onUpdate:t,onRemove:r,isEditing:o,onOpenFolder:a,isBatchMode:i,isSelected:l,onToggleSelect:c})})}function ds({columns:t,isBatchMode:r,batchSelectedIds:o,onBatchSelectedIdsChange:n,isEditing:a=!1,onEditingChange:i}){const{gridItems:l,updateGridItem:c,removeGridItem:d,getFilteredGridItems:u,migrateToGridItems:m,currentFolderId:h,setCurrentFolderId:p,moveGridItemToFolder:x,mergeFolders:g,createFolderFromShortcuts:f,reorderGridItemsInCurrentScope:w,reorderGridItemsInFolderScope:b}=pt(),[k,y]=e.useState(null),[j,I]=e.useState(null),[N,C]=e.useState(null),[S,F]=e.useState(null),[D,E]=e.useState(null),[z,G]=e.useState(null),U=e.useRef(null),{pushDndDebug:H}={pushDndDebug:e.useCallback(e=>{if("undefined"==typeof window)return;const t=window,s=t.__DND_DEBUG__??[];s.push(e),s.length>200&&s.splice(0,s.length-200),t.__DND_DEBUG__=s,t.__DND_DEBUG_LAST__=e},[])};!function(t,s){e.useEffect(()=>{if(!t)return;if("undefined"==typeof window)return;const e=()=>{s({type:"window.blur",id:t,ts:Date.now()})},r=()=>{s({type:"document.visibilitychange",id:t,state:document.visibilityState,ts:Date.now()})},o=e=>{s({type:"window.mouseup",id:t,button:e.button,buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,ts:Date.now()})},n=e=>{s({type:"window.pointercancel",id:t,pointerType:e.pointerType,clientX:e.clientX,clientY:e.clientY,ts:Date.now()})},a=()=>{s({type:"window.contextmenu",id:t,ts:Date.now()})},i=e=>{"Escape"===e.key&&s({type:"window.keydown.esc",id:t,ts:Date.now()})};return window.addEventListener("blur",e),document.addEventListener("visibilitychange",r),window.addEventListener("mouseup",o,!0),window.addEventListener("pointercancel",n,!0),window.addEventListener("contextmenu",a,!0),window.addEventListener("keydown",i,!0),()=>{window.removeEventListener("blur",e),document.removeEventListener("visibilitychange",r),window.removeEventListener("mouseup",o,!0),window.removeEventListener("pointercancel",n,!0),window.removeEventListener("contextmenu",a,!0),window.removeEventListener("keydown",i,!0)}},[t,s])}(k,H),e.useEffect(()=>{m()},[m]);const W=u(),K=r&&W.length>0&&W.every(e=>o?.has(e.id)),Y=e.useMemo(()=>S?l.find(e=>e.id===S&&"bookmarkFolder"===e.type)??null:null,[l,S]),q=e.useMemo(()=>Y?l.filter(e=>(e.parentId??null)===Y.id).sort((e,t)=>e.position-t.position):[],[l,Y]),V=T(L(P,{activationConstraint:{distance:6}}),L(_,{activationConstraint:{delay:150,tolerance:5}}),L(O,{coordinateGetter:Te})),X=e.useCallback(e=>{const t=String(e.active.id);y(t);const s=l.find(e=>e.id===t)??null;I(s),U.current=null,H({type:"start",id:t,hasSnapshot:!!s,snapshotType:s?.type??null,ts:Date.now()})},[l,H]),J=e.useCallback(e=>{H({type:"cancel",id:String(e.active.id),lastOverId:U.current,ts:Date.now()}),y(null),I(null),U.current=null},[H]),Q=e.useCallback(e=>{const t=e.over?.id?String(e.over.id):null;U.current!==t&&(U.current=t,H({type:"over",id:String(e.active.id),overId:t,ts:Date.now()}))},[H]),Z=e.useCallback(e=>{const{active:t,over:s}=e;if(H({type:"end",id:String(t.id),overId:s?.id?String(s.id):null,ts:Date.now()}),y(null),I(null),U.current=null,!s||t.id===s.id)return;const r=String(s.id);if(r.startsWith("folder-modal-undock-parent:")){const e=r.replace("folder-modal-undock-parent:",""),[s,o]=e.split(":"),n=o&&"root"!==o?o:null;if(!o){const e=l.find(e=>e.id===s);return void x(t.id,e?.parentId??null)}return void x(t.id,n)}if(Y?.id){const e=l.find(e=>e.id===String(t.id)),r=l.find(e=>e.id===String(s.id));if(e&&r&&(e.parentId??null)===Y.id&&(r.parentId??null)===Y.id)return void b(Y.id,String(t.id),String(s.id))}const o=l.find(e=>e.id===s.id);if("bookmarkFolder"===o?.type){const e=l.find(e=>e.id===t.id);return"bookmarkFolder"===e?.type?void E({sourceId:String(t.id),targetId:o.id,sourceName:e.bookmarkFolder?.title||"文件夹",targetName:o.bookmarkFolder?.title||"文件夹"}):void x(t.id,o.id)}const n=l.find(e=>e.id===t.id);"shortcut"!==n?.type||"shortcut"!==o?.type?w(t.id,s.id):G({sourceId:String(t.id),targetId:String(s.id),sourceName:n.shortcut?.title||"快捷方式",targetName:o.shortcut?.title||"快捷方式"})},[l,x,Y,H,w,b]),ee=e.useCallback(()=>{D&&(g(D.sourceId,D.targetId),E(null))},[D,g]),te=e.useCallback(()=>{z&&(f(z.sourceId,z.targetId),G(null))},[z,f]),se=e.useCallback(()=>{z&&(w(z.sourceId,z.targetId),G(null))},[z,w]),re=e.useCallback(()=>{D&&(x(D.sourceId,D.targetId),E(null))},[D,x]),oe=e.useCallback(e=>{F(e)},[]),ne=e.useCallback(e=>{if(!n)return;const t=new Set(o??new Set);t.has(e)?t.delete(e):t.add(e),n(t)},[o,n]);e.useEffect(()=>{h&&(F(h),p(null))},[h,p]);const ae=j??(k?l.find(e=>e.id===k):null);return 0===W.length?s.jsx("div",{className:"flex flex-col items-center gap-3 text-white/50",children:s.jsx("span",{className:"text-sm",children:"当前分组没有内容"})}):s.jsxs(s.Fragment,{children:[s.jsxs(A,{sensors:V,collisionDetection:R,onDragStart:X,onDragOver:Q,onDragCancel:J,onDragEnd:Z,children:[s.jsx(Ee,{items:W.map(e=>e.id),strategy:ze,children:s.jsx("div",{className:`grid ${{6:"grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6",8:"grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8",10:"grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10"}[t]} gap-4 auto-rows-[80px]`,children:W.map(e=>s.jsx(cs,{item:e,onUpdate:c,onRemove:d,isEditing:a,onConfigClick:C,onOpenFolder:oe,isBatchMode:r,isSelected:!!o?.has(e.id),onToggleSelect:ne},e.id))})}),"undefined"!=typeof document?B.createPortal(s.jsx(M,{zIndex:Ct,children:ae?s.jsx("div",{className:"opacity-80 pointer-events-none",children:s.jsx(Jt,{item:ae,onOpenFolder:oe,isEditing:!0,isBatchMode:r,isSelected:!!o?.has(ae.id),onToggleSelect:ne})}):null}),document.body):s.jsx(M,{zIndex:Ct,children:ae?s.jsx("div",{className:"opacity-80 pointer-events-none",children:s.jsx(Jt,{item:ae,onOpenFolder:oe,isBatchMode:r,isSelected:!!o?.has(ae.id),onToggleSelect:ne})}):null}),Y?s.jsx(ls,{folder:Y,items:q,isOpen:!0,onClose:()=>F(null),onOpenFolder:oe,isBatchMode:r,batchSelectedIds:o,onBatchSelectedIdsChange:n}):null]}),N&&s.jsx(Zt,{item:N,isOpen:!!N,onClose:()=>C(null),onUpdate:c,onRemove:d}),s.jsx("div",{className:"fixed bottom-6 right-6 z-40",children:s.jsx("button",{onClick:()=>i?.(!a),className:"p-3 rounded-full shadow-lg transition-all "+(a?"bg-green-500 hover:bg-green-600 text-white":"glass hover:bg-white/20 text-white/70"),title:a?"完成编辑":"编辑布局",children:a?s.jsx(v,{className:"w-5 h-5"}):s.jsx($,{className:"w-5 h-5"})})}),r&&s.jsx("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2 z-40 px-4 py-2 rounded-full glass text-sm text-white/80 animate-fadeIn",children:s.jsx("button",{onClick:()=>{const e=new Set(o??[]);K?W.forEach(t=>e.delete(t.id)):W.forEach(t=>e.add(t.id)),n?.(e)},className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors",children:K?"取消全选当前分组":"全选当前分组"})}),s.jsx(ns,{isOpen:!!D,title:"文件夹操作",message:`将「${D?.sourceName}」拖到了「${D?.targetName}」上`,actions:[{label:"合并文件夹",onClick:ee},{label:"移入文件夹",onClick:re}],onCancel:()=>E(null)}),s.jsx(ns,{isOpen:!!z,title:"创建文件夹",message:`将「${z?.sourceName}」拖到了「${z?.targetName}」上`,actions:[{label:"合并为文件夹",onClick:te},{label:"仅调整顺序",onClick:se}],onCancel:()=>G(null)})]})}const us="newtab_wallpaper_cache",ms="newtab_bing_info_cache";function hs({config:t,onRefresh:r}){const[o,n]=e.useState(null),[a,i]=e.useState(null),[c,d]=e.useState(!1),[u,m]=e.useState(!1);e.useEffect(()=>{"bing"===t.type?h():"unsplash"===t.type?p():"image"===t.type&&n(t.value)},[t.type,t.value,t.bingHistoryIndex]);const h=async(e=!1)=>{try{const s=t.bingHistoryIndex||0,r=`bing_${s}`;if(!e){const e=await x(r),t=await f(s);if(e&&t)return n(e),void i(t)}const o=`https://www.bing.com/HPImageArchive.aspx?format=js&idx=${s}&n=1&mkt=zh-CN`,a=await fetch(o),l=await a.json();if(l.images?.[0]){const t=l.images[0];let o=`https://www.bing.com${t.url}`;e&&(o+=`${o.includes("?")?"&":"?"}t=${Date.now()}`);const a={url:o,title:t.title||"",copyright:t.copyright||"",date:t.startdate||""};n(o),i(a),await g(r,o),await w(s,a)}}catch(s){}},p=async(e=!1)=>{try{if(!e){const e=await x("unsplash");if(e)return void n(e)}const t=`${Ie}?random=${Date.now()}`;n(t),await g("unsplash",t)}catch(t){}},x=async e=>{try{const t=(await chrome.storage.local.get(us))[us];if(t?.[e]){const s=Date.now()-t[e].timestamp;if(s<(e.startsWith("bing")?216e5:36e5))return t[e].url}}catch{}return null},g=async(e,t)=>{try{const s=(await chrome.storage.local.get(us))[us]||{};s[e]={url:t,timestamp:Date.now()},await chrome.storage.local.set({[us]:s})}catch(s){}},f=async e=>{try{const t=(await chrome.storage.local.get(ms))[ms];if(t?.[e]){const s=Date.now()-t[e].timestamp;if(s<216e5)return t[e].info}}catch{}return null},w=async(e,t)=>{try{const s=(await chrome.storage.local.get(ms))[ms]||{};s[e]={info:t,timestamp:Date.now()},await chrome.storage.local.set({[ms]:s})}catch(s){}},b={filter:`blur(${t.blur}px) brightness(${t.brightness}%)`};if("color"===t.type)return s.jsx("div",{className:"absolute inset-0 z-0",style:{...b,backgroundColor:t.value}});const k="bing"===t.type||"unsplash"===t.type?o:t.value;return k?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute inset-0 z-0 bg-cover bg-center bg-no-repeat",style:{...b,backgroundImage:`url(${k})`}}),("bing"===t.type||"unsplash"===t.type)&&s.jsxs("div",{className:"fixed bottom-6 right-24 z-50 flex items-center gap-2",children:["bing"===t.type&&t.showBingInfo&&a&&s.jsx("button",{onClick:()=>d(!c),className:"p-2 rounded-full glass-light hover:bg-white/20 transition-all group",title:"图片信息",children:s.jsx(U,{className:"w-4 h-4 text-white/80 group-hover:text-white"})}),s.jsx("button",{onClick:async()=>{if(!u){m(!0);try{"bing"===t.type?await h(!0):"unsplash"===t.type&&await p(!0),r?.()}catch(e){}finally{setTimeout(()=>m(!1),1e3)}}},disabled:u,className:"p-2 rounded-full glass-light hover:bg-white/20 transition-all group disabled:opacity-50",title:"刷新壁纸",children:s.jsx(l,{className:"w-4 h-4 text-white/80 group-hover:text-white "+(u?"animate-spin":"")})})]}),"bing"===t.type&&t.showBingInfo&&c&&a&&s.jsxs("div",{className:"fixed bottom-20 right-24 z-50 w-80 glass-modal-dark rounded-xl p-4 animate-fadeIn",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx("h3",{className:"text-sm font-medium text-white",children:"图片信息"}),s.jsx("button",{onClick:()=>d(!1),className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/70"})})]}),s.jsxs("div",{className:"space-y-2 text-xs",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-white/50 mb-1",children:"标题"}),s.jsx("div",{className:"text-white/90",children:a.title})]}),s.jsxs("div",{children:[s.jsx("div",{className:"text-white/50 mb-1",children:"版权信息"}),s.jsx("div",{className:"text-white/90 leading-relaxed",children:a.copyright})]}),s.jsxs("div",{children:[s.jsx("div",{className:"text-white/50 mb-1",children:"日期"}),s.jsx("div",{className:"text-white/90",children:a.date.replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")})]})]})]})]}):s.jsx("div",{className:"absolute inset-0 z-0",style:{backgroundColor:"var(--background)"}})}function ps(e,t){if(t)return t;try{return`https://www.google.com/s2/favicons?domain=${new URL(e).hostname}&sz=64`}catch{return""}}function xs({bookmark:e,isHovered:t,onHover:r,wasDragged:o}){const{attributes:n,listeners:a,setNodeRef:i,transform:l,transition:c,isDragging:d}=Ge({id:e.id}),u={transform:G.Transform.toString(l),transition:d?"none":c||"transform 0.2s",opacity:d?.5:1};return s.jsx("div",{ref:i,style:u,...n,...a,className:"relative cursor-grab active:cursor-grabbing",children:s.jsxs("a",{href:e.url,className:"relative block w-11 h-11 rounded-xl bg-white/10 hover:bg-white/20 active:scale-90 transition-all duration-200 overflow-hidden",style:{transform:t&&!d?"translateY(-8px) scale(1.15)":"translateY(0) scale(1)"},onMouseEnter:()=>r(e.id),onMouseLeave:()=>r(null),onClick:e=>{(d||o)&&e.preventDefault()},children:[t&&!d&&s.jsx("div",{className:"absolute -top-10 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-lg bg-black/90 text-white text-xs whitespace-nowrap z-50 animate-fadeIn pointer-events-none",children:e.title}),s.jsx("img",{src:ps(e.url,e.favicon),alt:e.title,className:"w-full h-full object-cover",onError:t=>{const s=t.currentTarget,r=`https://www.google.com/s2/favicons?domain=${new URL(e.url).hostname}&sz=64`;if(s.src.includes("google.com/s2/favicons")){s.style.display="none";const t=s.parentElement;if(t&&!t.querySelector(".fallback-letter")){const s=document.createElement("span");s.className="fallback-letter text-lg font-medium text-white/70",s.textContent=e.title.charAt(0).toUpperCase(),t.appendChild(s)}}else s.src=r}})]})})}function gs(){const{syncState:t,pinnedBookmarks:r,fetchPinnedBookmarks:o,reorderPinnedBookmarks:n}=wt(),[a,i]=e.useState(!1),[l,c]=e.useState(null),[d,u]=e.useState(!1),[m,h]=e.useState(!1),[p,x]=e.useState([]),[g,f]=e.useState(!1),w=e.useRef(!0),b=e.useRef(),k=T(L(H,{activationConstraint:{distance:8}}),L(O,{coordinateGetter:Te}));e.useEffect(()=>{x(r)},[r]),e.useEffect(()=>{o().finally(()=>{i(!0),w.current&&(w.current=!1,requestAnimationFrame(()=>{h(!0)}))})},[o]);return!a||t.error||0===p.length?null:s.jsx("div",{"data-dock-bar":"1",className:"fixed bottom-4 left-1/2 -translate-x-1/2 z-40 transition-opacity duration-300 "+(m?"opacity-100":"opacity-0"),children:s.jsx(A,{sensors:k,collisionDetection:R,onDragEnd:async e=>{const{active:t,over:s}=e;if(f(!0),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{f(!1)},200),!s||t.id===s.id)return;const r=p.findIndex(e=>e.id===t.id),o=p.findIndex(e=>e.id===s.id);if(-1!==r&&-1!==o){const e=[...p],[t]=e.splice(r,1);e.splice(o,0,t),x(e),await n(e.map(e=>e.id))}},children:s.jsx(Ee,{items:p.map(e=>e.id),strategy:Le,children:s.jsx("div",{className:"flex items-center gap-2 px-4 py-3 rounded-2xl glass-dark "+(d?"animate-pulse":""),onDoubleClick:async()=>{d||(u(!0),await o(!0),setTimeout(()=>u(!1),500))},title:"拖拽排序 | 双击同步最新",children:p.map(e=>s.jsx(xs,{bookmark:e,isHovered:l===e.id,onHover:c,wasDragged:g},e.id))})})})})}function fs({userName:t}){const r=e.useMemo(()=>{const e=(new Date).getHours();return e>=5&&e<12?{text:"早上好",icon:"🌅"}:e>=12&&e<14?{text:"中午好",icon:"☀️"}:e>=14&&e<18?{text:"下午好",icon:"🌤️"}:e>=18&&e<22?{text:"晚上好",icon:"🌆"}:{text:"夜深了",icon:"🌙"}},[]);return s.jsx("div",{className:"text-center text-white select-none",children:s.jsxs("h2",{className:"text-2xl font-light text-shadow",children:[r.text,t&&s.jsx("span",{className:"ml-2",children:t})]})})}function ws(){const t=e.useMemo(()=>{const e=Fe.Lunar.fromDate(new Date);let t="";try{const s=e.getFestivals?.()||[],r=e.getJieQi?.()||"";t=s[0]||r||""}catch{}return{date:`${e.getMonthInChinese()}月${e.getDayInChinese()}`,year:`${e.getYearInGanZhi()}${e.getYearShengXiao()}年`,festival:t}},[]);return s.jsxs("div",{className:"text-center text-white/70 text-sm select-none",children:[s.jsxs("span",{children:[t.year," ",t.date]}),t.festival&&s.jsx("span",{className:"ml-2 px-2 py-0.5 rounded-full bg-white/10 text-xs",children:t.festival})]})}const bs="newtab_poetry";function ks(){const[t,r]=e.useState(null),o=()=>{const e=Math.floor(Math.random()*je.length),t=je[e];r(t);const s=(new Date).toDateString();chrome.storage.local.set({[bs]:{poetry:t,date:s}})};return e.useEffect(()=>{chrome.storage.local.get(bs).then(e=>{const t=e[bs],s=(new Date).toDateString();t&&t.date===s?r(t.poetry):o()})},[]),t?s.jsxs("div",{className:"text-center text-white select-none group flex items-center justify-center gap-2",children:[s.jsxs("span",{className:"text-sm font-light tracking-wide text-shadow-sm",children:["「",t.content,"」"]}),s.jsxs("span",{className:"text-xs text-white/70 text-shadow-sm",children:["—— ",t.author,"《",t.title,"》"]}),s.jsx("button",{onClick:o,className:"p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all inline-flex items-center",title:"换一首",children:s.jsx(l,{className:"w-3 h-3 text-white/50"})})]}):null}const vs={Home:oe,Briefcase:re,GraduationCap:se,Gamepad2:te,Wrench:ee,Code:Z,Music:Q,Film:J,ShoppingCart:X,Heart:V,Star:q,Bookmark:w,Folder:S,Globe:Y,Zap:K};function ys(e){return vs[e]||S}function js({onOpenSettings:t}){const{shortcutGroups:r,activeGroupId:o,setActiveGroup:a,addGroup:i,removeGroup:l}=pt(),[c,d]=e.useState(!1),[u,m]=e.useState(""),[h,p]=e.useState("Folder"),[x,g]=e.useState(""),[f,w]=e.useState(null),[b,v]=e.useState(null);e.useEffect(()=>{(async()=>{const e=await Ce.getTMarksConfig();if(e?.bookmarkApiUrl){const t=e.bookmarkApiUrl.replace(/\/api\/?$/,"");g(t)}else g(Se().BASE_URL)})()},[]);const j=()=>{u.trim()&&(i(u.trim(),h),m(""),p("Folder"),d(!1))};return s.jsxs("div",{className:"fixed left-3 top-1/2 -translate-y-1/2 z-20 glass rounded-2xl p-2 animate-fadeIn flex flex-col gap-1",children:[r.map(e=>{const t="home"!==e.id,r=ys(e.icon);return s.jsxs("div",{className:"relative",onMouseEnter:()=>w(e.id),onMouseLeave:()=>w(null),children:[s.jsx("button",{onClick:()=>a(e.id),"data-group-id":e.id,className:"w-11 h-11 rounded-xl flex items-center justify-center transition-all active:scale-90 "+(o===e.id?"bg-white/20 text-white":"text-white/50 hover:text-white/80 hover:bg-white/10"),title:e.name,children:s.jsx(r,{className:"w-4 h-4"})}),f===e.id&&s.jsxs("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50 flex items-center gap-2",children:[e.name,t&&s.jsx(y,{className:"w-3 h-3 hover:text-red-400 cursor-pointer",onClick:t=>((e,t)=>{e.stopPropagation(),e.preventDefault(),v(t)})(t,e.id)})]})]},e.id)}),s.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>d(!c),onMouseEnter:()=>w("add"),onMouseLeave:()=>w(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all active:scale-90",title:"新建分组",children:[s.jsx(k,{className:"w-4 h-4"}),"add"===f&&!c&&s.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:"新建分组"})]}),c&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>d(!1)}),s.jsxs("div",{className:"absolute left-full top-0 ml-2 w-56 p-3 rounded-xl bg-gray-900/95 border border-white/10 shadow-2xl z-50 animate-scaleIn",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("span",{className:"text-sm font-medium text-white",children:"新建分组"}),s.jsx("button",{onClick:()=>d(!1),className:"p-1 rounded hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-3 h-3 text-white/60"})})]}),s.jsx("input",{type:"text",value:u,onChange:e=>m(e.target.value),placeholder:"分组名称",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 mb-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/40",autoFocus:!0,onKeyDown:e=>"Enter"===e.key&&j()}),s.jsx("div",{className:"grid grid-cols-5 gap-1.5 mb-3",children:Ne.map(e=>{const t=ys(e);return s.jsx("button",{onClick:()=>p(e),className:"p-1.5 rounded-lg transition-all "+(h===e?"bg-blue-500/30 text-blue-400 ring-1 ring-blue-500/50":"text-white/50 hover:bg-white/10 hover:text-white/80"),children:s.jsx(t,{className:"w-4 h-4 mx-auto"})},e)})}),s.jsx("button",{onClick:j,disabled:!u.trim(),className:"w-full py-1.5 rounded-lg bg-blue-500/80 hover:bg-blue-500 text-white text-sm transition-colors disabled:opacity-40 disabled:cursor-not-allowed",children:"创建"})]})]})]}),x&&s.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),x&&s.jsxs("button",{onClick:()=>window.open(x,"_blank"),onMouseEnter:()=>w("tmarks"),onMouseLeave:()=>w(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all",title:"TMarks 书签",children:[s.jsx(n,{className:"w-4 h-4"}),"tmarks"===f&&s.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:"书签管理"})]}),s.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),s.jsxs("button",{onClick:t,onMouseEnter:()=>w("settings"),onMouseLeave:()=>w(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all",title:"设置",children:[s.jsx(W,{className:"w-4 h-4"}),"settings"===f&&s.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:"设置"})]}),s.jsx(as,{isOpen:!!b,title:"删除分组",message:(()=>{const e=r.find(e=>e.id===b);return e?.bookmarkFolderId?"删除分组后，该分组的所有内容将被一并删除。确定删除？":"删除分组后，该分组的快捷方式将移到「首页」。确定删除？"})(),confirmText:"删除",cancelText:"取消",confirmVariant:"danger",onConfirm:()=>{b&&(l(b),v(null))},onCancel:()=>v(null)})]})}function Is({title:e,children:t}){return s.jsxs("div",{className:"bg-white/5 rounded-xl p-4",children:[s.jsx("h3",{className:"text-sm font-medium text-white/80 mb-4",children:e}),s.jsx("div",{className:"space-y-3",children:t})]})}function Ns({label:e,checked:t,onChange:r,disabled:o=!1}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("button",{onClick:()=>{o||r(!t)},disabled:o,className:"w-10 h-6 rounded-full transition-colors "+(o?"bg-white/10 cursor-not-allowed":t?"bg-blue-500":"bg-white/20"),children:s.jsx("div",{className:"w-4 h-4 rounded-full bg-white transition-transform mx-1 "+(t?"translate-x-4":"translate-x-0")})})]})}function Cs({label:e,value:t,options:r,onChange:o}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("select",{value:t,onChange:e=>o(e.target.value),className:"bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10",children:r.map(e=>s.jsx("option",{value:e.value,className:"bg-gray-800",children:e.label},e.value))})]})}function Ss({label:e,value:t,onChange:r}){return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsx("input",{type:"color",value:t,onChange:e=>r(e.target.value),className:"w-8 h-8 rounded cursor-pointer"})]})}function Bs({label:e,value:t,placeholder:r,onChange:o}){return s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("span",{className:"text-sm text-white/80 flex-shrink-0",children:e}),s.jsx("input",{type:"text",value:t,placeholder:r,onChange:e=>o(e.target.value),className:"flex-1 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})}function Fs({label:e,value:t,min:r,max:o,onChange:n}){return s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("span",{className:"text-sm text-white/80",children:e}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"range",value:t,min:r,max:o,onChange:e=>n(Number(e.target.value)),className:"w-24"}),s.jsx("span",{className:"text-xs text-white/60 w-8",children:t})]})]})}function Ds(){const{shortcuts:t,updateShortcut:r,gridItems:o,updateGridItem:n}=pt(),[a,i]=e.useState(!1),[l,c]=e.useState({current:0,total:0}),[d,u]=e.useState(null);e.useEffect(()=>{(async()=>{try{const e=await chrome.storage.local.getBytesInUse(),t=chrome.storage.local.QUOTA_BYTES||10485760;u({used:e,total:t})}catch(e){}})()},[a]);const m=t.length+o.filter(e=>"shortcut"===e.type).length,h=t.filter(e=>e.faviconBase64).length+o.filter(e=>"shortcut"===e.type&&e.shortcut?.faviconBase64).length,p=e=>e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1024/1024).toFixed(2)} MB`;return s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm text-white/80",children:"下载并缓存所有图标"}),s.jsxs("div",{className:"text-xs text-white/50 mt-1",children:["已缓存 ",h," / ",m," 个图标"]}),d&&s.jsxs("div",{className:"text-xs text-white/40 mt-0.5",children:["存储占用: ",p(d.used)," / ",p(d.total),"(",(d.used/d.total*100).toFixed(1),"%)"]})]}),s.jsx("button",{onClick:async()=>{i(!0),c({current:0,total:0});try{const{batchDownloadFavicons:e}=await Be(async()=>{const{batchDownloadFavicons:e}=await Promise.resolve().then(()=>qt);return{batchDownloadFavicons:e}},void 0);let s=0;if(t.length>0){const o=await e(t,(e,t)=>{c({current:e,total:t})});o.forEach((e,t)=>{r(t,{faviconBase64:e})}),s+=o.size}const a=o.filter(e=>"shortcut"===e.type&&e.shortcut);if(a.length>0){const r=await e(a.map(e=>({id:e.id,url:e.shortcut.url,favicon:e.shortcut.favicon,faviconBase64:e.shortcut.faviconBase64})),(e,s)=>{c({current:e+t.length,total:s+t.length})});r.forEach((e,t)=>{const s=o.find(e=>e.id===t);s?.shortcut&&n(t,{shortcut:{...s.shortcut,faviconBase64:e}})}),s+=r.size}alert(`成功缓存 ${s} 个图标`)}catch(e){alert("缓存图标失败，请重试")}finally{i(!1),c({current:0,total:0})}},disabled:a,className:"px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:a?"缓存中...":"立即缓存"})]}),a&&l.total>0&&s.jsxs("div",{className:"space-y-1",children:[s.jsx("div",{className:"w-full bg-white/10 rounded-full h-2 overflow-hidden",children:s.jsx("div",{className:"h-full bg-blue-500 transition-all duration-300",style:{width:l.current/l.total*100+"%"}})}),s.jsxs("div",{className:"text-xs text-white/50 text-center",children:[l.current," / ",l.total]})]}),s.jsx("div",{className:"text-xs text-white/40 leading-relaxed",children:"图标会自动压缩到 10KB 以内，离线时可正常显示"})]})}function Es(){const{settings:e,updateSettings:t}=pt();return s.jsxs("div",{className:"space-y-6",children:[s.jsxs(Is,{title:"个性化",children:[s.jsx(Ns,{label:"显示问候语",checked:e.showGreeting,onChange:e=>t({showGreeting:e})}),s.jsx(Bs,{label:"你的名字",value:e.userName,placeholder:"可选",onChange:e=>t({userName:e})})]}),s.jsxs(Is,{title:"时钟",children:[s.jsx(Ns,{label:"显示时钟",checked:e.showClock,onChange:e=>t({showClock:e})}),e.showClock&&s.jsxs(s.Fragment,{children:[s.jsx(Ns,{label:"显示日期",checked:e.showDate,onChange:e=>t({showDate:e})}),s.jsx(Ns,{label:"显示秒数",checked:e.showSeconds,onChange:e=>t({showSeconds:e})}),s.jsx(Ns,{label:"显示农历",checked:e.showLunar,onChange:e=>t({showLunar:e})}),s.jsx(Cs,{label:"时间格式",value:e.clockFormat,options:[{value:"24h",label:"24 小时制"},{value:"12h",label:"12 小时制"}],onChange:e=>t({clockFormat:e})})]})]}),s.jsx(Is,{title:"诗词",children:s.jsx(Ns,{label:"显示每日诗词",checked:e.showPoetry,onChange:e=>t({showPoetry:e})})}),s.jsxs(Is,{title:"搜索",children:[s.jsx(Ns,{label:"显示搜索框",checked:e.showSearch,onChange:e=>t({showSearch:e})}),s.jsx(Cs,{label:"搜索引擎",value:e.searchEngine,options:ke.map(e=>({value:e.id,label:e.name})),onChange:e=>t({searchEngine:e})})]}),s.jsx(Is,{title:"离线缓存",children:s.jsx(Ds,{})}),s.jsx(Is,{title:"使用说明",children:s.jsxs("div",{className:"text-sm text-white/70 leading-relaxed space-y-2",children:[s.jsx("div",{children:"1. 编辑模式下，双击文件夹可以进入文件夹。"}),s.jsx("div",{children:"2. 首页滚轮切分组：在图标区域内可滚动时优先滚动，滚到边界继续滚动才会切换分组。"}),s.jsx("div",{children:"3. 单个分组图标过多时，可在图标区域滚动进行左右翻页。"})]})})]})}function zs(){const{settings:e,updateSettings:t}=pt();return s.jsxs("div",{className:"space-y-6",children:[s.jsxs(Is,{title:"快捷方式",children:[s.jsx(Ns,{label:"显示快捷方式",checked:e.showShortcuts,onChange:e=>t({showShortcuts:e})}),s.jsx(Cs,{label:"每行数量",value:String(e.shortcutColumns),options:[{value:"6",label:"6 个"},{value:"8",label:"8 个"},{value:"10",label:"10 个"}],onChange:e=>t({shortcutColumns:Number(e)})}),s.jsx(Cs,{label:"样式",value:e.shortcutStyle,options:[{value:"icon",label:"图标"},{value:"card",label:"卡片"}],onChange:e=>t({shortcutStyle:e})})]}),s.jsxs(Is,{title:"壁纸",children:[s.jsx(Cs,{label:"壁纸类型",value:e.wallpaper.type,options:[{value:"color",label:"纯色"},{value:"bing",label:"Bing 每日壁纸"},{value:"unsplash",label:"随机风景"},{value:"image",label:"自定义图片"}],onChange:s=>t({wallpaper:{...e.wallpaper,type:s}})}),"color"===e.wallpaper.type&&s.jsx(Ss,{label:"背景颜色",value:e.wallpaper.value,onChange:s=>t({wallpaper:{...e.wallpaper,value:s}})}),"bing"===e.wallpaper.type&&s.jsxs(s.Fragment,{children:[s.jsx(Cs,{label:"历史图片",value:String(e.wallpaper.bingHistoryIndex||0),options:[{value:"0",label:"今天"},{value:"1",label:"昨天"},{value:"2",label:"2 天前"},{value:"3",label:"3 天前"},{value:"4",label:"4 天前"},{value:"5",label:"5 天前"},{value:"6",label:"6 天前"},{value:"7",label:"7 天前"}],onChange:s=>t({wallpaper:{...e.wallpaper,bingHistoryIndex:Number(s)}})}),s.jsx(Ns,{label:"显示图片信息",checked:e.wallpaper.showBingInfo||!1,onChange:s=>t({wallpaper:{...e.wallpaper,showBingInfo:s}})})]}),"image"===e.wallpaper.type&&s.jsx(Bs,{label:"图片 URL",value:e.wallpaper.value,placeholder:"https://...",onChange:s=>t({wallpaper:{...e.wallpaper,value:s}})}),s.jsx(Fs,{label:"模糊",value:e.wallpaper.blur,min:0,max:20,onChange:s=>t({wallpaper:{...e.wallpaper,blur:s}})}),s.jsx(Fs,{label:"亮度",value:e.wallpaper.brightness,min:20,max:100,onChange:s=>t({wallpaper:{...e.wallpaper,brightness:s}})})]})]})}function Gs(){const{settings:t,updateSettings:r}=pt(),[o,n]=e.useState(""),[a,i]=e.useState(!1),[l,c]=e.useState(null),[d,u]=e.useState(null);e.useEffect(()=>{(async()=>{const e=await Ce.getTMarksConfig();if(e?.bookmarkApiUrl){const t=e.bookmarkApiUrl.replace(/\/api\/?$/,"");n(t)}else n(Se().BASE_URL)})()},[]);return s.jsxs("div",{className:"space-y-6",children:[s.jsxs(Is,{title:"导入浏览器书签到工作区",children:[s.jsx("button",{onClick:async()=>{try{c(null),u(null),i(!0);const e=await chrome.runtime.sendMessage({type:"IMPORT_ALL_BOOKMARKS_TO_NEWTAB"});if(!e?.success)throw new Error(e?.error||"导入失败");const t=e.data?.folderTitle||"Imported",s=e.data?.counts?.folders??0,r=e.data?.counts?.bookmarks??0;c(`导入完成：${t}（目录 ${s} 个，书签 ${r} 个）`)}catch(e){u(e instanceof Error?e.message:"导入失败")}finally{i(!1)}},disabled:a,className:"w-full px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:a?"导入中...":"导入浏览器书签到 Tmarks"}),l&&s.jsx("div",{className:"text-xs text-green-400",children:l}),d&&s.jsx("div",{className:"text-xs text-red-400",children:d})]}),s.jsxs(Is,{title:"TMarks 同步",children:[s.jsx(Ns,{label:"显示置顶书签",checked:t.showPinnedBookmarks,onChange:e=>r({showPinnedBookmarks:e})}),s.jsx(Ns,{label:"搜索建议",checked:t.enableSearchSuggestions,onChange:e=>r({enableSearchSuggestions:e})}),o&&s.jsxs("a",{href:o,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-between p-3 mt-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",children:[s.jsx("span",{className:"text-sm text-white/70",children:"打开 TMarks 网站"}),s.jsx(N,{className:"w-4 h-4 text-white/50"})]}),s.jsx("div",{className:"text-xs text-white/40 mt-2",children:"在扩展设置中配置 API Key 以启用同步功能"})]}),s.jsxs(Is,{title:"自动刷新",children:[s.jsx(Ns,{label:"定时刷新置顶书签",checked:t.autoRefreshPinnedBookmarks,onChange:e=>r({autoRefreshPinnedBookmarks:e})}),t.autoRefreshPinnedBookmarks&&s.jsxs(s.Fragment,{children:[s.jsx(Cs,{label:"刷新时间",value:t.pinnedBookmarksRefreshTime,options:[{value:"morning",label:"早上 8:00"},{value:"evening",label:"晚上 22:00"}],onChange:e=>r({pinnedBookmarksRefreshTime:e})}),s.jsx("div",{className:"text-xs text-white/40 -mt-1 ml-1",children:"每天自动更新置顶书签缓存，保持数据最新"})]})]})]})}function Ts(){const{settings:t,updateSettings:r}=pt(),[o,n]=e.useState(!1),[a,i]=e.useState(null),[l,c]=e.useState(null),[d,u]=e.useState(!1),[m,h]=e.useState(null),[p,x]=e.useState([]),[g,f]=e.useState(!0);e.useEffect(()=>{if(!m)return;const e=e=>{if("AI_ORGANIZE_PROGRESS"!==String(e?.type??"").trim().toUpperCase())return;const t=e?.payload;t&&t.sessionId===m&&x(e=>{const s=[...e,t];return s.length>500?s.slice(s.length-500):s})};return chrome.runtime.onMessage.addListener(e),()=>{try{chrome.runtime.onMessage.removeListener(e)}catch{}}},[m]);const w=e.useCallback(()=>{x([])},[]),b=e.useCallback(()=>{u(!1),w()},[w]);return s.jsxs("div",{className:"space-y-6",children:[s.jsxs(Is,{title:"AI 整理",children:[s.jsx(Ns,{label:"启用 AI 整理",checked:t.enableWorkspaceAiOrganize??!0,onChange:e=>r({enableWorkspaceAiOrganize:e})}),s.jsx(Ls,{settings:t,updateSettings:r}),s.jsx(As,{settings:t,updateSettings:r}),s.jsx(Rs,{settings:t,updateSettings:r}),s.jsx(Ms,{settings:t,updateSettings:r}),s.jsx($s,{settings:t,updateSettings:r}),s.jsx("button",{"data-ai-organize-btn":!0,onClick:async()=>{try{i(null),c(null);const e=`${Date.now()}-${Math.random().toString(16).slice(2)}`;h(e),x([{ts:Date.now(),level:"info",step:"ui",message:"已发起整理任务，等待后台进度..."}]),u(!0),n(!0);const s=await chrome.runtime.sendMessage({type:"AI_ORGANIZE_NEWTAB_WORKSPACE",payload:{sessionId:e,rules:t.workspaceAiOrganizeRules??"",maxBookmarks:t.workspaceAiOrganizeMaxBookmarks??300,enableHistoryHeat:t.enableHistoryHeat??!1,historyDays:t.historyDays??30,historyHeatTopN:t.historyHeatTopN??20,strictHierarchy:t.workspaceAiOrganizeStrictHierarchy??!1,allowNewFolders:!t.workspaceAiOrganizeStrictHierarchy&&(t.workspaceAiOrganizeAllowNewFolders??!0),preferOriginalPaths:t.workspaceAiOrganizePreferOriginalPaths??!0,verboseLogs:t.workspaceAiOrganizeVerboseLogs??!0,topLevelCount:t.workspaceAiOrganizeTopLevelCount??5,promptTemplate:t.enableWorkspaceAiOrganizeCustomPrompt?t.workspaceAiOrganizePrompt??"":void 0}});if(!s?.success)throw new Error(s?.error||"AI 整理失败");const r=s.data?.createdFolders??0,o=s.data?.createdBookmarks??0,a=s.data?.processed??s.data?.total??0,l=s.data?.truncated?"（已截断）":"";i(`整理完成：已处理 ${a} 个书签${l}，创建目录 ${r} 个，复制书签 ${o} 个`)}catch(e){c(e instanceof Error?e.message:"AI 整理失败")}finally{n(!1),h(null)}},disabled:o,className:"w-full px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:o?"整理中...":"开始 AI 整理工作区"}),s.jsx("button",{onClick:()=>u(!0),className:"w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-white/80 text-sm transition-colors",children:"查看进度终端"}),a&&s.jsx("div",{className:"text-xs text-green-400",children:a}),l&&s.jsx("div",{className:"text-xs text-red-400",children:l}),s.jsx("div",{className:"text-xs text-white/40 leading-relaxed",children:"整理仅会在「TMarks」工作区内复制/重建目录结构，不会改动浏览器其它文件夹；如需备份，请在运行前自行手动备份。"})]}),d&&s.jsx(Os,{logs:p,sessionId:m,autoScroll:g,onAutoScrollChange:f,onClear:w,onClose:b})]})}function Ls({settings:e,updateSettings:t}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx("div",{className:"text-sm text-white/80",children:"自定义规则（可选）"}),s.jsx("textarea",{value:e.workspaceAiOrganizeRules??"",onChange:e=>t({workspaceAiOrganizeRules:e.target.value}),rows:6,placeholder:"示例：\n工作: github.com, jira., notion.so\n学习: coursera.org, edx.org\n娱乐: bilibili.com, youtube.com\n工具: translate.google.com, regex101.com",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none border border-white/10 font-mono"}),s.jsx("div",{className:"text-xs text-white/50",children:"规则会作为最高优先级提示给 AI。标签不可用时会参考原目录路径。"})]})}function As({settings:e,updateSettings:t}){const r=e.enableWorkspaceAiOrganizeCustomPrompt??!1;return s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:"text-sm text-white/80",children:"高级：自定义提示词模板"}),s.jsx("button",{type:"button",onClick:()=>t({enableWorkspaceAiOrganizeCustomPrompt:!r}),className:"px-3 py-1 rounded-lg text-xs font-medium transition-colors "+(r?"bg-blue-500 text-white hover:bg-blue-600":"bg-white/10 text-white/70 hover:bg-white/15"),children:r?"已启用":"已禁用"})]}),r&&s.jsxs(s.Fragment,{children:[s.jsx("textarea",{value:e.workspaceAiOrganizePrompt??"",onChange:e=>t({workspaceAiOrganizePrompt:e.target.value}),rows:10,placeholder:"可用变量：{{rules}} {{domainSummariesJson}}",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none border border-white/10 font-mono"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{type:"button",onClick:()=>t({workspaceAiOrganizePrompt:Ae}),className:"text-xs px-2 py-1 rounded-md bg-blue-500 hover:bg-blue-600 text-white transition-colors",children:"使用默认模板"}),s.jsx("button",{type:"button",onClick:()=>t({workspaceAiOrganizePrompt:""}),className:"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/15 text-white/80 transition-colors",children:"清空"})]}),s.jsx("div",{className:"text-xs text-white/50",children:'建议保持"只输出 JSON"的强约束，否则容易解析失败。'})]})]})}function Rs({settings:e,updateSettings:t}){return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex flex-col gap-4",children:[s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:"域名数上限"}),s.jsx("input",{type:"number",min:50,max:2e3,value:e.workspaceAiOrganizeMaxBookmarks??300,onChange:e=>t({workspaceAiOrganizeMaxBookmarks:Number(e.target.value)}),className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]}),s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:"期望的一级分类数量"}),s.jsx("input",{type:"number",min:3,max:7,value:e.workspaceAiOrganizeTopLevelCount??5,onChange:e=>{const s=Number(e.target.value);if(Number.isNaN(s))return;const r=Math.max(3,Math.min(7,Math.round(s)));t({workspaceAiOrganizeTopLevelCount:r})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})]}),s.jsxs("div",{className:"text-xs text-white/50 -mt-1 space-y-1",children:[s.jsx("p",{children:'为避免 AI Prompt 过大，这里限制参与分类规划的"域名数量"（按书签数量排序取前 N 个域名）。整理仍会应用到工作区全部书签。'}),s.jsx("p",{children:'当域名超过该上限时，会按此上限拆分为多批发送；AI 会在日志中看到"已拆分多批，收到全部批次后才输出"。'}),s.jsx("p",{children:"一级分类数量推荐 3-7 个，AI 会尽量按照你设定的数量生成顶级目录。"})]})]})}function Ms({settings:e,updateSettings:t}){const r=e.enableHistoryHeat??!1;return s.jsxs(s.Fragment,{children:[s.jsx(Ns,{label:"读取浏览器历史热度",checked:r,onChange:e=>t({enableHistoryHeat:e})}),r&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:"历史统计天数"}),s.jsx("input",{type:"number",min:1,max:90,value:e.historyDays??30,onChange:e=>{const s=Number(e.target.value);Number.isNaN(s)||t({historyDays:s})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]}),s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsx("div",{className:"text-sm text-white/80",children:"历史热度优先 Top N"}),s.jsx("input",{type:"number",min:5,max:100,value:e.historyHeatTopN??20,onChange:e=>{const s=Number(e.target.value);Number.isNaN(s)||t({historyHeatTopN:s})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})]}),s.jsxs("div",{className:"text-xs text-white/50 -mt-1 space-y-1",children:[s.jsx("p",{children:"启用后会统计最近 N 天的浏览记录来评估域名热度，用于决定目录层级。"}),s.jsx("p",{children:"Top N 域名会在 Prompt 中单独高亮，AI 会优先把它们放在一级目录或首页推荐区域（默认 20，可根据需要调节，范围 5-100）。"})]})]})]})}function $s({settings:e,updateSettings:t}){return s.jsxs("div",{className:"space-y-3 pt-2",children:[s.jsx("div",{className:"text-sm text-white/80",children:"层级策略"}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ns,{label:"严格沿用现有目录结构（仅合并/拆分/重命名）",checked:e.workspaceAiOrganizeStrictHierarchy??!1,onChange:e=>{t({workspaceAiOrganizeStrictHierarchy:e,...e?{workspaceAiOrganizeAllowNewFolders:!1}:{}})}}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"开启后，AI 只能在原有目录层级基础上微调，不得新增新的一级目录。"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ns,{label:"允许新增目录（严格模式下自动失效）",checked:e.workspaceAiOrganizeAllowNewFolders??!0,onChange:e=>t({workspaceAiOrganizeAllowNewFolders:e}),disabled:e.workspaceAiOrganizeStrictHierarchy??!1}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"关闭后，AI 只能把域名放入现有目录，不会创建新目录名称。"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ns,{label:"优先保留域名原有的目录路径",checked:e.workspaceAiOrganizePreferOriginalPaths??!0,onChange:e=>t({workspaceAiOrganizePreferOriginalPaths:e})}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"开启后，AI 会尽量把域名放回其历史常用目录，仅在冲突或规则要求时才调整。"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx(Ns,{label:"输出详细日志",checked:e.workspaceAiOrganizeVerboseLogs??!0,onChange:e=>t({workspaceAiOrganizeVerboseLogs:e})}),s.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"关闭后，仅保留关键步骤日志；开启则展示全部进度，便于排查问题。"})]})]})}function Os({logs:e,sessionId:t,autoScroll:r,onAutoScrollChange:o,onClear:n,onClose:a}){return s.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center",style:{zIndex:Nt+1},onClick:a,children:s.jsxs("div",{className:"w-[900px] max-w-[95%] h-[460px] rounded-2xl bg-black/80 border border-white/10 overflow-hidden flex flex-col",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[s.jsx("div",{className:"text-sm font-medium text-white/90",children:"AI 整理终端"}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/70 select-none",children:[s.jsx("input",{type:"checkbox",checked:r,onChange:e=>o(e.target.checked),className:"accent-blue-500"}),"自动滚动"]}),s.jsx("button",{onClick:n,className:"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/15 text-white/80",children:"清空"}),s.jsx("button",{onClick:a,className:"p-2 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/70"})})]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3 font-mono text-xs leading-relaxed",ref:e=>{e&&r&&setTimeout(()=>{try{e.scrollTop=e.scrollHeight}catch{}},0)},children:0===e.length?s.jsx("div",{className:"text-white/50",children:"暂无日志"}):s.jsx("div",{className:"space-y-2",children:e.map((e,t)=>{const r="number"==typeof e.ts?new Date(e.ts).toLocaleTimeString():"",o=String(e.level||"info"),n="error"===o?"text-red-300":"warn"===o?"text-yellow-300":"success"===o?"text-green-300":"text-white/80";return s.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[s.jsxs("div",{className:n,children:["[",r,"] [",o,"] [",String(e.step||""),"] ",String(e.message||"")]}),void 0!==e.detail&&null!==e.detail&&s.jsx("div",{className:"text-white/50 mt-1",children:(()=>{try{return JSON.stringify(e.detail,null,2)}catch{return String(e.detail)}})()})]},t)})})}),s.jsxs("div",{className:"px-4 py-3 border-t border-white/10 flex items-center justify-between gap-3",children:[s.jsxs("div",{className:"text-xs text-white/50 truncate",children:["Session: ",t||"-"]}),s.jsx("button",{onClick:()=>{try{const t=e.map(e=>{const t=`[${"number"==typeof e.ts?new Date(e.ts).toISOString():""}] [${String(e.level||"")}] [${String(e.step||"")}] ${String(e.message||"")}`;if(void 0===e.detail||null===e.detail)return t;try{return`${t}\n${JSON.stringify(e.detail,null,2)}`}catch{return`${t}\n${String(e.detail)}`}}).join("\n");navigator.clipboard.writeText(t)}catch{}},className:"text-xs px-3 py-1.5 rounded-md bg-blue-500 hover:bg-blue-600 text-white",children:"复制日志"})]})]})})}const _s=[{id:"general",label:"常规",icon:ne},{id:"appearance",label:"外观",icon:ae},{id:"sync",label:"同步",icon:a},{id:"ai",label:"AI 整理",icon:ie}];function Ps({onClose:t}){const[r,o]=e.useState("general");return B.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 animate-fadeIn",style:{zIndex:It},onClick:t,children:s.jsxs("div",{className:"relative w-full max-w-4xl h-[600px] rounded-2xl glass-modal-dark flex flex-col overflow-hidden",style:{zIndex:Nt,animation:"modalScale 0.2s ease-out"},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-white/10",children:[s.jsx("h2",{className:"text-lg font-medium text-white",children:"设置"}),s.jsx("button",{onClick:t,className:"p-2 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-5 h-5 text-white/70"})})]}),s.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[s.jsx("div",{className:"w-48 flex-shrink-0 border-r border-white/10 py-2",children:_s.map(e=>{const t=e.icon;return s.jsxs("button",{onClick:()=>o(e.id),className:"w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors relative "+(r===e.id?"text-white bg-white/10":"text-white/60 hover:text-white hover:bg-white/5"),children:[s.jsx(t,{className:"w-4 h-4"}),e.label,r===e.id&&s.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 bg-blue-500"})]},e.id)})}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:["general"===r&&s.jsx(Es,{}),"appearance"===r&&s.jsx(zs,{}),"sync"===r&&s.jsx(Gs,{}),"ai"===r&&s.jsx(Ts,{})]})]})]})}),document.body)}function Us({isOpen:t,onClose:r,onAdd:o,groupName:n}){const[a,i]=e.useState(""),[l,c]=e.useState(""),[d,u]=e.useState("");if(!t)return null;const m=()=>{if(u(""),a.trim())try{const e=a.startsWith("http")?a:`https://${a}`;new URL(e);const t=new URL(e).hostname,s=l.trim()||t;o(e,s),i(""),c(""),r()}catch{u("无效的网址格式")}else u("请输入网址")},h=e=>{"Enter"===e.key?m():"Escape"===e.key&&r()};return B.createPortal(s.jsxs("div",{className:"fixed inset-0 flex items-center justify-center animate-fadeIn",style:{zIndex:It},children:[s.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:r}),s.jsx("div",{className:"relative w-[400px] max-w-[90vw]",style:{zIndex:Nt,animation:"modalScale 0.2s ease-out"},children:s.jsxs("div",{className:"glass-modal rounded-2xl p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("h3",{className:"text-lg font-medium text-white",children:["添加快捷方式",n&&s.jsxs("span",{className:"ml-2 text-sm text-white/50",children:["到 ",n]})]}),s.jsx("button",{onClick:r,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-5 h-5 text-white/60"})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[s.jsx(le,{className:"w-4 h-4"}),"网址"]}),s.jsx("input",{type:"text",value:a,onChange:e=>i(e.target.value),onKeyDown:h,placeholder:"https://example.com",className:"w-full bg-white/10 text-white text-sm rounded-xl px-4 py-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/30 transition-colors",autoFocus:!0})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[s.jsx(ce,{className:"w-4 h-4"}),"名称 ",s.jsx("span",{className:"text-white/30",children:"(可选)"})]}),s.jsx("input",{type:"text",value:l,onChange:e=>c(e.target.value),onKeyDown:h,placeholder:"自动获取域名",className:"w-full bg-white/10 text-white text-sm rounded-xl px-4 py-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/30 transition-colors"})]}),d&&s.jsx("p",{className:"text-sm text-red-400",children:d})]}),s.jsxs("div",{className:"flex gap-3 mt-6",children:[s.jsx("button",{onClick:r,className:"flex-1 py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white/70 text-sm transition-colors",children:"取消"}),s.jsx("button",{onClick:m,className:"flex-1 py-2.5 rounded-xl bg-blue-500/80 hover:bg-blue-500 text-white text-sm transition-colors",children:"添加"})]})]})})]}),document.body)}function Hs({isOpen:t,onClose:r,onSave:o,initialName:n}){const[a,i]=e.useState("");if(e.useEffect(()=>{i(n||"")},[n,t]),!t)return null;return B.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 animate-fadeIn",style:{zIndex:It},onClick:r,children:s.jsxs("div",{className:"relative w-80 rounded-2xl glass-modal-dark overflow-hidden",style:{zIndex:Nt,animation:"modalScale 0.2s ease-out"},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(S,{className:"w-5 h-5 text-white/70"}),s.jsx("h3",{className:"text-base font-medium text-white",children:"新建文件夹"})]}),s.jsx("button",{onClick:r,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/60"})})]}),s.jsxs("form",{onSubmit:e=>{e.preventDefault(),a.trim()&&(o(a.trim()),i(""),r())},className:"p-4",children:[s.jsx("input",{type:"text",value:a,onChange:e=>i(e.target.value),placeholder:"文件夹名称",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2.5 outline-none border border-white/10 focus:border-white/30 placeholder-white/40",autoFocus:!0}),s.jsxs("div",{className:"flex gap-2 mt-4",children:[s.jsx("button",{type:"button",onClick:r,className:"flex-1 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-white/70 text-sm",children:"取消"}),s.jsx("button",{type:"submit",disabled:!a.trim(),className:"flex-1 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-white text-sm",children:"创建"})]})]})]})}),document.body)}function Ws({isOpen:t,onClose:r,selectedIds:o,onSelectedIdsChange:n}){const{shortcutGroups:a,getFilteredGridItems:i,removeGridItem:l,updateGridItem:c,activeGroupId:d,currentFolderId:u,gridItems:m,cleanupAllEmptyFolders:h,cleanupEmptyGroups:p}=pt(),[x,g]=e.useState(""),[f,w]=e.useState(!1),b=e.useMemo(()=>i().sort((e,t)=>e.position-t.position),[i,d,u,m]);if(e.useEffect(()=>{t||g("")},[t]),!t)return null;const k=()=>{n(new Set),g(""),r()},v=b.length>0&&b.every(e=>o.has(e.id));return B.createPortal(s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2",style:{zIndex:jt+1},children:s.jsxs("div",{className:"flex items-center justify-between gap-3 px-4 py-3 rounded-2xl glass-dark shadow-2xl w-[min(920px,calc(100vw-32px))]",style:{backdropFilter:"blur(16px) saturate(180%)",WebkitBackdropFilter:"blur(16px) saturate(180%)",border:"1px solid rgba(255,255,255,0.12)",boxShadow:"0 18px 42px rgba(0,0,0,0.42)"},children:[s.jsx("button",{onClick:()=>{if(b.length>0&&b.every(e=>o.has(e.id))){const e=new Set(o);b.forEach(t=>e.delete(t.id)),n(e)}else{const e=new Set(o);b.forEach(t=>e.add(t.id)),n(e)}},className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-xs text-white/80",children:v?"取消全选":"全选"}),s.jsxs("span",{className:"flex items-center gap-1 text-xs text-white/70 min-w-[76px]",children:[s.jsx(de,{className:"w-3.5 h-3.5"}),"已选 ",o.size]}),s.jsx("div",{className:"h-5 w-px bg-white/15"}),s.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[s.jsx("button",{onClick:k,className:"px-3 py-1.5 rounded-full bg-green-500/20 text-green-300 hover:bg-green-500/30 transition-colors text-xs",children:"完成"}),s.jsx("button",{onClick:k,className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-xs text-white/80",children:"取消"}),s.jsx("button",{onClick:()=>{0!==o.size&&w(!0)},disabled:0===o.size,className:"px-3 py-1.5 rounded-full bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-colors disabled:opacity-30 text-xs",children:"删除"})]}),s.jsx("div",{className:"h-5 w-px bg-white/15"}),s.jsxs("div",{className:"flex items-center gap-2 flex-1 justify-end min-w-0",children:[s.jsx(ue,{className:"w-4 h-4 text-white/70"}),s.jsxs("select",{value:x,onChange:e=>g(e.target.value),className:"bg-white/10 text-white text-xs rounded-xl px-3 py-2 outline-none border border-white/15 min-w-[140px] max-w-[280px]",children:[s.jsx("option",{value:"",children:"选择分组"}),a.map(e=>s.jsx("option",{value:e.id,className:"bg-slate-900 text-white",children:e.name},e.id))]}),s.jsx("button",{onClick:()=>{0!==o.size&&x&&(o.forEach(e=>{const t=m.find(t=>t.id===e);t&&(t.groupId!==x||t.parentId)&&c(e,{groupId:x,parentId:void 0})}),setTimeout(()=>{h(),p()},100),n(new Set),r())},disabled:!x||0===o.size,className:"px-4 py-2 rounded-xl bg-white text-slate-900 text-xs font-medium transition-colors disabled:opacity-40",children:"移动"})]})]})}),s.jsx(as,{isOpen:f,title:"删除确认",message:`确定要删除选中的 ${o.size} 个快捷方式吗？此操作不可恢复。`,confirmText:"删除",cancelText:"取消",confirmVariant:"danger",onConfirm:()=>{o.forEach(e=>l(e)),n(new Set),w(!1)},onCancel:()=>w(!1)})]}),document.body)}const Ks="tmarks_batch_edit_tip_dismissed";function Ys({isOpen:t,onClose:r}){const[o,n]=e.useState(!1),[a,i]=e.useState(!1);e.useEffect(()=>{if(t){const e=localStorage.getItem(Ks);i("true"!==e)}},[t]);const l=()=>{o&&localStorage.setItem(Ks,"true"),r()};return t&&a?B.createPortal(s.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn",style:{zIndex:It},onClick:l,children:s.jsxs("div",{className:"relative w-[min(420px,calc(100vw-32px))] rounded-2xl glass-dark p-6 shadow-2xl",style:{backdropFilter:"blur(20px) saturate(180%)",WebkitBackdropFilter:"blur(20px) saturate(180%)",border:"1px solid rgba(255,255,255,0.15)"},onClick:e=>e.stopPropagation(),children:[s.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-1.5 rounded-full hover:bg-white/10 transition-colors",children:s.jsx(y,{className:"w-4 h-4 text-white/60"})}),s.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[s.jsx("div",{className:"p-2.5 rounded-xl bg-blue-500/20",children:s.jsx(me,{className:"w-5 h-5 text-blue-400"})}),s.jsx("h3",{className:"text-lg font-semibold text-white",children:"批量编辑模式"})]}),s.jsxs("div",{className:"space-y-3 text-sm text-white/80",children:[s.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[s.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-blue-500/30 text-blue-300 flex items-center justify-center text-xs font-medium",children:"1"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-white/90",children:"单击"}),s.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:"选择/取消选择项目"})]})]}),s.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[s.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/30 text-purple-300 flex items-center justify-center text-xs font-medium",children:"2"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-white/90",children:"双击文件夹"}),s.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:"进入文件夹查看内容"})]})]}),s.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[s.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/30 text-amber-300 flex items-center justify-center text-xs font-medium",children:"!"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-white/90",children:"空文件夹自动删除"}),s.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:"移出所有内容后，文件夹会自动删除（首页除外）"})]})]})]}),s.jsx("div",{className:"mt-5 pt-4 border-t border-white/10",children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer select-none",children:[s.jsx("input",{type:"checkbox",checked:o,onChange:e=>n(e.target.checked),className:"w-4 h-4 rounded border-white/30 bg-white/10 text-blue-500 focus:ring-blue-500/50"}),s.jsx("span",{className:"text-xs text-white/60",children:"下次不再显示"})]})}),s.jsx("button",{onClick:l,className:"mt-4 w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white text-sm font-medium transition-colors",children:"知道了"})]})}),document.body):null}function qs({x:t,y:r,items:o,onClose:n}){const a=e.useRef(null);return e.useEffect(()=>{const e=e=>{a.current&&!a.current.contains(e.target)&&n()},t=e=>{"Escape"===e.key&&n()};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),document.addEventListener("contextmenu",n),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t),document.removeEventListener("contextmenu",n)}},[n]),e.useEffect(()=>{if(a.current){const e=a.current.getBoundingClientRect(),s=t+e.width>window.innerWidth?window.innerWidth-e.width-10:t,o=r+e.height>window.innerHeight?window.innerHeight-e.height-10:r;a.current.style.left=`${s}px`,a.current.style.top=`${o}px`}},[t,r]),B.createPortal(s.jsx("div",{ref:a,className:"fixed z-[9999] min-w-[180px] rounded-2xl glass-dark border border-white/10 shadow-xl py-2 animate-fadeIn overflow-hidden",style:{left:t,top:r},children:o.map((e,t)=>s.jsxs("div",{children:[s.jsxs("button",{onClick:()=>{e.onClick(),n()},className:`\n              w-full flex items-center gap-3 px-4 py-2 text-sm transition-colors\n              ${e.danger?"text-red-400 hover:bg-red-500/20":"text-white/80 hover:bg-white/10"}\n            `,children:[s.jsx("span",{className:"w-4 h-4 flex-shrink-0",children:e.icon}),s.jsx("span",{children:e.label})]}),e.divider&&s.jsx("div",{className:"h-px bg-white/10 my-1"})]},t))}),document.body)}function Vs(){const{settings:t,isLoading:r,loadData:o,updateSettings:n,shortcutGroups:a,activeGroupId:i,setActiveGroup:l,addGridItem:c}=pt(),[d,u]=e.useState(!1),[m,h]=e.useState(!1),[p,x]=e.useState(!1),[g,f]=e.useState(!1),[w,b]=e.useState(!1),[v,y]=e.useState(new Set),[j,I]=e.useState(null),[N,C]=e.useState(!1),S=e.useRef(),B=e.useRef(!1),F=e.useRef(null),D=e.useRef(null),E=e.useRef({shortcutGroups:a,activeGroupId:i,setActiveGroup:l});E.current={shortcutGroups:a,activeGroupId:i,setActiveGroup:l},mt(),e.useEffect(()=>{o()},[o]);const z=e.useCallback(e=>{const{shortcutGroups:t,activeGroupId:s,setActiveGroup:r}=E.current;if(B.current)return;const o=e.target.closest(".overflow-y-auto, .overflow-auto");if(o){const{scrollTop:t,scrollHeight:s,clientHeight:r}=o;if(s>r){if(e.deltaY<0&&t>0)return;if(e.deltaY>0&&t+r<s)return}}const n=t.map(e=>e.id);if(0===n.length)return;const a=n.indexOf(s||"");if(-1===a)return void r(n[0]);let i=a;e.deltaY>0?i=Math.min(a+1,n.length-1):e.deltaY<0&&(i=Math.max(a-1,0)),i!==a&&(e.preventDefault(),r(n[i]),B.current=!0,S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{B.current=!1},300))},[]),G=e.useCallback(e=>{const t=e.target,s=t.closest('[role="dialog"]')||t.closest(".glass-modal")||t.closest(".glass-modal-dark"),r="INPUT"===t.tagName||"TEXTAREA"===t.tagName;s||r||(e.preventDefault(),I({x:e.clientX,y:e.clientY}))},[]),T=e.useCallback(()=>{F.current&&(window.clearTimeout(F.current),F.current=null),D.current=null},[]),L=e.useCallback(e=>{if(0!==e.button)return;const t=e.target,s=t.closest('[role="dialog"]')||t.closest(".glass-modal")||t.closest(".glass-modal-dark"),r=t.closest("button")||t.closest("a")||t.closest("input")||t.closest("textarea"),o=t.closest("[data-shortcut-item]");s||r||o||(T(),D.current={x:e.clientX,y:e.clientY},F.current=window.setTimeout(()=>{C(e=>!e),T()},2e3))},[T]),A=e.useCallback(e=>{if(!D.current)return;const t=e.clientX-D.current.x,s=e.clientY-D.current.y;Math.hypot(t,s)>10&&T()},[T]),R=e.useCallback(()=>{T()},[T]);e.useEffect(()=>{if(t.showShortcuts)return window.addEventListener("wheel",z,{passive:!1}),()=>{window.removeEventListener("wheel",z),S.current&&clearTimeout(S.current)}},[z,t.showShortcuts]),e.useEffect(()=>(window.addEventListener("contextmenu",G),()=>{window.removeEventListener("contextmenu",G)}),[G]);const M=e.useCallback(()=>{},[]);return r?s.jsx("div",{className:"w-full h-full flex items-center justify-center bg-[#1a1a2e]",children:s.jsx("div",{className:"w-8 h-8 border-2 border-white/30 border-t-white rounded-full animate-spin"})}):s.jsxs("div",{className:"relative w-full h-full overflow-hidden",onPointerDown:L,onPointerMove:A,onPointerUp:R,onPointerLeave:R,children:[s.jsx(hs,{config:t.wallpaper,onRefresh:M}),s.jsxs("div",{className:"relative z-10 w-full h-full flex flex-col items-center px-4 pt-[12vh] pb-8 overflow-y-auto",children:[t.showGreeting&&s.jsx("div",{className:"mb-1 animate-fadeIn",children:s.jsx(fs,{userName:t.userName})}),t.showClock&&s.jsx("div",{className:"mb-3 animate-fadeIn",children:s.jsx(xt,{format:t.clockFormat,showDate:t.showDate,showSeconds:t.showSeconds,showLunar:t.showLunar})}),!t.showClock&&t.showLunar&&s.jsx("div",{className:"mb-3 animate-fadeIn",children:s.jsx(ws,{})}),t.showPoetry&&s.jsx("div",{className:"mb-6 animate-fadeIn",children:s.jsx(ks,{})}),t.showSearch&&s.jsx("div",{className:"w-full max-w-2xl mb-6 animate-fadeIn px-4 relative z-50",children:s.jsx(yt,{engine:t.searchEngine,enableSuggestions:t.enableSearchSuggestions,onEngineChange:e=>n({searchEngine:e})})}),t.showShortcuts&&s.jsx("div",{className:"w-full max-w-5xl animate-fadeIn px-4 shortcut-area",children:s.jsx("div",{className:"flex items-start gap-4",children:s.jsx(ds,{columns:t.shortcutColumns,isBatchMode:g,batchSelectedIds:v,onBatchSelectedIdsChange:y,isEditing:N,onEditingChange:C})})})]}),s.jsx(js,{onOpenSettings:()=>u(!0)}),t.showPinnedBookmarks&&s.jsx(gs,{}),d&&s.jsx(Ps,{onClose:()=>u(!1)}),m&&s.jsx(Us,{isOpen:m,onClose:()=>h(!1),onAdd:(e,t)=>{const s=new URL(e).hostname;c("shortcut",{groupId:i||void 0,shortcut:{url:e,title:t,favicon:`${ve}${s}&sz=64`}})},groupName:i?a.find(e=>e.id===i)?.name:void 0}),s.jsx(Ws,{isOpen:g,onClose:()=>{f(!1),y(new Set)},selectedIds:v,onSelectedIdsChange:y}),s.jsx(Ys,{isOpen:w,onClose:()=>b(!1)}),s.jsx(Hs,{isOpen:p,onClose:()=>x(!1),onSave:e=>c("bookmarkFolder",{groupId:i??void 0,bookmarkFolder:{title:e}})}),j&&s.jsx(qs,{x:j.x,y:j.y,items:[{label:"添加快捷方式",icon:s.jsx(k,{className:"w-4 h-4"}),onClick:()=>h(!0)},{label:"添加文件夹",icon:s.jsx(he,{className:"w-4 h-4"}),onClick:()=>x(!0)},{label:"批量编辑",icon:s.jsx(pe,{className:"w-4 h-4"}),onClick:()=>{y(new Set),f(!0),b(!0)},divider:!0}],onClose:()=>I(null)})]})}const Xs=document.getElementById("root");Xs&&xe.createRoot(Xs).render(s.jsx(ge.StrictMode,{children:s.jsx(Vs,{})}));
