import{S as t,g as e,d as a,P as s}from"./index-t8aYSNnz.js";import{A as r,g as o}from"./index-DNQOCTJz.js";import{c as n}from"./index-B0F8WSnQ.js";import"./prompts-CKcm-rRX.js";const i=new class{client=null;async initialize(){const a=await t.getBookmarkSiteApiUrl(),s=await t.getBookmarkSiteApiKey();if(!s)throw new r("API_KEY_INVALID","API Key not found. Please configure your TMarks API key in the extension settings (Options page).");let o;o=a?a.endsWith("/api")?a:e(a).API_BASE:e().API_BASE,this.client=n({apiKey:s,baseUrl:o})}async ensureClient(){if(this.client||await this.initialize(),!this.client)throw new r("API_KEY_INVALID","API Key not found. Failed to initialize TMarks client. Please configure your API key in the extension settings.");return this.client}async getTags(){const t=await this.ensureClient();try{return(await t.tags.getTags()).data.tags.map(t=>({name:t.name,color:t.color,count:t.bookmark_count||0,createdAt:new Date(t.created_at).getTime()}))}catch(e){if("MISSING_API_KEY"===e.code)throw new r("API_KEY_INVALID","TMarks API key is required. Please configure your API key in the extension settings.",{originalError:e});throw new r("BOOKMARK_SITE_ERROR",`Failed to fetch tags: ${e.message}`,{originalError:e})}}async getBookmarks(t=1,e=100){const a=await this.ensureClient();try{const s=await a.bookmarks.getBookmarks({page_size:e,page_cursor:t>1?`page_${t}`:void 0});if(!s.data.bookmarks.length)return{bookmarks:[],hasMore:!1};return{bookmarks:s.data.bookmarks.map(t=>({url:t.url,title:t.title,description:t.description||"",tags:t.tags.map(t=>t.name),createdAt:new Date(t.created_at).getTime(),remoteId:t.id,isPublic:t.is_public})),hasMore:s.data.meta.has_more}}catch(s){throw new r("BOOKMARK_SITE_ERROR",`Failed to fetch bookmarks: ${s.message}`,{originalError:s})}}async addBookmark(t){const e=await this.ensureClient();try{const a=await e.bookmarks.createBookmark({title:t.title,url:t.url,description:t.description,cover_image:t.thumbnail,favicon:t.favicon,tags:t.tags,is_public:t.isPublic??!1});if(!a.data.bookmark)throw new r("BOOKMARK_SITE_ERROR","Failed to add bookmark: No data returned");const s="BOOKMARK_EXISTS"===a.meta?.code;return s?{id:a.data.bookmark.id,isExisting:s,existingBookmark:a.data.bookmark}:{id:a.data.bookmark.id,isExisting:s}}catch(a){const t=a.message||"Unknown error";throw new r("BOOKMARK_SITE_ERROR",`Failed to add bookmark: ${t}`,{originalError:a})}}async updateBookmarkTags(t,e){const a=await this.ensureClient();try{await a.bookmarks.updateBookmark(t,{tags:e})}catch(s){throw new r("BOOKMARK_SITE_ERROR",`Failed to update tags: ${s.message}`,{originalError:s})}}async createSnapshot(t,e){const a=await this.ensureClient();try{await a.snapshots.createSnapshot(t,e)}catch(s){throw new r("BOOKMARK_SITE_ERROR",`Failed to create snapshot: ${s.message}`,{originalError:s})}}async createSnapshotV2(a,s){await this.ensureClient();try{const r=await t.getBookmarkSiteApiKey(),o=await t.getBookmarkSiteApiUrl();let n;n=o?o.endsWith("/api")?o:e(o).API_BASE:e().API_BASE;const i=await fetch(`${n}/tab/bookmarks/${a}/snapshots-v2`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":r},body:JSON.stringify(s)});if(!i.ok){const t=await i.json();throw new Error(t.error?.message||"Failed to create snapshot")}}catch(o){throw new r("BOOKMARK_SITE_ERROR",`Failed to create snapshot (V2): ${o.message}`,{originalError:o})}}async testConnection(){try{const t=await this.ensureClient();return await t.user.getMe(),!0}catch(t){return!1}}};const c=new class{contextCache=null;contextPromise=null;async recommendTags(e){try{const a=t.loadConfig(),s=this.getContext(),r=await a,o=r.aiConfig.apiKeys[r.aiConfig.provider];if(!o)return this.fallbackRecommendation(e);const n=await s,i={page:{title:e.title,url:e.url,description:e.description,content:e.content?.substring(0,500)},context:n,options:{maxTags:r.preferences.maxSuggestedTags||5,preferExisting:!0}},c=r.aiConfig.apiUrls?.[r.aiConfig.provider],l=r.aiConfig.enableCustomPrompt?r.aiConfig.customPrompt:void 0,u=await this.callAIWithRetry(i,o,r.aiConfig.provider,r.aiConfig.model,c,l,1,void 0),m=n.existingTags,d=new Set(m.map(t=>t.trim().toLowerCase())),h=u.suggestedTags.map(t=>{const e=t.name.trim().toLowerCase(),a=d.has(e);return{...t,isNew:!a}});return{tags:this.deduplicateAndSort(h),source:"ai",timestamp:Date.now()}}catch(a){const t=a instanceof Error?a.message:"AI recommendation failed";return this.fallbackRecommendation(e,t)}}async getContext(){if(this.contextCache)return this.contextCache;if(this.contextPromise)return this.contextPromise;this.contextPromise=this.loadContextFromDB();try{const t=await this.contextPromise;return this.contextCache=t,t}finally{this.contextPromise=null}}async callAIWithRetry(t,e,a,s,r,n,i,c){const l=o(a);let u;for(let o=0;o<i;o++)try{if("number"==typeof c&&c>0){const a=new Promise((t,e)=>{setTimeout(()=>e(new Error("AI request timeout")),c)});return await Promise.race([l.generateTags(t,e,s,r,n),a])}return await l.generateTags(t,e,s,r,n)}catch(m){if(u=m,o<i-1){const t=1e3*Math.pow(2,o);await this.delay(t)}}throw u||new Error("AI request failed after retries")}async fallbackRecommendation(t,e){const s=this.extractKeywords(t.title+" "+(t.description||""));return{tags:(await a.tags.toArray()).filter(t=>s.some(e=>t.name.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(t.name.toLowerCase()))).sort((t,e)=>(e.count||0)-(t.count||0)).slice(0,3).map(t=>({name:t.name,isNew:!1,confidence:.6})),source:"fallback",timestamp:Date.now(),message:e||null}}extractKeywords(t){return t.split(/[\s\/\-_、，。！？]+/).map(t=>t.trim()).filter(t=>t.length>1).slice(0,20)}deduplicateAndSort(t){const e=new Set,a=[];for(const s of t){const t=s.name.toLowerCase().trim();e.has(t)||(e.add(t),a.push(s))}return a.sort((t,e)=>e.confidence-t.confidence)}delay(t){return new Promise(e=>setTimeout(e,t))}clearContextCache(){this.contextCache=null}async preloadContext(){if(this.contextPromise)return void(await this.contextPromise);const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}async refreshContextFromDB(){const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}updateContextWithBookmark(t){if(!this.contextCache)return;const e=new Set(this.contextCache.existingTags.map(t=>t.toLowerCase())),a=[];for(const s of t.tags){const t=s.trim();t&&(e.has(t.toLowerCase())||(e.add(t.toLowerCase()),a.push(t)))}a.length>0&&(this.contextCache.existingTags=[...this.contextCache.existingTags,...a].slice(-200)),this.contextCache.recentBookmarks=[{title:t.title,tags:t.tags},...this.contextCache.recentBookmarks].slice(0,20)}async loadContextFromDB(t=!1){if(!t&&this.contextCache)return this.contextCache;const[e,s]=await Promise.all([a.tags.orderBy("count").reverse().limit(200).toArray().then(t=>t.map(t=>t.name)),a.bookmarks.orderBy("createdAt").reverse().limit(20).toArray().then(t=>t.map(t=>({title:t.title,tags:t.tags})))]),r={existingTags:e,recentBookmarks:s};return this.contextCache=r,r}};const l=new class{async fullSync(){const t=Date.now();try{const e=await i.getTags();await a.tags.clear(),await a.tags.bulkAdd(e);let r=1,o=0;for(await a.bookmarks.clear();r<=s.MAX_PAGES;){const{bookmarks:t,hasMore:e}=await i.getBookmarks(r,s.DEFAULT_PAGE_SIZE);if(t.length>0&&(await a.bookmarks.bulkAdd(t),o+=t.length),!e)break;r++}await a.updateLastSyncTime(Date.now()),await a.metadata.put({key:"totalTags",value:e.length,updatedAt:Date.now()}),await a.metadata.put({key:"totalBookmarks",value:o,updatedAt:Date.now()}),await c.refreshContextFromDB();return{success:!0,duration:Date.now()-t,stats:{tags:e.length,bookmarks:o}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async incrementalSync(){try{await a.getLastSyncTime();return this.fullSync()}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async getStats(){return a.getStats()}async isCacheStale(t=24){const e=await a.getLastSyncTime();if(0===e)return!0;const s=60*t*60*1e3;return Date.now()-e>s}async autoSync(t=24){return await this.isCacheStale(t)?this.incrementalSync():null}async clearCache(){await a.clearAll(),c.clearContextCache()}};const u=new class{async saveBookmark(t){let e,s=!1;try{const r=await i.addBookmark(t);if(e=r.id,s=r.isExisting||!1,s&&r.existingBookmark)return{success:!0,existingBookmark:{...r.existingBookmark,needsDialog:!0},message:"书签已存在"};s||(await a.bookmarks.add({url:t.url,title:t.title,description:t.description,tags:t.tags,createdAt:Date.now(),remoteId:r.id,isPublic:t.isPublic??!1}),await this.updateTagCounts(t.tags),c.updateContextWithBookmark({title:t.title,tags:t.tags}))}catch(r){if((r instanceof Error?r.message:"Unknown error").includes("Network"))return await this.queueForLaterSync(t),{success:!0,offline:!0,message:"已暂存,将在网络恢复后同步"};throw r}if(t.createSnapshot&&e)try{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});if(a&&a.id){let s;try{const t=chrome.tabs.sendMessage(a.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),e=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),r=await Promise.race([t,e]);if(!r.success)throw new Error(r.error||"Capture failed");s=r.data}catch(r){throw r}const o=s.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));await i.createSnapshotV2(e,{html_content:s.html,title:t.title,url:t.url,images:o})}}catch(o){}return{success:!0,bookmarkId:e,message:s?"书签已存在，已为其创建新快照":void 0}}async updateTagCounts(t){for(const e of t){const t=await a.tags.where("name").equals(e).first();t&&t.id?await a.tags.update(t.id,{count:(t.count||0)+1}):await a.tags.add({name:e,count:1,createdAt:Date.now()})}}async queueForLaterSync(t){await a.metadata.add({key:`pending_${Date.now()}`,value:t,updatedAt:Date.now()})}async syncPendingBookmarks(){const t=await a.metadata.where("key").startsWith("pending_").toArray();let e=0;for(const r of t)try{if(r.value&&"object"==typeof r.value&&"url"in r.value&&"title"in r.value){const t=r.value;await i.addBookmark(t),await a.metadata.delete(r.key),e++}}catch(s){}return e}async getPendingCount(){return await a.metadata.where("key").startsWith("pending_").count()}};c.preloadContext().catch(()=>{}),chrome.runtime.onInstalled.addListener(async t=>{"install"===t.reason||t.reason}),async function(){const e=()=>{const a=function(){const t=new Date,e=new Date(t);return e.setHours(23,0,0,0),e<=t&&e.setDate(e.getDate()+1),e.getTime()-t.getTime()}();setTimeout(async()=>{await async function(){try{const e=await t.loadConfig();if(!e.preferences.autoSync)return;await l.autoSync(e.preferences.syncInterval)}catch(e){}}(),e()},a)};e()}().catch(()=>{}),u.syncPendingBookmarks().catch(()=>{}),chrome.runtime.onMessage.addListener((e,a,s)=>(async function(e){switch(e.type){case"EXTRACT_PAGE_INFO":{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t||!t.id)throw new Error("No active tab found");const n=t.url||"";if(n.startsWith("chrome://")||n.startsWith("chrome-extension://")||n.startsWith("edge://")||n.startsWith("about:")||!n)return{success:!0,data:{title:t.title||"Untitled",url:n,description:"",content:"",thumbnail:""}};const i=async(t,e,a=3e3)=>Promise.race([chrome.tabs.sendMessage(t,e),new Promise((t,e)=>setTimeout(()=>e(new Error("Message timeout")),a))]),c=async t=>{try{const e=await chrome.tabs.get(t);return{success:!0,data:{title:e.title||"Untitled",url:e.url||"",description:"",content:"",thumbnail:""}}}catch(e){return{success:!0,data:{title:"Untitled",url:n,description:"",content:"",thumbnail:""}}}};let l=!1;try{await i(t.id,{type:"PING"},1e3),l=!0}catch(a){}if(!l)try{const e=chrome.runtime.getManifest(),a=e.content_scripts?.[0];if(!a||!a.js||0===a.js.length)return await c(t.id);const r=a.js[0];await chrome.scripting.executeScript({target:{tabId:t.id},files:[r]}),await new Promise(t=>setTimeout(t,300));try{await i(t.id,{type:"PING"},1e3),l=!0}catch(s){return await c(t.id)}}catch(r){return await c(t.id)}if(l)try{const a=await i(t.id,e,5e3);return a.success&&a.data?a:await c(t.id)}catch(o){return await c(t.id)}return await c(t.id)}case"RECOMMEND_TAGS":{const t=e.payload;return{success:!0,data:await c.recommendTags(t)}}case"SAVE_BOOKMARK":try{const t=e.payload;return{success:!0,data:await u.saveBookmark(t)}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to save bookmark"}}case"SYNC_CACHE":{const t=await l.fullSync();return{success:t.success,data:t,error:t.error}}case"GET_EXISTING_TAGS":try{return{success:!0,data:await i.getTags()}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to load tags"}}case"UPDATE_BOOKMARK_TAGS":try{const{bookmarkId:t,tags:a}=e.payload;return await i.updateBookmarkTags(t,a),{success:!0,data:{message:"Tags updated successfully"}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to update tags"}}case"CREATE_SNAPSHOT":try{const{bookmarkId:t,title:a,url:s}=e.payload,[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r||!r.id)throw new Error("No active tab found");let o;try{const t=chrome.tabs.sendMessage(r.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),e=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),a=await Promise.race([t,e]);if(!a.success)throw new Error(a.error||"Capture failed");o=a.data}catch(n){throw n}const c=o.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));return await i.createSnapshotV2(t,{html_content:o.html,title:a,url:s,images:c}),{success:!0,data:{message:"Snapshot created successfully (V2)",imageCount:c.length}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to create snapshot"}}case"GET_CONFIG":return{success:!0,data:await t.loadConfig()};default:throw new Error(`Unknown message type: ${e.type}`)}}(e).then(t=>s(t)).catch(t=>{s({success:!1,error:t instanceof Error?t.message:"Unknown error"})}),!0)),chrome.action.onClicked.addListener(async()=>{});
