import{S as t,g as e,t as a,P as o,a as r}from"./urls-T86wRnwx.js";import{d as n}from"./index-NQ3jknxk.js";import{A as s,g as i,c}from"./index-8lkdjZ4V.js";import{c as l}from"./index-3rMDm5L8.js";import{s as d}from"./tab-collection-BHctueL_.js";import{N as u,a as m}from"./newtabPrompts-Br339DSM.js";import{S as h}from"./constants-CAUY5aFy.js";import"./dexie-BAhLzSXZ.js";import"./prompts-CKcm-rRX.js";const f=new class{client=null;webBaseUrl=null;async initialize(){const a=await t.getBookmarkSiteApiUrl(),o=await t.getBookmarkSiteApiKey();if(!o)throw new s("API_KEY_INVALID","API Key not found. Please configure your TMarks API key in the extension settings (Options page).");let r;r=a?a.endsWith("/api")?a:e(a).API_BASE:e().API_BASE,this.webBaseUrl=r.endsWith("/api")?r.slice(0,-4):r,this.client=l({apiKey:o,baseUrl:r})}async notifyWebAppDataChanged(){if(this.webBaseUrl)try{const t=await chrome.tabs.query({url:[`${this.webBaseUrl}/*`]});await Promise.all((t||[]).filter(t=>"number"==typeof t.id).map(t=>chrome.tabs.sendMessage(t.id,{type:"TMARKS_WEB_DATA_CHANGED",payload:{timestamp:Date.now()}}).catch(()=>{})))}catch{}}async ensureClient(){if(await this.initialize(),!this.client)throw new s("API_KEY_INVALID","API Key not found. Failed to initialize TMarks client. Please configure your API key in the extension settings.");return this.client}async getTags(){const t=await this.ensureClient();try{return(await t.tags.getTags()).data.tags.map(t=>({name:t.name,color:t.color,count:t.bookmark_count||0,createdAt:new Date(t.created_at).getTime()}))}catch(e){if("MISSING_API_KEY"===e.code)throw new s("API_KEY_INVALID","TMarks API key is required. Please configure your API key in the extension settings.",{originalError:e});throw new s("BOOKMARK_SITE_ERROR",`Failed to fetch tags: ${e.message}`,{originalError:e})}}async getBookmarks(t=1,e=100){const a=await this.ensureClient();try{const o=await a.bookmarks.getBookmarks({page_size:e,page_cursor:t>1?`page_${t}`:void 0});if(!o.data.bookmarks.length)return{bookmarks:[],hasMore:!1};return{bookmarks:o.data.bookmarks.map(t=>({url:t.url,title:t.title,description:t.description||"",tags:t.tags.map(t=>t.name),createdAt:new Date(t.created_at).getTime(),remoteId:t.id,isPublic:t.is_public})),hasMore:o.data.meta.has_more}}catch(o){throw new s("BOOKMARK_SITE_ERROR",`Failed to fetch bookmarks: ${o.message}`,{originalError:o})}}async addBookmark(t){const e=await this.ensureClient(),o={title:t.title,url:t.url,description:t.description,cover_image:t.thumbnail,favicon:t.favicon,tags:t.tags,is_public:t.isPublic??!1};try{const t=await e.bookmarks.createBookmark(o);if(!t.data.bookmark)throw new s("BOOKMARK_SITE_ERROR","Failed to add bookmark: No data returned");const a="BOOKMARK_EXISTS"===t.meta?.code;return a?(await this.notifyWebAppDataChanged(),{id:t.data.bookmark.id,isExisting:a,existingBookmark:t.data.bookmark}):(await this.notifyWebAppDataChanged(),{id:t.data.bookmark.id,isExisting:a})}catch(r){let t;const e=r.code||"",o=r.status||0;t="INVALID_API_KEY"===e||"MISSING_API_KEY"===e||401===o?a("error_auth_failed"):"INSUFFICIENT_PERMISSIONS"===e||403===o?a("error_permission_save_bookmark"):"RATE_LIMIT_EXCEEDED"===e||429===o?a("error_rate_limit"):"NETWORK_ERROR"===e||0===o?a("error_network_error"):o>=500?a("error_server_error"):r.message||a("error_save_bookmark_failed");const n=new s("BOOKMARK_SITE_ERROR",t,{originalError:r});throw n.code=e,n.status=o,n}}async updateBookmarkTags(t,e){const a=await this.ensureClient();try{await a.bookmarks.updateBookmark(t,{tags:e}),await this.notifyWebAppDataChanged()}catch(o){throw new s("BOOKMARK_SITE_ERROR",`Failed to update tags: ${o.message}`,{originalError:o})}}async updateBookmarkDescription(t,e){const a=await this.ensureClient();try{await a.bookmarks.updateBookmark(t,{description:e}),await this.notifyWebAppDataChanged()}catch(o){throw new s("BOOKMARK_SITE_ERROR",`Failed to update description: ${o.message}`,{originalError:o})}}async createSnapshot(t,e){const a=await this.ensureClient();try{await a.snapshots.createSnapshot(t,e),await this.notifyWebAppDataChanged()}catch(o){throw new s("BOOKMARK_SITE_ERROR",`Failed to create snapshot: ${o.message}`,{originalError:o})}}async createSnapshotV2(a,o){await this.ensureClient();try{const r=await t.getBookmarkSiteApiKey(),n=await t.getBookmarkSiteApiUrl();let s;s=n?n.endsWith("/api")?n:e(n).API_BASE:e().API_BASE;const i=await fetch(`${s}/tab/bookmarks/${a}/snapshots-v2`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":r},body:JSON.stringify(o)});if(!i.ok){const t=await i.json();throw new Error(t.error?.message||"Failed to create snapshot")}await this.notifyWebAppDataChanged()}catch(r){throw new s("BOOKMARK_SITE_ERROR",`Failed to create snapshot (V2): ${r.message}`,{originalError:r})}}async testConnection(){try{const t=await this.ensureClient();return await t.user.getMe(),!0}catch(t){return!1}}};const p=new class{contextCache=null;contextPromise=null;async recommendTags(e){try{const a=t.loadConfig(),o=this.getContext(),r=await a,n=r.aiConfig.apiKeys[r.aiConfig.provider];if(!n)return this.fallbackRecommendation(e);const s=await o,i={page:{title:e.title,url:e.url,description:e.description,content:e.content?.substring(0,500)},context:s,options:{maxTags:r.preferences.maxSuggestedTags||5,preferExisting:!0}},c=r.aiConfig.apiUrls?.[r.aiConfig.provider],l=r.aiConfig.enableCustomPrompt?r.aiConfig.customPrompt:void 0,d=await this.callAIWithRetry(i,n,r.aiConfig.provider,r.aiConfig.model,c,l,1,void 0),u=s.existingTags,m=new Set(u.map(t=>t.trim().toLowerCase())),h=d.suggestedTags.map(t=>{const e=t.name.trim().toLowerCase(),a=m.has(e);return{...t,isNew:!a}});return{tags:this.deduplicateAndSort(h),source:"ai",timestamp:Date.now()}}catch(a){const t=a instanceof Error?a.message:"AI recommendation failed";return this.fallbackRecommendation(e,t)}}async getContext(){if(this.contextCache)return this.contextCache;if(this.contextPromise)return this.contextPromise;this.contextPromise=this.loadContextFromDB();try{const t=await this.contextPromise;return this.contextCache=t,t}finally{this.contextPromise=null}}async callAIWithRetry(t,e,a,o,r,n,s,c){const l=i(a);let d;for(let i=0;i<s;i++)try{if("number"==typeof c&&c>0){const a=new Promise((t,e)=>{setTimeout(()=>e(new Error("AI request timeout")),c)});return await Promise.race([l.generateTags(t,e,o,r,n),a])}return await l.generateTags(t,e,o,r,n)}catch(u){if(d=u,i<s-1){const t=1e3*Math.pow(2,i);await this.delay(t)}}throw d||new Error("AI request failed after retries")}async fallbackRecommendation(t,e){const a=this.extractKeywords(t.title+" "+(t.description||""));return{tags:(await n.tags.toArray()).filter(t=>a.some(e=>t.name.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(t.name.toLowerCase()))).sort((t,e)=>(e.count||0)-(t.count||0)).slice(0,3).map(t=>({name:t.name,isNew:!1,confidence:.6})),source:"fallback",timestamp:Date.now(),message:e||null}}extractKeywords(t){return t.split(/[\s\/\-_、，。！？]+/).map(t=>t.trim()).filter(t=>t.length>1).slice(0,20)}deduplicateAndSort(t){const e=new Set,a=[];for(const o of t){const t=o.name.toLowerCase().trim();e.has(t)||(e.add(t),a.push(o))}return a.sort((t,e)=>e.confidence-t.confidence)}delay(t){return new Promise(e=>setTimeout(e,t))}clearContextCache(){this.contextCache=null}async preloadContext(){if(this.contextPromise)return void(await this.contextPromise);const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}async refreshContextFromDB(){const t=this.loadContextFromDB(!0);this.contextPromise=t;try{const e=await t;this.contextCache=e}finally{this.contextPromise=null}}updateContextWithBookmark(t){if(!this.contextCache)return;const e=new Set(this.contextCache.existingTags.map(t=>t.toLowerCase())),a=[];for(const o of t.tags){const t=o.trim();t&&(e.has(t.toLowerCase())||(e.add(t.toLowerCase()),a.push(t)))}a.length>0&&(this.contextCache.existingTags=[...this.contextCache.existingTags,...a].slice(-200)),this.contextCache.recentBookmarks=[{title:t.title,tags:t.tags},...this.contextCache.recentBookmarks].slice(0,20)}async loadContextFromDB(t=!1){if(!t&&this.contextCache)return this.contextCache;const[e,a]=await Promise.all([n.tags.orderBy("count").reverse().limit(200).toArray().then(t=>t.map(t=>t.name)),n.bookmarks.orderBy("createdAt").reverse().limit(20).toArray().then(t=>t.map(t=>({title:t.title,tags:t.tags})))]),o={existingTags:e,recentBookmarks:a};return this.contextCache=o,o}};const w=new class{async fullSync(){const t=Date.now();try{const e=await f.getTags();await n.tags.clear(),await n.tags.bulkAdd(e);let a=1,r=0;for(await n.bookmarks.clear();a<=o.MAX_PAGES;){const{bookmarks:t,hasMore:e}=await f.getBookmarks(a,o.DEFAULT_PAGE_SIZE);if(t.length>0&&(await n.bookmarks.bulkAdd(t),r+=t.length),!e)break;a++}await n.updateLastSyncTime(Date.now()),await n.metadata.put({key:"totalTags",value:e.length,updatedAt:Date.now()}),await n.metadata.put({key:"totalBookmarks",value:r,updatedAt:Date.now()}),await p.refreshContextFromDB();return{success:!0,duration:Date.now()-t,stats:{tags:e.length,bookmarks:r}}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async incrementalSync(){try{await n.getLastSyncTime();return this.fullSync()}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async getStats(){return n.getStats()}async isCacheStale(t=24){const e=await n.getLastSyncTime();if(0===e)return!0;const a=60*t*60*1e3;return Date.now()-e>a}async autoSync(t=24){return await this.isCacheStale(t)?this.incrementalSync():null}async clearCache(){await n.clearAll(),p.clearContextCache()}};const g=new class{async saveBookmark(t){let e,o=!1;try{const r=await f.addBookmark(t);if(e=r.id,o=r.isExisting||!1,o&&r.existingBookmark)return{success:!0,existingBookmark:{...r.existingBookmark,needsDialog:!0},message:a("error_bookmark_exists")};o||(await n.bookmarks.add({url:t.url,title:t.title,description:t.description,tags:t.tags,createdAt:Date.now(),remoteId:r.id,isPublic:t.isPublic??!1}),await this.updateTagCounts(t.tags),p.updateContextWithBookmark({title:t.title,tags:t.tags}))}catch(r){const e=r instanceof Error?r.message:"Unknown error",o=r?.code||"",n=r?.status||0,s="INVALID_API_KEY"===o||"MISSING_API_KEY"===o||"INSUFFICIENT_PERMISSIONS"===o||401===n||403===n||e.includes("auth")||e.includes("API Key");if(("NETWORK_ERROR"===o||0===n)&&!s&&(e.includes("Network")||e.includes("network")||e.includes("connect")))return await this.queueForLaterSync(t),{success:!0,offline:!0,message:a("msg_offline_saved")};throw r}if(t.createSnapshot&&e)try{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});if(a&&a.id){let o;try{const t=chrome.tabs.sendMessage(a.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),e=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),r=await Promise.race([t,e]);if(!r.success)throw new Error(r.error||"Capture failed");o=r.data}catch(r){throw r}const n=o.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));await f.createSnapshotV2(e,{html_content:o.html,title:t.title,url:t.url,images:n})}}catch(s){}return{success:!0,bookmarkId:e,message:o?a("msg_bookmark_exists_snapshot"):void 0}}async updateTagCounts(t){for(const e of t){const t=await n.tags.where("name").equals(e).first();t&&t.id?await n.tags.update(t.id,{count:(t.count||0)+1}):await n.tags.add({name:e,count:1,createdAt:Date.now()})}}async queueForLaterSync(t){await n.metadata.add({key:`pending_${Date.now()}`,value:t,updatedAt:Date.now()})}async syncPendingBookmarks(){const t=await n.metadata.where("key").startsWith("pending_").toArray();let e=0;for(const o of t)try{if(o.value&&"object"==typeof o.value&&"url"in o.value&&"title"in o.value){const t=o.value;await f.addBookmark(t),await n.metadata.delete(o.key),e++}}catch(a){}return e}async getPendingCount(){return await n.metadata.where("key").startsWith("pending_").count()}},y="TMarks",k="NewTab Home",I="tmarks_root_bookmark_id",b="tmarks_home_bookmark_id",_="tmarks_workspace_uuid",C=864e5,A="[ROOT]";function x(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function E(t){const e=t.match(/^TMarks\s*\[([a-f0-9-]+)\]$/i);return e?e[1]:null}async function S(){try{const t=(await chrome.storage.local.get(I))[I];return"string"==typeof t?t:null}catch{return null}}async function T(t){try{await chrome.storage.local.set({[I]:t})}catch{}}async function P(){try{const t=(await chrome.storage.local.get(b))[b];return"string"==typeof t?t:null}catch{return null}}async function v(t){try{await chrome.storage.local.set({[b]:t})}catch{}}async function R(){try{const e=await async function(){try{const t=(await chrome.bookmarks.getTree())[0],e=t.children?.find(t=>"1"===t.id&&!t.url);if(e)return e.id;const a=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),o=t.children?.find(t=>!t.url&&a.has(t.title));if(o)return o.id;const r=t.children?.find(t=>!t.url);return r?.id||null}catch{return null}}();if(!e)return null;const a=await async function(){try{const t=(await chrome.storage.local.get(_))[_];if("string"==typeof t&&t.length>0)return t;const e=x();return await chrome.storage.local.set({[_]:e}),e}catch{return x()}}(),o=await S();if(o){const r=await async function(t){try{const e=await chrome.bookmarks.get(t),a=e?.[0];return a&&!a.url?a:null}catch{return null}}(o);if(r){const n=E(r.title);if(!n||n===a){const a=r.parentId;if(a&&a!==e)try{await chrome.bookmarks.move(o,{parentId:e})}catch(t){}if(n)try{await chrome.bookmarks.update(o,{title:y})}catch{}return{id:o,wasRecreated:!1}}}}const r=await chrome.bookmarks.getChildren(e),n=y,s=r.find(t=>{if(t.url)return!1;return E(t.title)===a});if(s){try{await chrome.bookmarks.update(s.id,{title:y})}catch{}return await T(s.id),{id:s.id,wasRecreated:!1}}const i=r.find(t=>!t.url&&t.title===y);if(i){try{await chrome.bookmarks.update(i.id,{title:n})}catch{}return await T(i.id),{id:i.id,wasRecreated:!1}}const c="AI 书签助手 NewTab",l=r.find(t=>!t.url&&t.title===c);if(l){try{await chrome.bookmarks.update(l.id,{title:n})}catch{}return await T(l.id),{id:l.id,wasRecreated:!1}}const d=await chrome.bookmarks.create({parentId:e,title:n});await T(d.id);const u=null!==o;return{id:d.id,wasRecreated:u}}catch(t){return null}}async function M(t){if(!t)return null;const e=await P();if(e)try{const o=await chrome.bookmarks.get(e),r=o?.[0];if(r&&!r.url){if(r.parentId!==t)try{await chrome.bookmarks.move(e,{parentId:t})}catch(a){}return await v(r.id),{id:r.id,wasRecreated:!1}}}catch{}try{const a=(await chrome.bookmarks.getChildren(t)).find(t=>!t.url&&t.title===k);if(a)return await v(a.id),{id:a.id,wasRecreated:!1};const o=await chrome.bookmarks.create({parentId:t,title:k});return await v(o.id),{id:o.id,wasRecreated:null!==e}}catch(a){return null}}async function B(){const t=await R();if(!t)return null;const e=await M(t.id);return{rootId:t.id,homeId:e?.id??null}}async function O(t){try{await chrome.runtime.sendMessage({type:"AI_ORGANIZE_PROGRESS",payload:{...t,ts:Date.now()}})}catch{}}async function N(t,e){try{const e=await chrome.tabs.get(t);return{success:!0,data:{title:e.title||"Untitled",url:e.url||"",description:"",content:"",thumbnail:""}}}catch{return{success:!0,data:{title:"Untitled",url:e,description:"",content:"",thumbnail:""}}}}async function D(t,e,a=3e3){return Promise.race([chrome.tabs.sendMessage(t,e),new Promise((t,e)=>setTimeout(()=>e(new Error("Message timeout")),a))])}function F(t){const e=(t||"").trim();if(!e)return null;const a=t=>{try{return JSON.parse(t)}catch{return null}},o=t=>{const e=(t||"").trim();return e?e.replace(/,\s*([}\]])/g,"$1"):""},r=a(e);if(r)return r;const n=e.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);if(n&&n[1]){const t=a(o(n[1]));if(t)return t}const s=e.indexOf("{"),i=e.lastIndexOf("}");if(-1!==s&&-1!==i&&i>s){const t=a(o(e.slice(s,i+1)));if(t)return t}const c=e.indexOf("["),l=e.lastIndexOf("]");if(-1!==c&&-1!==l&&l>c){const t=a(o(e.slice(c,l+1)));if(t)return t}const d=e.match(/"domainMoves"|"domain_moves"/);if(void 0!==d?.index){const t=e.lastIndexOf("{",d.index);if(-1!==t){const r=o(e.slice(t)),n=[];n.push(r);const s=r.lastIndexOf("}");if(-1!==s){const t=r.slice(0,s+1);n.push(t);const e=t.search(/"domainMoves"|"domain_moves"/);if(-1!==e){const a=t.indexOf("[",e),o=t.lastIndexOf("]");-1!==a&&o<a&&n.push(`${t}]}`)}}for(const t of n){const e=a(t);if(e)return e}}}return null}function K(t){try{return new URL(t).hostname||""}catch{return""}}async function $(t){const e=new Date,o=t=>String(t).padStart(2,"0"),r=`Imported ${e.getFullYear()}-${o(e.getMonth()+1)}-${o(e.getDate())} ${o(e.getHours())}${o(e.getMinutes())}${o(e.getSeconds())}`,n=await chrome.bookmarks.create({parentId:t,title:r}),s=await chrome.bookmarks.getTree(),i=s?.[0];if(!i)throw new Error("Bookmarks root not found");const c=await async function(t){const e=[],o={folders:0,bookmarks:0},r=(t,a)=>{t&&0!==t.length&&e.push({children:t,index:0,targetParentId:a})};for(r(t.sourceRoot.children,t.targetParentId);e.length>0;){const n=e[e.length-1];if(n.index>=n.children.length){e.pop();continue}const s=n.children[n.index],i=n.index;if(n.index+=1,t.skipSourceId&&s.id===t.skipSourceId)continue;if(!s.url&&s.title===y)continue;if(s.url){await chrome.bookmarks.create({parentId:n.targetParentId,index:i,title:s.title||s.url,url:s.url}),o.bookmarks+=1;continue}const c=await chrome.bookmarks.create({parentId:n.targetParentId,index:i,title:s.title||a("default_folder_name")});o.folders+=1,r(s.children,c.id)}return o}({sourceRoot:i,targetParentId:n.id,skipSourceId:t});return{importFolderId:n.id,folderTitle:r,counts:c}}async function L(t,e,a){const o=(e||"").split("/").map(t=>t.trim()).filter(Boolean).join("/");if(!o)return t;const r=a.get(o);if(r)return r;const n=o.split("/");let s=t,i="";for(const c of n){i=i?`${i}/${c}`:c;const t=a.get(i);if(t){s=t;continue}const e=(await chrome.bookmarks.getChildren(s)).find(t=>!t.url&&t.title===c);if(e){a.set(i,e.id),s=e.id;continue}const o=await chrome.bookmarks.create({parentId:s,title:c});a.set(i,o.id),s=o.id}return s}function j(t){const e=(t||"").split("/").map(t=>t.trim()).filter(Boolean);return 0===e.length?"":e.slice(0,2).join("/")}async function W(){const t=await R();if(!t)throw new Error("NewTab root folder not found");const e=t.id,a=(await chrome.bookmarks.get(e))?.[0];if(!a)throw new Error("NewTab root folder not found");const o=[],r=[{node:a,parentId:null,pathPrefix:""}];for(;r.length>0&&o.length<200;){const{node:t,parentId:e,pathPrefix:a}=r.shift(),n=a?`${a}/${t.title}`:t.title;o.push({id:t.id,title:t.title,parentId:e,path:n});const s=(await chrome.bookmarks.getChildren(t.id)).filter(t=>!t.url);for(const i of s){if(o.length+r.length>=200)break;r.push({node:i,parentId:t.id,pathPrefix:n})}}return{success:!0,data:{rootId:a.id,folders:o}}}function U(t,e,a,o){const r=function(t){const e=new Map;for(const a of t||[]){if(!a?.url)continue;const t=K(a.url)||"(no-domain)",o=e.get(t)||{clickCount:0,shortcutCount:0};o.shortcutCount+=1,o.clickCount+="number"==typeof a.clickCount?a.clickCount:0,e.set(t,o)}return e}(e),n=new Map;return{summaries:Array.from(t.entries()).map(([t,e])=>{const s=t||"(no-domain)",i=r.get(s)||{clickCount:0,shortcutCount:0},c=a?.get(s),l=c?.count??0,d=c?.lastVisitTime??null,u=d?Math.max(0,Math.min(1,1-Math.min((Date.now()-d)/C,o)/o)):0,m=e.length,h=i.clickCount,f=Number((1*m+.5*h+.3*l+2*u).toFixed(3)),p=new Map;for(const a of e){const t=a.path||A;p.set(t,(p.get(t)??0)+1)}const w=Array.from(p.entries()).sort((t,e)=>e[1]-t[1]).slice(0,5).map(([t,e])=>({path:t,count:e}));return w.length>0&&n.set(s,w[0].path),{domain:s,count:m,bookmarkCount:m,shortcutCount:i.shortcutCount,clickCount:h,historyCount:l,historyLastVisit:d,historyLastVisitISO:d?new Date(d).toISOString():null,recencyScore:Number(u.toFixed(3)),heatScore:f,samples:e.slice(0,3).map(t=>({title:t.title,url:t.url,path:t.path})),originalPaths:w}}).sort((t,e)=>(e.heatScore??0)!==(t.heatScore??0)?(e.heatScore??0)-(t.heatScore??0):(e.bookmarkCount??e.count??0)-(t.bookmarkCount??t.count??0)),domainPreferredPathMap:n}}async function G(e){const o=e.payload||{},r="string"==typeof o.sessionId&&o.sessionId.trim()?o.sessionId.trim():String(Date.now()),n="string"==typeof o.rules?o.rules:"",s=Math.min(2e3,Math.max(50,Number(o.maxBookmarks??300))),i="string"==typeof o.promptTemplate?o.promptTemplate.trim():"",l=Boolean(o.enableHistoryHeat),d=function(t){if(!Number.isFinite(t))return 30;const e=Math.round(t);return Math.max(1,Math.min(90,e))}(Number(o.historyDays??30)),u=function(t){if(!Number.isFinite(t))return 20;const e=Math.round(t);return Math.max(5,Math.min(100,e))}(Number(o.historyHeatTopN??10)),f=Boolean(o.strictHierarchy),p=!f&&!1!==o.allowNewFolders,w=!1!==o.preferOriginalPaths,g=!1!==o.verboseLogs,y=function(t){if(!Number.isFinite(t))return 5;const e=Math.round(t);return Math.max(2,Math.min(7,e))}(Number(o.topLevelCount??5));let k=!1;const I=async(t,e)=>{const a=t.level??"info";!g&&(e?.verbose??"info"===a)||await O(t)};await I({sessionId:r,level:"info",step:"start",message:"开始 AI 整理：准备读取书签与配置"},{verbose:!1});const b=await R();if(!b)throw new Error("NewTab root folder not found");const _=b.id;await I({sessionId:r,level:"info",step:"root",message:`已定位工作区根目录: ${_}`});const x=await async function(t){const e=await chrome.bookmarks.getTree(),o=e?.[0],r=[];if(!o)return r;const n=[{node:o,path:"",parentPath:""}];for(;n.length>0;){const{node:e,path:o,parentPath:s}=n.pop();if(t&&e.id===t)continue;if(e.url){const t=e.url||"",a=s||A;r.push({id:e.id,title:e.title||t,url:t,domain:K(t),path:a});continue}const i=e.children||[];for(let t=i.length-1;t>=0;t--){const e=i[t],r=(e.title||"").trim()||a("default_untitled"),s=e.url?o:o?`${o}/${r}`:r;n.push({node:e,path:s,parentPath:o})}}return r}(_);if(0===x.length)return await I({sessionId:r,level:"warn",step:"collect",message:"浏览器没有可整理的书签"}),{success:!0,data:{total:0,processed:0,truncated:k,moved:0,createdFolders:0,createdBookmarks:0,message:"浏览器没有可整理的书签"}};const E=await async function(){try{const t=await chrome.storage.local.get(h),e=t?.[h];return e&&"object"==typeof e&&Array.isArray(e.shortcuts)?e.shortcuts:[]}catch{return[]}}();await I({sessionId:r,level:"info",step:"usage",message:`已加载快捷方式: ${E.length} 个`});let S=null;if(l)if(chrome.history&&"function"==typeof chrome.history.search)try{await I({sessionId:r,level:"info",step:"history",message:`读取浏览历史：最近 ${d} 天`});const t=await async function(t){if(!chrome.history||"function"!=typeof chrome.history.search)throw new Error("History API unavailable");const e=Date.now()-t*C,a=await chrome.history.search({text:"",startTime:e,maxResults:5e3}),o=new Map;for(const r of a){if(!r?.url)continue;const t=K(r.url)||"(no-domain)",e=o.get(t)||{count:0,lastVisitTime:0};e.count+=1,"number"==typeof r.lastVisitTime&&r.lastVisitTime>e.lastVisitTime&&(e.lastVisitTime=r.lastVisitTime),o.set(t,e)}return{domains:o,totalItems:a.length,truncated:a.length>=5e3}}(d);S=t.domains,await I({sessionId:r,level:"info",step:"history",message:`历史记录: ${t.totalItems} 条，覆盖 ${S.size} 个域名${t.truncated?"（部分截断）":""}`})}catch(ot){await I({sessionId:r,level:"warn",step:"history",message:`历史记录读取失败：${ot instanceof Error?ot.message:"未知错误"}，继续使用书签数据`})}else await I({sessionId:r,level:"warn",step:"history",message:"历史记录 API 不可用，跳过热度统计"});const T=function(t){const e=new Map;for(const a of t){const t=a.domain||"(no-domain)",o=e.get(t)||[];o.push({id:a.id,title:a.title,url:a.url,path:a.path}),e.set(t,o)}return e}(x),P=function(t){const e=new Map;for(const a of t){const t=a.path||A;e.set(t,(e.get(t)??0)+1)}return Array.from(e.entries()).sort((t,e)=>e[1]-t[1]).slice(0,500).map(([t,e])=>({path:t,count:e}))}(x),{summaries:v}=U(T,E,S,d),M=v.slice(0,Math.min(u,v.length));await O({sessionId:r,level:"info",step:"collect",message:`已读取书签: ${x.length} 个；域名: ${T.size} 个`});const B=[];for(let t=0;t<v.length;t+=s)B.push(v.slice(t,t+s));const N={totalDomains:v.length,totalBatches:B.length||1,batchSize:s,truncated:!1,topHistoryLimit:u,topHistoryDomains:M,folderPaths:P,strictHierarchy:f,allowNewFolders:p,preferOriginalPaths:w,batches:(B.length?B:[v]).map((t,e,a)=>({batchIndex:e+1,totalBatches:a.length,waitForMoreBatches:e+1<a.length,isFinalBatch:e+1===a.length,domains:t})),allBatchesProvided:!0};await O({sessionId:r,level:"info",step:"summarize",message:`已生成域名汇总: ${N.totalDomains} 个，批次数 ${N.totalBatches}（每批 ${N.batchSize} 个），历史优先 Top ${u}`});const D=await t.loadConfig(),$=D.aiConfig.apiKeys[D.aiConfig.provider];if(!$)throw await O({sessionId:r,level:"error",step:"config",message:"未配置 AI API Key"}),new Error("未配置 AI API Key");await O({sessionId:r,level:"info",step:"ai_call",message:`准备调用 AI: ${D.aiConfig.provider}/${D.aiConfig.model}`});const W=(i||m).split("{{rules}}").join(n||"(无)").split("{{domainSummariesJson}}").join(JSON.stringify(N)).split("{{topLevelCount}}").join(String(y)).split("{{topHistoryLimit}}").join(String(u)),G=await c({provider:D.aiConfig.provider,apiKey:$,model:D.aiConfig.model,apiUrl:D.aiConfig.apiUrls?.[D.aiConfig.provider],prompt:W,temperature:.2,maxTokens:2e3});await O({sessionId:r,level:"success",step:"ai_call",message:`AI 调用完成（返回长度 ${String(G.content||"").length}）`});const H=G.content||"",V=F(H),z=Array.isArray(V?.domainMoves)?V.domainMoves:Array.isArray(V?.domain_moves)?V.domain_moves:[],q=j("string"==typeof V?.fallbackPath?V.fallbackPath:"")||"其他/未分类",Y=z.map(t=>({domain:"string"==typeof t?.domain?t.domain:"",path:j("string"==typeof t?.path?t.path:"")||q})).filter(t=>t.domain&&t.path);if(0===Y.length){const t=H.trim().slice(0,1e3);throw await O({sessionId:r,level:"error",step:"parse",message:"AI 返回结果不可解析或为空（domainMoves 为空）",detail:{rawPreview:t,parsed:V}}),new Error("AI 返回结果不可解析或为空")}const X=new Set;for(const t of Y){const e=t.path.split("/")[0];e&&X.add(e)}const J=X.size;let Z=0;if(J>y){const t=new Map;for(const r of Y){const e=r.path.split("/")[0];e&&t.set(e,(t.get(e)||0)+1)}const e=Array.from(t.entries()).sort((t,e)=>e[1]-t[1]).map(([t])=>t),a=new Set(e.slice(0,y)),o=new Set(e.slice(y));for(const r of Y){const t=r.path.split("/")[0];t&&o.has(t)&&(r.path=q,Z++)}await O({sessionId:r,level:"warn",step:"limit",message:`AI 返回 ${J} 个一级目录，超过限制 ${y}，已将 ${Z} 个域名合并到「${q}」`,detail:{kept:Array.from(a),merged:Array.from(o)}})}await O({sessionId:r,level:"success",step:"parse",message:`已解析 AI 规划: domainMoves=${Y.length}，一级目录=${Math.min(J,y)}，fallbackPath=${q}`});const Q=new Map;for(const t of Y)Q.set(t.domain,t.path);await async function(t,e){const a=await chrome.bookmarks.getChildren(t);let o=0;for(const r of a)(r.url||"NewTab Home"!==r.title)&&(await chrome.bookmarks.removeTree(r.id),o+=1);return await O({sessionId:e,level:"info",step:"cleanup",message:`已清空工作区：移除旧目录/书签 ${o} 个`}),o}(_,r);const{folderCache:tt,createdFolders:et}=await async function(t,e,a,o,r){const n=new Map;let s=0;const i=new Set;for(const[c]of e.entries()){const t=c||"(no-domain)",e=a.get(t)||o;i.add(e),"(no-domain)"!==t||a.has(t)||i.add(o)}for(const c of i){const e=n.size;await L(t,c,n);const a=n.size;a>e&&(s+=a-e)}return await O({sessionId:r,level:"info",step:"folders",message:`目录准备完成：新建目录 ${s} 个`}),{folderCache:n,createdFolders:s}}(_,T,Q,q,r),at=await async function(t,e,a,o,r,n){let s=0;for(const i of t){const c=i.domain||"(no-domain)",l=a.get(c)||o,d=await L(e,l,r);await chrome.bookmarks.create({parentId:d,title:i.title||i.url,url:i.url}),s+=1,s%100==0&&await O({sessionId:n,level:"info",step:"copy",message:`复制书签进度：${s}/${t.length}`})}return s}(x,_,Q,q,tt,r);return await O({sessionId:r,level:"success",step:"done",message:`整理完成：创建目录 ${et} 个，复制书签 ${at} 个`}),{success:!0,data:{total:x.length,processed:x.length,truncated:k,moved:0,createdFolders:et,createdBookmarks:at}}}r().catch(()=>{}),B().catch(()=>{}),p.preloadContext().catch(()=>{}),chrome.runtime.onInstalled.addListener(async t=>{"install"===t.reason||t.reason,B().catch(()=>{})}),chrome.runtime.onStartup.addListener(()=>{B().catch(()=>{})}),chrome.bookmarks.onRemoved.addListener(t=>{(async function(t){try{const[e,a]=await Promise.all([S(),P()]);if(t&&e&&t===e)return void(await B());if(t&&a&&t===a){const t=await R();t&&await M(t.id)}}catch(e){}})(t).catch(()=>{})}),chrome.bookmarks.onMoved.addListener(t=>{(async function(t){try{const[e,a]=await Promise.all([S(),P()]);if(e&&t===e)return void(await R());if(a&&t===a){const t=await R();t&&await M(t.id)}}catch(e){}})(t).catch(()=>{})}),async function(){const e=()=>{const a=function(){const t=new Date,e=new Date(t);return e.setHours(23,0,0,0),e<=t&&e.setDate(e.getDate()+1),e.getTime()-t.getTime()}();setTimeout(async()=>{await async function(){try{const e=await t.loadConfig();if(!e.preferences.autoSync)return;await w.autoSync(e.preferences.syncInterval)}catch{}}(),e()},a)};e()}().catch(()=>{}),g.syncPendingBookmarks().catch(()=>{}),(async()=>{try{const e=await t.loadConfig();e.bookmarkSite.apiKey&&await d(e.bookmarkSite)}catch{}})(),async function(){const t=async()=>{try{const e=(await chrome.storage.local.get("newtab")).newtab;if(!e?.settings?.autoRefreshPinnedBookmarks)return void setTimeout(t,36e5);const a=function(t){const e=new Date,a=new Date(e);return"morning"===t?a.setHours(8,0,0,0):a.setHours(22,0,0,0),a<=e&&a.setDate(a.getDate()+1),a.getTime()-e.getTime()}(e.settings.pinnedBookmarksRefreshTime||"morning");setTimeout(async()=>{await async function(){try{await chrome.storage.local.remove("tmarks_pinned_bookmarks_cache"),await chrome.runtime.sendMessage({type:"REFRESH_PINNED_BOOKMARKS",payload:{timestamp:Date.now(),source:"scheduled"}}).catch(()=>{})}catch(t){}}(),t()},a)}catch{setTimeout(t,36e5)}};t()}().catch(()=>{}),chrome.runtime.onMessage.addListener((e,o,r)=>(async function(e){const o=String(e?.type??"").trim().toUpperCase();switch(o){case"AI_ORGANIZE_PROGRESS":return{success:!0,data:{}};case"EXTRACT_PAGE_INFO":return async function(t){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.id)throw new Error("No active tab found");const a=e.url||"";if(a.startsWith("chrome://")||a.startsWith("chrome-extension://")||a.startsWith("edge://")||a.startsWith("about:")||!a)return{success:!0,data:{title:e.title||"Untitled",url:a,description:"",content:"",thumbnail:""}};let o=!1;try{await D(e.id,{type:"PING"},1e3),o=!0}catch{}if(!o)try{const t=chrome.runtime.getManifest(),r=t.content_scripts?.[0];if(!r||!r.js||0===r.js.length)return await N(e.id,a);const n=r.js[0];await chrome.scripting.executeScript({target:{tabId:e.id},files:[n]}),await new Promise(t=>setTimeout(t,300));try{await D(e.id,{type:"PING"},1e3),o=!0}catch{return await N(e.id,a)}}catch{return await N(e.id,a)}if(o)try{const o=await D(e.id,t,5e3);return o.success&&o.data?o:await N(e.id,a)}catch{return await N(e.id,a)}return await N(e.id,a)}(e);case"RECOMMEND_TAGS":{const t=e.payload;return{success:!0,data:await p.recommendTags(t)}}case"SAVE_BOOKMARK":{const t=e.payload;return{success:!0,data:await g.saveBookmark(t)}}case"AI_ORGANIZE_NEWTAB_WORKSPACE":try{return await G(e)}catch(r){const t=r instanceof Error?r.message:"Failed to organize",o=(()=>{const e=String(t||"");return e.includes("429")||e.includes("rate_limit_exceeded")?a("error_ai_rate_limit"):t})();try{const a=e.payload||{},n="string"==typeof a.sessionId&&a.sessionId.trim()?a.sessionId.trim():String(Date.now());await O({sessionId:n,level:"error",step:"fatal",message:o,detail:{rawMessage:t,stack:r instanceof Error?r.stack:void 0}})}catch{}return{success:!1,error:o}}case"SAVE_TO_NEWTAB":return async function(t){const e=t.payload,a=e?.url,o=e?.title||e?.url||"Untitled";if(!a)throw new Error("Missing url");const r=await R();if(!r)throw new Error("NewTab root folder not found");const n=r.id,s=e.parentBookmarkId||n;return{success:!0,data:{id:(await chrome.bookmarks.create({parentId:s,title:o,url:a})).id}}}(e);case"IMPORT_ALL_BOOKMARKS_TO_NEWTAB":return async function(){const t=await R();if(!t)throw new Error("NewTab root folder not found");const e=t.id,a=await $(e);return{success:!0,data:{importFolderId:a.importFolderId,folderTitle:a.folderTitle,counts:a.counts}}}();case"GET_NEWTAB_FOLDER":case"GET_NEWTAB_FOLDERS":return W();case"RECOMMEND_NEWTAB_FOLDER":return async function(e){const o=e.payload,r=o?.url;if(!r)throw new Error("Missing url");const n=await t.loadConfig();if(!1===n.preferences.enableNewtabAI)return{success:!0,data:{suggestedFolders:[]}};const s=Number(n.preferences.newtabFolderRecommendCount??10),i=Math.min(20,Math.max(1,Number.isFinite(s)?s:10)),l=await W();if(!l.success)throw new Error(l.error||"Failed to load folders");const d=l.data,m=d.folders.filter(t=>t.id!==d.rootId).map(t=>t.path).slice(0,200),h=u.split("{{title}}").join(o.title||"").split("{{url}}").join(r).split("{{description}}").join(o.description||a("none")).split("{{recommendCount}}").join(String(i)).split("{{folderPaths}}").join(m.join("\n")),f=(n.preferences.newtabFolderPrompt||"").trim(),p=n.preferences.enableNewtabFolderPrompt&&f?f.split("{{title}}").join(o.title||"").split("{{url}}").join(r).split("{{description}}").join(o.description||a("none")).split("{{recommendCount}}").join(String(i)).split("{{folderPaths}}").join(m.join("\n")):h,w=n.aiConfig.apiKeys[n.aiConfig.provider];if(!w)return{success:!0,data:{suggestedFolders:[]}};const g=(await c({provider:n.aiConfig.provider,apiKey:w,model:n.aiConfig.model,apiUrl:n.aiConfig.apiUrls?.[n.aiConfig.provider],prompt:p})).content||"",y=F(g)||{suggestedFolders:[]},k=Array.isArray(y?.suggestedFolders)?y.suggestedFolders:[];0===k.length&&g.trim();const I=new Map(d.folders.map(t=>[t.path,t.id]));return{success:!0,data:{suggestedFolders:k.map(t=>({path:"string"==typeof t?.path?t.path:"",confidence:"number"==typeof t?.confidence?t.confidence:0})).filter(t=>t.path&&I.has(t.path)).slice(0,i).map(t=>({id:I.get(t.path),path:t.path,confidence:t.confidence}))}}}(e);case"SYNC_CACHE":{const t=await w.fullSync();return{success:t.success,data:t,error:t.error}}case"GET_EXISTING_TAGS":return{success:!0,data:await f.getTags()};case"UPDATE_BOOKMARK_TAGS":{const{bookmarkId:t,tags:a}=e.payload;return await f.updateBookmarkTags(t,a),{success:!0,data:{message:"Tags updated successfully"}}}case"UPDATE_BOOKMARK_DESCRIPTION":{const{bookmarkId:t,description:a}=e.payload;return await f.updateBookmarkDescription(t,a),{success:!0,data:{message:"Description updated successfully"}}}case"REFRESH_PINNED_BOOKMARKS":{const t=await chrome.tabs.query({url:chrome.runtime.getURL("src/newtab/index.html")});for(const a of t)a.id&&chrome.tabs.sendMessage(a.id,{type:"REFRESH_PINNED_BOOKMARKS",payload:e.payload}).catch(()=>{});return{success:!0,data:{message:"Pinned bookmarks refresh triggered"}}}case"CREATE_SNAPSHOT":{const{bookmarkId:t,title:a,url:o}=e.payload,[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r||!r.id)throw new Error("No active tab found");const n=chrome.tabs.sendMessage(r.id,{type:"CAPTURE_PAGE_V2",options:{inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:104857600,timeout:3e4}}),s=new Promise((t,e)=>{setTimeout(()=>e(new Error("Capture timeout")),35e3)}),i=await Promise.race([n,s]);if(!i.success)throw new Error(i.error||"Capture failed");const c=i.data,l=c.images.map(t=>({hash:t.hash,data:t.data,type:t.type}));return await f.createSnapshotV2(t,{html_content:c.html,title:a,url:o,images:l}),{success:!0,data:{message:"Snapshot created successfully (V2)",imageCount:l.length}}}case"GET_CONFIG":return{success:!0,data:await t.loadConfig()};default:throw new Error(`Unknown message type: ${o||"(empty)"} (runtimeId=${chrome.runtime.id})`)}}(e).then(t=>r(t)).catch(t=>{r({success:!1,error:t instanceof Error?t.message:"Unknown error"})}),!0)),chrome.action.onClicked.addListener(async()=>{});
