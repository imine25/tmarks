import{t as e,S as s}from"./urls-T86wRnwx.js";import{o as a,k as r,r as n}from"./react-vendor-1ZtHTM4k.js";const o=a((a,r)=>({currentPage:null,recommendedTags:[],existingTags:[],selectedTags:[],isLoading:!1,isSaving:!1,isRecommending:!1,error:null,successMessage:null,loadingMessage:null,lastRecommendationSource:null,lastRecommendationMessage:null,lastSaveDurationMs:null,lastRecommendationDurationMs:null,isPublic:!0,includeThumbnail:!1,createSnapshot:!1,existingBookmark:null,setExistingBookmark:e=>a({existingBookmark:e}),config:null,setCurrentPage:e=>a(s=>{let a=!1;const r=s.config?.preferences.defaultIncludeThumbnail??!0;return e&&(a=s.currentPage&&s.currentPage.url===e.url?s.includeThumbnail&&Boolean(e.thumbnail):r&&Boolean(e.thumbnail)),{currentPage:e,includeThumbnail:a}}),setRecommendedTags:e=>a({recommendedTags:e}),setExistingTags:e=>a({existingTags:e}),setLoading:e=>a({isLoading:e}),setError:e=>a({error:e}),setSuccessMessage:e=>a({successMessage:e}),setLoadingMessage:e=>a({loadingMessage:e}),setIsPublic:e=>{const n=e?"public":"private",o=r(),t=o.config?{...o.config,preferences:{...o.config.preferences,defaultVisibility:n}}:o.config;a({isPublic:e,config:t??o.config});const i=o.config?{...o.config.preferences,defaultVisibility:n}:{theme:"auto",autoSync:!0,syncInterval:24,maxSuggestedTags:5,defaultVisibility:n,enableAI:!0,defaultIncludeThumbnail:!0,defaultCreateSnapshot:!1};s.saveConfig({preferences:i}).catch(()=>{})},setIncludeThumbnail:e=>a({includeThumbnail:e}),setCreateSnapshot:e=>a({createSnapshot:e}),toggleTag:e=>a(s=>({selectedTags:s.selectedTags.includes(e)?s.selectedTags.filter(s=>s!==e):[...s.selectedTags,e]})),addCustomTag:e=>a(s=>s.selectedTags.includes(e)||s.recommendedTags.some(s=>s.name===e)?s:{selectedTags:[...s.selectedTags,e],recommendedTags:[...s.recommendedTags,{name:e,isNew:!0,confidence:1}]}),clearSelectedTags:()=>a({selectedTags:[]}),loadExistingTags:async()=>{try{const e=await t({type:"GET_EXISTING_TAGS"});a({existingTags:e})}catch(e){}},loadConfig:async()=>{try{const e=await s.loadConfig();a({config:e,isPublic:"public"===e.preferences.defaultVisibility,createSnapshot:e.preferences.defaultCreateSnapshot??!1})}catch(r){a({error:e("error_load_config")})}},saveConfig:async r=>{try{await s.saveConfig(r);const e=await s.loadConfig();a({config:e,isPublic:"public"===e.preferences.defaultVisibility})}catch(n){a({error:e("error_save_config")})}},extractPageInfo:async()=>{try{a({isLoading:!0,error:null});const{config:e}=r(),s=e?.preferences.defaultVisibility??"public",n=e?.preferences.defaultIncludeThumbnail??!0,o=await t({type:"EXTRACT_PAGE_INFO"});a({currentPage:o,isLoading:!1,isPublic:"public"===s,includeThumbnail:n&&Boolean(o.thumbnail)})}catch(s){a({error:s instanceof Error?s.message:e("error_extract_page_info"),isLoading:!1})}},recommendTags:async()=>{const{currentPage:s}=r();if(!s)return void a({error:e("error_no_page_info")});const n=Date.now();try{a({isLoading:!0,isRecommending:!0,error:null,lastRecommendationSource:null,lastRecommendationMessage:null,lastRecommendationDurationMs:null});const o=await t({type:"RECOMMEND_TAGS",payload:s}),i=Date.now()-n,c=o.tags.map(e=>e.name),l={recommendedTags:o.tags,selectedTags:c,isLoading:!1,isRecommending:!1,lastRecommendationSource:o.source,lastRecommendationMessage:o.message||null,lastRecommendationDurationMs:i};if("fallback"===o.source)a({...l,error:o.message?e("error_ai_recommend_fallback_with_msg",o.message):e("error_ai_recommend_fallback")});else{a({...l,error:null});const s=e("msg_ai_recommend_complete",(i/1e3).toFixed(2));a({successMessage:s}),setTimeout(()=>{r().successMessage===s&&a({successMessage:null})},2e3)}}catch(o){const s=Date.now()-n;a({error:o instanceof Error?o.message:e("error_recommend_tags"),isLoading:!1,isRecommending:!1,lastRecommendationSource:null,lastRecommendationMessage:null,lastRecommendationDurationMs:s})}},saveBookmark:async()=>{const{currentPage:s,selectedTags:n,isPublic:o,includeThumbnail:i,createSnapshot:c}=r();if(!s)return void a({error:e("error_no_page_info")});if(0===n.length)return void a({error:e("error_select_one_tag")});const l=Date.now();try{a({isLoading:!0,isSaving:!0,error:null});const d=await t({type:"SAVE_BOOKMARK",payload:{url:s.url,title:s.title,description:s.description,tags:n,thumbnail:i?s.thumbnail:void 0,isPublic:o,createSnapshot:c}}),g=Date.now()-l,u=(g/1e3).toFixed(2);if(!d.success)return void a({error:`${d.message||d.error||e("error_save_failed")}（${u}s）`,isLoading:!1,isSaving:!1,lastSaveDurationMs:g});if(d.existingBookmark)return void a({existingBookmark:d.existingBookmark,isLoading:!1,isSaving:!1,lastSaveDurationMs:g});let m;d.offline?(m=`${d.message||e("msg_bookmark_offline_saved")}（${u}s）`,a({successMessage:m,isLoading:!1,isSaving:!1,lastSaveDurationMs:g}),chrome.notifications.create({type:"basic",iconUrl:"/icons/icon-128.png",title:e("extName"),message:`${d.message||e("msg_bookmark_offline_saved")}（${u}s）`})):(m=`✅ ${e("success")}!（${u}s）`,a({successMessage:m,isLoading:!1,isSaving:!1,lastSaveDurationMs:g}),chrome.notifications.create({type:"basic",iconUrl:"/icons/icon-128.png",title:e("extName"),message:`"${s.title}" ${e("success")}（${u}s）`}));const f=m;setTimeout(()=>{r().successMessage===f&&a({successMessage:null})},2e3)}catch(d){const s=Date.now()-l,r=(s/1e3).toFixed(2);a({error:e("error_save_bookmark_with_time",[d instanceof Error?d.message:e("error_save_bookmark_failed"),r]),isLoading:!1,isSaving:!1,lastSaveDurationMs:s})}},updateExistingBookmarkTags:async(s,r)=>{try{a({isSaving:!0,error:null});const n=await t({type:"UPDATE_BOOKMARK_TAGS",payload:{bookmarkId:s,tags:r}});if(!n.success)throw new Error(n.error||e("error_update_tags_failed"));a({successMessage:`✅ ${e("msg_tags_updated")}`,isSaving:!1,existingBookmark:null}),chrome.notifications.create({type:"basic",iconUrl:"/icons/icon-128.png",title:e("extName"),message:e("msg_tags_updated")}),setTimeout(()=>{a({successMessage:null})},2e3)}catch(n){a({error:n instanceof Error?n.message:e("error_update_tags_failed"),isSaving:!1})}},updateExistingBookmarkDescription:async(s,r)=>{try{a({isSaving:!0,error:null});const n=await t({type:"UPDATE_BOOKMARK_DESCRIPTION",payload:{bookmarkId:s,description:r}});if(!n.success)throw new Error(n.error||e("error_update_desc_failed"));a({successMessage:`✅ ${e("msg_desc_updated")}`,isSaving:!1,existingBookmark:null}),chrome.notifications.create({type:"basic",iconUrl:"/icons/icon-128.png",title:e("extName"),message:e("msg_desc_updated")}),setTimeout(()=>{a({successMessage:null})},2e3)}catch(n){a({error:n instanceof Error?n.message:e("error_update_desc_failed"),isSaving:!1})}},createSnapshotForBookmark:async s=>{const{currentPage:n}=r();if(n)try{a({isSaving:!0,error:null,loadingMessage:e("msg_capturing_page"),successMessage:null});const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});r&&r.id&&(await t({type:"CREATE_SNAPSHOT",payload:{bookmarkId:s,title:n.title,url:n.url}}),a({successMessage:e("msg_snapshot_created"),loadingMessage:null,isSaving:!1,existingBookmark:null}),chrome.notifications.create({type:"basic",iconUrl:"/icons/icon-128.png",title:e("extName"),message:e("msg_snapshot_created")}),setTimeout(()=>{a({successMessage:null})},3e3))}catch(o){a({error:o instanceof Error?o.message:e("error_create_snapshot"),loadingMessage:null,isSaving:!1})}},syncCache:async()=>{try{a({isLoading:!0,error:null}),await t({type:"SYNC_CACHE"}),a({successMessage:e("msg_cache_synced"),isLoading:!1}),setTimeout(()=>{a({successMessage:null})},2e3)}catch(s){a({error:s instanceof Error?s.message:e("error_sync_cache"),isLoading:!1})}}}));async function t(e){return new Promise((s,a)=>{chrome.runtime.sendMessage(e,e=>{chrome.runtime.lastError?a(new Error(chrome.runtime.lastError.message)):e.success?s(e.data):a(new Error(e.error||"Unknown error"))})})}function i(){return r.jsx("div",{className:"flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[color:var(--tab-message-info-icon)]"})})}function c({message:s,onDismiss:a,onRetry:n}){return r.jsx("div",{className:"bg-[color:var(--tab-message-danger-bg)] border border-[color:var(--tab-message-danger-border)] rounded-lg p-3 shadow-lg animate-in slide-in-from-top-5 fade-in duration-300 text-[var(--tab-message-danger-icon)]",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"bg-[color:var(--tab-message-danger-icon-bg)] rounded-full p-1.5 flex-shrink-0",children:r.jsx("svg",{className:"w-5 h-5 text-[var(--tab-message-danger-icon)]",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),r.jsx("div",{className:"flex-1 pt-0.5",children:r.jsx("p",{className:"text-sm font-medium",children:s})}),r.jsxs("div",{className:"flex items-center gap-1.5 flex-shrink-0",children:[n&&r.jsx("button",{onClick:n,className:"text-[var(--tab-message-danger-icon)] hover:opacity-90 text-xs font-medium transition-colors",children:e("btn_retry")}),a&&r.jsx("button",{onClick:a,className:"opacity-80 hover:opacity-100 transition-opacity",children:r.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})})}function l({message:e,onDismiss:s,autoHideDuration:a=3e3}){return n.useEffect(()=>{if(s&&a>0){const e=setTimeout(()=>{s()},a);return()=>{clearTimeout(e)}}},[s,a]),r.jsx("div",{className:"bg-[color:var(--tab-message-success-bg)] border border-[color:var(--tab-message-success-border)] rounded-lg p-3 shadow-lg animate-in slide-in-from-top-5 fade-in duration-300 text-[var(--tab-message-success-icon)]",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"bg-[color:var(--tab-message-success-icon-bg)] rounded-full p-1.5 flex-shrink-0",children:r.jsx("svg",{className:"w-5 h-5 text-[var(--tab-message-success-icon)]",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),r.jsx("div",{className:"flex-1 pt-0.5",children:r.jsx("p",{className:"text-sm font-medium",children:e})}),s&&r.jsx("button",{onClick:s,className:"flex-shrink-0 opacity-80 hover:opacity-100 transition-opacity",children:r.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})}const d={default:"theme-default",bw:"theme-bw",tmarks:"theme-tmarks"};function g(e){const s=document.documentElement;Object.values(d).forEach(e=>s.classList.remove(e)),s.classList.add(d[e])}function u(e){const s=document.documentElement;if("dark"===e)s.classList.add("dark");else if("light"===e)s.classList.remove("dark");else{window.matchMedia("(prefers-color-scheme: dark)").matches?s.classList.add("dark"):s.classList.remove("dark")}}function m(e){const s=window.matchMedia("(prefers-color-scheme: dark)"),a=()=>{"auto"===e()&&u("auto")};return s.addEventListener("change",a),u(e()),()=>s.removeEventListener("change",a)}export{c as E,i as L,l as S,u as a,g as b,m as i,o as u};
